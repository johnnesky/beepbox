<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>BeepBox</title>
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="theme-color" content="#444" />
	<meta name="format-detection" content="telephone=no" />
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" rel="stylesheet" media="none" onload="if (this.media != 'all') this.media='all';" /> <!-- this is a trick to load CSS asynchronously. -->
	<meta name="robots" content="noindex, nofollow" />
	<style type="text/css">
		html {
			background: var(--page-margin, black);
			overflow-x: hidden;
			font-size: large;
			font-family: 'Roboto', sans-serif;
			line-height: 1.3;
			color: var(--primary-text, white);
		}
		body {
			margin: auto;
			overflow-x: hidden;
			display: flex;
			flex-direction: column;
			align-items: center;
			align-content: center;
		}
		#beepboxEditorContainer {
			min-height: 645px;
			overflow: auto;
			background: var(--editor-background, black);
			width: 100%;
			max-width: 700px;
			padding-left: 30px;
			padding-right: 30px;
		}
		#text-content {
			overflow: auto;
			background: var(--editor-background, black);
			width: 100%;
			max-width: 700px;
			padding-left: 30px;
			padding-right: 30px;
		}
		h1 {
			font-size: 1.7rem;
			text-align: center;
			margin-top: 0.5em;
			margin-bottom: 0.5em;
			-webkit-text-stroke-width: 0;
		}
		h2 {
			font-size: 1.5rem;
			text-align: center;
			margin-top: 0.5em;
			margin-bottom: 0.5em;
			-webkit-text-stroke-width: 0;
		}
		a {
			color: var(--link-accent, #98f);
		}
		.donation form {
			display: inline;
		}
		.donation input[type="submit"] {
			-webkit-appearance: none;
			appearance: none;
			background: none;
			border: none;
			font-family: inherit;
			font-size: inherit;
			color: var(--link-accent, #98f);
			text-decoration: underline;
			cursor: pointer;
			padding: 0;
			margin: 0;
		}
		
		/* wide screen */
		@media (min-width: 701px) {
			html {
				width: 100%;
			}
			body {
				width: 100%;
			}
			.column-container {
				width: 700px;
				display: flex;
				justify-content: space-between;
			}
			/*.instructions-column {
				width: 375px;
			}
			.twitter-column {
				width: 300px;
			}*/
		}
		
		/* narrow screen */
		@media (max-width: 700px) {
			body {
				width: 100%;
			}
			p, .donation {
				margin: 1em 0.5em;
			}
			.column-container {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
		}
	</style>
</head>

<body>
	<div id="beepboxEditorContainer">
		<noscript>
			Sorry, BeepBox requires a JavaScript-enabled browser.
		</noscript>
	</div>
	<div id="text-content">
		<section>
			<h1>
				BeepBox Offline
			</h1>
			<p id="introduction">
				BeepBox is an online (and offline!) tool for sketching and sharing instrumental melodies. 
			</p>
			<p>
				All song data is contained in the URL at the top of your browser. 
				When you make changes to the song, the URL is updated to reflect your changes. 
				When you are satisfied with your song, just copy and paste the URL to save and share your song! 
			</p>
			<div class="donation">
				BeepBox is a passion project, and will always be free to use. If you find it valuable and have the means, any gratuity via
				<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
					<input type="hidden" name="cmd" value="_donations" />
					<input type="hidden" name="business" value="QZJTX9GRYEV9N" />
					<input type="hidden" name="currency_code" value="USD" />
					<input type="submit" name="submit" value="Paypal"/>
				</form>
				would be appreciated!
			</div>
		</section>
	
		<div class="column-container">
			<main class="instructions-column">
				<section>
					<h2>
						Instructions
					</h2>
					<p>
						You can add or remove notes by clicking on the gray rows at the top. 
						BeepBox automatically plays the notes out loud for you. Try it!
					</p>
					<p>
						Notes go into patterns, and you can edit one pattern at a time.
						Those numbered boxes at the bottom of the editor are the different patterns you can edit.
						<span id="bar-editing">
							Click the other boxes to move to a different part of the song, or click the arrows on the currently selected box to swap which pattern is played during that part of the song.
						</span>
					</p>
					<p>
						BeepBox can play several rows of patterns simultaneously, and each row has its own set of patterns. 
						Most rows can play melodies or harmonies, but the bottom row is for drums.
					</p>
					<p>
						The purple loop underneath the numbered boxes controls which part of the song is currently repeating. 
						Move the loop to listen to a different part of the song, or drag the ends to expand the loop to include the whole song. 
					</p>
					<div id="keyboard-instructions">
						<p>
							When BeepBox has focus (click on its interface above), you can use these keyboard shortcuts: <br/>
						</p>
						<ul>
							<li>Spacebar: play or pause the song</li>
							<li>Z: undo</li>
							<li>Y or Shift Z: redo</li>
							<li>C: copy pattern from selection</li>
							<li>V: paste pattern into selection</li>
							<li>1-8: assign a pattern number to selection</li>
							<li>Arrows: move selection</li>
							<li>[ ]: move playhead backward or forward</li>
							<li>Shift & Drag: select part of a pattern (long press on touch screen)</li>
							<li>Check BeepBox's edit menu for more!</li>
						</ul>
					</div>
					<p>
						In the note pattern editor, you can click and drag horizontally on a note to adjust its duration.
						You can also click above or below an existing note to add more notes to be played simultaneously, which is called a chord. 
					</p>
					<p>
						ADVANCED: Drag vertically from an existing note to bend its pitch, or drag vertically from above or below the note to adjust its volume. Drag on the numbered pattern boxes to select multiple patterns to copy and paste parts of your song.
					</p>
					<p>
						BeepBox has many more features. 
						Try playing with the buttons and menus on the right side to find out what it can do!
						You can also click on the label next to each option for a description of what it does.
					</p>
				</section>
				<section>
					<h2>
						About
					</h2>
					<p>
						BeepBox is developed by <a href="http://www.johnnesky.com">John Nesky</a>, also known as <a href="https://twitter.com/shaktool">@shaktool</a>. 
					</p>
					<p>
						BeepBox does not claim ownership over songs created with it, so original songs belong to their authors. 
					</p>
					<p>
						Neither John Nesky nor BeepBox assume responsibility for any copyrighted material played on BeepBox. No songs are ever received, recorded, or distributed by BeepBox's servers. All song data is contained in the URL after the hash (#) mark, and your song data will not leave your device unless you copy and share the URL.
					</p>
					<p>
						BeepBox does not collect, track, or share any user data. 
					</p>
				<section>
			</main>
		</div>
	</div>
	
	<script type="text/javascript">

if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent) ) {
	document.getElementById("introduction").innerHTML = "BeepBox is an online tool for sketching and sharing instrumental melodies. Make sure that your volume is turned up, then press the play button!";
	document.getElementById("keyboard-instructions").style.display = "none";
	document.getElementById("bar-editing").innerHTML = "Tap the other boxes to move to a different part of the song, or tap on the currently selected box to swap which pattern is played during that part of the song.";
}

var beepbox=function(t){"use strict";
/*!
    Copyright (C) 2020 John Nesky

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
    */class e{}function i(t){let e=0;for(let i=0;i<t.length;i++)e+=t[i];const i=e/t.length;let s=0,n=0;for(let e=0;e<t.length;e++)s+=n,n=t[e]-i,t[e]=s;return t.push(0),new Float64Array(t)}function s(t,i=null,s=null){let o=e.chipNoises[t].samples;if(null==o){if(o=new Float32Array(e.chipNoiseLength+1),e.chipNoises[t].samples=o,0==t){let t=1;for(let i=0;i<e.chipNoiseLength;i++){o[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=16384),t=e}}else if(1==t)for(let t=0;t<e.chipNoiseLength;t++)o[t]=2*Math.random()-1;else if(2==t){let t=1;for(let i=0;i<e.chipNoiseLength;i++){o[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=32768),t=e}}else if(3==t){let t=1;for(let i=0;i<e.chipNoiseLength;i++){o[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=40),t=e}}else{if(4!=t)throw new Error("Unrecognized drum index: "+t);n(o,10,11,1,1,0),n(o,11,14,.6578,.6578,0),i(o,e.chipNoiseLength),s(o,1/Math.sqrt(e.chipNoiseLength))}o[e.chipNoiseLength]=o[0]}return o}function n(t,i,n,o,r,h){const a=0|Math.pow(2,i),l=Math.min(e.chipNoiseLength>>1,0|Math.pow(2,n)),c=s(0);let f=0;for(let s=a;s<l;s++){let a=o+(r-o)*(Math.log(s)/Math.LN2-i)/(n-i),l=Math.pow(2,(a-1)*e.spectrumMax+1)*a;l*=Math.pow(s/2048,h),f+=l,l*=c[s];const u=.61803398875*s*s*Math.PI*2;t[s]=Math.cos(u)*l,t[e.chipNoiseLength-s]=Math.sin(u)*l}return f}function o(t,i,s){const n=e.rhythms[i].arpeggioPatterns[t-1];return null!=n?n[s%n.length]:s%t}function r(t){const e={};for(let i=0;i<t.length;i++){const s=t[i];s.index=i,e[s.name]=s}const i=t;return i.dictionary=e,i}e.scales=r([{name:"easy :)",realName:"pentatonic major",flags:[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"easy :(",realName:"pentatonic minor",flags:[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1]},{name:"island :)",realName:"ryukyu",flags:[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0]},{name:"island :(",realName:"pelog selisir",flags:[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1]},{name:"blues :)",realName:"blues major",flags:[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"blues :(",realName:"blues",flags:[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1]},{name:"normal :)",realName:"ionian",flags:[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0]},{name:"normal :(",realName:"aeolian",flags:[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1]},{name:"dbl harmonic :)",realName:"double harmonic major",flags:[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0]},{name:"dbl harmonic :(",realName:"double harmonic minor",flags:[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0]},{name:"strange",realName:"whole tone",flags:[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1]},{name:"expert",realName:"chromatic",flags:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]}]),e.keys=r([{name:"C",isWhiteKey:!0,basePitch:12},{name:"C♯",isWhiteKey:!1,basePitch:13},{name:"D",isWhiteKey:!0,basePitch:14},{name:"D♯",isWhiteKey:!1,basePitch:15},{name:"E",isWhiteKey:!0,basePitch:16},{name:"F",isWhiteKey:!0,basePitch:17},{name:"F♯",isWhiteKey:!1,basePitch:18},{name:"G",isWhiteKey:!0,basePitch:19},{name:"G♯",isWhiteKey:!1,basePitch:20},{name:"A",isWhiteKey:!0,basePitch:21},{name:"A♯",isWhiteKey:!1,basePitch:22},{name:"B",isWhiteKey:!0,basePitch:23}]),e.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],e.tempoMin=30,e.tempoMax=300,e.reverbRange=4,e.beatsPerBarMin=3,e.beatsPerBarMax=16,e.barCountMin=1,e.barCountMax=128,e.instrumentsPerChannelMin=1,e.instrumentsPerChannelMax=10,e.partsPerBeat=24,e.ticksPerPart=2,e.rhythms=r([{name:"÷3 (triplets)",stepsPerBeat:3,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1]],roundUpThresholds:[5,12,18]},{name:"÷4 (standard)",stepsPerBeat:4,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1]],roundUpThresholds:[3,9,17,21]},{name:"÷6",stepsPerBeat:6,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null},{name:"÷8",stepsPerBeat:8,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null},{name:"freehand",stepsPerBeat:24,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null}]),e.instrumentTypeNames=["chip","FM","noise","spectrum","drumset","harmonics","PWM"],e.instrumentTypeHasSpecialInterval=[!0,!0,!1,!1,!1,!0,!1],e.chipWaves=r([{name:"rounded",volume:.94,samples:i([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])},{name:"triangle",volume:1,samples:i([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15])},{name:"square",volume:.5,samples:i([1,-1])},{name:"1/4 pulse",volume:.5,samples:i([1,-1,-1,-1])},{name:"1/8 pulse",volume:.5,samples:i([1,-1,-1,-1,-1,-1,-1,-1])},{name:"sawtooth",volume:.65,samples:i([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31])},{name:"double saw",volume:.5,samples:i([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2])},{name:"double pulse",volume:.4,samples:i([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1])},{name:"spiky",volume:.4,samples:i([1,-1,1,-1,1,0])}]),e.chipNoises=r([{name:"retro",volume:.25,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"white",volume:1,basePitch:69,pitchFilterMult:8,isSoft:!0,samples:null},{name:"clang",volume:.4,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"buzz",volume:.3,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"hollow",volume:1.5,basePitch:96,pitchFilterMult:1,isSoft:!0,samples:null}]),e.filterCutoffMaxHz=8e3,e.filterCutoffMinHz=1,e.filterMax=.95,e.filterMaxResonance=.95,e.filterCutoffRange=11,e.filterResonanceRange=8,e.transitions=r([{name:"seamless",isSeamless:!0,attackSeconds:0,releases:!1,releaseTicks:1,slides:!1,slideTicks:3},{name:"hard",isSeamless:!1,attackSeconds:0,releases:!1,releaseTicks:3,slides:!1,slideTicks:3},{name:"soft",isSeamless:!1,attackSeconds:.025,releases:!1,releaseTicks:3,slides:!1,slideTicks:3},{name:"slide",isSeamless:!0,attackSeconds:.025,releases:!1,releaseTicks:3,slides:!0,slideTicks:3},{name:"cross fade",isSeamless:!1,attackSeconds:.04,releases:!0,releaseTicks:6,slides:!1,slideTicks:3},{name:"hard fade",isSeamless:!1,attackSeconds:0,releases:!0,releaseTicks:48,slides:!1,slideTicks:3},{name:"medium fade",isSeamless:!1,attackSeconds:.0125,releases:!0,releaseTicks:72,slides:!1,slideTicks:3},{name:"soft fade",isSeamless:!1,attackSeconds:.06,releases:!0,releaseTicks:96,slides:!1,slideTicks:6}]),e.vibratos=r([{name:"none",amplitude:0,periodsSeconds:[.14],delayParts:0},{name:"light",amplitude:.15,periodsSeconds:[.14],delayParts:0},{name:"delayed",amplitude:.3,periodsSeconds:[.14],delayParts:18},{name:"heavy",amplitude:.45,periodsSeconds:[.14],delayParts:0},{name:"shaky",amplitude:.1,periodsSeconds:[.11,.17798,.33],delayParts:0}]),e.intervals=r([{name:"union",spread:0,offset:0,volume:.7,sign:1},{name:"shimmer",spread:.018,offset:0,volume:.8,sign:1},{name:"hum",spread:.045,offset:0,volume:1,sign:1},{name:"honky tonk",spread:.09,offset:0,volume:1,sign:1},{name:"dissonant",spread:.25,offset:0,volume:.9,sign:1},{name:"fifth",spread:3.5,offset:3.5,volume:.9,sign:1},{name:"octave",spread:6,offset:6,volume:.8,sign:1},{name:"bowed",spread:.02,offset:0,volume:1,sign:-1},{name:"piano",spread:.01,offset:0,volume:1,sign:.7}]),e.effectsNames=["none","reverb","chorus","chorus & reverb"],e.volumeRange=8,e.volumeLogScale=-.5,e.panCenter=4,e.panMax=2*e.panCenter,e.chords=r([{name:"harmony",harmonizes:!0,customInterval:!1,arpeggiates:!1,isCustomInterval:!1,strumParts:0},{name:"strum",harmonizes:!0,customInterval:!1,arpeggiates:!1,isCustomInterval:!1,strumParts:1},{name:"arpeggio",harmonizes:!1,customInterval:!1,arpeggiates:!0,isCustomInterval:!1,strumParts:0},{name:"custom interval",harmonizes:!0,customInterval:!0,arpeggiates:!0,isCustomInterval:!0,strumParts:0}]),e.maxChordSize=4,e.operatorCount=4,e.algorithms=r([{name:"1←(2 3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3,4],[],[],[]]},{name:"1←(2 3←4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[],[4],[]]},{name:"1←2←(3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3,4],[],[]]},{name:"1←(2 3)←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[4],[4],[]]},{name:"1←2←3←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3],[4],[]]},{name:"1←3 2←4",carrierCount:2,associatedCarrier:[1,2,1,2],modulatedBy:[[3],[4],[],[]]},{name:"1 2←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3,4],[],[]]},{name:"1 2←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3],[4],[]]},{name:"(1 2)←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3],[3],[4],[]]},{name:"(1 2)←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3,4],[3,4],[],[]]},{name:"1 2 3←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[],[],[4],[]]},{name:"(1 2 3)←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[4],[4],[4],[]]},{name:"1 2 3 4",carrierCount:4,associatedCarrier:[1,2,3,4],modulatedBy:[[],[],[],[]]}]),e.operatorCarrierInterval=[0,.04,-.073,.091],e.operatorAmplitudeMax=15,e.operatorFrequencies=r([{name:"1×",mult:1,hzOffset:0,amplitudeSign:1},{name:"~1×",mult:1,hzOffset:1.5,amplitudeSign:-1},{name:"2×",mult:2,hzOffset:0,amplitudeSign:1},{name:"~2×",mult:2,hzOffset:-1.3,amplitudeSign:-1},{name:"3×",mult:3,hzOffset:0,amplitudeSign:1},{name:"4×",mult:4,hzOffset:0,amplitudeSign:1},{name:"5×",mult:5,hzOffset:0,amplitudeSign:1},{name:"6×",mult:6,hzOffset:0,amplitudeSign:1},{name:"7×",mult:7,hzOffset:0,amplitudeSign:1},{name:"8×",mult:8,hzOffset:0,amplitudeSign:1},{name:"9×",mult:9,hzOffset:0,amplitudeSign:1},{name:"11×",mult:11,hzOffset:0,amplitudeSign:1},{name:"13×",mult:13,hzOffset:0,amplitudeSign:1},{name:"16×",mult:16,hzOffset:0,amplitudeSign:1},{name:"20×",mult:20,hzOffset:0,amplitudeSign:1}]),e.envelopes=r([{name:"custom",type:0,speed:0},{name:"steady",type:1,speed:0},{name:"punch",type:2,speed:0},{name:"flare 1",type:3,speed:32},{name:"flare 2",type:3,speed:8},{name:"flare 3",type:3,speed:2},{name:"twang 1",type:4,speed:32},{name:"twang 2",type:4,speed:8},{name:"twang 3",type:4,speed:2},{name:"swell 1",type:5,speed:32},{name:"swell 2",type:5,speed:8},{name:"swell 3",type:5,speed:2},{name:"tremolo1",type:6,speed:4},{name:"tremolo2",type:6,speed:2},{name:"tremolo3",type:6,speed:1},{name:"tremolo4",type:7,speed:4},{name:"tremolo5",type:7,speed:2},{name:"tremolo6",type:7,speed:1},{name:"decay 1",type:8,speed:10},{name:"decay 2",type:8,speed:7},{name:"decay 3",type:8,speed:4}]),e.feedbacks=r([{name:"1⟲",indices:[[1],[],[],[]]},{name:"2⟲",indices:[[],[2],[],[]]},{name:"3⟲",indices:[[],[],[3],[]]},{name:"4⟲",indices:[[],[],[],[4]]},{name:"1⟲ 2⟲",indices:[[1],[2],[],[]]},{name:"3⟲ 4⟲",indices:[[],[],[3],[4]]},{name:"1⟲ 2⟲ 3⟲",indices:[[1],[2],[3],[]]},{name:"2⟲ 3⟲ 4⟲",indices:[[],[2],[3],[4]]},{name:"1⟲ 2⟲ 3⟲ 4⟲",indices:[[1],[2],[3],[4]]},{name:"1→2",indices:[[],[1],[],[]]},{name:"1→3",indices:[[],[],[1],[]]},{name:"1→4",indices:[[],[],[],[1]]},{name:"2→3",indices:[[],[],[2],[]]},{name:"2→4",indices:[[],[],[],[2]]},{name:"3→4",indices:[[],[],[],[3]]},{name:"1→3 2→4",indices:[[],[],[1],[2]]},{name:"1→4 2→3",indices:[[],[],[2],[1]]},{name:"1→2→3→4",indices:[[],[1],[2],[3]]}]),e.chipNoiseLength=32768,e.spectrumBasePitch=24,e.spectrumControlPoints=30,e.spectrumControlPointsPerOctave=7,e.spectrumControlPointBits=3,e.spectrumMax=(1<<e.spectrumControlPointBits)-1,e.harmonicsControlPoints=28,e.harmonicsRendered=64,e.harmonicsControlPointBits=3,e.harmonicsMax=(1<<e.harmonicsControlPointBits)-1,e.harmonicsWavelength=2048,e.pulseWidthRange=8,e.pitchChannelCountMin=1,e.pitchChannelCountMax=6,e.noiseChannelCountMin=0,e.noiseChannelCountMax=3,e.noiseInterval=6,e.pitchesPerOctave=12,e.drumCount=12,e.pitchOctaves=7,e.windowOctaves=3,e.scrollableOctaves=e.pitchOctaves-e.windowOctaves,e.windowPitchCount=e.windowOctaves*e.pitchesPerOctave+1,e.maxPitch=e.pitchOctaves*e.pitchesPerOctave,e.maximumTonesPerChannel=2*e.maxChordSize,e.sineWaveLength=256,e.sineWaveMask=e.sineWaveLength-1,e.sineWave=function(){const t=new Float64Array(e.sineWaveLength+1);for(let i=0;i<e.sineWaveLength+1;i++)t[i]=Math.sin(i*Math.PI*2/e.sineWaveLength);return t}();const h=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent);function a(t){return t.toFixed(2).replace(/\.?0*$/,"")}class l{static valueToPreset(t){const e=t>>6,i=63&t;return l.presetCategories[e].presets[i]}static midiProgramToPresetValue(t){for(let e=0;e<l.presetCategories.length;e++){const i=l.presetCategories[e];for(let s=0;s<i.presets.length;s++){const n=i.presets[s];if(n.generalMidi&&n.midiProgram==t)return(e<<6)+s}}return null}static nameToPresetValue(t){for(let e=0;e<l.presetCategories.length;e++){const i=l.presetCategories[e];for(let s=0;s<i.presets.length;s++){if(i.presets[s].name==t)return(e<<6)+s}}return null}}l.version="3.0.13",l.versionDisplayName="BeepBox "+l.version,l.presetCategories=r([{name:"Custom Instruments",presets:r([{name:"chip wave",customType:0},{name:"FM (expert)",customType:1},{name:"basic noise",customType:2},{name:"spectrum",customType:3},{name:"drumset",customType:4},{name:"harmonics",customType:5},{name:"pulse width",customType:6}])},{name:"Retro Presets",presets:r([{name:"square wave",midiProgram:80,settings:{type:"chip",transition:"seamless",effects:"none",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"steady",wave:"square",interval:"union",vibrato:"none"}},{name:"triangle wave",midiProgram:71,settings:{type:"chip",transition:"seamless",effects:"none",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"steady",wave:"triangle",interval:"union",vibrato:"none"}},{name:"square lead",midiProgram:80,generalMidi:!0,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",wave:"square",interval:"hum",vibrato:"none"}},{name:"sawtooth lead 1",midiProgram:81,generalMidi:!0,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",wave:"sawtooth",interval:"shimmer",vibrato:"none"}},{name:"sawtooth lead 2",midiProgram:81,settings:{type:"chip",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:5657,filterResonance:29,filterEnvelope:"steady",wave:"sawtooth",interval:"hum",vibrato:"light"}},{name:"chip noise",midiProgram:116,isNoise:!0,settings:{type:"noise",transition:"hard",effects:"none",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"steady",wave:"retro"}},{name:"FM twang",midiProgram:32,settings:{type:"FM",transition:"hard",effects:"none",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"twang 2"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"FM bass",midiProgram:36,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"custom interval",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"twang 2"},{frequency:"1×",amplitude:9,envelope:"twang 3"},{frequency:"20×",amplitude:3,envelope:"twang 2"}]}},{name:"FM flute",midiProgram:73,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"twang 2"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"FM organ",midiProgram:16,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"custom interval",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:11,envelope:"steady"},{frequency:"2×",amplitude:11,envelope:"steady"}]}}])},{name:"Keyboard Presets",presets:r([{name:"grand piano",midiProgram:0,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"twang 3",interval:"piano",vibrato:"none",harmonics:[100,100,86,86,86,71,71,71,0,86,71,71,71,57,57,71,57,14,57,57,57,57,57,57,57,57,29,57]}},{name:"bright piano",midiProgram:1,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 3",interval:"piano",vibrato:"none",harmonics:[100,100,86,86,71,71,0,71,86,86,71,71,71,14,57,57,57,57,57,57,29,57,57,57,57,57,57,57]}},{name:"electric grand",midiProgram:2,generalMidi:!0,settings:{type:"chip",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 3",wave:"1/8 pulse",interval:"shimmer",vibrato:"none"}},{name:"honky-tonk piano",midiProgram:3,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:5657,filterResonance:29,filterEnvelope:"twang 2",interval:"honky tonk",vibrato:"none",harmonics:[100,100,86,71,86,71,43,71,43,43,57,57,57,29,57,43,43,43,43,43,29,43,43,43,29,29,29,29]}},{name:"electric piano 1",midiProgram:4,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[86,100,100,71,71,57,57,43,43,43,29,29,29,14,14,14,0,0,0,0,0,57,0,0,0,0,0,0]}},{name:"electric piano 2",midiProgram:5,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"steady"},{frequency:"16×",amplitude:6,envelope:"twang 3"}]}},{name:"harpsichord",midiProgram:6,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"4⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"steady"},{frequency:"3×",amplitude:6,envelope:"steady"},{frequency:"5×",amplitude:7,envelope:"steady"}]}},{name:"clavinet",midiProgram:7,generalMidi:!0,settings:{type:"FM",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 2",operators:[{frequency:"3×",amplitude:15,envelope:"custom"},{frequency:"~1×",amplitude:6,envelope:"steady"},{frequency:"8×",amplitude:4,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"dulcimer",midiProgram:15,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",interval:"piano",vibrato:"none",harmonics:[100,100,100,86,100,86,57,100,100,86,100,86,100,86,100,71,57,71,71,100,86,71,86,86,100,86,86,86]}}])},{name:"Idiophone Presets",presets:r([{name:"celesta",midiProgram:8,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:11,envelope:"custom"},{frequency:"8×",amplitude:6,envelope:"custom"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"3×",amplitude:1,envelope:"twang 2"}]}},{name:"glockenspiel",midiProgram:9,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:2,feedbackEnvelope:"decay 1",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"5×",amplitude:11,envelope:"custom"},{frequency:"8×",amplitude:7,envelope:"custom"},{frequency:"20×",amplitude:2,envelope:"twang 1"}]}},{name:"music box 1",midiProgram:10,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[100,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,86,0,0,0,0,0,0,71,0]}},{name:"music box 2",midiProgram:10,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,57,57,0,0,0,0,0,0,57,0,0,0,14,14,14,14,14,14,43,14,14,14,14,14,14,14,14]}},{name:"vibraphone",midiProgram:11,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:3,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"~1×",amplitude:9,envelope:"custom"},{frequency:"9×",amplitude:3,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"}]}},{name:"marimba",midiProgram:12,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"4×",amplitude:6,envelope:"custom"},{frequency:"13×",amplitude:6,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"kalimba",midiProgram:108,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:11,envelope:"custom"},{frequency:"5×",amplitude:3,envelope:"twang 2"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"xylophone",midiProgram:13,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"11×",amplitude:9,envelope:"custom"},{frequency:"20×",amplitude:6,envelope:"twang 1"}]}},{name:"tubular bell",midiProgram:14,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 3",interval:"hum",vibrato:"none",harmonics:[43,71,0,100,0,100,0,86,0,0,86,0,14,71,14,14,57,14,14,43,14,14,43,14,14,43,14,14]}},{name:"bell synth",midiProgram:14,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~2×",amplitude:10,envelope:"custom"},{frequency:"7×",amplitude:6,envelope:"twang 3"},{frequency:"20×",amplitude:1,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"rain drop",midiProgram:96,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"6×",amplitude:4,envelope:"custom"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"1×",amplitude:6,envelope:"tremolo1"}]}},{name:"crystal",midiProgram:98,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"delayed",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:4,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"custom"},{frequency:"6×",amplitude:4,envelope:"custom"},{frequency:"13×",amplitude:4,envelope:"custom"}]}},{name:"tinkle bell",midiProgram:112,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:5,feedbackEnvelope:"twang 3",operators:[{frequency:"~2×",amplitude:7,envelope:"custom"},{frequency:"5×",amplitude:7,envelope:"custom"},{frequency:"7×",amplitude:7,envelope:"custom"},{frequency:"16×",amplitude:7,envelope:"custom"}]}},{name:"agogo",midiProgram:113,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→4",feedbackAmplitude:15,feedbackEnvelope:"decay 1",operators:[{frequency:"2×",amplitude:9,envelope:"custom"},{frequency:"5×",amplitude:6,envelope:"custom"},{frequency:"8×",amplitude:9,envelope:"custom"},{frequency:"13×",amplitude:11,envelope:"custom"}]}}])},{name:"Guitar Presets",presets:r([{name:"nylon guitar",midiProgram:24,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"5×",amplitude:2,envelope:"steady"},{frequency:"7×",amplitude:4,envelope:"steady"}]}},{name:"steel guitar",midiProgram:25,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,71,71,86,86,71,57,43,43,43,57,57,57,57,57,43,43,43,43,43,43,43,43,43,43]}},{name:"jazz guitar",midiProgram:26,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,57,71,71,43,57,71,57,43,29,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},{name:"clean guitar",midiProgram:27,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[86,100,100,100,86,57,86,100,100,100,71,57,43,71,86,71,57,57,71,71,71,71,57,57,57,57,57,43]}},{name:"muted guitar",midiProgram:28,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:4,envelope:"twang 3"},{frequency:"4×",amplitude:4,envelope:"twang 2"},{frequency:"16×",amplitude:4,envelope:"twang 1"}]}}])},{name:"Picked Bass Presets",presets:r([{name:"acoustic bass",midiProgram:32,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,86,71,71,71,71,57,57,57,57,43,43,43,43,43,29,29,29,29,29,29,14,14,14,14,14,14,14]}},{name:"fingered bass",midiProgram:33,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,86,71,57,71,43,57,29,29,29,29,29,29,14,14,14,14,14,14,14,14,14,14,14,14,14,14,0]}},{name:"picked bass",midiProgram:34,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:4,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"11×",amplitude:1,envelope:"twang 3"},{frequency:"1×",amplitude:9,envelope:"steady"}]}},{name:"fretless bass",midiProgram:35,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:1e3,filterResonance:14,filterEnvelope:"flare 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,71,57,57,71,71,71,57,57,57,57,57,57,57,43,43,43,43,43,43,43,43,29,29,14]}},{name:"slap bass 1",midiProgram:36,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,100,100,100,86,71,57,29,29,43,43,57,71,57,29,29,43,57,57,57,43,43,43,57,71,71,71,71]}},{name:"slap bass 2",midiProgram:37,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"3⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"3×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"steady"},{frequency:"13×",amplitude:3,envelope:"steady"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"bass synth 1",midiProgram:38,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"3⟲ 4⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"twang 1"},{frequency:"~1×",amplitude:13,envelope:"twang 2"}]}},{name:"bass synth 2",midiProgram:39,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:1e3,filterResonance:57,filterEnvelope:"punch",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1→2",feedbackAmplitude:4,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"steady"},{frequency:"3×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"bass & lead",midiProgram:87,generalMidi:!0,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:86,filterEnvelope:"twang 2",wave:"sawtooth",interval:"shimmer",vibrato:"none"}}])},{name:"Picked String Presets",presets:r([{name:"pizzicato strings",midiProgram:45,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:1e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"3×",amplitude:11,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"~1×",amplitude:10,envelope:"steady"}]}},{name:"harp",midiProgram:46,generalMidi:!0,settings:{type:"FM",transition:"hard fade",effects:"reverb",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:6,envelope:"custom"},{frequency:"~2×",amplitude:3,envelope:"steady"},{frequency:"1×",amplitude:6,envelope:"steady"}]}},{name:"sitar",midiProgram:104,generalMidi:!0,settings:{type:"FM",transition:"hard fade",effects:"reverb",chord:"strum",filterCutoffHz:8e3,filterResonance:57,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"twang 3"},{frequency:"9×",amplitude:3,envelope:"twang 3"},{frequency:"16×",amplitude:9,envelope:"swell 3"}]}},{name:"banjo",midiProgram:105,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"2⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"11×",amplitude:3,envelope:"twang 3"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"ukulele",midiProgram:105,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 1",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"9×",amplitude:4,envelope:"twang 2"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"shamisen",midiProgram:106,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"steady"},{frequency:"16×",amplitude:4,envelope:"twang 3"},{frequency:"1×",amplitude:7,envelope:"steady"}]}},{name:"koto",midiProgram:107,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 2",operators:[{frequency:"~1×",amplitude:12,envelope:"custom"},{frequency:"6×",amplitude:10,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"twang 3"},{frequency:"~2×",amplitude:8,envelope:"twang 3"}]}}])},{name:"Distortion Presets",presets:r([{name:"overdrive guitar",midiProgram:29,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1→2",feedbackAmplitude:2,feedbackEnvelope:"punch",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"steady"},{frequency:"~2×",amplitude:6,envelope:"twang 1"},{frequency:"1×",amplitude:12,envelope:"swell 3"}]}},{name:"distortion guitar",midiProgram:30,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1→2",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:11,envelope:"steady"},{frequency:"1×",amplitude:9,envelope:"swell 1"},{frequency:"~2×",amplitude:4,envelope:"swell 3"}]}},{name:"charango synth",midiProgram:84,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1→2→3→4",feedbackAmplitude:8,feedbackEnvelope:"twang 3",operators:[{frequency:"3×",amplitude:13,envelope:"custom"},{frequency:"~1×",amplitude:5,envelope:"steady"},{frequency:"4×",amplitude:6,envelope:"steady"},{frequency:"3×",amplitude:7,envelope:"steady"}]}},{name:"guitar harmonics",midiProgram:31,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3)←4",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"16×",amplitude:5,envelope:"swell 1"},{frequency:"1×",amplitude:2,envelope:"punch"},{frequency:"~1×",amplitude:12,envelope:"twang 1"}]}},{name:"distorted synth 1",midiProgram:30,settings:{type:"PWM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",pulseWidth:17.6875,pulseEnvelope:"punch",vibrato:"none"}},{name:"distorted synth 2",midiProgram:30,settings:{type:"FM",effects:"reverb",transition:"seamless",chord:"strum",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:7,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:13,envelope:"steady"},{frequency:"1×",amplitude:11,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"flare 1"}]}},{name:"distorted synth 3",midiProgram:30,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←(2 3 4)",feedbackType:"1→2",feedbackAmplitude:3,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:11,envelope:"steady"},{frequency:"1×",amplitude:12,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"distorted synth 4",midiProgram:30,settings:{type:"PWM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"steady",pulseWidth:50,pulseEnvelope:"swell 1",vibrato:"delayed"}}])},{name:"Bellows Presets",presets:r([{name:"drawbar organ 1",midiProgram:16,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[86,86,0,86,0,0,0,86,0,0,0,0,0,0,0,86,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"drawbar organ 2",midiProgram:16,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[86,29,71,86,71,14,0,100,0,0,0,86,0,0,0,71,0,0,0,57,0,0,0,29,0,0,0,0]}},{name:"percussive organ",midiProgram:17,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"punch",vibrato:"light",algorithm:"1 2 3 4",feedbackType:"1→3 2→4",feedbackAmplitude:7,feedbackEnvelope:"decay 1",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"custom"},{frequency:"3×",amplitude:8,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"custom"}]}},{name:"rock organ",midiProgram:18,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"hard",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"punch",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:2,feedbackEnvelope:"flare 1",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"2×",amplitude:5,envelope:"steady"}]}},{name:"pipe organ",midiProgram:19,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",transition:"cross fade",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"2×",amplitude:9,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"8×",amplitude:8,envelope:"custom"}]}},{name:"reed organ",midiProgram:20,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[71,86,100,86,71,100,57,71,71,71,43,43,43,71,43,71,57,57,57,57,57,57,57,29,43,29,29,14]}},{name:"accordion",midiProgram:21,generalMidi:!0,settings:{type:"chip",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"swell 1",wave:"double saw",interval:"honky tonk",vibrato:"none"}},{name:"bandoneon",midiProgram:23,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",interval:"hum",vibrato:"none",harmonics:[86,86,86,57,71,86,57,71,71,71,57,43,57,43,71,43,71,57,57,43,43,43,57,43,43,29,29,29]}},{name:"bagpipe",midiProgram:109,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"punch",interval:"hum",vibrato:"none",harmonics:[71,86,86,100,100,86,57,100,86,71,71,71,57,57,57,71,57,71,57,71,43,57,57,43,43,43,43,43]}}])},{name:"String Presets",presets:r([{name:"violin",midiProgram:40,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2)←(3 4)",feedbackType:"4⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 3",operators:[{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"3×",amplitude:9,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"steady"},{frequency:"7×",amplitude:5,envelope:"swell 1"}]}},{name:"viola",midiProgram:41,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:8,feedbackEnvelope:"swell 1",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"7×",amplitude:7,envelope:"custom"},{frequency:"13×",amplitude:4,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"}]}},{name:"cello",midiProgram:42,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:11,envelope:"custom"},{frequency:"3×",amplitude:9,envelope:"custom"},{frequency:"8×",amplitude:7,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"}]}},{name:"contrabass",midiProgram:43,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2)←3←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"16×",amplitude:5,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"6×",amplitude:3,envelope:"swell 1"}]}},{name:"fiddle",midiProgram:110,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2)←(3 4)",feedbackType:"3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 1",operators:[{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"8×",amplitude:8,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"16×",amplitude:3,envelope:"steady"}]}},{name:"tremolo strings",midiProgram:44,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"tremolo4",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:12,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"~2×",amplitude:8,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"custom"},{frequency:"7×",amplitude:8,envelope:"custom"}]}},{name:"strings",midiProgram:48,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"4⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 3",operators:[{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"3×",amplitude:9,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"steady"},{frequency:"7×",amplitude:3,envelope:"swell 1"}]}},{name:"slow strings",midiProgram:49,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:1414,filterResonance:0,filterEnvelope:"swell 2",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"4⟲",feedbackAmplitude:6,feedbackEnvelope:"flare 3",operators:[{frequency:"4×",amplitude:10,envelope:"custom"},{frequency:"3×",amplitude:10,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"steady"},{frequency:"7×",amplitude:4,envelope:"swell 1"}]}},{name:"strings synth 1",midiProgram:50,generalMidi:!0,settings:{type:"chip",volume:60,transition:"soft fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:1414,filterResonance:43,filterEnvelope:"steady",wave:"sawtooth",interval:"hum",vibrato:"delayed"}},{name:"strings synth 2",midiProgram:51,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:12,feedbackEnvelope:"swell 1",operators:[{frequency:"3×",amplitude:6,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"custom"}]}},{name:"orchestra hit 1",midiProgram:55,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"custom",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:14,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:15,envelope:"twang 3"},{frequency:"2×",amplitude:15,envelope:"flare 3"},{frequency:"4×",amplitude:15,envelope:"flare 2"},{frequency:"8×",amplitude:15,envelope:"flare 1"}]}},{name:"orchestra hit 2",midiProgram:55,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"decay 1",vibrato:"delayed",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:14,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"3×",amplitude:12,envelope:"custom"},{frequency:"4×",amplitude:14,envelope:"custom"}]}}])},{name:"Vocal Presets",presets:r([{name:"choir soprano",midiProgram:94,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,86,43,14,14,57,71,57,14,14,14,14,14,43,57,43,14,14,14,14,14,14,14,0,0,0,0]}},{name:"choir tenor",midiProgram:52,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,100,86,71,57,29,14,14,14,29,43,43,43,29,14,14,14,0,0,0,0,0,0,0,0,0,0]}},{name:"choir bass",midiProgram:52,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[71,86,86,100,86,100,57,43,14,14,14,14,29,29,43,43,43,43,43,29,29,29,29,14,14,14,0,0]}},{name:"solo soprano",midiProgram:85,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:71,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,86,43,14,14,57,71,57,14,14,14,14,14,43,57,43,14,14,14,14,14,14,14,0,0,0,0]}},{name:"solo tenor",midiProgram:85,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,100,86,71,57,29,14,14,14,29,43,43,43,29,14,14,14,0,0,0,0,0,0,0,0,0,0]}},{name:"solo bass",midiProgram:85,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[71,86,86,100,86,100,57,43,14,14,14,14,29,29,43,43,43,43,43,29,29,29,29,14,14,14,0,0]}},{name:"voice ooh",midiProgram:53,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:1414,filterResonance:57,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[100,57,43,43,14,14,0,0,0,14,29,29,14,0,14,29,29,14,0,0,0,0,0,0,0,0,0,0]}},{name:"voice synth",midiProgram:54,generalMidi:!0,settings:{type:"chip",transition:"medium fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:57,filterEnvelope:"steady",wave:"rounded",interval:"union",vibrato:"light"}},{name:"vox synth lead",midiProgram:85,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",vibrato:"light",algorithm:"(1 2 3)←4",feedbackType:"1→2→3→4",feedbackAmplitude:2,feedbackEnvelope:"punch",operators:[{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"9×",amplitude:5,envelope:"custom"},{frequency:"20×",amplitude:1,envelope:"custom"},{frequency:"~1×",amplitude:4,envelope:"steady"}]}},{name:"tiny robot",midiProgram:85,settings:{type:"FM",transition:"slide",effects:"reverb",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"twang 3",operators:[{frequency:"2×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"punch"},{frequency:"~1×",amplitude:7,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"yowie",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:86,filterEnvelope:"tremolo5",vibrato:"none",algorithm:"1←2←(3 4)",feedbackType:"1⟲",feedbackAmplitude:12,feedbackEnvelope:"tremolo3",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"16×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"mouse",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"slide",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:5,feedbackEnvelope:"flare 2",operators:[{frequency:"2×",amplitude:13,envelope:"custom"},{frequency:"5×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"gumdrop",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:15,envelope:"punch"},{frequency:"4×",amplitude:15,envelope:"punch"},{frequency:"7×",amplitude:15,envelope:"punch"},{frequency:"1×",amplitude:10,envelope:"twang 1"}]}},{name:"echo drop",midiProgram:102,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"punch",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"~2×",amplitude:11,envelope:"custom"},{frequency:"~1×",amplitude:5,envelope:"steady"},{frequency:"11×",amplitude:2,envelope:"steady"},{frequency:"16×",amplitude:5,envelope:"swell 3"}]}},{name:"dark choir",midiProgram:85,settings:{type:"spectrum",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",spectrum:[43,14,14,14,14,14,14,100,14,14,14,57,14,14,100,14,43,14,43,14,14,43,14,29,14,29,14,14,29,0]}}])},{name:"Brass Presets",presets:r([{name:"trumpet",midiProgram:56,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:9,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:5,envelope:"flare 2"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"trombone",midiProgram:57,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"2⟲",feedbackAmplitude:7,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"tuba",midiProgram:58,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"2⟲",feedbackAmplitude:8,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"muted trumpet",midiProgram:59,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:5,feedbackEnvelope:"flare 2",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"9×",amplitude:5,envelope:"steady"},{frequency:"13×",amplitude:9,envelope:"swell 1"}]}},{name:"french horn",midiProgram:60,generalMidi:!0,settings:{type:"FM",transition:"soft",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:3,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"swell 1"},{frequency:"~1×",amplitude:8,envelope:"flare 2"}]}},{name:"brass section",midiProgram:61,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"punch",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"swell 1"},{frequency:"~1×",amplitude:10,envelope:"swell 1"}]}},{name:"brass synth 1",midiProgram:62,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:11,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"flare 1"},{frequency:"~1×",amplitude:8,envelope:"flare 2"}]}},{name:"brass synth 2",midiProgram:63,generalMidi:!0,settings:{type:"FM",transition:"soft",effects:"reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:9,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"flare 1"},{frequency:"~1×",amplitude:7,envelope:"flare 1"}]}},{name:"pulse brass",midiProgram:62,settings:{type:"PWM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",pulseWidth:50,pulseEnvelope:"flare 3",vibrato:"none"}}])},{name:"Reed Presets",presets:r([{name:"soprano sax",midiProgram:64,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"4⟲",feedbackAmplitude:5,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"4×",amplitude:4,envelope:"swell 1"},{frequency:"1×",amplitude:7,envelope:"steady"},{frequency:"5×",amplitude:4,envelope:"punch"}]}},{name:"alto sax",midiProgram:65,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:4,feedbackEnvelope:"punch",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"4×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:12,envelope:"steady"}]}},{name:"tenor sax",midiProgram:66,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"steady"},{frequency:"1×",amplitude:3,envelope:"steady"},{frequency:"8×",amplitude:3,envelope:"steady"}]}},{name:"baritone sax",midiProgram:67,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"swell 2",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"8×",amplitude:4,envelope:"steady"},{frequency:"4×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:4,envelope:"punch"}]}},{name:"sax synth",midiProgram:64,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1←(2 3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"shehnai",midiProgram:111,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:3,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"oboe",midiProgram:68,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"2⟲",feedbackAmplitude:2,feedbackEnvelope:"tremolo5",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"6×",amplitude:2,envelope:"steady"}]}},{name:"english horn",midiProgram:69,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"2⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"punch"},{frequency:"8×",amplitude:4,envelope:"steady"}]}},{name:"bassoon",midiProgram:70,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:707,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"6×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"clarinet",midiProgram:71,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[100,43,86,57,86,71,86,71,71,71,71,71,71,43,71,71,57,57,57,57,57,57,43,43,43,29,14,0]}},{name:"harmonica",midiProgram:22,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:29,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:9,feedbackEnvelope:"tremolo5",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"steady"},{frequency:"~2×",amplitude:2,envelope:"twang 3"},{frequency:"1×",amplitude:0,envelope:"steady"}]}}])},{name:"Flute Presets",presets:r([{name:"flute",midiProgram:73,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"4⟲",feedbackAmplitude:7,feedbackEnvelope:"decay 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"2×",amplitude:4,envelope:"steady"},{frequency:"1×",amplitude:3,envelope:"steady"},{frequency:"~1×",amplitude:1,envelope:"punch"}]}},{name:"recorder",midiProgram:74,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 2",interval:"union",vibrato:"none",harmonics:[100,43,57,43,57,43,43,43,43,43,43,43,43,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},{name:"whistle",midiProgram:78,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",interval:"union",vibrato:"delayed",harmonics:[100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"ocarina",midiProgram:79,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[100,14,57,14,29,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"piccolo",midiProgram:72,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"4⟲",feedbackAmplitude:15,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"~2×",amplitude:3,envelope:"punch"},{frequency:"~1×",amplitude:5,envelope:"punch"}]}},{name:"shakuhachi",midiProgram:77,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←(2 3←4)",feedbackType:"3→4",feedbackAmplitude:15,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"2×",amplitude:3,envelope:"punch"},{frequency:"~1×",amplitude:4,envelope:"twang 1"},{frequency:"20×",amplitude:15,envelope:"steady"}]}},{name:"pan flute",midiProgram:75,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:43,filterEnvelope:"steady",spectrum:[100,0,0,0,0,0,0,14,0,0,0,71,0,0,14,0,57,0,29,14,29,14,14,29,14,29,14,14,29,14]}},{name:"blown bottle",midiProgram:76,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"3×",amplitude:4,envelope:"custom"},{frequency:"6×",amplitude:2,envelope:"custom"},{frequency:"11×",amplitude:2,envelope:"custom"}]}},{name:"calliope",midiProgram:82,generalMidi:!0,settings:{type:"spectrum",transition:"cross fade",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"steady",spectrum:[100,0,0,0,0,0,0,86,0,0,0,71,0,0,57,0,43,0,29,14,14,29,14,14,14,14,14,14,14,14]}},{name:"chiffer",midiProgram:83,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"punch",spectrum:[86,0,0,0,0,0,0,71,0,0,0,71,0,0,57,0,57,0,43,14,14,43,14,29,14,29,29,29,29,14]}},{name:"breath noise",midiProgram:121,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"cross fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 1",spectrum:[71,0,0,0,0,0,0,29,0,0,0,71,0,0,29,0,100,29,14,29,100,29,100,14,14,71,0,29,0,0]}}])},{name:"Pad Presets",presets:r([{name:"new age pad",midiProgram:88,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:43,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:3,feedbackEnvelope:"swell 3",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"~1×",amplitude:4,envelope:"swell 2"},{frequency:"6×",amplitude:3,envelope:"twang 3"},{frequency:"13×",amplitude:3,envelope:"steady"}]}},{name:"warm pad",midiProgram:89,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"swell 3",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:7,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"polysynth pad",midiProgram:90,generalMidi:!0,settings:{type:"chip",transition:"hard fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"twang 3",wave:"sawtooth",interval:"hum",vibrato:"delayed"}},{name:"space voice pad",midiProgram:91,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:71,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"swell 2",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"2×",amplitude:8,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"custom"},{frequency:"11×",amplitude:1,envelope:"punch"}]}},{name:"bowed glass pad",midiProgram:92,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"twang 3"},{frequency:"7×",amplitude:4,envelope:"flare 3"}]}},{name:"metallic pad",midiProgram:93,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:13,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"~1×",amplitude:9,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"swell 2"},{frequency:"11×",amplitude:7,envelope:"steady"}]}},{name:"sweep pad",midiProgram:95,generalMidi:!0,settings:{type:"chip",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:86,filterEnvelope:"flare 3",wave:"sawtooth",interval:"hum",vibrato:"none"}},{name:"atmosphere",midiProgram:99,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"3⟲ 4⟲",feedbackAmplitude:3,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"swell 3"},{frequency:"3×",amplitude:7,envelope:"twang 2"},{frequency:"1×",amplitude:7,envelope:"twang 3"}]}},{name:"brightness",midiProgram:100,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 3",interval:"octave",vibrato:"none",harmonics:[100,86,86,86,43,57,43,71,43,43,43,57,43,43,57,71,57,43,29,43,57,57,43,29,29,29,29,14]}},{name:"goblins",midiProgram:101,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"swell 2",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:10,feedbackEnvelope:"flare 3",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:5,envelope:"swell 3"},{frequency:"1×",amplitude:10,envelope:"tremolo1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"sci-fi",midiProgram:103,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 3",vibrato:"none",algorithm:"(1 2)←3←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:8,feedbackEnvelope:"twang 3",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"5×",amplitude:5,envelope:"twang 3"},{frequency:"11×",amplitude:8,envelope:"tremolo5"}]}},{name:"flutter pad",midiProgram:90,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:86,filterEnvelope:"twang 3",vibrato:"delayed",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:9,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"5×",amplitude:7,envelope:"custom"},{frequency:"7×",amplitude:5,envelope:"tremolo1"},{frequency:"~1×",amplitude:6,envelope:"punch"}]}},{name:"feedback pad",midiProgram:89,settings:{type:"FM",effects:"reverb",transition:"soft fade",chord:"custom interval",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"swell 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"~1×",amplitude:15,envelope:"custom"}]}}])},{name:"Drum Presets",presets:r([{name:"standard drumset",midiProgram:116,isNoise:!0,settings:{type:"drumset",effects:"reverb",drums:[{filterEnvelope:"twang 1",spectrum:[57,71,71,86,86,86,71,71,71,71,57,57,57,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29,29]},{filterEnvelope:"twang 1",spectrum:[0,0,0,100,71,71,57,86,57,57,57,71,43,43,57,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43]},{filterEnvelope:"twang 1",spectrum:[0,0,0,0,100,57,43,43,29,57,43,29,71,43,43,43,43,57,43,43,43,43,43,43,43,43,29,43,43,43]},{filterEnvelope:"twang 1",spectrum:[0,0,0,0,0,71,57,43,43,43,57,57,43,29,57,43,43,43,29,43,57,43,43,43,43,43,43,29,43,43]},{filterEnvelope:"decay 2",spectrum:[0,14,29,43,86,71,29,43,43,43,43,29,71,29,71,29,43,43,43,43,57,43,43,57,43,43,43,57,57,57]},{filterEnvelope:"decay 1",spectrum:[0,0,14,14,14,14,29,29,29,43,43,43,57,57,57,71,71,71,71,71,71,71,71,57,57,57,57,43,43,43]},{filterEnvelope:"twang 3",spectrum:[43,43,43,71,29,29,43,43,43,29,43,43,43,29,29,43,43,29,29,29,57,14,57,43,43,57,43,43,57,57]},{filterEnvelope:"decay 3",spectrum:[29,43,43,43,43,29,29,43,29,29,43,29,14,29,43,29,43,29,57,29,43,57,43,71,43,71,57,57,71,71]},{filterEnvelope:"twang 3",spectrum:[43,29,29,43,29,29,29,57,29,29,29,57,43,43,29,29,57,43,43,43,71,43,43,71,57,71,71,71,71,71]},{filterEnvelope:"decay 3",spectrum:[57,57,57,43,57,57,43,43,57,43,43,43,71,57,43,57,86,71,57,86,71,57,86,100,71,86,86,86,86,86]},{filterEnvelope:"flare 1",spectrum:[0,0,14,14,14,14,29,29,29,43,43,43,57,57,71,71,86,86,100,100,100,100,100,100,100,100,86,57,29,0]},{filterEnvelope:"decay 2",spectrum:[14,14,14,14,29,14,14,29,14,43,14,43,57,86,57,57,100,57,43,43,57,100,57,43,29,14,0,0,0,0]}]}},{name:"steel pan",midiProgram:114,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"decay 2",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:14,envelope:"custom"},{frequency:"7×",amplitude:3,envelope:"flare 1"},{frequency:"3×",amplitude:5,envelope:"flare 2"},{frequency:"4×",amplitude:4,envelope:"swell 2"}]}},{name:"steel pan synth",midiProgram:114,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1 2 3←4",feedbackType:"1⟲",feedbackAmplitude:5,feedbackEnvelope:"flare 1",operators:[{frequency:"~1×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:14,envelope:"flare 1"},{frequency:"~1×",amplitude:3,envelope:"flare 2"}]}},{name:"timpani",midiProgram:47,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"twang 2",spectrum:[100,0,0,0,86,0,0,71,0,14,43,14,43,43,0,29,43,29,29,29,43,29,43,29,43,43,43,43,43,43]}},{name:"dark strike",midiProgram:47,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"twang 2",spectrum:[0,0,0,0,14,14,14,29,29,43,43,86,43,43,43,29,86,29,29,29,86,29,14,14,14,14,0,0,0,0]}},{name:"woodblock",midiProgram:115,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",spectrum:[0,14,29,43,43,57,86,86,71,57,57,43,43,57,86,86,43,43,71,57,57,57,57,57,86,86,71,71,71,71]}},{name:"taiko drum",midiProgram:116,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"twang 1",spectrum:[71,100,100,43,43,71,71,43,43,43,43,43,43,57,29,57,43,57,43,43,57,43,43,43,43,43,43,43,43,43]}},{name:"melodic drum",midiProgram:117,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-1.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"twang 1",spectrum:[100,71,71,57,57,43,43,71,43,43,43,57,43,43,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29]}},{name:"drum synth",midiProgram:118,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"decay 1",spectrum:[100,86,71,57,43,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29]}},{name:"tom-tom",midiProgram:116,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",spectrum:[100,29,14,0,0,86,14,43,29,86,29,14,29,57,43,43,43,43,57,43,43,43,29,57,43,43,43,43,43,43]}},{name:"metal pipe",midiProgram:117,isNoise:!0,midiSubharmonicOctaves:-1.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"twang 2",spectrum:[29,43,86,43,43,43,43,43,100,29,14,14,100,14,14,0,0,0,0,0,14,29,29,14,0,0,14,29,0,0]}}])},{name:"Novelty Presets",presets:r([{name:"guitar fret noise",midiProgram:120,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:8e3,filterResonance:86,filterEnvelope:"flare 1",spectrum:[0,0,0,0,0,0,0,0,0,0,0,0,0,14,0,0,0,29,14,0,0,43,0,43,0,71,43,0,57,0]}},{name:"fifth saw lead",midiProgram:86,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"chip",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"twang 3",wave:"sawtooth",interval:"fifth",vibrato:"none"}},{name:"fifth swell",midiProgram:86,midiSubharmonicOctaves:1,settings:{type:"chip",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:57,filterEnvelope:"swell 3",wave:"sawtooth",interval:"fifth",vibrato:"none"}},{name:"soundtrack",midiProgram:97,generalMidi:!0,settings:{type:"chip",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"flare 3",wave:"sawtooth",interval:"fifth",vibrato:"none"}},{name:"reverse cymbal",midiProgram:119,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",effects:"none",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"swell 3",spectrum:[29,57,57,29,57,57,29,29,43,29,29,43,29,29,57,57,14,57,14,57,71,71,57,86,57,100,86,86,86,86]}},{name:"seashore",midiProgram:122,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",transition:"soft fade",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"swell 3",spectrum:[14,14,29,29,43,43,43,57,57,57,57,57,57,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,57]}},{name:"bird tweet",midiProgram:123,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"decay 1",interval:"hum",vibrato:"heavy",harmonics:[0,0,14,100,14,0,0,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"telephone ring",midiProgram:124,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"tremolo4",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:4,envelope:"tremolo1"},{frequency:"20×",amplitude:1,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"helicopter",midiProgram:125,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-.5,settings:{type:"spectrum",effects:"reverb",transition:"seamless",chord:"arpeggio",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"tremolo4",spectrum:[14,43,43,57,57,57,71,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,71,71,71,57,57]}},{name:"applause",midiProgram:126,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",effects:"reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"swell 3",spectrum:[14,14,29,29,29,43,43,57,71,71,86,86,86,71,71,57,57,57,71,86,86,86,86,86,71,71,57,57,57,57]}},{name:"gunshot",midiProgram:127,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:1414,filterResonance:29,filterEnvelope:"twang 1",spectrum:[14,29,43,43,57,57,57,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,57,57,57,57,43]}},{name:"scoot",midiProgram:92,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:707,filterResonance:86,filterEnvelope:"flare 1",wave:"sawtooth",interval:"shimmer",vibrato:"none"}},{name:"buzz saw",midiProgram:30,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"custom interval",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"5×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"~1×",amplitude:6,envelope:"steady"},{frequency:"11×",amplitude:12,envelope:"steady"}]}},{name:"mosquito",midiProgram:93,settings:{type:"PWM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"steady",pulseWidth:4.40625,pulseEnvelope:"tremolo6",vibrato:"shaky"}},{name:"breathing",midiProgram:126,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"swell 2",spectrum:[14,14,14,29,29,29,29,29,43,29,29,43,43,43,29,29,71,43,86,86,57,100,86,86,86,86,71,86,71,57]}},{name:"klaxon synth",midiProgram:125,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"noise",effects:"reverb",transition:"slide",chord:"harmony",filterCutoffHz:2e3,filterResonance:86,filterEnvelope:"steady",wave:"buzz"}},{name:"theremin",midiProgram:40,settings:{type:"harmonics",effects:"reverb",transition:"slide",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"heavy",harmonics:[100,71,57,43,29,29,14,14,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"sonar ping",midiProgram:121,settings:{type:"spectrum",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"twang 2",spectrum:[100,43,29,29,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}}])}]);var c=t&&t.t||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],s=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&s>=t.length&&(t=void 0),{value:t&&t[s++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},f=t&&t.i||function(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,n,o=i.call(t),r=[];try{for(;(void 0===e||e-- >0)&&!(s=o.next()).done;)r.push(s.value)}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return r},u=t&&t.o||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t};function d(t,e){var i,s,n,o,r,h;try{for(var a=c(e),l=a.next();!l.done;l=a.next()){var f=l.value;if(f instanceof Node)t.appendChild(f);else if("string"==typeof f)t.appendChild(document.createTextNode(f));else if("function"==typeof f)d(t,[f()]);else if(Array.isArray(f))d(t,f);else if(f&&"undefined"!=typeof Symbol&&"function"==typeof f[Symbol.iterator])d(t,u(f));else if(f&&f.constructor===Object&&t instanceof Element)try{for(var m=(n=void 0,c(Object.keys(f))),p=m.next();!p.done;p=m.next()){var y=p.value,g=f[y];if("class"===y)"string"==typeof g?t.setAttribute("class",g):Array.isArray(f)||g&&"undefined"!=typeof Symbol&&"function"==typeof g[Symbol.iterator]?t.setAttribute("class",u(g).join(" ")):console.warn("Invalid "+y+' value "'+g+'" on '+t.tagName+" element.");else if("style"===y)if(g&&g.constructor===Object)try{for(var v=(r=void 0,c(Object.keys(g))),b=v.next();!b.done;b=v.next()){var w=b.value;w in t.style?t.style[w]=g[w]:t.style.setProperty(w,g[w])}}catch(t){r={error:t}}finally{try{b&&!b.done&&(h=v.return)&&h.call(v)}finally{if(r)throw r.error}}else t.setAttribute(y,g);else"function"==typeof g?t[y]=g:"boolean"==typeof g?g?t.setAttribute(y,""):t.removeAttribute(y):t.setAttribute(y,g)}}catch(t){n={error:t}}finally{try{p&&!p.done&&(o=m.return)&&o.call(m)}finally{if(n)throw n.error}}else t.appendChild(document.createTextNode(f))}}catch(t){i={error:t}}finally{try{l&&!l.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}return t}var m="http://www.w3.org/2000/svg";var p,y,g,v,b=t&&t.t||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],s=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&s>=t.length&&(t=void 0),{value:t&&t[s++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},w=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return document.createRange().createContextualFragment(t.join())},k=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=document.createDocumentFragment(),s=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg">'+t.join()+"</svg>","image/svg+xml").documentElement;null!==s.firstChild;)document.importNode(s.firstChild,!0),i.appendChild(s.firstChild);return i},M=function(t){w[t]=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return d(document.createElement(t),e)}};try{for(var x=b("a abbr address area article aside audio b base bdi bdo blockquote br button canvas caption cite code col colgroup datalist dd del details dfn dialog div dl dt em embed fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 header hr i iframe img input ins kbd label legend li link main map mark menu menuitem meta meter nav noscript object ol optgroup option output p param picture pre progress q rp rt ruby s samp script section select small source span strong style sub summary sup table tbody td template textarea tfoot th thead time title tr track u ul var video wbr".split(" ")),E=x.next();!E.done;E=x.next()){M(E.value)}}catch(t){p={error:t}}finally{try{E&&!E.done&&(y=x.return)&&y.call(x)}finally{if(p)throw p.error}}var q=function(t){if(k[t]=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return d(document.createElementNS(m,t),e)},/-/.test(t)){var e=t.replace(/-/g,"_");k[e]=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return d(document.createElementNS(m,t),e)}}};try{for(var C=b("a altGlyph altGlyphDef altGlyphItem animate animateMotion animateTransform circle clipPath color-profile cursor defs desc discard ellipse feBlend feColorMatrix feComponentTransfer feComposite feConvolveMatrix feDiffuseLighting feDisplacementMap feDistantLight feDropShadow feFlood feFuncA feFuncB feFuncG feFuncR feGaussianBlur feImage feMerge feMergeNode feMorphology feOffset fePointLight feSpecularLighting feSpotLight feTile feTurbulence filter font font-face font-face-format font-face-name font-face-src font-face-uri foreignObject g glyph glyphRef hkern image line linearGradient marker mask metadata missing-glyph mpath path pattern polygon polyline radialGradient rect script set stop style svg switch symbol text textPath title tref tspan use view vkern".split(" ")),P=C.next();!P.done;P=C.next()){q(P.value)}}catch(t){g={error:t}}finally{try{P&&!P.done&&(v=C.return)&&v.call(C)}finally{if(g)throw g.error}}class S{static getChannelColor(t,e){return e<t.pitchChannelCount?S.pitchChannels[e%S.pitchChannels.length]:S.noiseChannels[(e-t.pitchChannelCount)%S.noiseChannels.length]}static setTheme(t){this.h.textContent=this.themes[t];const e=document.querySelector("meta[name='theme-color']");null!=e&&e.setAttribute("content",getComputedStyle(document.documentElement).getPropertyValue("--ui-widget-background"))}}S.themes={"dark classic":"\n\t\t\t\t:root {\n\t\t\t\t\t--page-margin: black;\n\t\t\t\t\t--editor-background: black;\n\t\t\t\t\t--hover-preview: white;\n\t\t\t\t\t--playhead: white;\n\t\t\t\t\t--primary-text: white;\n\t\t\t\t\t--secondary-text: #999;\n\t\t\t\t\t--inverted-text: black;\n\t\t\t\t\t--text-selection: rgba(119,68,255,0.99);\n\t\t\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\n\t\t\t\t\t--loop-accent: #74f;\n\t\t\t\t\t--link-accent: #98f;\n\t\t\t\t\t--ui-widget-background: #444;\n\t\t\t\t\t--ui-widget-focus: #777;\n\t\t\t\t\t--pitch-background: #444;\n\t\t\t\t\t--tonic: #864;\n\t\t\t\t\t--fifth-note: #468;\n\t\t\t\t\t--white-piano-key: #bbb;\n\t\t\t\t\t--black-piano-key: #444;\n\t\t\t\t\t--pitch1-secondary-channel: #0099a1;\n\t\t\t\t\t--pitch1-primary-channel:   #25f3ff;\n\t\t\t\t\t--pitch1-secondary-note:    #00bdc7;\n\t\t\t\t\t--pitch1-primary-note:      #92f9ff;\n\t\t\t\t\t--pitch2-secondary-channel: #a1a100;\n\t\t\t\t\t--pitch2-primary-channel:   #ffff25;\n\t\t\t\t\t--pitch2-secondary-note:    #c7c700;\n\t\t\t\t\t--pitch2-primary-note:      #ffff92;\n\t\t\t\t\t--pitch3-secondary-channel: #c75000;\n\t\t\t\t\t--pitch3-primary-channel:   #ff9752;\n\t\t\t\t\t--pitch3-secondary-note:    #ff771c;\n\t\t\t\t\t--pitch3-primary-note:      #ffcdab;\n\t\t\t\t\t--pitch4-secondary-channel: #00a100;\n\t\t\t\t\t--pitch4-primary-channel:   #50ff50;\n\t\t\t\t\t--pitch4-secondary-note:    #00c700;\n\t\t\t\t\t--pitch4-primary-note:      #a0ffa0;\n\t\t\t\t\t--pitch5-secondary-channel: #d020d0;\n\t\t\t\t\t--pitch5-primary-channel:   #ff90ff;\n\t\t\t\t\t--pitch5-secondary-note:    #e040e0;\n\t\t\t\t\t--pitch5-primary-note:      #ffc0ff;\n\t\t\t\t\t--pitch6-secondary-channel: #7777b0;\n\t\t\t\t\t--pitch6-primary-channel:   #a0a0ff;\n\t\t\t\t\t--pitch6-secondary-note:    #8888d0;\n\t\t\t\t\t--pitch6-primary-note:      #d0d0ff;\n\t\t\t\t\t--noise1-secondary-channel: #6f6f6f;\n\t\t\t\t\t--noise1-primary-channel:   #aaaaaa;\n\t\t\t\t\t--noise1-secondary-note:    #a7a7a7;\n\t\t\t\t\t--noise1-primary-note:      #e0e0e0;\n\t\t\t\t\t--noise2-secondary-channel: #996633;\n\t\t\t\t\t--noise2-primary-channel:   #ddaa77;\n\t\t\t\t\t--noise2-secondary-note:    #cc9966;\n\t\t\t\t\t--noise2-primary-note:      #f0d0bb;\n\t\t\t\t\t--noise3-secondary-channel: #4a6d8f;\n\t\t\t\t\t--noise3-primary-channel:   #77aadd;\n\t\t\t\t\t--noise3-secondary-note:    #6f9fcf;\n\t\t\t\t\t--noise3-primary-note:      #bbd7ff;\n\t\t\t\t}\n\t\t\t","light classic":"\n\t\t\t\t:root {\n\t\t\t\t\t-webkit-text-stroke-width: 0.5px;\n\t\t\t\t\t--page-margin: #685d88;\n\t\t\t\t\t--editor-background: white;\n\t\t\t\t\t--hover-preview: black;\n\t\t\t\t\t--playhead: rgba(0,0,0,0.5);\n\t\t\t\t\t--primary-text: black;\n\t\t\t\t\t--secondary-text: #777;\n\t\t\t\t\t--inverted-text: white;\n\t\t\t\t\t--text-selection: rgba(200,170,255,0.99);\n\t\t\t\t\t--box-selection-fill: rgba(0,0,0,0.1);\n\t\t\t\t\t--loop-accent: #98f;\n\t\t\t\t\t--link-accent: #74f;\n\t\t\t\t\t--ui-widget-background: #ececec;\n\t\t\t\t\t--ui-widget-focus: #eee;\n\t\t\t\t\t--pitch-background: #ececec;\n\t\t\t\t\t--tonic: #f0d6b6;\n\t\t\t\t\t--fifth-note: #bbddf0;\n\t\t\t\t\t--white-piano-key: #eee;\n\t\t\t\t\t--black-piano-key: #666;\n\t\t\t\t\t--pitch1-secondary-channel: #6CD9ED;\n\t\t\t\t\t--pitch1-primary-channel:   #00A0BD;\n\t\t\t\t\t--pitch1-secondary-note:    #34C2DC;\n\t\t\t\t\t--pitch1-primary-note:      #00758A;\n\t\t\t\t\t--pitch2-secondary-channel: #E3C941;\n\t\t\t\t\t--pitch2-primary-channel:   #B49700;\n\t\t\t\t\t--pitch2-secondary-note:    #D1B628;\n\t\t\t\t\t--pitch2-primary-note:      #836E00;\n\t\t\t\t\t--pitch3-secondary-channel: #FF9D61;\n\t\t\t\t\t--pitch3-primary-channel:   #E14E00;\n\t\t\t\t\t--pitch3-secondary-note:    #F67D3C;\n\t\t\t\t\t--pitch3-primary-note:      #B64000;\n\t\t\t\t\t--pitch4-secondary-channel: #4BE24B;\n\t\t\t\t\t--pitch4-primary-channel:   #00A800;\n\t\t\t\t\t--pitch4-secondary-note:    #2DC82D;\n\t\t\t\t\t--pitch4-primary-note:      #008000;\n\t\t\t\t\t--pitch5-secondary-channel: #FF90FF;\n\t\t\t\t\t--pitch5-primary-channel:   #E12EDF;\n\t\t\t\t\t--pitch5-secondary-note:    #EC6EEC;\n\t\t\t\t\t--pitch5-primary-note:      #A600A5;\n\t\t\t\t\t--pitch6-secondary-channel: #B5B5FE;\n\t\t\t\t\t--pitch6-primary-channel:   #6969FD;\n\t\t\t\t\t--pitch6-secondary-note:    #9393FE;\n\t\t\t\t\t--pitch6-primary-note:      #4A4AD7;\n\t\t\t\t\t--noise1-secondary-channel: #C1C1C1;\n\t\t\t\t\t--noise1-primary-channel:   #898989;\n\t\t\t\t\t--noise1-secondary-note:    #ADADAD;\n\t\t\t\t\t--noise1-primary-note:      #6C6C6C;\n\t\t\t\t\t--noise2-secondary-channel: #E8BB8C;\n\t\t\t\t\t--noise2-primary-channel:   #BD7D3A;\n\t\t\t\t\t--noise2-secondary-note:    #D1A374;\n\t\t\t\t\t--noise2-primary-note:      #836342;\n\t\t\t\t\t--noise3-secondary-channel: #9BC4EB;\n\t\t\t\t\t--noise3-primary-channel:   #4481BE;\n\t\t\t\t\t--noise3-secondary-note:    #7CA7D3;\n\t\t\t\t\t--noise3-primary-note:      #476685;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor button, .beepboxEditor select {\n\t\t\t\t\tbox-shadow: inset 0 0 0 1px var(--secondary-text);\n\t\t\t\t}\n\t\t\t"},S.pageMargin="var(--page-margin)",S.editorBackground="var(--editor-background)",S.hoverPreview="var(--hover-preview)",S.playhead="var(--playhead)",S.primaryText="var(--primary-text)",S.secondaryText="var(--secondary-text)",S.invertedText="var(--inverted-text)",S.textSelection="var(--text-selection)",S.boxSelectionFill="var(--box-selection-fill)",S.loopAccent="var(--loop-accent)",S.linkAccent="var(--link-accent)",S.uiWidgetBackground="var(--ui-widget-background)",S.uiWidgetFocus="var(--ui-widget-focus)",S.pitchBackground="var(--pitch-background)",S.tonic="var(--tonic)",S.fifthNote="var(--fifth-note)",S.whitePianoKey="var(--white-piano-key)",S.blackPianoKey="var(--black-piano-key)",S.pitchChannels=r([{name:"pitch1",secondaryChannel:"var(--pitch1-secondary-channel)",primaryChannel:"var(--pitch1-primary-channel)",secondaryNote:"var(--pitch1-secondary-note)",primaryNote:"var(--pitch1-primary-note)"},{name:"pitch2",secondaryChannel:"var(--pitch2-secondary-channel)",primaryChannel:"var(--pitch2-primary-channel)",secondaryNote:"var(--pitch2-secondary-note)",primaryNote:"var(--pitch2-primary-note)"},{name:"pitch3",secondaryChannel:"var(--pitch3-secondary-channel)",primaryChannel:"var(--pitch3-primary-channel)",secondaryNote:"var(--pitch3-secondary-note)",primaryNote:"var(--pitch3-primary-note)"},{name:"pitch4",secondaryChannel:"var(--pitch4-secondary-channel)",primaryChannel:"var(--pitch4-primary-channel)",secondaryNote:"var(--pitch4-secondary-note)",primaryNote:"var(--pitch4-primary-note)"},{name:"pitch5",secondaryChannel:"var(--pitch5-secondary-channel)",primaryChannel:"var(--pitch5-primary-channel)",secondaryNote:"var(--pitch5-secondary-note)",primaryNote:"var(--pitch5-primary-note)"},{name:"pitch6",secondaryChannel:"var(--pitch6-secondary-channel)",primaryChannel:"var(--pitch6-primary-channel)",secondaryNote:"var(--pitch6-secondary-note)",primaryNote:"var(--pitch6-primary-note)"}]),S.noiseChannels=r([{name:"noise1",secondaryChannel:"var(--noise1-secondary-channel)",primaryChannel:"var(--noise1-primary-channel)",secondaryNote:"var(--noise1-secondary-note)",primaryNote:"var(--noise1-primary-note)"},{name:"noise2",secondaryChannel:"var(--noise2-secondary-channel)",primaryChannel:"var(--noise2-primary-channel)",secondaryNote:"var(--noise2-secondary-note)",primaryNote:"var(--noise2-primary-note)"},{name:"noise3",secondaryChannel:"var(--noise3-secondary-channel)",primaryChannel:"var(--noise3-primary-channel)",secondaryNote:"var(--noise3-secondary-note)",primaryNote:"var(--noise3-primary-note)"}]),S.h=document.head.appendChild(w.style({type:"text/css"}));const T=document.body.appendChild(w.div({style:"width:30px; height:30px; overflow: auto;"},w.div({style:"width:100%;height:40px"})));T.firstChild.clientWidth<30&&document.documentElement.classList.add("obtrusive-scrollbars"),document.body.removeChild(T),document.head.appendChild(w.style({type:"text/css"},`\n\n/* Note: "#" symbols need to be encoded as "%23" in SVG data urls, otherwise they are interpreted as fragment identifiers! */\n:root {\n\t--play-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -8 L -4 8 L 9 0 z" fill="gray"/></svg>');\n\t--pause-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-4" y="-8" width="4" height="16" fill="gray"/><rect x="5" y="-8" width="4" height="16" fill="gray"/></svg>');\n\t--prev-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-6" y="-6" width="2" height="12" fill="gray"/><path d="M 6 -6 L 6 6 L -3 0 z" fill="gray"/></svg>');\n\t--next-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="4" y="-6" width="2" height="12" fill="gray"/><path d="M -6 -6 L -6 6 L 3 0 z" fill="gray"/></svg>');\n\t--volume-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');\n\t--unmuted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');\n\t--muted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z" fill="gray"/></svg>');\n\t--menu-down-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -2 L 4 -2 L 0 3 z" fill="gray"/></svg>');\n\t--select-arrows-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -3 L 4 -3 L 0 -8 z M -4 3 L 4 3 L 0 8 z" fill="gray"/></svg>');\n\t--file-page-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z" fill="gray"/></svg>');\n\t--edit-pencil-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z" fill="gray"/></svg>');\n\t--preferences-gear-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M 5.78 -1.6 L 7.93 -0.94 L 7.93 0.94 L 5.78 1.6 L 4.85 3.53 L 5.68 5.61 L 4.21 6.78 L 2.36 5.52 L 0.27 5.99 L -0.85 7.94 L -2.68 7.52 L -2.84 5.28 L -4.52 3.95 L -6.73 4.28 L -7.55 2.59 L -5.9 1.07 L -5.9 -1.07 L -7.55 -2.59 L -6.73 -4.28 L -4.52 -3.95 L -2.84 -5.28 L -2.68 -7.52 L -0.85 -7.94 L 0.27 -5.99 L 2.36 -5.52 L 4.21 -6.78 L 5.68 -5.61 L 4.85 -3.53 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z" fill="gray"/></svg>');\n\t--customize-dial-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"> \t\t\t<g transform="translate(0,1)" fill="gray"> \t\t\t\t<circle cx="0" cy="0" r="6.5" stroke="gray" stroke-width="1" fill="none"/> \t\t\t\t<rect x="-1" y="-5" width="2" height="4" transform="rotate(30)"/> \t\t\t\t<circle cx="-7.79" cy="4.5" r="0.75"/> \t\t\t\t<circle cx="-9" cy="0" r="0.75"/> \t\t\t\t<circle cx="-7.79" cy="-4.5" r="0.75"/> \t\t\t\t<circle cx="-4.5" cy="-7.79" r="0.75"/> \t\t\t\t<circle cx="0" cy="-9" r="0.75"/> \t\t\t\t<circle cx="4.5" cy="-7.79" r="0.75"/> \t\t\t\t<circle cx="7.79" cy="-4.5" r="0.75"/> \t\t\t\t<circle cx="9" cy="0" r="0.75"/> \t\t\t\t<circle cx="7.79" cy="4.5" r="0.75"/> \t\t\t</g> \t\t</svg>');\n\t--export-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z"/></svg>');\n\t--close-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 -6 L -6 -8 L 0 -2  L 6 -8 L 8 -6 L 2 0 L 8 6 L 6 8 L 0 2 L -6 8 L -8 6 L -2 0 z"/></svg>');\n\t--checkmark-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -9 -2 L -8 -3 L -3 2 L 9 -8 L 10 -7 L -3 8 z"/></svg>');\n\t--drum-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"> \t\t\t<defs> \t\t\t\t<linearGradient id="gold1" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%237e3302"/> \t\t\t\t\t<stop offset="40%" stop-color="%23ffec6b"/> \t\t\t\t\t<stop offset="100%" stop-color="%237e3302"/> \t\t\t\t</linearGradient> \t\t\t\t<linearGradient id="gold2" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%23faaf7d"/> \t\t\t\t\t<stop offset="15%" stop-color="%23fffba9"/> \t\t\t\t\t<stop offset="40%" stop-color="%23ffffe3"/> \t\t\t\t\t<stop offset="65%" stop-color="%23fffba9"/> \t\t\t\t\t<stop offset="100%" stop-color="%23faaf7d"/> \t\t\t\t</linearGradient> \t\t\t\t<radialGradient id="gold3" cx="0%" cy="0%" r="100%"> \t\t\t\t\t<stop offset="0%" stop-color="%23ffffe3"/> \t\t\t\t\t<stop offset="50%" stop-color="%23ffec6b"/> \t\t\t\t\t<stop offset="100%" stop-color="%237e3302"/> \t\t\t\t</radialGradient> \t\t\t\t<linearGradient id="red" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%23641919"/> \t\t\t\t\t<stop offset="40%" stop-color="%23cd2c2c"/> \t\t\t\t\t<stop offset="100%" stop-color="%23641919"/> \t\t\t\t</linearGradient> \t\t\t\t<radialGradient id="membrane"> \t\t\t\t\t<stop offset="10%" stop-color="%23cccccc" /> \t\t\t\t\t<stop offset="90%" stop-color="%23f6f6f7" /> \t\t\t\t\t<stop offset="100%" stop-color="%23999" /> \t\t\t\t</radialGradient> \t\t\t</defs> \t\t\t<ellipse cx="16" cy="26" rx="16" ry="14" fill="rgba(0,0,0,0.5)"/> \t\t\t<ellipse cx="16" cy="25" rx="16" ry="14" fill="url(%23gold1)"/> \t\t\t<rect x="0" y="23" width="32" height="2" fill="url(%23gold1)"/> \t\t\t<ellipse cx="16" cy="23" rx="16" ry="14" fill="url(%23gold2)"/> \t\t\t<ellipse cx="16" cy="23" rx="15" ry="13" fill="url(%23red)"/> \t\t\t<rect x="1" y="17" width="30" height="6" fill="url(%23red)"/> \t\t\t<rect x="5" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="15" y="31" width="2" height="5" rx="1" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="26" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="5" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> \t\t\t<rect x="15" y="30" width="2" height="5" rx="1" fill="url(%23gold3)"/> \t\t\t<rect x="26" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> \t\t\t<ellipse cx="16" cy="18" rx="15" ry="13" fill="rgba(0,0,0,0.5)"/> \t\t\t<ellipse cx="16" cy="16" rx="16" ry="14" fill="url(%23gold1)"/> \t\t\t<rect x="0" y="14" width="32" height="2" fill="url(%23gold1)"/> \t\t\t<ellipse cx="16" cy="14" rx="16" ry="14" fill="url(%23gold2)"/> \t\t\t<ellipse cx="16" cy="14" rx="15" ry="13" fill="url(%23membrane)"/> \t\t</svg>');\n\t--piano-key-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="15" preserveAspectRatio="none" viewBox="0 -1 32 15"> \t\t\t<defs> \t\t\t\t<linearGradient id="shadow" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="rgba(0,0,0,0.5)"/> \t\t\t\t\t<stop offset="100%" stop-color="transparent"/> \t\t\t\t</linearGradient> \t\t\t</defs> \t\t\t<rect x="-1" y="1" width="31" height="1" rx="0.6" fill="rgba(255,255,255,0.4)"/> \t\t\t<path d="M -1 11 L 30 11 L 30 2 L 33 -1 L 33 14 L -1 14 z" fill="rgba(0,0,0,0.7)"/> \t\t\t<rect x="-1" y="-1" width="19" height="15" fill="url(%23shadow)"/> \t\t</svg>');\n}\n\n\n.obtrusive-scrollbars, .obtrusive-scrollbars * {\n\tscrollbar-width: thin;\n\tscrollbar-color: ${S.uiWidgetBackground} ${S.editorBackground};\n}\n.obtrusive-scrollbars::-webkit-scrollbar, .obtrusive-scrollbars *::-webkit-scrollbar {\n\twidth: 12px;\n}\n.obtrusive-scrollbars::-webkit-scrollbar-track, .obtrusive-scrollbars *::-webkit-scrollbar-track {\n\tbackground: ${S.editorBackground};\n}\n.obtrusive-scrollbars::-webkit-scrollbar-thumb, .obtrusive-scrollbars *::-webkit-scrollbar-thumb {\n\tbackground-color: ${S.uiWidgetBackground};\n\tborder: 3px solid ${S.editorBackground};\n}\n\n\n.beepboxEditor {\n\tdisplay: grid;\n    grid-template-columns: minmax(0, 1fr) max-content;\n    grid-template-rows: max-content 1fr; /* max-content minmax(0, 1fr); Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\n    grid-template-areas: "pattern-area settings-area" "track-area settings-area";\n\tgrid-column-gap: 6px;\n\tgrid-row-gap: 6px;\n\tposition: relative;\n\ttouch-action: manipulation;\n\tcursor: default;\n\tfont-size: small;\n\toverflow: hidden;\n\tcolor: ${S.primaryText};\n\tbackground: ${S.editorBackground};\n}\n\n.beepboxEditor .noSelection {\n\t-webkit-touch-callout: none;\n\t-webkit-user-select: none;\n\t-moz-user-select: none;\n\t-ms-user-select: none;\n\tuser-select: none;\n}\n\n.beepboxEditor div {\n\tmargin: 0;\n\tpadding: 0;\n}\n\n.beepboxEditor .pattern-area {\n\tgrid-area: pattern-area;\n\theight: 481px;\n\tdisplay: flex;\n\tflex-direction: row;\n}\n\n.beepboxEditor .track-area {\n\tgrid-area: track-area;\n}\n\n.beepboxEditor .settings-area {\n\tgrid-area: settings-area;\n\tdisplay: grid;\n    grid-template-columns: auto;\n    grid-template-rows: min-content min-content min-content min-content min-content;\n    grid-template-areas: "version-area" "play-pause-area" "menu-area" "song-settings-area" "instrument-settings-area";\n\tgrid-column-gap: 6px;\n}\n\n.beepboxEditor .version-area{ grid-area: version-area; }\n.beepboxEditor .play-pause-area{ grid-area: play-pause-area; }\n.beepboxEditor .menu-area{ grid-area: menu-area; }\n.beepboxEditor .song-settings-area{ grid-area: song-settings-area; }\n.beepboxEditor .instrument-settings-area{ grid-area: instrument-settings-area; }\n\n.beepboxEditor .tip {\n\tcursor: help;\n}\n\n.beepboxEditor .tip:hover {\n\tcolor: ${S.linkAccent};\n\ttext-decoration: underline;\n}\n.beepboxEditor .tip:active {\n\tcolor: ${S.primaryText};\n}\n\n.beepboxEditor .volume-speaker {\n\tflex-shrink: 0;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: ${S.secondaryText};\n\t-webkit-mask-image: var(--volume-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--volume-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .drum-button {\n\tflex: 1;\n\tbackground-color: transparent;\n\tbackground-image: var(--drum-symbol);\n\tbackground-repeat: no-repeat;\n\tbackground-position: center;\n}\n\n.beepboxEditor .piano-button {\n\tflex: 1;\n\tposition: relative;\n\tdisplay: flex;\n\talign-items: center;\n}\n.beepboxEditor .piano-button::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 0;\n\ttop: 0;\n\twidth: 100%;\n\theight: 100%;\n\tpointer-events: none;\n\tbackground-image: var(--piano-key-symbol);\n\tbackground-repeat: no-repeat;\n\tbackground-position: center;\n\tbackground-size: 100% 115.38%;\n}\n.beepboxEditor .piano-button.disabled::after {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0;\n\ttop: 0;\n\twidth: 70%;\n\theight: 100%;\n\tpointer-events: none;\n\tbackground: ${S.editorBackground};\n\t-webkit-mask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .customize-instrument {\n\tmargin: 2px 0;\n}\n.beepboxEditor .customize-instrument::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--customize-dial-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--customize-dial-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .menu.file::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--file-page-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--file-page-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .menu.edit::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--edit-pencil-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--edit-pencil-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .menu.preferences::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--preferences-gear-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--preferences-gear-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .mute-button::before {\n\tcontent: "";\n\tpointer-events: none;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: ${S.primaryText};\n\tdisplay: inline-block;\n\t-webkit-mask-image: var(--unmuted-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\t-webkit-mask-size: contain;\n\tmask-image: var(--unmuted-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\tmask-size: contain;\n}\n\n.beepboxEditor .mute-button.muted::before {\n\tbackground: ${S.editorBackground};\n\t-webkit-mask-image: var(--muted-symbol);\n\tmask-image: var(--muted-symbol);\n}\n\n.beepboxEditor .promptContainer {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n}\n\n.beepboxEditor .promptContainer::before {\n\tcontent: "";\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: ${S.editorBackground};\n\topacity: 0.5;\n\tdisplay: flex;\n}\n\n.beepboxEditor .prompt {\n\tmargin: auto;\n\ttext-align: center;\n\tbackground: ${S.editorBackground};\n\tborder-radius: 15px;\n\tborder: 4px solid ${S.uiWidgetBackground};\n\tcolor: ${S.primaryText};\n\tpadding: 20px;\n\tdisplay: flex;\n\tflex-direction: column;\n\tposition: relative;\n\tbox-shadow: 5px 5px 20px 10px rgba(0,0,0,0.5);\n}\n\n.beepboxEditor .prompt > *:not(:first-child):not(.cancelButton) {\n\tmargin-top: 1.5em;\n}\n\n.beepboxEditor .prompt h2 {\n\tfont-size: 2em;\n\tmargin: 0 16px;\n\tfont-weight: normal;\n}\n\n.beepboxEditor .prompt p {\n\ttext-align: left;\n\tmargin: 1em 0;\n}\n\n.beepboxEditor .selectContainer {\n\tposition: relative;\n}\n.beepboxEditor .selectContainer:not(.menu)::after {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tright: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 1.1em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--select-arrows-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--select-arrows-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor .selectContainer.menu::after {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tright: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--menu-down-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--menu-down-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor select {\n\tmargin: 0;\n\tpadding: 0 0.3em;\n\tdisplay: block;\n\theight: 2em;\n\tborder: none;\n\tborder-radius: 0.4em;\n\tbackground: ${S.uiWidgetBackground};\n\tcolor: inherit;\n\tfont-size: inherit;\n\tcursor: pointer;\n\tfont-family: inherit;\n\tfont-weight: inherit;\n\n\t-webkit-appearance:none;\n\t-moz-appearance: none;\n\tappearance: none;\n}\n.beepboxEditor .menu select {\n\tpadding: 0 2em;\n}\n.beepboxEditor select:focus {\n\tbackground: ${S.uiWidgetFocus};\n\toutline: none;\n}\n.beepboxEditor .menu select {\n\ttext-align: center;\n\ttext-align-last: center;\n}\n.beepboxEditor .settings-area select {\n       width: 100%;\n}\n\n/* This makes it look better in firefox on my computer... What about others?\n@-moz-document url-prefix() {\n\t.beepboxEditor select { padding: 0 2px; }\n}\n*/\n.beepboxEditor button {\n\tmargin: 0;\n\tposition: relative;\n\theight: 2em;\n\tborder: none;\n\tborder-radius: 0.4em;\n\tbackground: ${S.uiWidgetBackground};\n\tcolor: inherit;\n\tfont-size: inherit;\n\tfont-family: inherit;\n\tfont-weight: inherit;\n\tcursor: pointer;\n}\n.beepboxEditor button:focus {\n\tbackground: ${S.uiWidgetFocus};\n\toutline: none;\n}\n\n.beepboxEditor button.cancelButton {\n\tfloat: right;\n\twidth: 2em;\n\tposition: absolute;\n\ttop: 8px;\n\tright: 8px;\n}\n\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.okayButton, .beepboxEditor button.exportButton {\n\tpadding-left: 2em;\n}\n.beepboxEditor button.playButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--play-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--play-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor button.pauseButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--pause-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--pause-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.prevBarButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: -1em;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--prev-bar-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--prev-bar-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.nextBarButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: -1em;\n\tmargin-top: -1em;\n\tpointer-events: none;\n\twidth: 2em;\n\theight: 2em;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--next-bar-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--next-bar-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.cancelButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 2em;\n\theight: 2em;\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--close-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--close-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor button.okayButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 2em;\n\theight: 2em;\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--checkmark-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--checkmark-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.exportButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 2em;\n\theight: 2em;\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--export-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--export-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor canvas {\n\toverflow: hidden;\n\tposition: absolute;\n\tdisplay: block;\n}\n\n.beepboxEditor .trackContainer {\n\toverflow-x: hidden;\n\tflex-grow: 1;\n}\n\n.beepboxEditor .trackAndMuteContainer {\n\tdisplay: flex;\n\talign-items: flex-start;\n}\n\n.beepboxEditor .muteEditor {\n\theight: 128px;\n\twidth: 32px;\n\tflex-shrink: 0;\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: stretch;\n}\n\n.beepboxEditor .selectRow {\n\tmargin: 2px 0;\n\theight: 2em;\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: center;\n\tjustify-content: space-between;\n}\n\n.beepboxEditor .tip {\n\tcolor: ${S.secondaryText};\n}\n\n.beepboxEditor .selectRow > :nth-child(2) {\n\twidth: 61.5%;\n}\n\n.beepboxEditor .operatorRow {\n\tmargin: 2px 0;\n\theight: 2em;\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: center;\n}\n\n.beepboxEditor .operatorRow > * {\n\tflex-grow: 1;\n\tflex-shrink: 1;\n}\n\n.beepboxEditor .menu-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n.beepboxEditor .menu-area > * {\n\tmargin: 2px 0;\n}\n.beepboxEditor .menu-area > button {\n\tpadding: 0 2em;\n\twhite-space: nowrap;\n}\n\n.beepboxEditor .song-settings-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-controls {\n\tflex-shrink: 0;\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .instrument-settings-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {\n\tflex-shrink: 0;\n}\n\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\n\tfont-size: inherit;\n\tfont-weight: inherit;\n\tfont-family: inherit;\n\tbackground: transparent;\n\tborder: 1px solid ${S.uiWidgetFocus};\n\tcolor: ${S.primaryText};\n}\n\n.beepboxEditor input[type=text]::selection, .beepboxEditor input[type=number]::selection {\n\tbackground-color: ${S.textSelection};\n\tcolor: ${S.primaryText};\n}\n\n.beepboxEditor input[type=checkbox] {\n  transform: scale(1.5);\n}\n\n.beepboxEditor input[type=range] {\n\t-webkit-appearance: none;\n\tcolor: inherit;\n\twidth: 100%;\n\theight: 2em;\n\tfont-size: inherit;\n\tmargin: 0;\n\tcursor: pointer;\n\tbackground-color: ${S.editorBackground};\n\ttouch-action: pan-y;\n}\n.beepboxEditor input[type=range]:focus {\n\toutline: none;\n}\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: ${S.uiWidgetBackground};\n}\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tbackground: currentColor;\n\tcursor: pointer;\n\t-webkit-appearance: none;\n\tmargin-top: -0.75em;\n}\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\n\tbackground: ${S.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-moz-range-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: ${S.uiWidgetBackground};\n}\n.beepboxEditor input[type=range]:focus::-moz-range-track {\n\tbackground: ${S.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-moz-range-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tborder: none;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n.beepboxEditor input[type=range]::-ms-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: ${S.uiWidgetBackground};\n\tborder-color: transparent;\n}\n.beepboxEditor input[type=range]:focus::-ms-track {\n\tbackground: ${S.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-ms-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n.beepboxEditor .hintButton {\n\tborder: 1px solid currentColor;\n\tborder-radius: 50%;\n\ttext-decoration: none;\n\twidth: 1em;\n\theight: 1em;\n\ttext-align: center;\n\tmargin-left: auto;\n\tmargin-right: .4em;\n\tcursor: pointer;\n}\n\n/* wide screen */\n@media (min-width: 701px) {\n\t#beepboxEditorContainer {\n\t\tdisplay: table;\n\t}\n\t.beepboxEditor {\n\t\tflex-direction: row;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: 3px solid ${S.uiWidgetBackground};\n\t}\n\t.beepboxEditor .trackAndMuteContainer {\n\t\twidth: 512px;\n\t}\n\t.beepboxEditor .play-pause-area {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t\talign-items: center;\n\t}\n\t.beepboxEditor .pauseButton, .beepboxEditor .playButton {\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n\t\tflex-grow: 1;\n\t\tmargin-left: 10px;\n\t}\n\t.beepboxEditor .settings-area {\n\t\twidth: 14em;\n\t}\n}\n\n/* narrow screen */\n@media (max-width: 700px) {\n\t.beepboxEditor {\n\t\tgrid-template-columns: minmax(0, 1fr);\n\t\tgrid-template-rows: min-content 6px min-content min-content;\n\t\tgrid-template-areas: "pattern-area" "." "track-area" "settings-area";\n\t\tgrid-row-gap: 0;\n\t}\n\t.beepboxEditor .settings-area {\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n\t\tgrid-template-rows: min-content min-content 1fr min-content;\n\t\tgrid-template-areas:\n\t\t\t"play-pause-area play-pause-area"\n\t\t\t"menu-area instrument-settings-area"\n\t\t\t"song-settings-area instrument-settings-area"\n\t\t\t"version-area version-area";\n\t\tgrid-column-gap: 8px;\n\t\tmargin: 0 4px;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: none;\n\t}\n\t.beepboxEditor .pattern-area {\n\t\tmax-height: 75vh;\n\t}\n\t.beepboxEditor .trackContainer {\n\t\toverflow-x: auto;\n\t}\n\t.beepboxEditor .barScrollBar {\n\t\tdisplay: none;\n\t}\n\t.beepboxEditor .play-pause-area {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tflex-grow: 1;\n\t\tmargin: 0 2px;\n\t}\n\t.beepboxEditor .pauseButton, .beepboxEditor .playButton,\n\t.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n\t\tflex-grow: 1;\n\t\tmargin: 0 2px;\n\t}\n}\n\n`));class R{static setFullScreen(t){this.h.textContent=t?this.l:this.u}}R.u="\n\t\t",R.l=`\n\t\t\t/* wide screen */\n\t\t\t@media (min-width: 701px) {\n\t\t\t\t#beepboxEditorContainer {\n\t\t\t\t\tmax-width: initial;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tmin-height: 100vh;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) 30em; /* minmax(0, 1fr) min-content; Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\n\t\t\t\t\tgrid-template-rows: minmax(481px, 1fr) min-content;\n\t\t\t\t\tgrid-template-areas: "pattern-area settings-area" "track-area track-area";\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .pattern-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .track-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .editor-widget-column {\n\t\t\t\t\tflex: 0;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area {\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\tposition: relative;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .song-settings-area {\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .settings-area {\n\t\t\t\t\twidth: 30em;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n\t\t\t\t\tgrid-template-rows: auto auto auto minmax(0, 1fr);\n\t\t\t\t\tgrid-template-areas:\n\t\t\t\t\t\t"instrument-settings-area version-area"\n\t\t\t\t\t\t"instrument-settings-area play-pause-area"\n\t\t\t\t\t\t"instrument-settings-area menu-area"\n\t\t\t\t\t\t"instrument-settings-area song-settings-area";\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .barScrollBar {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer {\n\t\t\t\t\toverflow-x: auto;\n\t\t\t\t\tscrollbar-width: auto;\n\t\t\t\t\tscrollbar-color: ${S.uiWidgetBackground} ${S.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer::-webkit-scrollbar {\n\t\t\t\t\twidth: 20px;\n\t\t\t\t\theight: 20px;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer::-webkit-scrollbar-track {\n\t\t\t\t\tbackground: ${S.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer::-webkit-scrollbar-thumb {\n\t\t\t\t\tbackground-color: ${S.uiWidgetBackground};\n\t\t\t\t\tborder: 3px solid ${S.editorBackground};\n\t\t\t\t}\n\t\t\t}\n\t\t`,R.h=document.head.appendChild(w.style({type:"text/css"}));const{button:z,div:B,p:N,h2:L}=w;class F{constructor(t,e){let i;switch(this.m=t,this.v=z({class:"cancelButton"}),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.k)},e){case"scale":i=B(L("Scale"),N("This setting limits the available pitches for adding notes. You may think that there's no point in limiting your choices, but the set of pitches you use has a strong influence on the mood and feel of your song, and these scales serve as guides to help you choose appropriate pitches. Don't worry, you can change the scale at any time, so you're not locked into it. Try making little melodies using all the available notes of a scale to get a sense for how it sounds."),N('Most of the scales have a major version, marked with a smiley face, and a minor version, marked with a sad face. Major scales tend to sound more playful or optimistic if you emphasize "tonic" notes (the brown rows in the pattern editor) at various points in your melody, whereas minor scales sound more serious or sad if you emphasize "tonic" notes.'));break;case"key":i=B(L("Song Key"),N('This setting can shift the frequency of every note in your entire song up or down to align the tonic notes (the brown rows) with the selected "key" pitch.'));break;case"tempo":i=B(L("Song Tempo"),N("This setting controls the speed of your song, measured in beats-per-minute."));break;case"reverb":i=B(L("Reverb"),N("Reverb is a kind of echo effect. You can use this slider to control the amount of reverb for instruments that enable it. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery."));break;case"rhythm":i=B(L("Rhythm"),N("This setting determines how beats are divided. The pattern editor helps you align notes to fractions of a beat based on this setting."));break;case"instrumentIndex":i=B(L("Instrument Number"),N("BeepBox can have multiple instruments per channel, but it can only play one instrument at a time in each channel. This setting determines which of the instruments should be used to play the currently selected pattern. Different patterns in the channel can use different instruments."));break;case"instrumentVolume":i=B(L("Instrument Volume"),N("This setting controls the volume of the selected instrument without affecting the volume of the other instruments. This allows you to balance the loudness of each instrument relative to each other."));break;case"pan":i=B(L("Instrument Panning"),N("If you're listening through headphones or some other stereo sound system, this controls the position of the instrument and where the sound is coming from, ranging from left to right."),N("As a rule of thumb, composers typically put lead melodies, drums, and basses in the center, and spread any other instruments to either side. If too many instruments seem like they're coming from the same place, it can feel crowded and harder to distinguish individual sounds, especially if they cover a similar pitch range."));break;case"instrumentType":i=B(L("Instrument Type"),N("BeepBox comes with many instrument presets. You can also create your own custom instruments!"),N("There are also options for copying and pasting instrument settings and for generating random instruments at the top of the instrument type menu."));break;case"filterCutoff":i=B(L("Low-Pass Filter Cutoff Frequency"),N('The lowest setting feels "muffled" or "dark", and the highest setting feels "harsh" or "bright".'),N("Most sounds include a range of frequencies from low to high. BeepBox instruments have a filter that allows the lowest frequencies to pass through at full volume, but can reduce the volume of the higher frequencies that are above a cutoff frequency. This setting controls the cutoff frequency and thus the range of higher frequencies that are reduced."),N("This cutoff setting also determines which frequency resonates when the resonance peak setting is used."));break;case"filterResonance":i=B(L("Low-Pass Filter Resonance Peak"),N("Increasing this setting emphasizes a narrow range of frequencies, based on the position of the filter cutoff setting. This can be used to imitate the resonant bodies of acoustic instruments and other interesting effects."),N("The filter preserves the volume of frequencies that are below the cutoff frequency, and reduces the volume of frequencies that are above the cutoff. If this setting is used, the filter also increases the volume of frequencies that are near the cutoff."));break;case"filterEnvelope":i=B(L("Low-Pass Filter Envelope"),N("This setting can dynamically change the filter cutoff frequency over time. Try the different options to see how they sound!"),N('The "custom" option uses the note volume as drawn in the pattern editor as the cutoff envelope.'));break;case"transition":i=B(L("Transition"),N("This setting controls how quickly notes begin and end."),N("Hard transitions start suddenly and sound like instruments that are played by hitting or plucking, whereas soft transitions start gradually and sound like instruments that are played by blowing air. Some transitions also stop suddenly, whereas others fade out slowly after the end of the note."),N('The "seamless" and "slide" transitions connect the end of a note with the start of the next note.'));break;case"chipWave":i=B(L("Chip Wave"),N("BeepBox comes with some sound waves based on classic electronic sound chips, as well as several unique waves."));break;case"chipNoise":i=B(L("Noise"),N("BeepBox comes with several basic noise sounds. These do not have any distinct musical pitch, and can be used like drums to create beats and emphasize your song's rhythm."));break;case"pulseEnvelope":i=B(L("Pulse Wave Envelope"),N("This setting can dynamically change the pulse width over time. Try the different options to see how they sound!"),N('The "custom" option uses the note volume as drawn in the pattern editor as the pulse width envelope.'));break;case"pulseWidth":i=B(L("Pulse Wave Width"),N("This setting controls the shape and sound of a pulse wave. At the minimum width, it sounds light and buzzy. At the maximum width, it is shaped like a classic square wave."));break;case"interval":i=B(L("Instrument Interval"),N('Some BeepBox instrument types can play two waves at slightly different frequencies. The difference between the frequencies is called an "interval", and this setting controls how large it is.'),N("When two similar waves play at slightly different frequencies, they move in and out of phase with each other over time as different parts of the waves line up. This creates a dynamic, shifting sound. Pianos are a common example of this kind of sound, because each piano key strikes multiple strings that are tuned to slightly different frequencies."),N('If the interval is large, then the waves can sound out-of-tune and "dissonant". If the interval is even larger, then the two frequencies can even be distinct pitches.'));break;case"chords":i=B(L("Chords"),N("When multiple notes occur at the same time, this is called a chord. Chords can be created in BeepBox's pattern editor by adding notes above or below another note."),N('This setting determines how chords are played. The standard option is "harmony" which plays all of the notes out loud simultaneously. The "strum" option is similar, but plays the notes starting at slightly different times. The "arpeggio" option is used in "chiptune" style music and plays a single tone that rapidly alternates between all of the pitches in the chord.'),N('Some BeepBox instruments have an option called "custom interval" which uses the chord notes to control the interval between the waves of a single tone. This can create strange sound effects when combined with FM modulators.'));break;case"vibrato":i=B(L("Vibrato"),N("This setting causes the frequency of a note to wobble slightly. Singers and violinists often use vibrato."));break;case"algorithm":i=B(L("FM Algorithm"),N("FM Synthesis is a mysterious but powerful technique for crafting sounds, popularized by Yamaha keyboards and the Sega Genesis/Mega Drive. It may seem confusing, but try playing around with the options until you get a feel for it, or check out some of the preset examples!"),N("This FM synthesizer uses up to four waves, numbered 1, 2, 3, and 4. Each wave may have its own frequency, volume, and volume envelope to control its effect over time."),N('There are two kinds of waves: "carrier" waves play a tone out loud, but "modulator" waves distort other waves instead. Wave 1 is always a carrier and plays a tone, but other waves may distort it. The "Algorithm" setting determines which waves are modulators, and which other waves those modulators distort. For example, "1←2" means that wave 2 modulates wave 1, and wave 1 plays out loud.'));break;case"feedbackType":i=B(L("Feedback"),N("Modulators distort in one direction (like 1←2), but you can also use the feedback setting to make any wave distort in the opposite direction (1→2), or even itself (1⟲)."));break;case"operatorFrequency":i=B(L("Operator Frequency"),N('This setting controls the frequency of an individual FM wave. The fundamental frequency (1×) is determined by the pitch of the note, and the frequency (2×) is an octave (12 semitones) above it. The frequencies with a "~" are slightly detuned and shift in and out of phase over time compared to the other frequencies.'),N('Try different combinations of a "carrier" wave and a "modulator" wave with different frequencies to get a feel for how they sound together.'));break;case"operatorVolume":i=B(L("Operator Volume"),N('This setting controls the volume of "carrier" waves, or the amount of distortion that "modulator" waves apply to other waves.'));break;case"operatorEnvelope":i=B(L("Operator Envelope"),N("This setting can dynamically change the FM wave volume over time. Try the different options to see how they sound!"),N('The "custom" option uses the note volume as drawn in the pattern editor as the FM wave envelope.'));break;case"spectrum":i=B(L("Spectrum"),N("This setting allows you to draw your own noise spectrum! This is good for making drum sounds when combined with a hard transition and a falling filter cutoff envelope."),N("If you only use certain frequencies and a soft transition, it's also possible to make howling wind sounds or even musical blown bottle sounds."),N("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"harmonics":i=B(L("Harmonics"),N("This setting allows you to design your own sound wave! Most musical waves are actually a combination of sine waves at certain frequencies, and this lets you control the volume of each sine wave individually."),N("The left side of the harmonics editor controls the sine wave volumes at lower frequencies, and the right side controls higher frequencies."));break;case"effects":i=B(L("Effects"),N("BeepBox has two special effects you can add to instruments. You can turn on either effect, or both at once."),N('Reverb is a kind of echo effect. You can use the "reverb" slider in the "Song Settings" section above to control the amount of reverb for instruments that enable it. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery.'),N("The chorus effect combines multiple copies of the instrument's sound and adds a bit of vibrato to simulate an ensemble of instruments or voices."));break;case"drumsetEnvelope":i=B(L("Drumset Envelope"),N("This setting can dynamically change the filter cutoff frequency over time. Each row in the pattern editor gets its own envelope."),N('The "custom" option uses the note volume as drawn in the pattern editor as the drumset cutoff envelope.'));break;case"drumsetSpectrum":i=B(L("Drumset Spectrum"),N("This setting allows you to draw your own noise spectrum! This is good for making drumsets. Each row in the pattern editor gets its own spectrum."),N("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;default:throw new Error("Unhandled TipPrompt type: "+e)}this.container=B({class:"prompt",style:"width: 250px;"},i,this.v),setTimeout((()=>this.v.focus())),this.v.addEventListener("click",this.k)}}function A(t,e){for(let i=0;i<t.length;i++)t[i]*=e}function H(t){if(!function(t){return!(!t||t&t-1)}(t))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(t)/Math.log(2))}function I(t,e){const i=H(e);if(e<4)throw new Error("FFT array length must be at least 4.");for(let s=i-1;s>=2;s--){const i=1<<s,n=i>>1,o=i<<1,r=2*Math.PI/o,h=Math.cos(r),a=Math.sin(r),l=2*h;for(let s=0;s<e;s+=o){const e=s,o=e+n,r=e+i,c=r+n,f=r+i,u=t[e],d=t[r];t[e]=u+d,t[o]*=2,t[r]=u-d,t[c]*=2;let m=h,p=-a,y=1,g=0;for(let i=1;i<n;i++){const s=e+i,n=r-i,o=r+i,h=f-i,a=t[s],c=t[n],u=t[o],d=t[h],v=a-c,b=u+d;t[s]=a+c,t[n]=d-u,t[o]=v*m-b*p,t[h]=b*m+v*p;const w=l*m-y,k=l*p-g;y=m,g=p,m=w,p=k}}}for(let i=0;i<e;i+=4){const e=i+1,s=i+2,n=i+3,o=t[i],r=2*t[e],h=t[s],a=2*t[n],l=o+h,c=o-h;t[i]=l+r,t[e]=l-r,t[s]=c+a,t[n]=c-a}!function(t,e){const i=H(e);if(i>16)throw new Error("FFT array length must not be greater than 2^16.");const s=16-i;for(let i=0;i<e;i++){let e;if(e=(43690&i)>>1|(21845&i)<<1,e=(52428&e)>>2|(13107&e)<<2,e=(61680&e)>>4|(3855&e)<<4,e=(e>>8|(255&e)<<8)>>s,e>i){let s=t[i];t[i]=t[e],t[e]=s}}}(t,e)}class O{constructor(){this.M=1,this.q=[void 0],this.P=0,this.S=0,this.T=0}pushFront(t){this.T>=this.M&&this.R(),this.S=this.S-1&this.P,this.q[this.S]=t,this.T++}pushBack(t){this.T>=this.M&&this.R(),this.q[this.S+this.T&this.P]=t,this.T++}popFront(){if(this.T<=0)throw new Error("No elements left to pop.");const t=this.q[this.S];return this.q[this.S]=void 0,this.S=this.S+1&this.P,this.T--,t}popBack(){if(this.T<=0)throw new Error("No elements left to pop.");this.T--;const t=this.S+this.T&this.P,e=this.q[t];return this.q[t]=void 0,e}peakFront(){if(this.T<=0)throw new Error("No elements left to pop.");return this.q[this.S]}peakBack(){if(this.T<=0)throw new Error("No elements left to pop.");return this.q[this.S+this.T-1&this.P]}count(){return this.T}set(t,e){if(t<0||t>=this.T)throw new Error("Invalid index");this.q[this.S+t&this.P]=e}get(t){if(t<0||t>=this.T)throw new Error("Invalid index");return this.q[this.S+t&this.P]}remove(t){if(t<0||t>=this.T)throw new Error("Invalid index");if(t<=this.T>>1){for(;t>0;)this.set(t,this.get(t-1)),t--;this.popFront()}else{for(t++;t<this.T;)this.set(t-1,this.get(t)),t++;this.popBack()}}R(){if(this.M>=1073741824)throw new Error("Capacity too big.");this.M=this.M<<1;const t=this.q,e=new Array(this.M),i=0|this.T,s=0|this.S;for(let n=0;n<i;n++)e[n]=t[s+n&this.P];for(let t=i;t<this.M;t++)e[t]=void 0;this.S=0,this.q=e,this.P=this.M-1}}const U=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],$=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0];class _{constructor(t,e,i){this.N=[],this.L=0;for(let s=e;s<i;s++){const e=$[t.charCodeAt(s)];this.N.push(e>>5&1),this.N.push(e>>4&1),this.N.push(e>>3&1),this.N.push(e>>2&1),this.N.push(e>>1&1),this.N.push(1&e)}}read(t){let e=0;for(;t>0;)e<<=1,e+=this.N[this.L++],t--;return e}readLongTail(t,e){let i=t,s=e;for(;this.N[this.L++];)i+=1<<s,s++;for(;s>0;)s--,this.N[this.L++]&&(i+=1<<s);return i}readPartDuration(){return this.readLongTail(1,3)}readLegacyPartDuration(){return this.readLongTail(1,2)}readPinCount(){return this.readLongTail(1,0)}readPitchInterval(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)}}class D{constructor(){this.H=0,this.N=[]}clear(){this.H=0}write(t,e){for(t--;t>=0;)this.N[this.H++]=e>>>t&1,t--}writeLongTail(t,e,i){if(i<t)throw new Error("value out of bounds");i-=t;let s=e;for(;i>=1<<s;)this.N[this.H++]=1,i-=1<<s,s++;for(this.N[this.H++]=0;s>0;)s--,this.N[this.H++]=i>>>s&1}writePartDuration(t){this.writeLongTail(1,3,t)}writePinCount(t){this.writeLongTail(1,0,t)}writePitchInterval(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))}concat(t){for(let e=0;e<t.H;e++)this.N[this.H++]=t.N[e]}encodeBase64(t){for(let e=0;e<this.H;e+=6){const i=this.N[e]<<5|this.N[e+1]<<4|this.N[e+2]<<3|this.N[e+3]<<2|this.N[e+4]<<1|this.N[e+5];t.push(U[i])}return t}lengthBase64(){return Math.ceil(this.H/6)}}function W(t,e,i){return{interval:t,time:e,volume:i}}function j(t,e,i){return i<=(e-=1)?i>=t?i:t:e}function V(t,e,i){if(t<=i&&i<=e)return i;throw new Error(`Value ${i} not in range [${t}, ${e}]`)}class G{constructor(t,e,i,s,n=!1){this.pitches=[t],this.pins=[W(0,0,s),W(0,i-e,n?0:s)],this.start=e,this.end=i}pickMainInterval(){let t=0,e=0;for(let i=1;i<this.pins.length;i++){const s=this.pins[i-1],n=this.pins[i];if(s.interval==n.interval){const i=n.time-s.time;t<i&&(t=i,e=s.interval)}}if(0==t){let t=0;for(let i=0;i<this.pins.length;i++){const s=this.pins[i];t<s.volume&&(t=s.volume,e=s.interval)}}return e}clone(){const t=new G(-1,this.start,this.end,3);t.pitches=this.pitches.concat(),t.pins=[];for(const e of this.pins)t.pins.push(W(e.interval,e.time,e.volume));return t}}class K{constructor(){this.notes=[],this.instrument=0}cloneNotes(){const t=[];for(const e of this.notes)t.push(e.clone());return t}reset(){this.notes.length=0,this.instrument=0}}class J{constructor(t){this.frequency=0,this.amplitude=0,this.envelope=0,this.reset(t)}reset(t){this.frequency=0,this.amplitude=t<=1?e.operatorAmplitudeMax:0,this.envelope=0==t?0:1}}class Y{constructor(t){this.spectrum=[],this.I=null,this.O=!1,this.reset(t)}reset(t){for(let i=0;i<e.spectrumControlPoints;i++)if(t)this.spectrum[i]=Math.round(e.spectrumMax*(1/Math.sqrt(1+i/3)));else{const t=0==i||7==i||11==i||14==i||16==i||18==i||21==i||23==i||i>=25;this.spectrum[i]=t?Math.max(0,Math.round(e.spectrumMax*(1-i/30))):0}this.O=!1}markCustomWaveDirty(){this.O=!1}getCustomWave(t){if(!this.O||null==this.I){let s=e.chipNoiseLength;null!=this.I&&this.I.length==s+1||(this.I=new Float32Array(s+1));const o=this.I;for(let t=0;t<s;t++)o[t]=0;const r=14,h=.25,a=[0,1/7,Math.log(5/4)/Math.LN2,3/7,Math.log(1.5)/Math.LN2,5/7,6/7];function i(i){return t+Math.floor(i/e.spectrumControlPointsPerOctave)+a[(i+e.spectrumControlPointsPerOctave)%e.spectrumControlPointsPerOctave]}let l=1;for(let t=0;t<e.spectrumControlPoints+1;t++){const s=t<=0?0:this.spectrum[t-1],a=t>=e.spectrumControlPoints?this.spectrum[e.spectrumControlPoints-1]:this.spectrum[t],c=i(t-1);let f=i(t);t>=e.spectrumControlPoints&&(f=r+(f-r)*h),0==s&&0==a||(l+=.02*n(o,c,f,s/e.spectrumMax,a/e.spectrumMax,-.5))}this.spectrum[e.spectrumControlPoints-1]>0&&(l+=.02*n(o,r+(i(e.spectrumControlPoints)-r)*h,r,this.spectrum[e.spectrumControlPoints-1]/e.spectrumMax,0,-.5)),I(o,s),A(o,5/(Math.sqrt(s)*Math.pow(l,.75))),o[s]=o[0],this.O=!0}return this.I}}class Z{constructor(){this.harmonics=[],this.I=null,this.O=!1,this.reset()}reset(){for(let t=0;t<e.harmonicsControlPoints;t++)this.harmonics[t]=0;this.harmonics[0]=e.harmonicsMax,this.harmonics[3]=e.harmonicsMax,this.harmonics[6]=e.harmonicsMax,this.O=!1}markCustomWaveDirty(){this.O=!1}getCustomWave(){if(!this.O||null==this.I){let t=e.harmonicsWavelength;const i=s(0);null!=this.I&&this.I.length==t+1||(this.I=new Float32Array(t+1));const n=this.I;for(let e=0;e<t;e++)n[e]=0;const o=-.25;let r=1;for(let s=0;s<e.harmonicsRendered;s++){const h=s+1;let a=s<e.harmonicsControlPoints?this.harmonics[s]:this.harmonics[e.harmonicsControlPoints-1];s>=e.harmonicsControlPoints&&(a*=1-(s-e.harmonicsControlPoints)/(e.harmonicsRendered-e.harmonicsControlPoints));const l=a/e.harmonicsMax;let c=Math.pow(2,a-e.harmonicsMax+1)*Math.sqrt(l);s<e.harmonicsControlPoints&&(r+=c),c*=Math.pow(h,o),c*=i[s+589],n[t-h]=c}I(n,t);const h=1/Math.pow(r,.7);let a=0,l=0;for(let t=0;t<n.length;t++)a+=l,l=n[t]*h,n[t]=a;n[t]=n[0],this.O=!0}return this.I}}class Q{constructor(t){this.type=0,this.preset=0,this.chipWave=2,this.chipNoise=1,this.filterCutoff=6,this.filterResonance=0,this.filterEnvelope=1,this.transition=1,this.vibrato=0,this.interval=0,this.effects=0,this.chord=1,this.volume=0,this.pan=e.panCenter,this.pulseWidth=e.pulseWidthRange-1,this.pulseEnvelope=1,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1,this.operators=[],this.harmonicsWave=new Z,this.drumsetEnvelopes=[],this.drumsetSpectrumWaves=[],this.spectrumWave=new Y(t);for(let t=0;t<e.operatorCount;t++)this.operators[t]=new J(t);for(let t=0;t<e.drumCount;t++)this.drumsetEnvelopes[t]=e.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[t]=new Y(!0)}setTypeAndReset(t,i){switch(this.type=t,this.preset=t,this.volume=0,this.pan=e.panCenter,t){case 0:this.chipWave=2,this.filterCutoff=6,this.filterResonance=0,this.filterEnvelope=e.envelopes.dictionary.steady.index,this.transition=1,this.vibrato=0,this.interval=0,this.effects=1,this.chord=2;break;case 1:this.transition=1,this.vibrato=0,this.effects=1,this.chord=3,this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=1,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=e.envelopes.dictionary.steady.index;for(let t=0;t<this.operators.length;t++)this.operators[t].reset(t);break;case 2:this.chipNoise=1,this.transition=1,this.effects=0,this.chord=2,this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=e.envelopes.dictionary.steady.index;break;case 3:this.transition=1,this.effects=1,this.chord=0,this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=e.envelopes.dictionary.steady.index,this.spectrumWave.reset(i);break;case 4:this.effects=0;for(let t=0;t<e.drumCount;t++)this.drumsetEnvelopes[t]=e.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[t].reset(i);break;case 5:this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=e.envelopes.dictionary.steady.index,this.transition=1,this.vibrato=0,this.interval=0,this.effects=1,this.chord=0,this.harmonicsWave.reset();break;case 6:this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=e.envelopes.dictionary.steady.index,this.transition=1,this.vibrato=0,this.interval=0,this.effects=1,this.chord=2,this.pulseWidth=e.pulseWidthRange-1,this.pulseEnvelope=e.envelopes.dictionary["twang 2"].index;break;default:throw new Error("Unrecognized instrument type: "+t)}}toJsonObject(){const t={type:e.instrumentTypeNames[this.type],volume:20*(5-this.volume),pan:100*(this.pan-e.panCenter)/e.panCenter,effects:e.effectsNames[this.effects]};if(this.preset!=this.type&&(t.preset=this.preset),4!=this.type&&(t.transition=e.transitions[this.transition].name,t.chord=this.getChord().name,t.filterCutoffHz=Math.round(e.filterCutoffMaxHz*Math.pow(2,this.getFilterCutoffOctaves())),t.filterResonance=Math.round(100*this.filterResonance/(e.filterResonanceRange-1)),t.filterEnvelope=this.getFilterEnvelope().name),2==this.type)t.wave=e.chipNoises[this.chipNoise].name;else if(3==this.type){t.spectrum=[];for(let i=0;i<e.spectrumControlPoints;i++)t.spectrum[i]=Math.round(100*this.spectrumWave.spectrum[i]/e.spectrumMax)}else if(4==this.type){t.drums=[];for(let i=0;i<e.drumCount;i++){const s=[];for(let t=0;t<e.spectrumControlPoints;t++)s[t]=Math.round(100*this.drumsetSpectrumWaves[i].spectrum[t]/e.spectrumMax);t.drums[i]={filterEnvelope:this.getDrumsetEnvelope(i).name,spectrum:s}}}else if(0==this.type)t.wave=e.chipWaves[this.chipWave].name,t.interval=e.intervals[this.interval].name,t.vibrato=e.vibratos[this.vibrato].name;else if(6==this.type)t.pulseWidth=Math.round(50*Math.pow(.5,.5*(e.pulseWidthRange-this.pulseWidth-1))*32)/32,t.pulseEnvelope=e.envelopes[this.pulseEnvelope].name,t.vibrato=e.vibratos[this.vibrato].name;else if(5==this.type){t.interval=e.intervals[this.interval].name,t.vibrato=e.vibratos[this.vibrato].name,t.harmonics=[];for(let i=0;i<e.harmonicsControlPoints;i++)t.harmonics[i]=Math.round(100*this.harmonicsWave.harmonics[i]/e.harmonicsMax)}else{if(1!=this.type)throw new Error("Unrecognized instrument type");{const i=[];for(const t of this.operators)i.push({frequency:e.operatorFrequencies[t.frequency].name,amplitude:t.amplitude,envelope:e.envelopes[t.envelope].name});t.vibrato=e.vibratos[this.vibrato].name,t.algorithm=e.algorithms[this.algorithm].name,t.feedbackType=e.feedbacks[this.feedbackType].name,t.feedbackAmplitude=this.feedbackAmplitude,t.feedbackEnvelope=e.envelopes[this.feedbackEnvelope].name,t.operators=i}}return t}fromJsonObject(t,i){null==t&&(t={});let s=e.instrumentTypeNames.indexOf(t.type);-1==s&&(s=i?2:0),this.setTypeAndReset(s,i),null!=t.preset&&(this.preset=t.preset>>>0),null!=t.volume?this.volume=j(0,e.volumeRange,Math.round(5-(0|t.volume)/20)):this.volume=0,null!=t.pan?this.pan=j(0,e.panMax+1,Math.round(e.panCenter+(0|t.pan)*e.panCenter/100)):this.pan=e.panCenter;const n={binary:0,sudden:1,smooth:2},o=t.transition||t.envelope;if(this.transition=null!=n[o]?n[o]:e.transitions.findIndex((t=>t.name==o)),-1==this.transition&&(this.transition=1),this.effects=e.effectsNames.indexOf(t.effects),-1==this.effects&&(this.effects=2==this.type?0:1),null!=t.filterCutoffHz?this.filterCutoff=j(0,e.filterCutoffRange,Math.round(e.filterCutoffRange-1+2*Math.log((0|t.filterCutoffHz)/e.filterCutoffMaxHz)/Math.LN2)):this.filterCutoff=0==this.type?6:10,null!=t.filterResonance?this.filterResonance=j(0,e.filterResonanceRange,Math.round((e.filterResonanceRange-1)*(0|t.filterResonance)/100)):this.filterResonance=0,this.filterEnvelope=e.envelopes.findIndex((e=>e.name==t.filterEnvelope)),-1==this.filterEnvelope&&(this.filterEnvelope=e.envelopes.dictionary.steady.index),null!=t.filter){const e=[10,6,3,0,8,5,2],i=[1,1,1,1,18,19,20],s=["none","bright","medium","soft","decay bright","decay medium","decay soft"],n={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};let o=null!=n[t.filter]?n[t.filter]:s.indexOf(t.filter);-1==o&&(o=0),this.filterCutoff=e[o],this.filterEnvelope=i[o],this.filterResonance=0}const r=["none","vibrato light","vibrato delayed","vibrato heavy"];if(2==this.type)this.chipNoise=e.chipNoises.findIndex((e=>e.name==t.wave)),-1==this.chipNoise&&(this.chipNoise=1),this.chord=e.chords.findIndex((e=>e.name==t.chord)),-1==this.chord&&(this.chord=2);else if(3==this.type){if(null!=t.spectrum)for(let i=0;i<e.spectrumControlPoints;i++)this.spectrumWave.spectrum[i]=Math.max(0,Math.min(e.spectrumMax,Math.round(e.spectrumMax*+t.spectrum[i]/100)));this.chord=e.chords.findIndex((e=>e.name==t.chord)),-1==this.chord&&(this.chord=0)}else if(4==this.type){if(null!=t.drums)for(let i=0;i<e.drumCount;i++){const s=t.drums[i];if(null!=s&&(null!=s.filterEnvelope&&(this.drumsetEnvelopes[i]=e.envelopes.findIndex((t=>t.name==s.filterEnvelope)),-1==this.drumsetEnvelopes[i]&&(this.drumsetEnvelopes[i]=e.envelopes.dictionary["twang 2"].index)),null!=s.spectrum))for(let t=0;t<e.spectrumControlPoints;t++)this.drumsetSpectrumWaves[i].spectrum[t]=Math.max(0,Math.min(e.spectrumMax,Math.round(e.spectrumMax*+s.spectrum[t]/100)))}}else if(5==this.type){if(null!=t.harmonics)for(let i=0;i<e.harmonicsControlPoints;i++)this.harmonicsWave.harmonics[i]=Math.max(0,Math.min(e.harmonicsMax,Math.round(e.harmonicsMax*+t.harmonics[i]/100)));null!=t.interval&&(this.interval=e.intervals.findIndex((e=>e.name==t.interval)),-1==this.interval&&(this.interval=0)),null!=t.vibrato&&(this.vibrato=e.vibratos.findIndex((e=>e.name==t.vibrato)),-1==this.vibrato&&(this.vibrato=0)),this.chord=e.chords.findIndex((e=>e.name==t.chord)),-1==this.chord&&(this.chord=0)}else if(6==this.type)null!=t.pulseWidth?this.pulseWidth=j(0,e.pulseWidthRange,Math.round(Math.log(+t.pulseWidth/50)/Math.LN2/.5-1+8)):this.pulseWidth=e.pulseWidthRange-1,null!=t.pulseEnvelope&&(this.pulseEnvelope=e.envelopes.findIndex((e=>e.name==t.pulseEnvelope)),-1==this.pulseEnvelope&&(this.pulseEnvelope=e.envelopes.dictionary.steady.index)),null!=t.vibrato&&(this.vibrato=e.vibratos.findIndex((e=>e.name==t.vibrato)),-1==this.vibrato&&(this.vibrato=0)),this.chord=e.chords.findIndex((e=>e.name==t.chord)),-1==this.chord&&(this.chord=0);else if(0==this.type){const i={triangle:1,square:2,"pulse wide":3,"pulse narrow":4,sawtooth:5,"double saw":6,"double pulse":7,spiky:8,plateau:0};if(this.chipWave=null!=i[t.wave]?i[t.wave]:e.chipWaves.findIndex((e=>e.name==t.wave)),-1==this.chipWave&&(this.chipWave=1),null!=t.interval)this.interval=e.intervals.findIndex((e=>e.name==t.interval)),-1==this.interval&&(this.interval=0);else if(null!=t.chorus){const i={fifths:5,octaves:6};this.interval=null!=i[t.chorus]?i[t.chorus]:e.intervals.findIndex((e=>e.name==t.chorus)),-1==this.interval&&(this.interval=0)}null!=t.vibrato?(this.vibrato=e.vibratos.findIndex((e=>e.name==t.vibrato)),-1==this.vibrato&&(this.vibrato=0)):null!=t.effect&&(this.vibrato=r.indexOf(t.effect),-1==this.vibrato&&(this.vibrato=0)),this.chord=e.chords.findIndex((e=>e.name==t.chord)),-1==this.chord&&(this.chord=2),"custom harmony"==t.chorus&&(this.interval=2,this.chord=3)}else{if(1!=this.type)throw new Error("Unrecognized instrument type.");{null!=t.vibrato?(this.vibrato=e.vibratos.findIndex((e=>e.name==t.vibrato)),-1==this.vibrato&&(this.vibrato=0)):null!=t.effect&&(this.vibrato=r.indexOf(t.effect),-1==this.vibrato&&(this.vibrato=0)),this.chord=e.chords.findIndex((e=>e.name==t.chord)),-1==this.chord&&(this.chord=3),this.algorithm=e.algorithms.findIndex((e=>e.name==t.algorithm)),-1==this.algorithm&&(this.algorithm=0),this.feedbackType=e.feedbacks.findIndex((e=>e.name==t.feedbackType)),-1==this.feedbackType&&(this.feedbackType=0),null!=t.feedbackAmplitude?this.feedbackAmplitude=j(0,e.operatorAmplitudeMax+1,0|t.feedbackAmplitude):this.feedbackAmplitude=0;const i={"pluck 1":6,"pluck 2":7,"pluck 3":8};this.feedbackEnvelope=null!=i[t.feedbackEnvelope]?i[t.feedbackEnvelope]:e.envelopes.findIndex((e=>e.name==t.feedbackEnvelope)),-1==this.feedbackEnvelope&&(this.feedbackEnvelope=0);for(let s=0;s<e.operatorCount;s++){const n=this.operators[s];let o=void 0;t.operators&&(o=t.operators[s]),null==o&&(o={}),n.frequency=e.operatorFrequencies.findIndex((t=>t.name==o.frequency)),-1==n.frequency&&(n.frequency=0),null!=o.amplitude?n.amplitude=j(0,e.operatorAmplitudeMax+1,0|o.amplitude):n.amplitude=0,n.envelope=null!=i[o.envelope]?i[o.envelope]:e.envelopes.findIndex((t=>t.name==o.envelope)),-1==n.envelope&&(n.envelope=0)}}}}static frequencyFromPitch(t){return 440*Math.pow(2,(t-69)/12)}static drumsetIndexReferenceDelta(t){return Q.frequencyFromPitch(e.spectrumBasePitch+6*t)/44100}static U(t){return 15+Math.log(Q.drumsetIndexReferenceDelta(t))/Math.LN2}warmUp(){if(2==this.type)s(this.chipNoise,I,A);else if(5==this.type)this.harmonicsWave.getCustomWave();else if(3==this.type)this.spectrumWave.getCustomWave(8);else if(4==this.type)for(let t=0;t<e.drumCount;t++)this.drumsetSpectrumWaves[t].getCustomWave(Q.U(t))}getDrumWave(){if(2==this.type)return s(this.chipNoise,I,A);if(3==this.type)return this.spectrumWave.getCustomWave(8);throw new Error("Unhandled instrument type in getDrumWave")}getDrumsetWave(t){if(4==this.type)return this.drumsetSpectrumWaves[t].getCustomWave(Q.U(t));throw new Error("Unhandled instrument type in getDrumWave")}getTransition(){return 4==this.type?e.transitions.dictionary["hard fade"]:e.transitions[this.transition]}getChord(){return 4==this.type?e.chords.dictionary.harmony:e.chords[this.chord]}getFilterCutoffOctaves(){return 4==this.type?0:.5*(this.filterCutoff-(e.filterCutoffRange-1))}getFilterIsFirstOrder(){return 4!=this.type&&0==this.filterResonance}getFilterResonance(){return 4==this.type?1:this.filterResonance}getFilterEnvelope(){if(4==this.type)throw new Error("Can't getFilterEnvelope() for drumset.");return e.envelopes[this.filterEnvelope]}getDrumsetEnvelope(t){if(4!=this.type)throw new Error("Can't getDrumsetEnvelope() for non-drumset.");return e.envelopes[this.drumsetEnvelopes[t]]}}class X{constructor(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[],this.muted=!1}}class tt{constructor(t){this.channels=[],null!=t?this.fromBase64String(t):this.initToDefault(!0)}getChannelCount(){return this.pitchChannelCount+this.noiseChannelCount}getChannelIsNoise(t){return t>=this.pitchChannelCount}initToDefault(t=!0){if(this.scale=0,this.key=0,this.loopStart=0,this.loopLength=4,this.tempo=150,this.reverb=0,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.rhythm=1,this.instrumentsPerChannel=1,t){this.pitchChannelCount=3,this.noiseChannelCount=1;for(let t=0;t<this.getChannelCount();t++){this.channels.length<=t&&(this.channels[t]=new X);const e=this.channels[t];e.octave=3-t;for(let t=0;t<this.patternsPerChannel;t++)e.patterns.length<=t?e.patterns[t]=new K:e.patterns[t].reset();e.patterns.length=this.patternsPerChannel;const i=t>=this.pitchChannelCount;for(let t=0;t<this.instrumentsPerChannel;t++)e.instruments.length<=t&&(e.instruments[t]=new Q(i)),e.instruments[t].setTypeAndReset(i?2:0,i);e.instruments.length=this.instrumentsPerChannel;for(let t=0;t<this.barCount;t++)e.bars[t]=t<4?1:0;e.bars.length=this.barCount}this.channels.length=this.getChannelCount()}}toBase64String(){let t,i=[];i.push(U[tt.$]),i.push(110,U[this.pitchChannelCount],U[this.noiseChannelCount]),i.push(115,U[this.scale]),i.push(107,U[this.key]),i.push(108,U[this.loopStart>>6],U[63&this.loopStart]),i.push(101,U[this.loopLength-1>>6],U[this.loopLength-1&63]),i.push(116,U[this.tempo>>6],U[63&this.tempo]),i.push(109,U[this.reverb]),i.push(97,U[this.beatsPerBar-1]),i.push(103,U[this.barCount-1>>6],U[this.barCount-1&63]),i.push(106,U[this.patternsPerChannel-1>>6],U[this.patternsPerChannel-1&63]),i.push(105,U[this.instrumentsPerChannel-1]),i.push(114,U[this.rhythm]),i.push(111);for(let t=0;t<this.getChannelCount();t++)i.push(U[this.channels[t].octave]);for(let t=0;t<this.getChannelCount();t++)for(let s=0;s<this.instrumentsPerChannel;s++){const n=this.channels[t].instruments[s];if(i.push(84,U[n.type]),i.push(118,U[n.volume]),i.push(76,U[n.pan]),i.push(117,U[n.preset>>6],U[63&n.preset]),i.push(113,U[n.effects]),4!=n.type&&(i.push(100,U[n.transition]),i.push(102,U[n.filterCutoff]),i.push(121,U[n.filterResonance]),i.push(122,U[n.filterEnvelope]),i.push(67,U[n.chord])),0==n.type)i.push(119,U[n.chipWave]),i.push(99,U[n.vibrato]),i.push(104,U[n.interval]);else if(1==n.type){i.push(99,U[n.vibrato]),i.push(65,U[n.algorithm]),i.push(70,U[n.feedbackType]),i.push(66,U[n.feedbackAmplitude]),i.push(86,U[n.feedbackEnvelope]),i.push(81);for(let t=0;t<e.operatorCount;t++)i.push(U[n.operators[t].frequency]);i.push(80);for(let t=0;t<e.operatorCount;t++)i.push(U[n.operators[t].amplitude]);i.push(69);for(let t=0;t<e.operatorCount;t++)i.push(U[n.operators[t].envelope])}else if(2==n.type)i.push(119,U[n.chipNoise]);else if(3==n.type){i.push(83);const t=new D;for(let i=0;i<e.spectrumControlPoints;i++)t.write(e.spectrumControlPointBits,n.spectrumWave.spectrum[i]);t.encodeBase64(i)}else if(4==n.type){i.push(122);for(let t=0;t<e.drumCount;t++)i.push(U[n.drumsetEnvelopes[t]]);i.push(83);const t=new D;for(let i=0;i<e.drumCount;i++)for(let s=0;s<e.spectrumControlPoints;s++)t.write(e.spectrumControlPointBits,n.drumsetSpectrumWaves[i].spectrum[s]);t.encodeBase64(i)}else if(5==n.type){i.push(99,U[n.vibrato]),i.push(104,U[n.interval]),i.push(72);const t=new D;for(let i=0;i<e.harmonicsControlPoints;i++)t.write(e.harmonicsControlPointBits,n.harmonicsWave.harmonics[i]);t.encodeBase64(i)}else{if(6!=n.type)throw new Error("Unknown instrument type.");i.push(99,U[n.vibrato]),i.push(87,U[n.pulseWidth],U[n.pulseEnvelope])}}i.push(98),t=new D;let s=0;for(;1<<s<this.patternsPerChannel+1;)s++;for(let e=0;e<this.getChannelCount();e++)for(let i=0;i<this.barCount;i++)t.write(s,this.channels[e].bars[i]);t.encodeBase64(i),i.push(112),t=new D;const n=new D;let o=0;for(;1<<o<this.instrumentsPerChannel;)o++;for(let i=0;i<this.getChannelCount();i++){const s=this.getChannelIsNoise(i),r=s?0:12*this.channels[i].octave;let h=(s?4:12)+r;const a=s?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],l=[];for(let t=0;t<a.length;t++)a[t]+=r;for(const s of this.channels[i].patterns)if(t.write(o,s.instrument),s.notes.length>0){t.write(1,1);let i=0;for(const o of s.notes){o.start>i&&(t.write(2,0),t.writePartDuration(o.start-i)),n.clear();for(let t=1;t<o.pitches.length;t++)n.write(1,1);o.pitches.length<e.maxChordSize&&n.write(1,0),n.writePinCount(o.pins.length-1),n.write(2,o.pins[0].volume);let s=0,r=o.pitches[0],c=r;const f=[];for(let t=1;t<o.pins.length;t++){const e=o.pins[t],i=r+e.interval;c!=i?(n.write(1,1),f.push(i),c=i):n.write(1,0),n.writePartDuration(e.time-s),s=e.time,n.write(2,e.volume)}const u=String.fromCharCode.apply(null,n.encodeBase64([])),d=l.indexOf(u);-1==d?(t.write(2,1),t.concat(n)):(t.write(1,1),t.writeLongTail(0,0,d),l.splice(d,1)),l.unshift(u),l.length>10&&l.pop();const m=o.pitches.concat(f);for(let e=0;e<m.length;e++){const i=m[e],s=a.indexOf(i);if(-1==s){let e=0,s=h;if(s<i)for(;s!=i;)s++,-1==a.indexOf(s)&&e++;else for(;s!=i;)s--,-1==a.indexOf(s)&&e--;t.write(1,0),t.writePitchInterval(e)}else t.write(1,1),t.write(3,s),a.splice(s,1);a.unshift(i),a.length>8&&a.pop(),h=e==o.pitches.length-1?o.pitches[0]:i}i=o.end}i<this.beatsPerBar*e.partsPerBeat&&(t.write(2,0),t.writePartDuration(this.beatsPerBar*e.partsPerBeat-i))}else t.write(1,0)}let r=t.lengthBase64(),h=[];for(;r>0;)h.unshift(U[63&r]),r>>=6;i.push(U[h.length]),Array.prototype.push.apply(i,h),t.encodeBase64(i);const a=64e3;if(i.length<a)return String.fromCharCode.apply(null,i);{let t="";for(let e=0;e<i.length;e+=a)t+=String.fromCharCode.apply(null,i.slice(e,e+a));return t}}fromBase64String(t){if(null==t||""==t)return void this.initToDefault(!0);let i=0;for(;t.charCodeAt(i)<=32;)i++;if(35==t.charCodeAt(i)&&i++,123==t.charCodeAt(i))return void this.fromJsonObject(JSON.parse(0==i?t:t.substring(i)));const s=$[t.charCodeAt(i++)];if(-1==s||s>tt.$||s<tt._)return;const n=s<3,o=s<4,r=s<5,h=s<6,a=s<7,l=s<8;if(this.initToDefault(h),n){for(const t of this.channels)t.instruments[0].transition=0;this.channels[3].instruments[0].chipNoise=0}let c,f=0,u=-1;for(;i<t.length;)switch(c=t.charCodeAt(i++)){case 110:this.pitchChannelCount=$[t.charCodeAt(i++)],this.noiseChannelCount=$[t.charCodeAt(i++)],this.pitchChannelCount=V(e.pitchChannelCountMin,e.pitchChannelCountMax,this.pitchChannelCount),this.noiseChannelCount=V(e.noiseChannelCountMin,e.noiseChannelCountMax,this.noiseChannelCount);for(let t=this.channels.length;t<this.getChannelCount();t++)this.channels[t]=new X;this.channels.length=this.getChannelCount();break;case 115:this.scale=$[t.charCodeAt(i++)],n&&10==this.scale&&(this.scale=11);break;case 107:this.key=j(0,e.keys.length,a?11-$[t.charCodeAt(i++)]:$[t.charCodeAt(i++)]);break;case 108:this.loopStart=r?$[t.charCodeAt(i++)]:($[t.charCodeAt(i++)]<<6)+$[t.charCodeAt(i++)];break;case 101:this.loopLength=r?$[t.charCodeAt(i++)]:($[t.charCodeAt(i++)]<<6)+$[t.charCodeAt(i++)]+1;break;case 116:this.tempo=o?[95,120,151,190][$[t.charCodeAt(i++)]]:a?[88,95,103,111,120,130,140,151,163,176,190,206,222,240,259][$[t.charCodeAt(i++)]]:$[t.charCodeAt(i++)]<<6|$[t.charCodeAt(i++)],this.tempo=j(e.tempoMin,e.tempoMax+1,this.tempo);break;case 109:this.reverb=$[t.charCodeAt(i++)],this.reverb=j(0,e.reverbRange,this.reverb);break;case 97:this.beatsPerBar=n?[6,7,8,9,10][$[t.charCodeAt(i++)]]:$[t.charCodeAt(i++)]+1,this.beatsPerBar=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,this.beatsPerBar));break;case 103:{const s=($[t.charCodeAt(i++)]<<6)+$[t.charCodeAt(i++)]+1;this.barCount=V(e.barCountMin,e.barCountMax,s);for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].bars.length;e<this.barCount;e++)this.channels[t].bars[e]=1;this.channels[t].bars.length=this.barCount}}break;case 106:{let s;s=l?$[t.charCodeAt(i++)]+1:($[t.charCodeAt(i++)]<<6)+$[t.charCodeAt(i++)]+1,this.patternsPerChannel=V(1,e.barCountMax,s);for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].patterns.length;e<this.patternsPerChannel;e++)this.channels[t].patterns[e]=new K;this.channels[t].patterns.length=this.patternsPerChannel}}break;case 105:{const s=$[t.charCodeAt(i++)]+1;this.instrumentsPerChannel=V(e.instrumentsPerChannelMin,e.instrumentsPerChannelMax,s);for(let t=0;t<this.getChannelCount();t++){const e=t>=this.pitchChannelCount;for(let i=this.channels[t].instruments.length;i<this.instrumentsPerChannel;i++)this.channels[t].instruments[i]=new Q(e);if(this.channels[t].instruments.length=this.instrumentsPerChannel,h)for(let i=0;i<this.instrumentsPerChannel;i++)this.channels[t].instruments[i].setTypeAndReset(e?2:0,e)}}break;case 114:this.rhythm=$[t.charCodeAt(i++)];break;case 111:if(n){const s=$[t.charCodeAt(i++)];this.channels[s].octave=j(0,e.scrollableOctaves+1,$[t.charCodeAt(i++)])}else for(let s=0;s<this.getChannelCount();s++)this.channels[s].octave=j(0,e.scrollableOctaves+1,$[t.charCodeAt(i++)]);break;case 84:{u++,u>=this.instrumentsPerChannel&&(f++,u=0),V(0,this.channels.length-1,f);const e=this.channels[f].instruments[u],s=V(0,6,$[t.charCodeAt(i++)]);e.setTypeAndReset(s,f>=this.pitchChannelCount)}break;case 117:{const e=$[t.charCodeAt(i++)]<<6|$[t.charCodeAt(i++)];this.channels[f].instruments[u].preset=e}break;case 119:if(n){const s=[1,2,3,4,5,6,7,8,0],n=$[t.charCodeAt(i++)];this.channels[n].instruments[0].chipWave=j(0,e.chipWaves.length,0|s[$[t.charCodeAt(i++)]])}else if(h){const s=[1,2,3,4,5,6,7,8,0];for(let n=0;n<this.getChannelCount();n++)for(let o=0;o<this.instrumentsPerChannel;o++)n>=this.pitchChannelCount?this.channels[n].instruments[o].chipNoise=j(0,e.chipNoises.length,$[t.charCodeAt(i++)]):this.channels[n].instruments[o].chipWave=j(0,e.chipWaves.length,0|s[$[t.charCodeAt(i++)]])}else if(a){const s=[1,2,3,4,5,6,7,8,0];f>=this.pitchChannelCount?this.channels[f].instruments[u].chipNoise=j(0,e.chipNoises.length,$[t.charCodeAt(i++)]):this.channels[f].instruments[u].chipWave=j(0,e.chipWaves.length,0|s[$[t.charCodeAt(i++)]])}else f>=this.pitchChannelCount?this.channels[f].instruments[u].chipNoise=j(0,e.chipNoises.length,$[t.charCodeAt(i++)]):this.channels[f].instruments[u].chipWave=j(0,e.chipWaves.length,$[t.charCodeAt(i++)]);break;case 102:if(a){const e=[10,6,3,0,8,5,2],s=[1,1,1,1,18,19,20],o=["none","bright","medium","soft","decay bright","decay medium","decay soft"];if(n){const n=$[t.charCodeAt(i++)],r=this.channels[n].instruments[0],h=[1,3,4,5][j(0,o.length,$[t.charCodeAt(i++)])];r.filterCutoff=e[h],r.filterEnvelope=s[h],r.filterResonance=0}else if(h)for(let n=0;n<this.getChannelCount();n++)for(let r=0;r<this.instrumentsPerChannel;r++){const h=this.channels[n].instruments[r],a=j(0,o.length,$[t.charCodeAt(i++)]+1);n<this.pitchChannelCount?(h.filterCutoff=e[a],h.filterEnvelope=s[a],h.filterResonance=0):(h.filterCutoff=10,h.filterEnvelope=1,h.filterResonance=0)}else{const n=j(0,o.length,$[t.charCodeAt(i++)]),r=this.channels[f].instruments[u];r.filterCutoff=e[n],r.filterEnvelope=s[n],r.filterResonance=0}}else{this.channels[f].instruments[u].filterCutoff=j(0,e.filterCutoffRange,$[t.charCodeAt(i++)])}break;case 121:this.channels[f].instruments[u].filterResonance=j(0,e.filterResonanceRange,$[t.charCodeAt(i++)]);break;case 122:{const s=this.channels[f].instruments[u];if(4==s.type)for(let n=0;n<e.drumCount;n++)s.drumsetEnvelopes[n]=j(0,e.envelopes.length,$[t.charCodeAt(i++)]);else s.filterEnvelope=j(0,e.envelopes.length,$[t.charCodeAt(i++)])}break;case 87:{const s=this.channels[f].instruments[u];s.pulseWidth=j(0,e.pulseWidthRange,$[t.charCodeAt(i++)]),s.pulseEnvelope=j(0,e.envelopes.length,$[t.charCodeAt(i++)])}break;case 100:if(n){const s=$[t.charCodeAt(i++)];this.channels[s].instruments[0].transition=j(0,e.transitions.length,$[t.charCodeAt(i++)])}else if(h)for(let s=0;s<this.getChannelCount();s++)for(let n=0;n<this.instrumentsPerChannel;n++)this.channels[s].instruments[n].transition=j(0,e.transitions.length,$[t.charCodeAt(i++)]);else this.channels[f].instruments[u].transition=j(0,e.transitions.length,$[t.charCodeAt(i++)]);break;case 99:if(n){const e=[0,3,2,0],s=[1,1,1,13],n=$[t.charCodeAt(i++)],o=j(0,e.length,$[t.charCodeAt(i++)]),r=this.channels[n].instruments[0];r.vibrato=e[o],r.filterEnvelope=1==r.filterEnvelope?s[o]:r.filterEnvelope}else if(h){const e=[0,1,2,3,0,0],s=[1,1,1,1,16,13];for(let n=0;n<this.getChannelCount();n++)for(let o=0;o<this.instrumentsPerChannel;o++){const r=j(0,e.length,$[t.charCodeAt(i++)]),h=this.channels[n].instruments[o];h.vibrato=e[r],h.filterEnvelope=1==h.filterEnvelope?s[r]:h.filterEnvelope}}else if(a){const e=[0,1,2,3,0,0],s=[1,1,1,1,16,13],n=j(0,e.length,$[t.charCodeAt(i++)]),o=this.channels[f].instruments[u];o.vibrato=e[n],o.filterEnvelope=1==o.filterEnvelope?s[n]:o.filterEnvelope}else{const s=j(0,e.vibratos.length,$[t.charCodeAt(i++)]);this.channels[f].instruments[u].vibrato=s}break;case 104:if(n){const s=$[t.charCodeAt(i++)];this.channels[s].instruments[0].interval=j(0,e.intervals.length,$[t.charCodeAt(i++)])}else if(h)for(let s=0;s<this.getChannelCount();s++)for(let n=0;n<this.instrumentsPerChannel;n++){const o=$[t.charCodeAt(i++)];let r=j(0,e.intervals.length,o);8==o&&(r=2,this.channels[s].instruments[n].chord=3),this.channels[s].instruments[n].interval=r}else if(a){const s=$[t.charCodeAt(i++)];let n=j(0,e.intervals.length,s);8==s&&(n=2,this.channels[f].instruments[u].chord=3),this.channels[f].instruments[u].interval=n}else this.channels[f].instruments[u].interval=j(0,e.intervals.length,$[t.charCodeAt(i++)]);break;case 67:this.channels[f].instruments[u].chord=j(0,e.chords.length,$[t.charCodeAt(i++)]);break;case 113:this.channels[f].instruments[u].effects=j(0,e.effectsNames.length,$[t.charCodeAt(i++)]);break;case 118:if(n){const s=$[t.charCodeAt(i++)],n=this.channels[s].instruments[0];n.volume=j(0,e.volumeRange,$[t.charCodeAt(i++)]),5==n.volume&&(n.volume=e.volumeRange-1)}else if(h)for(let s=0;s<this.getChannelCount();s++)for(let n=0;n<this.instrumentsPerChannel;n++){const o=this.channels[s].instruments[n];o.volume=j(0,e.volumeRange,$[t.charCodeAt(i++)]),5==o.volume&&(o.volume=e.volumeRange-1)}else if(a){const s=this.channels[f].instruments[u];s.volume=j(0,e.volumeRange,$[t.charCodeAt(i++)]),5==s.volume&&(s.volume=e.volumeRange-1)}else{this.channels[f].instruments[u].volume=j(0,e.volumeRange,$[t.charCodeAt(i++)])}break;case 76:this.channels[f].instruments[u].pan=j(0,e.panMax+1,$[t.charCodeAt(i++)]);break;case 65:this.channels[f].instruments[u].algorithm=j(0,e.algorithms.length,$[t.charCodeAt(i++)]);break;case 70:this.channels[f].instruments[u].feedbackType=j(0,e.feedbacks.length,$[t.charCodeAt(i++)]);break;case 66:this.channels[f].instruments[u].feedbackAmplitude=j(0,e.operatorAmplitudeMax+1,$[t.charCodeAt(i++)]);break;case 86:this.channels[f].instruments[u].feedbackEnvelope=j(0,e.envelopes.length,$[t.charCodeAt(i++)]);break;case 81:for(let s=0;s<e.operatorCount;s++)this.channels[f].instruments[u].operators[s].frequency=j(0,e.operatorFrequencies.length,$[t.charCodeAt(i++)]);break;case 80:for(let s=0;s<e.operatorCount;s++)this.channels[f].instruments[u].operators[s].amplitude=j(0,e.operatorAmplitudeMax+1,$[t.charCodeAt(i++)]);break;case 69:for(let s=0;s<e.operatorCount;s++)this.channels[f].instruments[u].operators[s].envelope=j(0,e.envelopes.length,$[t.charCodeAt(i++)]);break;case 83:{const s=this.channels[f].instruments[u];if(3==s.type){const n=Math.ceil(e.spectrumControlPoints*e.spectrumControlPointBits/6),o=new _(t,i,i+n);for(let t=0;t<e.spectrumControlPoints;t++)s.spectrumWave.spectrum[t]=o.read(e.spectrumControlPointBits);s.spectrumWave.markCustomWaveDirty(),i+=n}else{if(4!=s.type)throw new Error("Unhandled instrument type for spectrum song tag code.");{const n=Math.ceil(e.drumCount*e.spectrumControlPoints*e.spectrumControlPointBits/6),o=new _(t,i,i+n);for(let t=0;t<e.drumCount;t++){for(let i=0;i<e.spectrumControlPoints;i++)s.drumsetSpectrumWaves[t].spectrum[i]=o.read(e.spectrumControlPointBits);s.drumsetSpectrumWaves[t].markCustomWaveDirty()}i+=n}}}break;case 72:{const s=this.channels[f].instruments[u],n=Math.ceil(e.harmonicsControlPoints*e.harmonicsControlPointBits/6),o=new _(t,i,i+n);for(let t=0;t<e.harmonicsControlPoints;t++)s.harmonicsWave.harmonics[t]=o.read(e.harmonicsControlPointBits);s.harmonicsWave.markCustomWaveDirty(),i+=n}break;case 98:{let e;if(n){const s=$[t.charCodeAt(i++)],n=$[t.charCodeAt(i++)];e=Math.ceil(.5*n);const o=new _(t,i,i+e);for(let t=0;t<n;t++)this.channels[s].bars[t]=o.read(3)+1}else if(r){let s=0;for(;1<<s<this.patternsPerChannel;)s++;e=Math.ceil(this.getChannelCount()*this.barCount*s/6);const n=new _(t,i,i+e);for(let t=0;t<this.getChannelCount();t++)for(let e=0;e<this.barCount;e++)this.channels[t].bars[e]=n.read(s)+1}else{let s=0;for(;1<<s<this.patternsPerChannel+1;)s++;e=Math.ceil(this.getChannelCount()*this.barCount*s/6);const n=new _(t,i,i+e);for(let t=0;t<this.getChannelCount();t++)for(let e=0;e<this.barCount;e++)this.channels[t].bars[e]=n.read(s)}i+=e}break;case 112:{let s,o=0;if(n)s=$[t.charCodeAt(i++)],i++,o=$[t.charCodeAt(i++)],o<<=6,o+=$[t.charCodeAt(i++)];else{s=0;let e=V(1,4,$[t.charCodeAt(i++)]);for(;e>0;)o<<=6,o+=$[t.charCodeAt(i++)],e--}const r=new _(t,i,i+o);i+=o;let h=0;for(;1<<h<this.instrumentsPerChannel;)h++;for(;;){const t=this.getChannelIsNoise(s),i=t?0:12*this.channels[s].octave;let o=null,l=null,c=(t?4:12)+i;const f=t?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],u=[];for(let t=0;t<f.length;t++)f[t]+=i;for(let t=0;t<this.patternsPerChannel;t++){const i=this.channels[s].patterns[t];if(i.reset(),i.instrument=r.read(h),!n&&0==r.read(1))continue;let d=0;const m=i.notes;for(;d<this.beatsPerBar*e.partsPerBeat;){const t=1==r.read(1);let i=!1,s=0;if(t?s=V(0,u.length-1,r.readLongTail(0,0)):i=1==r.read(1),t||i){let i,n,h;if(t)i=u[s],u.splice(s,1);else{for(i={},i.pitchCount=1;i.pitchCount<e.maxChordSize&&1==r.read(1);)i.pitchCount++;i.pinCount=r.readPinCount(),i.initialVolume=r.read(2),i.pins=[],i.length=0,i.bendCount=0;for(let t=0;t<i.pinCount;t++)n={},n.pitchBend=1==r.read(1),n.pitchBend&&i.bendCount++,i.length+=a?r.readLegacyPartDuration()*e.partsPerBeat/e.rhythms[this.rhythm].stepsPerBeat:r.readPartDuration(),n.time=i.length,n.volume=r.read(2),i.pins.push(n)}u.unshift(i),u.length>10&&u.pop(),o=new G(0,d,d+i.length,i.initialVolume),o.pitches=[],o.pins.length=1;const p=[];for(let t=0;t<i.pitchCount+i.bendCount;t++){if(1==r.read(1)){const t=V(0,f.length-1,r.read(3));h=f[t],f.splice(t,1)}else{const t=r.readPitchInterval();h=c;let e=t;for(;e>0;){for(h++;-1!=f.indexOf(h);)h++;e--}for(;e<0;){for(h--;-1!=f.indexOf(h);)h--;e++}}f.unshift(h),f.length>8&&f.pop(),t<i.pitchCount?o.pitches.push(h):p.push(h),c=t==i.pitchCount-1?o.pitches[0]:h}p.unshift(o.pitches[0]);for(const t of i.pins)t.pitchBend&&p.shift(),l=W(p[0]-o.pitches[0],t.time,t.volume),o.pins.push(l);d=V(0,this.beatsPerBar*e.partsPerBeat,o.end),m.push(o)}else{d+=a?r.readLegacyPartDuration()*e.partsPerBeat/e.rhythms[this.rhythm].stepsPerBeat:r.readPartDuration()}}}if(n)break;if(s++,s>=this.getChannelCount())break}}break;default:throw new Error("Unrecognized song tag code "+String.fromCharCode(c)+" at index "+(i-1))}}toJsonObject(t=!0,i=1,s=!0){const n=[];for(let o=0;o<this.getChannelCount();o++){const r=[],h=this.getChannelIsNoise(o);for(let t=0;t<this.instrumentsPerChannel;t++)r.push(this.channels[o].instruments[t].toJsonObject());const a=[];for(const t of this.channels[o].patterns){const i=[];for(const s of t.notes){const t=[];for(const i of s.pins)t.push({tick:(i.time+s.start)*e.rhythms[this.rhythm].stepsPerBeat/e.partsPerBeat,pitchBend:i.interval,volume:Math.round(100*i.volume/3)});i.push({pitches:s.pitches,points:t})}a.push({instrument:t.instrument+1,notes:i})}const l=[];if(t)for(let t=0;t<this.loopStart;t++)l.push(this.channels[o].bars[t]);for(let t=0;t<i;t++)for(let t=this.loopStart;t<this.loopStart+this.loopLength;t++)l.push(this.channels[o].bars[t]);if(s)for(let t=this.loopStart+this.loopLength;t<this.barCount;t++)l.push(this.channels[o].bars[t]);n.push({type:h?"drum":"pitch",octaveScrollBar:this.channels[o].octave,instruments:r,patterns:a,sequence:l})}return{format:tt.W,version:tt.$,scale:e.scales[this.scale].name,key:e.keys[this.key].name,introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:e.rhythms[this.rhythm].stepsPerBeat,beatsPerMinute:this.tempo,reverb:this.reverb,channels:n}}fromJsonObject(t){if(this.initToDefault(!0),!t)return;if(this.scale=11,null!=t.scale){const i={"romani :)":"dbl harmonic :)","romani :(":"dbl harmonic :(",enigma:"strange"},s=null!=i[t.scale]?i[t.scale]:t.scale,n=e.scales.findIndex((t=>t.name==s));-1!=n&&(this.scale=n)}if(null!=t.key)if("number"==typeof t.key)this.key=(t.key+1200>>>0)%e.keys.length;else if("string"==typeof t.key){const e=t.key,i=e.charAt(0).toUpperCase(),s=e.charAt(1).toLowerCase();let n={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[i];const o={"#":1,"♯":1,b:-1,"♭":-1}[s];null!=n&&(null!=o&&(n+=o),n<0&&(n+=12),n%=12,this.key=n)}null!=t.beatsPerMinute&&(this.tempo=j(e.tempoMin,e.tempoMax+1,0|t.beatsPerMinute)),null!=t.reverb&&(this.reverb=j(0,e.reverbRange,0|t.reverb)),null!=t.beatsPerBar&&(this.beatsPerBar=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,0|t.beatsPerBar)));let i=4;null!=t.ticksPerBeat&&(i=0|t.ticksPerBeat||4,this.rhythm=e.rhythms.findIndex((t=>t.stepsPerBeat==i)),-1==this.rhythm&&(this.rhythm=1));let s=1,n=1,o=1;if(t.channels)for(const e of t.channels)e.instruments&&(s=Math.max(s,0|e.instruments.length)),e.patterns&&(n=Math.max(n,0|e.patterns.length)),e.sequence&&(o=Math.max(o,0|e.sequence.length));this.instrumentsPerChannel=Math.min(s,e.instrumentsPerChannelMax),this.patternsPerChannel=Math.min(n,e.barCountMax),this.barCount=Math.min(o,e.barCountMax),null!=t.introBars&&(this.loopStart=j(0,this.barCount,0|t.introBars)),null!=t.loopBars&&(this.loopLength=j(1,this.barCount-this.loopStart+1,0|t.loopBars));const r=[],h=[];if(t.channels)for(let s=0;s<t.channels.length;s++){let n=t.channels[s];const o=new X;let a=!1;a=null!=n.type?"drum"==n.type:s>=3,a?h.push(o):r.push(o),null!=n.octaveScrollBar&&(o.octave=j(0,e.scrollableOctaves+1,0|n.octaveScrollBar));for(let t=o.instruments.length;t<this.instrumentsPerChannel;t++)o.instruments[t]=new Q(a);o.instruments.length=this.instrumentsPerChannel;for(let t=o.patterns.length;t<this.patternsPerChannel;t++)o.patterns[t]=new K;o.patterns.length=this.patternsPerChannel;for(let t=0;t<this.barCount;t++)o.bars[t]=1;o.bars.length=this.barCount;for(let t=0;t<this.instrumentsPerChannel;t++){o.instruments[t].fromJsonObject(n.instruments[t],a)}for(let t=0;t<this.patternsPerChannel;t++){const s=o.patterns[t];let r=void 0;if(n.patterns&&(r=n.patterns[t]),null!=r&&(s.instrument=j(0,this.instrumentsPerChannel,(0|r.instrument)-1),r.notes&&r.notes.length>0)){const t=Math.min(this.beatsPerBar*e.partsPerBeat,r.notes.length>>>0);let n=0;for(let o=0;o<r.notes.length&&!(o>=t);o++){const t=r.notes[o];if(!(t&&t.pitches&&t.pitches.length>=1&&t.points&&t.points.length>=2))continue;const h=new G(0,0,0,0);h.pitches=[],h.pins=[];for(let i=0;i<t.pitches.length;i++){const s=0|t.pitches[i];if(-1==h.pitches.indexOf(s)&&(h.pitches.push(s),h.pitches.length>=e.maxChordSize))break}if(h.pitches.length<1)continue;let l=n,c=0;for(let s=0;s<t.points.length;s++){const n=t.points[s];if(null==n||null==n.tick)continue;const o=null==n.pitchBend?0:0|n.pitchBend,r=Math.round(+n.tick*e.partsPerBeat/i),a=null==n.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|n.volume)/100)));if(!(r>this.beatsPerBar*e.partsPerBeat)){if(0==h.pins.length){if(r<l)continue;h.start=r,c=o}else if(r<=l)continue;l=r,h.pins.push(W(o-c,r-h.start,a))}}if(h.pins.length<2)continue;h.end=h.pins[h.pins.length-1].time+h.start;const f=a?e.drumCount-1:e.maxPitch;let u=f,d=0;for(let t=0;t<h.pitches.length;t++)h.pitches[t]+=c,(h.pitches[t]<0||h.pitches[t]>f)&&(h.pitches.splice(t,1),t--),h.pitches[t]<u&&(u=h.pitches[t]),h.pitches[t]>d&&(d=h.pitches[t]);if(!(h.pitches.length<1)){for(let t=0;t<h.pins.length;t++){const e=h.pins[t];e.interval+u<0&&(e.interval=-u),e.interval+d>f&&(e.interval=f-d),t>=2&&e.interval==h.pins[t-1].interval&&e.interval==h.pins[t-2].interval&&e.volume==h.pins[t-1].volume&&e.volume==h.pins[t-2].volume&&(h.pins.splice(t-1,1),t--)}s.notes.push(h),n=h.end}}}}for(let t=0;t<this.barCount;t++)o.bars[t]=n.sequence?Math.min(this.patternsPerChannel,n.sequence[t]>>>0):0}r.length>e.pitchChannelCountMax&&(r.length=e.pitchChannelCountMax),h.length>e.noiseChannelCountMax&&(h.length=e.noiseChannelCountMax),this.pitchChannelCount=r.length,this.noiseChannelCount=h.length,this.channels.length=0,Array.prototype.push.apply(this.channels,r),Array.prototype.push.apply(this.channels,h)}getPattern(t,e){if(e<0||e>=this.barCount)return null;const i=this.channels[t].bars[e];return 0==i?null:this.channels[t].patterns[i-1]}getPatternInstrument(t,e){const i=this.getPattern(t,e);return null==i?0:i.instrument}getBeatsPerMinute(){return this.tempo}}tt.W="BeepBox",tt._=2,tt.$=8;class et{constructor(){this.pitches=[0,0,0,0],this.pitchCount=0,this.chordSize=0,this.drumsetPitch=0,this.note=null,this.prevNote=null,this.nextNote=null,this.prevNotePitchIndex=0,this.nextNotePitchIndex=0,this.active=!1,this.noteStart=0,this.noteEnd=0,this.noteLengthTicks=0,this.ticksSinceReleased=0,this.liveInputSamplesHeld=0,this.lastInterval=0,this.lastVolume=0,this.stereoVolume1=0,this.stereoVolume2=0,this.stereoOffset=0,this.stereoDelay=0,this.sample=0,this.phases=[],this.phaseDeltas=[],this.volumeStarts=[],this.volumeDeltas=[],this.volumeStart=0,this.volumeDelta=0,this.phaseDeltaScale=0,this.pulseWidth=0,this.pulseWidthDelta=0,this.filter=0,this.filterScale=0,this.filterSample0=0,this.filterSample1=0,this.vibratoScale=0,this.intervalMult=0,this.intervalVolumeMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.reset()}reset(){for(let t=0;t<e.operatorCount;t++)this.phases[t]=0,this.feedbackOutputs[t]=0;this.sample=0,this.filterSample0=0,this.filterSample1=0,this.liveInputSamplesHeld=0}}class it{constructor(t=null){this.samplesPerSecond=44100,this.song=null,this.liveInputDuration=0,this.liveInputStarted=!1,this.liveInputPitches=[],this.liveInputChannel=0,this.loopRepeatCount=-1,this.volume=1,this.playheadInternal=0,this.bar=0,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=0,this.isPlayingSong=!1,this.liveInputEndTime=0,this.tonePool=new O,this.activeTones=[],this.releasedTones=[],this.liveInputTones=new O,this.limit=0,this.stereoBufferIndex=0,this.samplesForNone=null,this.samplesForReverb=null,this.samplesForChorus=null,this.samplesForChorusReverb=null,this.chorusDelayLine=new Float32Array(2048),this.chorusDelayPos=0,this.chorusPhase=0,this.reverbDelayLine=new Float32Array(16384),this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0,this.audioCtx=null,this.scriptNode=null,this.audioProcessCallback=t=>{const e=t.outputBuffer,i=e.getChannelData(0),s=e.getChannelData(1);if(performance.now()<this.liveInputEndTime||this.isPlayingSong)this.synthesize(i,s,e.length,this.isPlayingSong);else{for(let t=0;t<e.length;t++)i[t]=0,s[t]=0;this.deactivateAudio()}},null!=t&&this.setSong(t)}static warmUpSynthesizer(t){if(null!=t)for(let e=0;e<t.getChannelCount();e++)for(let i=0;i<t.instrumentsPerChannel;i++)it.getInstrumentSynthFunction(t.channels[e].instruments[i]),t.channels[e].instruments[i].warmUp()}static operatorAmplitudeCurve(t){return(Math.pow(16,t/15)-1)/15}get playing(){return this.isPlayingSong}get playhead(){return this.playheadInternal}set playhead(t){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,t));let i=this.playheadInternal;this.bar=Math.floor(i),i=this.song.beatsPerBar*(i-this.bar),this.beat=Math.floor(i),i=e.partsPerBeat*(i-this.beat),this.part=Math.floor(i),i=e.ticksPerPart*(i-this.part),this.tick=Math.floor(i);const s=this.getSamplesPerTick();i=s*(i-this.tick),this.tickSampleCountdown=s-i}}getSamplesPerBar(){if(null==this.song)throw new Error;return this.getSamplesPerTick()*e.ticksPerPart*e.partsPerBeat*this.song.beatsPerBar}getTotalBars(t,e){if(null==this.song)throw new Error;let i=this.song.loopLength*(this.loopRepeatCount+1);return t&&(i+=this.song.loopStart),e&&(i+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),i}setSong(t){"string"==typeof t?this.song=new tt(t):t instanceof tt&&(this.song=t)}activateAudio(){null!=this.audioCtx&&null!=this.scriptNode||(this.audioCtx=this.audioCtx||new(window.AudioContext||window.webkitAudioContext),this.samplesPerSecond=this.audioCtx.sampleRate,this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(2048,0,2):this.audioCtx.createJavaScriptNode(2048,0,2),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.scriptNode.connect(this.audioCtx.destination)),this.audioCtx.resume()}deactivateAudio(){null!=this.audioCtx&&null!=this.scriptNode&&(this.scriptNode.disconnect(this.audioCtx.destination),this.scriptNode=null,this.audioCtx.close&&this.audioCtx.close(),this.audioCtx=null)}maintainLiveInput(){this.activateAudio(),this.liveInputEndTime=performance.now()+1e4}play(){this.isPlayingSong||(this.isPlayingSong=!0,it.warmUpSynthesizer(this.song),this.activateAudio())}pause(){this.isPlayingSong&&(this.isPlayingSong=!1)}snapToStart(){this.bar=0,this.snapToBar()}goToBar(t){this.bar=t,this.playheadInternal=this.bar}snapToBar(){this.playheadInternal=this.bar,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=0}resetEffects(){this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0,this.freeAllTones();for(let t=0;t<this.reverbDelayLine.length;t++)this.reverbDelayLine[t]=0;for(let t=0;t<this.chorusDelayLine.length;t++)this.chorusDelayLine[t]=0;if(null!=this.samplesForNone)for(let t=0;t<this.samplesForNone.length;t++)this.samplesForNone[t]=0;if(null!=this.samplesForReverb)for(let t=0;t<this.samplesForReverb.length;t++)this.samplesForReverb[t]=0;if(null!=this.samplesForChorus)for(let t=0;t<this.samplesForChorus.length;t++)this.samplesForChorus[t]=0;if(null!=this.samplesForChorusReverb)for(let t=0;t<this.samplesForChorusReverb.length;t++)this.samplesForChorusReverb[t]=0}jumpIntoLoop(){if(this.song&&(this.bar<this.song.loopStart||this.bar>=this.song.loopStart+this.song.loopLength)){const t=this.bar;this.bar=this.song.loopStart,this.playheadInternal+=this.bar-t}}nextBar(){if(!this.song)return;const t=this.bar;this.bar++,this.bar>=this.song.barCount&&(this.bar=0),this.playheadInternal+=this.bar-t}prevBar(){if(!this.song)return;const t=this.bar;this.bar--,(this.bar<0||this.bar>=this.song.barCount)&&(this.bar=this.song.barCount-1),this.playheadInternal+=this.bar-t}synthesize(t,i,s,n=!0){if(null==this.song){for(let e=0;e<s;e++)t[e]=0,i[e]=0;return void this.deactivateAudio()}const o=this.song.getChannelCount();for(let t=this.activeTones.length;t<o;t++)this.activeTones[t]=new O,this.releasedTones[t]=new O;this.activeTones.length=o,this.releasedTones.length=o;const r=this.getSamplesPerTick();let h=0,a=!1;for(;this.tickSampleCountdown<=0;)this.tickSampleCountdown+=r;this.tickSampleCountdown>r&&(this.tickSampleCountdown=r),n&&(this.beat>=this.song.beatsPerBar&&(this.bar++,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=r,0!=this.loopRepeatCount&&this.bar==this.song.loopStart+this.song.loopLength&&(this.bar=this.song.loopStart,this.loopRepeatCount>0&&this.loopRepeatCount--)),this.bar>=this.song.barCount&&(this.bar=0,-1!=this.loopRepeatCount&&(a=!0,this.pause())));const l=4*s;null!=this.samplesForNone&&this.samplesForNone.length==l&&null!=this.samplesForReverb&&this.samplesForReverb.length==l&&null!=this.samplesForChorus&&this.samplesForChorus.length==l&&null!=this.samplesForChorusReverb&&this.samplesForChorusReverb.length==l||(this.samplesForNone=new Float32Array(l),this.samplesForReverb=new Float32Array(l),this.samplesForChorus=new Float32Array(l),this.samplesForChorusReverb=new Float32Array(l),this.stereoBufferIndex=0);let c=this.stereoBufferIndex;const f=this.samplesForNone,u=this.samplesForReverb,d=this.samplesForChorus,m=this.samplesForChorusReverb,p=+this.volume,y=this.chorusDelayLine,g=this.reverbDelayLine,v=2*Math.PI/(2*this.samplesPerSecond),b=150*this.samplesPerSecond/44100,w=2048-1.51*b,k=2048-2.1*b,M=2048-3.35*b,x=2048-1.47*b,E=2048-2.15*b,q=2048-3.25*b;let C=this.chorusPhase%(2*Math.PI),P=2047&this.chorusDelayPos,S=16383&this.reverbDelayPos,T=+this.reverbFeedback0,R=+this.reverbFeedback1,z=+this.reverbFeedback2,B=+this.reverbFeedback3;const N=.425*Math.pow(this.song.reverb/e.reverbRange,.667),L=1-Math.pow(.5,4/this.samplesPerSecond),F=1-Math.pow(.5,4e3/this.samplesPerSecond);let A=+this.limit;for(;h<s&&!a;){const o=s-h,H=Math.min(Math.ceil(this.tickSampleCountdown),o);for(let t=0;t<this.song.getChannelCount();t++){if(t==this.liveInputChannel){this.determineLiveInputTones(this.song);for(let e=0;e<this.liveInputTones.count();e++){const i=this.liveInputTones.get(e);this.playTone(this.song,c,l,t,r,H,i,!1,!1)}}this.determineCurrentActiveTones(this.song,t,n);for(let e=0;e<this.activeTones[t].count();e++){const i=this.activeTones[t].get(e);this.playTone(this.song,c,l,t,r,H,i,!1,!1)}for(let i=0;i<this.releasedTones[t].count();i++){const s=this.releasedTones[t].get(i);if(s.ticksSinceReleased>=s.instrument.getTransition().releaseTicks){this.freeReleasedTone(t,i),i--;continue}const n=i+this.activeTones[t].count()>=e.maximumTonesPerChannel;this.playTone(this.song,c,l,t,r,H,s,!0,n)}}let I=P+w-b*Math.sin(C+0),O=P+k-b*Math.sin(C+2.1),U=P+M-b*Math.sin(C+4.2),$=P+1024+x-b*Math.sin(C+3.2),_=P+1024+E-b*Math.sin(C+5.3),D=P+1024+q-b*Math.sin(C+1);C+=v*H;const W=(P+H+w-b*Math.sin(C+0)-I)/H,j=(P+H+k-b*Math.sin(C+2.1)-O)/H,V=(P+H+M-b*Math.sin(C+4.2)-U)/H,G=(P+H+1024+x-b*Math.sin(C+3.2)-$)/H,K=(P+H+1024+E-b*Math.sin(C+5.3)-_)/H,J=(P+H+1024+q-b*Math.sin(C+1)-D)/H,Y=h+H;for(let e=h;e<Y;e++){const s=c,n=c+1,o=f[s];f[s]=0;const r=f[n];f[n]=0;const h=u[s];u[s]=0;const a=u[n];u[n]=0;const l=d[s];d[s]=0;const v=d[n];d[n]=0;const b=m[s];m[s]=0;const w=m[n];m[n]=0,c+=2;const k=l+b,M=v+w,x=I%1,E=O%1,q=U%1,C=$%1,H=_%1,Y=D%1,Z=y[2047&I],Q=y[I+1&2047],X=y[2047&O],tt=y[O+1&2047],et=y[2047&U],it=y[U+1&2047],st=y[2047&$],nt=y[$+1&2047],ot=y[2047&_],rt=y[_+1&2047],ht=y[2047&D],at=.5*(k-(Z+(Q-Z)*x)+(X+(tt-X)*E)-(et+(it-et)*q)),lt=.5*(M-(st+(nt-st)*C)+(ot+(rt-ot)*H)-(ht+(y[D+1&2047]-ht)*Y));y[P]=k,y[P+1024&2047]=M,P=P+1&2047,I+=W,O+=j,U+=V,$+=G,_+=K,D+=J;const ct=S+3041&16383,ft=S+6426&16383,ut=S+10907&16383,dt=g[S],mt=g[ct],pt=g[ft],yt=g[ut],gt=-(dt+b+h)+mt,vt=-(dt+w+a)-mt,bt=-pt+yt,wt=-pt-yt;T+=.5*((gt+bt)*N-T),R+=.5*((vt+wt)*N-R),z+=.5*((gt-bt)*N-z),B+=.5*((vt-wt)*N-B),g[ct]=T,g[ft]=R,g[ut]=z,g[S]=B,S=S+1&16383;const kt=o+at+h+mt+pt+yt,Mt=r+lt+a+dt+pt-yt,xt=kt<0?-kt:kt,Et=Mt<0?-Mt:Mt,qt=xt>Et?xt:Et;A+=(qt-A)*(A<qt?F:L);const Ct=p/(A>=1?1.05*A:.8*A+.25);t[e]=kt*Ct,i[e]=Mt*Ct}if(h+=H,this.tickSampleCountdown-=H,this.tickSampleCountdown<=0){for(let t=0;t<this.song.getChannelCount();t++)for(let i=0;i<this.releasedTones[t].count();i++){this.releasedTones[t].get(i).ticksSinceReleased++;i+this.activeTones[t].count()>=e.maximumTonesPerChannel&&(this.freeReleasedTone(t,i),i--)}if(this.tick++,this.tickSampleCountdown+=r,this.tick==e.ticksPerPart){this.tick=0,this.part++,this.liveInputDuration--;for(let t=0;t<this.song.getChannelCount();t++)for(let i=0;i<this.activeTones[t].count();i++){const s=this.activeTones[t].get(i),n=s.instrument.getTransition();n.isSeamless||null==s.note||s.note.end!=this.part+this.beat*e.partsPerBeat||(n.releases?this.releaseTone(t,s):this.freeTone(s),this.activeTones[t].remove(i),i--)}this.part==e.partsPerBeat&&(this.part=0,n&&(this.beat++,this.beat==this.song.beatsPerBar&&(this.beat=0,this.bar++,0!=this.loopRepeatCount&&this.bar==this.song.loopStart+this.song.loopLength&&(this.bar=this.song.loopStart,this.loopRepeatCount>0&&this.loopRepeatCount--),this.bar>=this.song.barCount&&(this.bar=0,-1!=this.loopRepeatCount&&(a=!0,this.resetEffects(),this.pause())))))}}}const H=1e-24;-1e-24<T&&T<H&&(T=0),-1e-24<R&&R<H&&(R=0),-1e-24<z&&z<H&&(z=0),-1e-24<B&&B<H&&(B=0),-1e-24<A&&A<H&&(A=0),this.stereoBufferIndex=(this.stereoBufferIndex+2*s)%l,this.chorusPhase=C,this.chorusDelayPos=P,this.reverbDelayPos=S,this.reverbFeedback0=T,this.reverbFeedback1=R,this.reverbFeedback2=z,this.reverbFeedback3=B,this.limit=A,n&&(this.playheadInternal=(((this.tick+1-this.tickSampleCountdown/r)/2+this.part)/e.partsPerBeat+this.beat)/this.song.beatsPerBar+this.bar)}freeTone(t){this.tonePool.pushBack(t)}newTone(){if(this.tonePool.count()>0){const t=this.tonePool.popBack();return t.reset(),t.active=!1,t}return new et}releaseTone(t,e){this.releasedTones[t].pushFront(e)}freeReleasedTone(t,e){this.freeTone(this.releasedTones[t].get(e)),this.releasedTones[t].remove(e)}freeAllTones(){for(;this.liveInputTones.count()>0;)this.freeTone(this.liveInputTones.popBack());for(let t=0;t<this.activeTones.length;t++)for(;this.activeTones[t].count()>0;)this.freeTone(this.activeTones[t].popBack());for(let t=0;t<this.releasedTones.length;t++)for(;this.releasedTones[t].count()>0;)this.freeTone(this.releasedTones[t].popBack())}determineLiveInputTones(t){const e=this.liveInputTones,i=this.liveInputPitches;let s=0;if(this.liveInputDuration>0){const n=t.channels[this.liveInputChannel].instruments[t.getPatternInstrument(this.liveInputChannel,this.bar)];if(n.getChord().arpeggiates){let t;0==e.count()?(t=this.newTone(),e.pushBack(t)):!n.getTransition().isSeamless&&this.liveInputStarted?(this.releaseTone(this.liveInputChannel,e.popFront()),t=this.newTone(),e.pushBack(t)):t=e.get(0),s=1;for(let e=0;e<i.length;e++)t.pitches[e]=i[e];t.pitchCount=i.length,t.chordSize=1,t.instrument=n,t.note=t.prevNote=t.nextNote=null}else for(let t=0;t<i.length;t++){let o;e.count()<=t?(o=this.newTone(),e.pushBack(o)):!n.getTransition().isSeamless&&this.liveInputStarted?(this.releaseTone(this.liveInputChannel,e.get(t)),o=this.newTone(),e.set(t,o)):o=e.get(t),s++,o.pitches[0]=i[t],o.pitchCount=1,o.chordSize=i.length,o.instrument=n,o.note=o.prevNote=o.nextNote=null}}for(;e.count()>s;)this.releaseTone(this.liveInputChannel,e.popBack());this.liveInputStarted=!1}determineCurrentActiveTones(t,i,s){const n=t.channels[i].instruments[t.getPatternInstrument(i,this.bar)],o=t.getPattern(i,this.bar),r=this.part+this.beat*e.partsPerBeat;let h=null,a=null,l=null;if(s&&null!=o&&!t.channels[i].muted)for(let t=0;t<o.notes.length;t++)if(o.notes[t].end<=r)a=o.notes[t];else if(o.notes[t].start<=r&&o.notes[t].end>r)h=o.notes[t];else if(o.notes[t].start>r){l=o.notes[t];break}const c=this.activeTones[i];if(null!=h)null!=a&&a.end!=h.start&&(a=null),null!=l&&l.start!=h.end&&(l=null),this.syncTones(i,c,n,h.pitches,h,a,l,r);else for(;c.count()>0;)c.peakBack().instrument.getTransition().releases?this.releaseTone(i,c.popBack()):this.freeTone(c.popBack())}syncTones(t,i,s,n,o,r,h,a){let l=0;if(s.getChord().arpeggiates){let t;0==i.count()?(t=this.newTone(),i.pushBack(t)):t=i.get(0),l=1;for(let e=0;e<n.length;e++)t.pitches[e]=n[e];t.pitchCount=n.length,t.chordSize=1,t.instrument=s,t.note=o,t.noteStart=o.start,t.noteEnd=o.end,t.prevNote=r,t.nextNote=h,t.prevNotePitchIndex=0,t.nextNotePitchIndex=0}else{const t=s.getTransition();for(let c=0;c<n.length;c++){const n=c*s.getChord().strumParts;let f=r&&r.pitches.length>c?r:null,u=o,d=h&&h.pitches.length>c?h:null,m=u.start+n;if(m>a){if(!(i.count()>c&&t.isSeamless&&null!=f))break;d=u,u=f,f=null,m=u.start+n}let p,y=u.end;t.isSeamless&&null!=d&&(y=Math.min(e.partsPerBeat*this.song.beatsPerBar,y+n)),i.count()<=c?(p=this.newTone(),i.pushBack(p)):p=i.get(c),l++,p.pitches[0]=u.pitches[c],p.pitchCount=1,p.chordSize=u.pitches.length,p.instrument=s,p.note=u,p.noteStart=m,p.noteEnd=y,p.prevNote=f,p.nextNote=d,p.prevNotePitchIndex=c,p.nextNotePitchIndex=c}}for(;i.count()>l;)i.peakBack().instrument.getTransition().releases?this.releaseTone(t,i.popBack()):this.freeTone(i.popBack())}playTone(t,e,i,s,n,o,r,h,a){let l;switch(it.computeTone(this,t,s,n,o,r,h,a),r.instrument.effects){case 0:l=this.samplesForNone;break;case 1:l=this.samplesForReverb;break;case 2:l=this.samplesForChorus;break;case 3:l=this.samplesForChorusReverb;break;default:throw new Error}it.getInstrumentSynthFunction(r.instrument)(this,l,e,i,2*o,r,r.instrument)}static computeEnvelope(t,e,i,s){switch(t.type){case 0:return s;case 1:return 1;case 4:return 1/(1+e*t.speed);case 5:return 1-1/(1+e*t.speed);case 6:return.5-.5*Math.cos(2*i*Math.PI*t.speed);case 7:return.75-.25*Math.cos(2*i*Math.PI*t.speed);case 2:return Math.max(1,2-10*e);case 3:const n=t.speed,o=.25/Math.sqrt(n);return e<o?e/o:1/(1+(e-o)*n);case 8:return Math.pow(2,-t.speed*e);default:throw new Error("Unrecognized operator envelope type.")}}static computeChordVolume(t){return 1/(.25*(t-1)+1)}static computeTone(t,i,s,n,r,h,a,l){const c=h.instrument,f=c.getTransition(),u=c.getChord(),d=u.arpeggiates?1:it.computeChordVolume(h.chordSize),m=i.getChannelIsNoise(s),p=m?e.noiseInterval:1,y=e.ticksPerPart*n/t.samplesPerSecond,g=1/e.partsPerBeat,v=h.active,b=t.tickSampleCountdown,w=1-b/n,k=1-(b-r)/n,M=(t.beat*e.partsPerBeat+t.part)*e.ticksPerPart+t.tick,x=M/e.ticksPerPart,E=(M+1)/e.ticksPerPart,q=x+(E-x)*w,C=x+(E-x)*k;h.phaseDeltaScale=0,h.filter=1,h.filterScale=1,h.vibratoScale=0,h.intervalMult=1,h.intervalVolumeMult=1,h.active=!1;const P=(c.pan-e.panCenter)/e.panCenter,S=65e-5*t.samplesPerSecond,T=2*Math.round(-P*S),R=1.414*Math.cos((1+P)*Math.PI*.25),z=1.414*Math.cos((1-P)*Math.PI*.25),B=Math.max(0,-T),N=Math.max(0,T);T>=0?(h.stereoVolume1=R,h.stereoVolume2=z,h.stereoOffset=0,h.stereoDelay=N+1):(h.stereoVolume1=z,h.stereoVolume2=R,h.stereoOffset=1,h.stereoDelay=B-1);let L,F,A,H,I=!0,O=0,U=0,$=0,_=1,D=1,W=d,j=d,V=0,G=0,K=0,J=0;if(3==c.type)m?(F=e.spectrumBasePitch,A=.6):(F=e.keys[i.key].basePitch,A=.3),L=e.spectrumBasePitch,H=28;else if(4==c.type)F=e.spectrumBasePitch,A=.45,L=F,H=48;else if(2==c.type)F=e.chipNoises[c.chipNoise].basePitch,A=.19,L=F,H=e.chipNoises[c.chipNoise].isSoft?24:60;else if(1==c.type)F=e.keys[i.key].basePitch,A=.03,L=16,H=48;else if(0==c.type)F=e.keys[i.key].basePitch,A=.03375,L=16,H=48;else if(5==c.type)F=e.keys[i.key].basePitch,A=.025,L=16,H=48;else{if(6!=c.type)throw new Error("Unknown instrument type in computeTone.");F=e.keys[i.key].basePitch,A=.04725,L=16,H=48}for(let t=0;t<e.operatorCount;t++)h.phaseDeltas[t]=0,h.volumeStarts[t]=0,h.volumeDeltas[t]=0;if(a){const t=h.noteLengthTicks+h.ticksSinceReleased,i=h.ticksSinceReleased+w,s=h.ticksSinceReleased+k,n=h.noteLengthTicks+i,o=h.noteLengthTicks+s,r=h.instrument.getTransition();I=!1,O=Math.floor(t/e.ticksPerPart),U=$=h.lastInterval,V=G=it.expressionToVolumeMult(h.lastVolume),_=it.expressionToVolumeMult(3*(1-i/r.releaseTicks)),D=it.expressionToVolumeMult(3*(1-s/r.releaseTicks)),K=n/e.ticksPerPart,J=o/e.ticksPerPart,l&&(_*=1-w,D*=1-k)}else if(null==h.note){_=D=1,V=G=1,h.lastInterval=0,h.lastVolume=3,h.ticksSinceReleased=0,I=!1;const t=h.liveInputSamplesHeld/n;h.liveInputSamplesHeld+=r;const i=h.liveInputSamplesHeld/n;h.noteLengthTicks=i;const s=t/e.ticksPerPart,o=i/e.ticksPerPart;O=Math.floor(s),K=s,J=o}else{const s=h.note,n=h.prevNote,o=h.nextNote,r=t.part+t.beat*e.partsPerBeat,a=e.partsPerBeat*i.beatsPerBar,l=h.noteStart,c=h.noteEnd;let m;for(O=r-l,m=1;m<s.pins.length-1&&!(s.pins[m].time+s.start>r);m++);const p=s.pins[m-1],y=s.pins[m],g=l*e.ticksPerPart,b=c*e.ticksPerPart-g,M=(s.start+p.time)*e.ticksPerPart,q=(s.start+y.time)*e.ticksPerPart;h.lastInterval=s.pins[s.pins.length-1].interval,h.lastVolume=s.pins[s.pins.length-1].volume,h.ticksSinceReleased=0,h.noteLengthTicks=b;const C=r*e.ticksPerPart+t.tick,P=r*e.ticksPerPart+t.tick+1,S=C-g,T=P-g,R=Math.min(1,(C-M)/(q-M)),z=Math.min(1,(P-M)/(q-M));let B=p.volume+(y.volume-p.volume)*R,N=p.volume+(y.volume-p.volume)*z,L=1,F=1,A=d,H=d,Y=p.interval+(y.interval-p.interval)*R,Z=p.interval+(y.interval-p.interval)*z,Q=x-l,X=E-l;I=C+w-g==0||!v;const tt=.5*b;if(f.isSeamless&&!f.slides&&0==s.start)I=!v;else if(f.isSeamless&&null!=n&&(I=!v,f.slides)){const t=Math.min(tt,f.slideTicks),e=Math.max(0,1-S/t),i=Math.max(0,1-T/t),o=.5*(n.pitches[h.prevNotePitchIndex]+n.pins[n.pins.length-1].interval-h.pitches[0]),r=.5*(n.pins[n.pins.length-1].volume-s.pins[0].volume),a=.5*(n.end-n.start);if(Y+=e*o,Z+=i*o,B+=e*r,N+=i*r,Q+=e*a,X+=i*a,!u.arpeggiates){const t=.5*(n.pitches.length-h.chordSize);A=it.computeChordVolume(h.chordSize+e*t),H=it.computeChordVolume(h.chordSize+i*t)}}if(f.isSeamless&&!f.slides&&s.end==a);else if(f.isSeamless&&null!=o){if(f.slides){const t=Math.min(tt,f.slideTicks),e=Math.max(0,1-(b-S)/t),i=Math.max(0,1-(b-T)/t),n=.5*(o.pitches[h.nextNotePitchIndex]-(h.pitches[0]+s.pins[s.pins.length-1].interval)),r=.5*(o.pins[0].volume-s.pins[s.pins.length-1].volume),a=.5*-(c-l);if(Y+=e*n,Z+=i*n,B+=e*r,N+=i*r,Q+=e*a,X+=i*a,!u.arpeggiates){const t=.5*(o.pitches.length-h.chordSize);A=it.computeChordVolume(h.chordSize+e*t),H=it.computeChordVolume(h.chordSize+i*t)}}}else if(!f.releases){const t=f.releaseTicks;t>0&&(L*=Math.min(1,(b-S)/t),F*=Math.min(1,(b-T)/t))}U=Y+(Z-Y)*w,$=Y+(Z-Y)*k,V=it.expressionToVolumeMult(B+(N-B)*w),G=it.expressionToVolumeMult(B+(N-B)*k),_=L+(F-L)*w,D=L+(F-L)*k,W=A+(H-A)*w,j=A+(H-A)*k,K=Q+(X-Q)*w,J=Q+(X-Q)*k}const Y=1/t.samplesPerSecond;if(h.active=!0,0==c.type||1==c.type||5==c.type||6==c.type){const t=it.getLFOAmplitude(c,y*q),i=it.getLFOAmplitude(c,y*C),s=O<e.vibratos[c.vibrato].delayParts?0:e.vibratos[c.vibrato].amplitude;U+=s*t,$+=s*i}if(!f.isSeamless||(f.slides||null==h.note||0!=h.note.start)&&null==h.prevNote){const t=f.attackSeconds;t>0&&(_*=Math.min(1,y*K/t),D*=Math.min(1,y*J/t))}const Z=it.instrumentVolumeToVolumeMult(c.volume);4==c.type&&(h.drumsetPitch=h.pitches[0],null!=h.note&&(h.drumsetPitch+=h.note.pickMainInterval()),h.drumsetPitch=Math.max(0,Math.min(e.drumCount-1,h.drumsetPitch)));const X=c.getFilterCutoffOctaves(),tt=4==c.type?c.getDrumsetEnvelope(h.drumsetPitch):c.getFilterEnvelope(),et=e.filterCutoffMaxHz*Math.pow(2,X),st=2*Math.sin(Math.PI*et/t.samplesPerSecond),nt=2*Math.sin(Math.PI*e.filterCutoffMinHz/t.samplesPerSecond);h.filter=st*it.computeEnvelope(tt,y*K,g*q,V);let ot=st*it.computeEnvelope(tt,y*J,g*C,G);h.filter=Math.min(e.filterMax,Math.max(nt,h.filter)),ot=Math.min(e.filterMax,Math.max(nt,ot)),h.filterScale=Math.pow(ot/h.filter,1/r);let rt=Math.pow(.5,.35*X);if(c.filterResonance>0&&(rt=Math.pow(rt,1.7)*Math.pow(.5,.125*(c.filterResonance-1))),8==tt.type?rt*=1.25+.025*tt.speed:4==tt.type&&(rt*=1+.02*tt.speed),I&&h.reset(),1==c.type){let s=1,n=0,a=0;if(h.pitchCount>1&&!u.harmonizes){const s=Math.floor((t.tick+t.part*e.ticksPerPart)/e.rhythms[i.rhythm].ticksPerArpeggio);a=h.pitches[o(h.pitchCount,i.rhythm,s)]-h.pitches[0]}const l=e.algorithms[c.algorithm].carrierCount;for(let t=0;t<e.operatorCount;t++){const i=e.algorithms[c.algorithm].associatedCarrier[t]-1,o=h.pitches[u.harmonizes?t<h.pitchCount?t:i<h.pitchCount?i:0:0],f=e.operatorFrequencies[c.operators[t].frequency].mult,d=e.operatorCarrierInterval[i]+a,m=F+(o+U)*p+d,v=f*Q.frequencyFromPitch(m)+e.operatorFrequencies[c.operators[t].frequency].hzOffset;h.phaseDeltas[t]=v*Y*e.sineWaveLength;const b=it.operatorAmplitudeCurve(c.operators[t].amplitude),w=b*e.operatorFrequencies[c.operators[t].frequency].amplitudeSign;let k=w,M=w;if(t<l){const t=F+(o+$)*p+d,e=Math.pow(2,-(m-L)/H),i=Math.pow(2,-(t-L)/H);k*=e,M*=i,n+=b}else k*=1.5*e.sineWaveLength,M*=1.5*e.sineWaveLength,s*=1-Math.min(1,c.operators[t].amplitude/15);const x=e.envelopes[c.operators[t].envelope];k*=it.computeEnvelope(x,y*K,g*q,V),M*=it.computeEnvelope(x,y*J,g*C,G),h.volumeStarts[t]=k,h.volumeDeltas[t]=(M-k)/r}const f=.3*e.sineWaveLength*c.feedbackAmplitude/15,d=e.envelopes[c.feedbackEnvelope];let m=f*it.computeEnvelope(d,y*K,g*q,V),v=f*it.computeEnvelope(d,y*J,g*C,G);h.feedbackMult=m,h.feedbackDelta=(v-h.feedbackMult)/r;const b=A*Z;h.volumeStart=rt*b*_*W;const w=rt*b*D*j;h.volumeDelta=(w-h.volumeStart)/r,s*=(Math.pow(2,2-1.4*c.feedbackAmplitude/15)-1)/3,s*=1-Math.min(1,Math.max(0,n-1)/2),h.volumeStart*=1+3*s,h.volumeDelta*=1+3*s}else{let s=h.pitches[0];if(h.pitchCount>1){const n=Math.floor((t.tick+t.part*e.ticksPerPart)/e.rhythms[i.rhythm].ticksPerArpeggio);if(u.harmonizes){const t=h.pitches[1+o(h.pitchCount-1,i.rhythm,n)]-h.pitches[0];h.intervalMult=Math.pow(2,t/12),h.intervalVolumeMult=Math.pow(2,-t/H)}else s=h.pitches[o(h.pitchCount,i.rhythm,n)]}const n=F+(s+U)*p,a=F+(s+$)*p,l=Q.frequencyFromPitch(n),f=Math.pow(2,-(n-L)/H),d=Math.pow(2,-(a-L)/H);let m=A*rt;if(2==c.type&&(m*=e.chipNoises[c.chipNoise].volume),0==c.type&&(m*=e.chipWaves[c.chipWave].volume),0!=c.type&&5!=c.type||(m*=e.intervals[c.interval].volume),6==c.type){const t=e.envelopes[c.pulseEnvelope],i=.5*Math.pow(.5,.5*(e.pulseWidthRange-c.pulseWidth-1)),s=i*it.computeEnvelope(t,y*K,g*q,V),n=i*it.computeEnvelope(t,y*J,g*C,G);h.pulseWidth=s,h.pulseWidthDelta=(n-s)/r}h.phaseDeltas[0]=l*Y,h.volumeStart=_*W*f*m*Z;let v=D*j*d*m*Z;0==tt.type||6==c.type&&0==e.envelopes[c.pulseEnvelope].type||(h.volumeStart*=V,v*=G),h.volumeDelta=(v-h.volumeStart)/r}h.phaseDeltaScale=Math.pow(2,($-U)*p/12/r)}static getLFOAmplitude(t,i){let s=0;for(const n of e.vibratos[t.vibrato].periodsSeconds)s+=Math.sin(2*Math.PI*i/n);return s}static getInstrumentSynthFunction(t){if(1==t.type){const i=t.algorithm+"_"+t.feedbackType;if(null==it.fmSynthFunctionCache[i]){const s=[];for(const i of it.fmSourceTemplate)if(-1!=i.indexOf("// CARRIER OUTPUTS")){const n=[];for(let i=0;i<e.algorithms[t.algorithm].carrierCount;i++)n.push("operator"+i+"Scaled");s.push(i.replace("/*operator#Scaled*/",n.join(" + ")))}else if(-1!=i.indexOf("// INSERT OPERATOR COMPUTATION HERE"))for(let i=e.operatorCount-1;i>=0;i--)for(const n of it.operatorSourceTemplate)if(-1!=n.indexOf("/* + operator@Scaled*/")){let o="";for(const s of e.algorithms[t.algorithm].modulatedBy[i])o+=" + operator"+(s-1)+"Scaled";const r=e.feedbacks[t.feedbackType].indices[i];if(r.length>0){o+=" + feedbackMult * (";const t=[];for(const e of r)t.push("operator"+(e-1)+"Output");o+=t.join(" + ")+")"}s.push(n.replace(/\#/g,i+"").replace("/* + operator@Scaled*/",o))}else s.push(n.replace(/\#/g,i+""));else if(-1!=i.indexOf("#"))for(let t=0;t<e.operatorCount;t++)s.push(i.replace(/\#/g,t+""));else s.push(i);it.fmSynthFunctionCache[i]=new Function("synth","data","stereoBufferIndex","stereoBufferLength","runLength","tone","instrument",s.join("\n"))}return it.fmSynthFunctionCache[i]}if(0==t.type)return it.chipSynth;if(5==t.type)return it.harmonicsSynth;if(6==t.type)return it.pulseWidthSynth;if(2==t.type)return it.noiseSynth;if(3==t.type)return it.spectrumSynth;if(4==t.type)return it.drumsetSynth;throw new Error("Unrecognized instrument type: "+t.type)}static chipSynth(t,i,s,n,o,r,h){const a=e.chipWaves[h.chipWave].samples,l=+a.length-1,c=+Math.pow(2,(e.intervals[h.interval].offset+e.intervals[h.interval].spread)/12),f=Math.pow(2,(e.intervals[h.interval].offset-e.intervals[h.interval].spread)/12)*r.intervalMult,u=r.intervalVolumeMult*e.intervals[h.interval].sign;0!=h.interval||h.getChord().customInterval||(r.phases[1]=r.phases[0]);const d=f/c;let m=r.phaseDeltas[0]*c*l,p=m*d;const y=+r.phaseDeltaScale;let g=+r.volumeStart;const v=+r.volumeDelta;let b=r.phases[0]%1*l,w=r.phases[1]%1*l,k=+r.filter,M=h.getFilterIsFirstOrder()?1:k;const x=+r.filterScale,E=h.getFilterIsFirstOrder()?1:x,q=e.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(e.filterResonanceRange-2),.5);let C=+r.filterSample0,P=+r.filterSample1;const S=0|b,T=0|w,R=S%l,z=T%l,B=b-S,N=w-T;let L=a[R],F=a[z];L+=(a[R+1]-L)*B,F+=(a[z+1]-F)*N;const A=s+o;s+=r.stereoOffset;const H=r.stereoVolume1,I=r.stereoVolume2,O=r.stereoDelay;for(;s<A;){b+=m,w+=p;const t=0|b,e=0|w,o=t%l,r=e%l;let h=a[o],c=a[r];const f=b-t,d=w-e;h+=(a[o+1]-h)*f,c+=(a[r+1]-c)*d;let S=(h-L)/m,T=(c-F)/p;L=h,F=c;C+=k*(S+T*u-C+(q+q/(1-k))*(C-P)),P+=M*(C-P),k*=x,M*=E,m*=y,p*=y;const R=P*g;g+=v,i[s]+=R*H,i[(s+O)%n]+=R*I,s+=2}r.phases[0]=b/l,r.phases[1]=w/l;const U=1e-24;-1e-24<C&&C<U&&(C=0),-1e-24<P&&P<U&&(P=0),r.filterSample0=C,r.filterSample1=P}static harmonicsSynth(t,i,s,n,o,r,h){const a=h.harmonicsWave.getCustomWave(),l=+a.length-1,c=+Math.pow(2,(e.intervals[h.interval].offset+e.intervals[h.interval].spread)/12),f=Math.pow(2,(e.intervals[h.interval].offset-e.intervals[h.interval].spread)/12)*r.intervalMult,u=r.intervalVolumeMult*e.intervals[h.interval].sign;0!=h.interval||h.getChord().customInterval||(r.phases[1]=r.phases[0]);const d=f/c;let m=r.phaseDeltas[0]*c*l,p=m*d;const y=+r.phaseDeltaScale;let g=+r.volumeStart;const v=+r.volumeDelta;let b=r.phases[0]%1*l,w=r.phases[1]%1*l,k=+r.filter,M=h.getFilterIsFirstOrder()?1:k;const x=+r.filterScale,E=h.getFilterIsFirstOrder()?1:x,q=e.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(e.filterResonanceRange-2),.5);let C=+r.filterSample0,P=+r.filterSample1;const S=0|b,T=0|w,R=S%l,z=T%l,B=b-S,N=w-T;let L=a[R],F=a[z];L+=(a[R+1]-L)*B,F+=(a[z+1]-F)*N;const A=s+o;s+=r.stereoOffset;const H=r.stereoVolume1,I=r.stereoVolume2,O=r.stereoDelay;for(;s<A;){b+=m,w+=p;const t=0|b,e=0|w,o=t%l,r=e%l;let h=a[o],c=a[r];const f=b-t,d=w-e;h+=(a[o+1]-h)*f,c+=(a[r+1]-c)*d;let S=(h-L)/m,T=(c-F)/p;L=h,F=c;C+=k*(S+T*u-C+(q+q/(1-k))*(C-P)),P+=M*(C-P),k*=x,M*=E,m*=y,p*=y;const R=P*g;g+=v,i[s]+=R*H,i[(s+O)%n]+=R*I,s+=2}r.phases[0]=b/l,r.phases[1]=w/l;const U=1e-24;-1e-24<C&&C<U&&(C=0),-1e-24<P&&P<U&&(P=0),r.filterSample0=C,r.filterSample1=P}static pulseWidthSynth(t,i,s,n,o,r,h){let a=r.phaseDeltas[0];const l=+r.phaseDeltaScale;let c=+r.volumeStart;const f=+r.volumeDelta;let u=r.phases[0]%1,d=r.pulseWidth;const m=r.pulseWidthDelta;let p=+r.filter,y=h.getFilterIsFirstOrder()?1:p;const g=+r.filterScale,v=h.getFilterIsFirstOrder()?1:g,b=e.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(e.filterResonanceRange-2),.5);let w=+r.filterSample0,k=+r.filterSample1;const M=s+o;s+=r.stereoOffset;const x=r.stereoVolume1,E=r.stereoVolume2,q=r.stereoDelay;for(;s<M;){const t=u%1,e=(u+d)%1;let o=e-t;if(t<a)o+=.5*((C=t/a)+C-C*C-1);else if(t>1-a){o+=.5*((C=(t-1)/a)+C+C*C+1)}if(e<a)o-=.5*((C=e/a)+C-C*C-1);else if(e>1-a){var C;o-=.5*((C=(e-1)/a)+C+C*C+1)}w+=p*(o-w+(b+b/(1-p))*(w-k)),k+=y*(w-k),p*=g,y*=v,u+=a,a*=l,d+=m;const r=k*c;c+=f,i[s]+=r*x,i[(s+q)%n]+=r*E,s+=2}r.phases[0]=u;const P=1e-24;-1e-24<w&&w<P&&(w=0),-1e-24<k&&k<P&&(k=0),r.filterSample0=w,r.filterSample1=k}static noiseSynth(t,i,s,n,o,r,h){let a=h.getDrumWave(),l=+r.phaseDeltas[0];const c=+r.phaseDeltaScale;let f=+r.volumeStart;const u=+r.volumeDelta;let d=r.phases[0]%1*e.chipNoiseLength;0==r.phases[0]&&(d=Math.random()*e.chipNoiseLength);let m=+r.sample,p=+r.filter,y=h.getFilterIsFirstOrder()?1:p;const g=+r.filterScale,v=h.getFilterIsFirstOrder()?1:g,b=e.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(e.filterResonanceRange-2),.5);let w=+r.filterSample0,k=+r.filterSample1;const M=Math.min(1,r.phaseDeltas[0]*e.chipNoises[h.chipNoise].pitchFilterMult),x=s+o;s+=r.stereoOffset;const E=r.stereoVolume1,q=r.stereoVolume2,C=r.stereoDelay;for(;s<x;){m+=(a[32767&d]-m)*M;w+=p*(m-w+(b+b/(1-p))*(w-k)),k+=y*(w-k),d+=l,p*=g,y*=v,l*=c;const t=k*f;f+=u,i[s]+=t*E,i[(s+C)%n]+=t*q,s+=2}r.phases[0]=d/e.chipNoiseLength,r.sample=m;const P=1e-24;-1e-24<w&&w<P&&(w=0),-1e-24<k&&k<P&&(k=0),r.filterSample0=w,r.filterSample1=k}static spectrumSynth(t,i,s,n,o,r,h){let a=h.getDrumWave(),l=128*r.phaseDeltas[0];const c=+r.phaseDeltaScale;let f=+r.volumeStart;const u=+r.volumeDelta;let d=+r.sample,m=+r.filter,p=h.getFilterIsFirstOrder()?1:m;const y=+r.filterScale,g=h.getFilterIsFirstOrder()?1:y,v=e.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(e.filterResonanceRange-2),.5);let b=+r.filterSample0,w=+r.filterSample1,k=r.phases[0]%1*e.chipNoiseLength;0==r.phases[0]&&(k=it.findRandomZeroCrossing(a)+l);const M=Math.min(1,l),x=s+o;s+=r.stereoOffset;const E=r.stereoVolume1,q=r.stereoVolume2,C=r.stereoDelay;for(;s<x;){const t=0|k,e=32767&t;let o=a[e];const r=k-t;o+=(a[e+1]-o)*r,d+=(o-d)*M;b+=m*(d-b+(v+v/(1-m))*(b-w)),w+=p*(b-w),k+=l,m*=y,p*=g,l*=c;const h=w*f;f+=u,i[s]+=h*E,i[(s+C)%n]+=h*q,s+=2}r.phases[0]=k/e.chipNoiseLength,r.sample=d;const P=1e-24;-1e-24<b&&b<P&&(b=0),-1e-24<w&&w<P&&(w=0),r.filterSample0=b,r.filterSample1=w}static drumsetSynth(t,i,s,n,o,r,h){let a=h.getDrumsetWave(r.drumsetPitch),l=r.phaseDeltas[0]/Q.drumsetIndexReferenceDelta(r.drumsetPitch);const c=+r.phaseDeltaScale;let f=+r.volumeStart;const u=+r.volumeDelta;let d=+r.sample,m=+r.filter,p=h.getFilterIsFirstOrder()?1:m;const y=+r.filterScale,g=h.getFilterIsFirstOrder()?1:y,v=e.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(e.filterResonanceRange-2),.5);let b=+r.filterSample0,w=+r.filterSample1,k=r.phases[0]%1*e.chipNoiseLength;0==r.phases[0]&&(k=it.findRandomZeroCrossing(a)+l);const M=s+o;s+=r.stereoOffset;const x=r.stereoVolume1,E=r.stereoVolume2,q=r.stereoDelay;for(;s<M;){const t=0|k,e=32767&t;d=a[e];const o=k-t;d+=(a[e+1]-d)*o;b+=m*(d-b+(v+v/(1-m))*(b-w)),w+=p*(b-w),k+=l,m*=y,p*=g,l*=c;const r=w*f;f+=u,i[s]+=r*x,i[(s+q)%n]+=r*E,s+=2}r.phases[0]=k/e.chipNoiseLength,r.sample=d;const C=1e-24;-1e-24<b&&b<C&&(b=0),-1e-24<w&&w<C&&(w=0),r.filterSample0=b,r.filterSample1=w}static findRandomZeroCrossing(t){let i=Math.random()*e.chipNoiseLength,s=32767&i,n=t[s];for(let o=128;o>0;o--){const o=s+16&32767,r=t[o];if(n*r<=0){for(let o=0;o<16;o++){const o=s+1&32767,r=t[o];if(n*r<=0){const t=r-n;i=s,Math.abs(t)>1e-8&&(i+=-n/t),i=Math.max(0,i)%e.chipNoiseLength;break}s=o,n=r}break}s=o,n=r}return i}static instrumentVolumeToVolumeMult(t){return t==e.volumeRange-1?0:Math.pow(2,e.volumeLogScale*t)}static volumeMultToInstrumentVolume(t){return t<=0?e.volumeRange-1:Math.min(e.volumeRange-2,Math.log(t)/Math.LN2/e.volumeLogScale)}static expressionToVolumeMult(t){return Math.pow(Math.max(0,t)/3,1.5)}static volumeMultToExpression(t){return 3*Math.pow(Math.max(0,t),1/1.5)}getSamplesPerTick(){if(null==this.song)return 0;const t=this.song.getBeatsPerMinute()/60,i=e.partsPerBeat*t,s=e.ticksPerPart*i;return this.samplesPerSecond/s}}it.fmSynthFunctionCache={},it.fmSourceTemplate=("\n\t\t\tconst sineWave = beepbox.Config.sineWave;\n\t\t\t\n\t\t\tlet phaseDeltaScale = +tone.phaseDeltaScale;\n\t\t\t// I'm adding 1000 to the phase to ensure that it's never negative even when modulated by other waves because negative numbers don't work with the modulus operator very well.\n\t\t\tlet operator#Phase       = +((tone.phases[#] % 1) + 1000) * beepbox.Config.sineWaveLength;\n\t\t\tlet operator#PhaseDelta  = +tone.phaseDeltas[#];\n\t\t\tlet operator#OutputMult  = +tone.volumeStarts[#];\n\t\t\tconst operator#OutputDelta = +tone.volumeDeltas[#];\n\t\t\tlet operator#Output      = +tone.feedbackOutputs[#];\n\t\t\tlet feedbackMult         = +tone.feedbackMult;\n\t\t\tconst feedbackDelta        = +tone.feedbackDelta;\n\t\t\tlet volume = +tone.volumeStart;\n\t\t\tconst volumeDelta = +tone.volumeDelta;\n\t\t\t\n\t\t\tlet filter1 = +tone.filter;\n\t\t\tlet filter2 = instrument.getFilterIsFirstOrder() ? 1.0 : filter1;\n\t\t\tconst filterScale1 = +tone.filterScale;\n\t\t\tconst filterScale2 = instrument.getFilterIsFirstOrder() ? 1.0 : filterScale1;\n\t\t\tconst filterResonance = beepbox.Config.filterMaxResonance * Math.pow(Math.max(0, instrument.getFilterResonance() - 1) / (beepbox.Config.filterResonanceRange - 2), 0.5);\n\t\t\tlet filterSample0 = +tone.filterSample0;\n\t\t\tlet filterSample1 = +tone.filterSample1;\n\t\t\t\n\t\t\tconst stopIndex = stereoBufferIndex + runLength;\n\t\t\tstereoBufferIndex += tone.stereoOffset;\n\t\t\tconst stereoVolume1 = tone.stereoVolume1;\n\t\t\tconst stereoVolume2 = tone.stereoVolume2;\n\t\t\tconst stereoDelay = tone.stereoDelay;\n\t\t\twhile (stereoBufferIndex < stopIndex) {\n\t\t\t\t// INSERT OPERATOR COMPUTATION HERE\n\t\t\t\tconst fmOutput = (/*operator#Scaled*/); // CARRIER OUTPUTS\n\t\t\t\t\n\t\t\t\tconst feedback = filterResonance + filterResonance / (1.0 - filter1);\n\t\t\t\tfilterSample0 += filter1 * (fmOutput - filterSample0 + feedback * (filterSample0 - filterSample1));\n\t\t\t\tfilterSample1 += filter2 * (filterSample0 - filterSample1);\n\t\t\t\t\n\t\t\t\tfeedbackMult += feedbackDelta;\n\t\t\t\toperator#OutputMult += operator#OutputDelta;\n\t\t\t\toperator#Phase += operator#PhaseDelta;\n\t\t\t\toperator#PhaseDelta *= phaseDeltaScale;\n\t\t\t\tfilter1 *= filterScale1;\n\t\t\t\tfilter2 *= filterScale2;\n\t\t\t\t\n\t\t\t\tconst output = filterSample1 * volume;\n\t\t\t\tvolume += volumeDelta;\n\t\t\t\t\n\t\t\t\tdata[stereoBufferIndex] += output * stereoVolume1;\n\t\t\t\tdata[(stereoBufferIndex + stereoDelay) % stereoBufferLength] += output * stereoVolume2;\n\t\t\t\tstereoBufferIndex += 2;\n\t\t\t}\n\t\t\t\n\t\t\ttone.phases[#] = operator#Phase / "+e.sineWaveLength+";\n\t\t\ttone.feedbackOutputs[#] = operator#Output;\n\t\t\t\n\t\t\tconst epsilon = (1.0e-24);\n\t\t\tif (-epsilon < filterSample0 && filterSample0 < epsilon) filterSample0 = 0.0;\n\t\t\tif (-epsilon < filterSample1 && filterSample1 < epsilon) filterSample1 = 0.0;\n\t\t\ttone.filterSample0 = filterSample0;\n\t\t\ttone.filterSample1 = filterSample1;\n\t\t").split("\n"),it.operatorSourceTemplate=("\n\t\t\t\tconst operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\n\t\t\t\tconst operator#PhaseInt = operator#PhaseMix|0;\n\t\t\t\tconst operator#Index    = operator#PhaseInt & "+e.sineWaveMask+";\n\t\t\t\tconst operator#Sample   = sineWave[operator#Index];\n\t\t\t\toperator#Output       = operator#Sample + (sineWave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\n\t\t\t\tconst operator#Scaled   = operator#OutputMult * operator#Output;\n\t\t").split("\n");class st{constructor(){this.j=!0}V(){this.j=!1}isNoop(){return this.j}commit(){}}class nt extends st{constructor(t){super(),this.K=t,this.J=!t}undo(){this.K?(this.Y(),this.J=!0):(this.Z(),this.J=!1)}redo(){this.K?(this.Z(),this.J=!1):(this.Y(),this.J=!0)}X(){return this.J}Y(){throw new Error("Change.doForwards(): Override me.")}Z(){throw new Error("Change.doBackwards(): Override me.")}}class ot extends st{constructor(){super()}append(t){t.isNoop()||this.V()}}class rt extends nt{constructor(t){super(!1),this.tt=null==t?[]:t.concat()}append(t){t.isNoop()||(this.tt[this.tt.length]=t,this.V())}Y(){for(let t=0;t<this.tt.length;t++)this.tt[t].redo()}Z(){for(let t=this.tt.length-1;t>=0;t--)this.tt[t].undo()}}function ht(t,e){for(const i of t.notes)for(const t of i.pitches)for(const s of i.pins){const i=(t+s.interval)%12;e[i]||(e[i]=!0)}}function at(t,e,i,s,n){const o=new G(-1,i,s,3,!1);n.push(o),o.pins.length=0,o.pitches.length=0;const r=s-i;for(const e of t.pitches)o.pitches.push(e);for(let i=0;i<t.pins.length;i++){const s=t.pins[i],n=s.time+e;if(n<0){if(i+1>=t.pins.length)throw new Error("Error converting pins in note overflow.");const r=t.pins[i+1],h=r.time+e;if(h>0){const t=-n/(h-n);o.pins.push(W(Math.round(s.interval+t*(r.interval-s.interval)),0,Math.round(s.volume+t*(r.volume-s.volume))))}}else if(n<=r)o.pins.push(W(s.interval,n,s.volume));else{if(i<1)throw new Error("Error converting pins in note overflow.");const h=t.pins[i-1],a=h.time+e;if(a<r){const t=(r-a)/(n-a);o.pins.push(W(Math.round(h.interval+t*(s.interval-h.interval)),r,Math.round(h.volume+t*(s.volume-h.volume))))}}}const h=o.pins[0].interval;for(let t=0;t<o.pitches.length;t++)o.pitches[t]+=h;for(let t=0;t<o.pins.length;t++)o.pins[t].interval-=h}class lt extends ot{constructor(t,i,s){super();const n=[],o=[];for(let r=0;r<t.song.getChannelCount();r++){const h=t.song.channels[r],a=new X;r<t.song.pitchChannelCount?n.push(a):o.push(a),a.muted=h.muted,a.octave=h.octave;for(const t of h.instruments)a.instruments.push(t);const l=e.partsPerBeat*t.song.beatsPerBar,c=e.partsPerBeat*i;let f=-1,u=null;for(let e=0;e<t.song.barCount;e++){const i=t.song.getPattern(r,e);if(null!=i){const t=e*l;for(const e of i.notes){const n=e.start+t+s,o=e.end+t+s,r=Math.floor(n/c),h=Math.ceil(o/c);for(let t=r;t<h;t++){const s=t*c,r=Math.max(0,n-s),h=Math.min(c,o-s);if(r<h){if(f!=t||null==u){for(f++;f<t;)a.bars[f]=0,f++;u=new K,a.patterns.push(u),a.bars[f]=a.patterns.length,u.instrument=i.instrument}at(e,n-s-r,r,h,u.notes)}}}}}}ue(n),ue(o),this.append(new ce(t,n,o))}}class ct extends nt{constructor(t,e){super(!1),this.m=t,this.et=e,this.it=this.et.start,this.st=this.et.end,this.nt=this.et.start,this.ot=this.et.end,this.rt=this.et.pins,this.ht=[],this.at=this.et.pitches,this.lt=[]}ct(){for(let t=0;t<this.ht.length-1;)this.ht[t].time>=this.ht[t+1].time?this.ht.splice(t,1):t++;for(let t=1;t<this.ht.length-1;)this.ht[t-1].interval==this.ht[t].interval&&this.ht[t].interval==this.ht[t+1].interval&&this.ht[t-1].volume==this.ht[t].volume&&this.ht[t].volume==this.ht[t+1].volume?this.ht.splice(t,1):t++;const t=this.ht[0].interval,e=this.ht[0].time;for(let e=0;e<this.at.length;e++)this.lt[e]=this.at[e]+t;for(let i=0;i<this.ht.length;i++)this.ht[i].interval-=t,this.ht[i].time-=e;this.nt=this.it+e,this.ot=this.nt+this.ht[this.ht.length-1].time,this.Y(),this.V()}Y(){this.et.pins=this.ht,this.et.pitches=this.lt,this.et.start=this.nt,this.et.end=this.ot,null!=this.m&&this.m.notifier.changed()}Z(){this.et.pins=this.rt,this.et.pitches=this.at,this.et.start=this.it,this.et.end=this.st,null!=this.m&&this.m.notifier.changed()}}class ft extends st{constructor(t){super();const e=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];e.preset!=e.type&&(e.preset=e.type,t.notifier.changed(),this.V())}}class ut extends st{constructor(t,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];if(s.preset!=i){const n=l.valueToPreset(i);if(null!=n)if(null!=n.customType)s.type=n.customType,!e.instrumentTypeHasSpecialInterval[s.type]&&e.chords[s.chord].isCustomInterval&&(s.chord=0);else if(null!=n.settings){const e=s.volume,i=s.pan;s.fromJsonObject(n.settings,t.song.getChannelIsNoise(t.channel)),s.volume=e,s.pan=i}s.preset=i,t.notifier.changed(),this.V()}}}class dt extends st{constructor(t){function i(t){let e=0;for(const i of t)e+=i.weight;let i=Math.random()*e;for(const e of t)if(i-=e.weight,i<=0)return e.item;return t[Math.random()*t.length|0].item}function s(t,e,s,n){const o=[];for(let i=t;i<=e;i++)o.push({item:i,weight:1/(Math.pow((i-s)/n,2)+1)});return i(o)}super();const n=t.song.getChannelIsNoise(t.channel),o=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];if(n){const t=i([{item:2,weight:1},{item:3,weight:3}]);function r(t){let i=0;for(const e of t)e>i&&(i=e);for(let s=0;s<t.length;s++)t[s]=e.harmonicsMax*t[s]/i}switch(o.preset=o.type=t,o.filterCutoff=s(4,e.filterCutoffRange-1,e.filterCutoffRange-2,2),o.filterResonance=s(0,e.filterResonanceRange-1,1,2),o.filterEnvelope=e.envelopes.dictionary[i([{item:"steady",weight:2},{item:"punch",weight:4},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:8},{item:"twang 2",weight:8},{item:"twang 3",weight:8},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:4},{item:"decay 3",weight:4}])].index,o.transition=e.transitions.dictionary[i([{item:"seamless",weight:1},{item:"hard",weight:4},{item:"soft",weight:2},{item:"slide",weight:1},{item:"cross fade",weight:2},{item:"hard fade",weight:8},{item:"medium fade",weight:2},{item:"soft fade",weight:1}])].index,o.effects=e.effectsNames.indexOf(i([{item:"none",weight:1},{item:"reverb",weight:3}])),o.chord=e.chords.dictionary[i([{item:"harmony",weight:4},{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index,t){case 2:o.chipNoise=Math.random()*e.chipNoises.length|0;break;case 3:{const t=[()=>{const t=[];for(let i=0;i<e.spectrumControlPoints;i++)t[i]=Math.random()<.5?Math.random():0;return t},()=>{let t=1;const i=[t];for(let s=1;s<e.spectrumControlPoints;s++)t*=Math.pow(2,Math.random()-.52),i[s]=t;return i},()=>{let t=1;const i=[t];for(let s=1;s<e.spectrumControlPoints;s++)t*=Math.pow(2,Math.random()-.52),i[s]=t*Math.random();return i}],i=(0,t[Math.random()*t.length|0])();r(i);for(let t=0;t<e.spectrumControlPoints;t++)o.spectrumWave.spectrum[t]=Math.round(i[t]);o.spectrumWave.markCustomWaveDirty()}break;default:throw new Error("Unhandled noise instrument type in random generator.")}}else{const t=i([{item:0,weight:4},{item:6,weight:4},{item:5,weight:6},{item:3,weight:1},{item:1,weight:4}]);function r(t){let i=0;for(const e of t)e>i&&(i=e);for(let s=0;s<t.length;s++)t[s]=e.harmonicsMax*t[s]/i}switch(o.preset=o.type=t,o.filterCutoff=s(2,e.filterCutoffRange-1,7,1.5),o.filterResonance=s(0,e.filterResonanceRange-1,1,2),o.filterEnvelope=e.envelopes.dictionary[i([{item:"steady",weight:10},{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index,o.transition=e.transitions.dictionary[i([{item:"seamless",weight:1},{item:"hard",weight:4},{item:"soft",weight:4},{item:"slide",weight:2},{item:"cross fade",weight:4},{item:"hard fade",weight:4},{item:"medium fade",weight:2},{item:"soft fade",weight:2}])].index,o.effects=e.effectsNames.indexOf(i([{item:"none",weight:1},{item:"reverb",weight:10},{item:"chorus",weight:2},{item:"chorus & reverb",weight:2}])),o.chord=e.chords.dictionary[i([{item:"harmony",weight:7},{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index,3!=t&&(o.vibrato=e.vibratos.dictionary[i([{item:"none",weight:6},{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),0!=t&&5!=t||(o.interval=e.intervals.dictionary[i([{item:"union",weight:10},{item:"shimmer",weight:5},{item:"hum",weight:4},{item:"honky tonk",weight:3},{item:"dissonant",weight:1},{item:"fifth",weight:1},{item:"octave",weight:2},{item:"bowed",weight:2},{item:"piano",weight:5}])].index),t){case 0:o.chipWave=Math.random()*e.chipWaves.length|0;break;case 6:o.pulseEnvelope=e.envelopes.dictionary[i([{item:"steady",weight:10},{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:4},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:4},{item:"swell 3",weight:4},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:2},{item:"tremolo5",weight:2},{item:"tremolo6",weight:2},{item:"decay 1",weight:2},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index,o.pulseWidth=s(0,e.pulseWidthRange-1,e.pulseWidthRange-1,2);break;case 5:{const t=[()=>{const t=[];for(let i=0;i<e.harmonicsControlPoints;i++)t[i]=Math.random()<.4?Math.random():0;return t[8*Math.random()|0]=Math.pow(Math.random(),.25),t},()=>{let t=1;const i=[t];for(let s=1;s<e.harmonicsControlPoints;s++)t*=Math.pow(2,Math.random()-.55),i[s]=t;return i},()=>{let t=1;const i=[t];for(let s=1;s<e.harmonicsControlPoints;s++)t*=Math.pow(2,Math.random()-.55),i[s]=t*Math.random();return i}],i=(0,t[Math.random()*t.length|0])();r(i);for(let t=0;t<e.harmonicsControlPoints;t++)o.harmonicsWave.harmonics[t]=Math.round(i[t]);o.harmonicsWave.markCustomWaveDirty()}break;case 3:{const t=[];for(let i=0;i<e.spectrumControlPoints;i++){const e=0==i||7==i||11==i||14==i||16==i||18==i||21==i;t[i]=e?Math.pow(Math.random(),.25):.5*Math.pow(Math.random(),3)}r(t);for(let i=0;i<e.spectrumControlPoints;i++)o.spectrumWave.spectrum[i]=Math.round(t[i]);o.spectrumWave.markCustomWaveDirty()}break;case 1:{o.algorithm=Math.random()*e.algorithms.length|0,o.feedbackType=Math.random()*e.feedbacks.length|0;const t=e.algorithms[o.algorithm];for(let i=0;i<t.carrierCount;i++)o.operators[i].frequency=s(0,e.operatorFrequencies.length-1,0,3),o.operators[i].amplitude=s(0,e.operatorAmplitudeMax,e.operatorAmplitudeMax-1,2),o.operators[i].envelope=e.envelopes.dictionary.custom.index;for(let n=t.carrierCount;n<e.operatorCount;n++)o.operators[n].frequency=s(3,e.operatorFrequencies.length-1,0,3),o.operators[n].amplitude=Math.pow(Math.random(),2)*e.operatorAmplitudeMax|0,o.operators[n].envelope=e.envelopes.dictionary[i([{item:"steady",weight:6},{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index;o.feedbackAmplitude=Math.pow(Math.random(),3)*e.operatorAmplitudeMax|0,o.feedbackEnvelope=e.envelopes.dictionary[i([{item:"steady",weight:4},{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index}break;default:throw new Error("Unhandled pitched instrument type in random generator.")}}t.notifier.changed(),this.V()}}class mt extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.transition!=e&&(this.V(),i.transition=e,i.preset=i.type,t.notifier.changed())}}class pt extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.effects!=e&&(this.V(),i.effects=e,i.preset=i.type,t.notifier.changed())}}class yt extends st{constructor(t,e,i,s,n,o){if(super(),e>t.song.patternsPerChannel)throw new Error("invalid pattern");for(let r=i;r<i+n;r++)for(let i=s;i<s+o;i++)t.song.channels[i].bars[r]!=e&&(t.song.channels[i].bars[r]=e,this.V());t.notifier.changed()}}class gt extends st{constructor(t,e,i){if(super(),t.song.barCount!=e){for(const s of t.song.channels)if(i){for(;s.bars.length<e;)s.bars.unshift(0);t.song.barCount>e&&s.bars.splice(0,t.song.barCount-e)}else{for(;s.bars.length<e;)s.bars.push(0);s.bars.length=e}if(i){const i=e-t.song.barCount;t.bar=Math.max(0,t.bar+i),(i<0||t.barScrollPos>0)&&(t.barScrollPos=Math.max(0,t.barScrollPos+i)),t.song.loopStart=Math.max(0,t.song.loopStart+i)}t.bar=Math.min(t.bar,e-1),t.barScrollPos=Math.max(0,Math.min(e-t.trackVisibleBars,t.barScrollPos)),t.song.loopLength=Math.min(e,t.song.loopLength),t.song.loopStart=Math.min(e-t.song.loopLength,t.song.loopStart),t.song.barCount=e,t.notifier.changed(),this.V()}}}class vt extends st{constructor(t,i,s){super();const n=Math.min(e.barCountMax,t.song.barCount+s);if(0!=(s=n-t.song.barCount)){for(const e of t.song.channels)for(;e.bars.length<n;)e.bars.splice(i,0,0);t.song.barCount=n,t.bar+=s,t.barScrollPos=Math.min(n-t.trackVisibleBars,t.barScrollPos+s),t.song.loopStart>=i?t.song.loopStart+=s:t.song.loopStart+t.song.loopLength>=i&&(t.song.loopLength+=s),t.notifier.changed(),this.V()}}}class bt extends st{constructor(t,e,i){super();for(const s of t.song.channels)s.bars.splice(e,i),0==s.bars.length&&s.bars.push(0);t.song.barCount=Math.max(1,t.song.barCount-i),t.bar=Math.max(0,t.bar-i),t.barScrollPos=Math.max(0,t.barScrollPos-i),t.song.loopStart>=e?t.song.loopStart=Math.max(0,t.song.loopStart-i):t.song.loopStart+t.song.loopLength>e&&(t.song.loopLength-=i),t.song.loopLength=Math.max(1,Math.min(t.song.barCount-t.song.loopStart,t.song.loopLength)),t.notifier.changed(),this.V()}}class wt extends st{constructor(t,e,i){if(super(),t.song.pitchChannelCount!=e||t.song.noiseChannelCount!=i){const n=[];function s(e,i,s,o,r,h){for(let a=0;a<e;a++){const e=a+s,c=a+o;if(a<i)n[e]=t.song.channels[c];else{n[e]=new X,n[e].octave=r;for(let i=0;i<t.song.instrumentsPerChannel;i++){const t=new Q(h),s=re(h),o=l.valueToPreset(s);t.fromJsonObject(o.settings,h),t.preset=s,t.volume=1,n[e].instruments[i]=t}for(let i=0;i<t.song.patternsPerChannel;i++)n[e].patterns[i]=new K;for(let i=0;i<t.song.barCount;i++)n[e].bars[i]=0}}}s(e,t.song.pitchChannelCount,0,0,2,!1),s(i,t.song.noiseChannelCount,e,t.song.pitchChannelCount,0,!0),t.song.pitchChannelCount=e,t.song.noiseChannelCount=i;for(let e=0;e<t.song.getChannelCount();e++)t.song.channels[e]=n[e];t.song.channels.length=t.song.getChannelCount(),t.channel=Math.min(t.channel,e+i-1),t.notifier.changed(),this.V()}}}class kt extends st{constructor(t,e,i,s=!1){super();const n=t.channel,o=t.bar;t.channel=e,t.bar=i,s||(t.barScrollPos=Math.min(t.bar,Math.max(t.bar-(t.trackVisibleBars-1),t.barScrollPos))),t.notifier.changed(),n==e&&o==i||this.V()}}class Mt extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.interval!=e&&(this.V(),i.interval=e,i.preset=i.type,t.notifier.changed())}}class xt extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chord!=e&&(this.V(),i.chord=e,i.preset=i.type,t.notifier.changed())}}class Et extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.vibrato!=e&&(i.vibrato=e,i.preset=i.type,t.notifier.changed(),this.V())}}class qt extends st{constructor(t,e,i){super(),i.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.V()}}class Ct extends st{constructor(t,e,i){super(),i.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.V()}}class Pt extends st{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.drumsetEnvelopes[e]!=i&&(s.drumsetEnvelopes[e]=i,s.preset=s.type,t.notifier.changed(),this.V())}}class St extends st{constructor(t){super(),this.m=t,this.ft=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()]}commit(){this.isNoop()||(this.ft.preset=this.ft.type,this.m.notifier.changed())}}class Tt extends St{constructor(t,e,i){super(t),this.ft.pulseWidth=i,t.notifier.changed(),e!=i&&this.V()}}class Rt extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.pulseEnvelope!=e&&(i.pulseEnvelope=e,i.preset=i.type,t.notifier.changed(),this.V())}}class zt extends St{constructor(t,e,i){super(t),this.ft.filterCutoff=i,t.notifier.changed(),e!=i&&this.V()}}class Bt extends St{constructor(t,e,i){super(t),this.ft.filterResonance=i,t.notifier.changed(),e!=i&&this.V()}}class Nt extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.filterEnvelope!=e&&(i.filterEnvelope=e,i.preset=i.type,t.notifier.changed(),this.V())}}class Lt extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.algorithm!=e&&(i.algorithm=e,i.preset=i.type,t.notifier.changed(),this.V())}}class Ft extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.feedbackType!=e&&(i.feedbackType=e,i.preset=i.type,t.notifier.changed(),this.V())}}class At extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.feedbackEnvelope!=e&&(i.feedbackEnvelope=e,i.preset=i.type,t.notifier.changed(),this.V())}}class Ht extends st{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.operators[e].envelope!=i&&(s.operators[e].envelope=i,s.preset=s.type,t.notifier.changed(),this.V())}}class It extends st{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.operators[e].frequency!=i&&(s.operators[e].frequency=i,s.preset=s.type,t.notifier.changed(),this.V())}}class Ot extends St{constructor(t,e,i,s){super(t),this.ft.operators[e].amplitude=s,t.notifier.changed(),i!=s&&this.V()}}class Ut extends St{constructor(t,e,i){super(t),this.ft.feedbackAmplitude=i,t.notifier.changed(),e!=i&&this.V()}}class $t extends st{constructor(t,e){if(super(),t.song.instrumentsPerChannel!=e){for(let i=0;i<t.song.getChannelCount();i++){const s=t.song.channels[i].instruments[t.song.instrumentsPerChannel-1],n=s.toJsonObject();for(let o=t.song.instrumentsPerChannel;o<e;o++){const e=new Q(t.song.getChannelIsNoise(i));4==s.type?e.setTypeAndReset(3,!0):e.fromJsonObject(n,t.song.getChannelIsNoise(i)),t.song.channels[i].instruments[o]=e}t.song.channels[i].instruments.length=e;for(let s=0;s<t.song.patternsPerChannel;s++)t.song.channels[i].patterns[s].instrument>=e&&(t.song.channels[i].patterns[s].instrument=0)}t.song.instrumentsPerChannel=e,t.notifier.changed(),this.V()}}}class _t extends st{constructor(t,e){super(),t.song.key!=e&&(t.song.key=e,t.notifier.changed(),this.V())}}class Dt extends st{constructor(t,e,i,s,n){super(),this.m=t,this.oldStart=e,this.oldLength=i,this.newStart=s,this.newLength=n,this.m.song.loopStart=this.newStart,this.m.song.loopLength=this.newLength,this.m.notifier.changed(),this.oldStart==this.newStart&&this.oldLength==this.newLength||this.V()}}class Wt extends nt{constructor(t,e,i,s,n=!1){super(n),this.m=t,this.et=e,this.ut=i,this.H=s,this.V(),this.redo()}Y(){this.et.pitches.splice(this.H,0,this.ut),this.m.notifier.changed()}Z(){this.et.pitches.splice(this.H,1),this.m.notifier.changed()}}class jt extends st{constructor(t,e,i){super(),this.oldValue=e,t.song.channels[t.channel].octave=i,t.notifier.changed(),e!=i&&this.V()}}class Vt extends ot{constructor(t,e){super(),t.song.rhythm!=e&&(t.song.rhythm=e,t.notifier.changed(),this.V())}}class Gt extends ot{constructor(t,e,i,s,n,o){super(),this.append(new ge(t,e,s,n));let r=0;for(let t=0;t<e.notes.length;t++)if(e.notes[t].start<s){if(e.notes[t].end>s)throw new Error;r=t+1}else if(e.notes[t].start<n)throw new Error;for(;s<n;){for(const o of i){const i=o.start+s,h=o.end+s;if(i>=n)break;const a=new G(o.pitches[0],i,h,o.pins[0].volume,!1);a.pitches.length=0;for(const t of o.pitches)a.pitches.push(t);a.pins.length=0;for(const t of o.pins)a.pins.push(W(t.interval,t.time,t.volume));e.notes.splice(r++,0,a),a.end>n&&this.append(new ye(t,a,a.start,n))}s+=o}t.notifier.changed(),this.V()}}class Kt extends ot{constructor(t,e,i){super(),e.fromJsonObject(i,i.isDrum),t.notifier.changed(),this.V()}}class Jt extends st{constructor(t,e,i){super(),i.instrument!=e&&(i.instrument=e,t.notifier.changed(),this.V())}}class Yt extends st{constructor(t,e){if(super(),t.song.patternsPerChannel!=e){for(let i=0;i<t.song.getChannelCount();i++){const s=t.song.channels[i].bars,n=t.song.channels[i].patterns;for(let t=0;t<s.length;t++)s[t]>e&&(s[t]=0);for(let t=n.length;t<e;t++)n[t]=new K;n.length=e}t.song.patternsPerChannel=e,t.notifier.changed(),this.V()}}}class Zt extends nt{constructor(t,e,i){super(!1),this.dt=null;const s=t.song;if(0!=s.channels[e].bars[i])return;this.m=t,this.yt=i,this.gt=e,this.vt=s.patternsPerChannel,this.bt=s.patternsPerChannel;let n=null,o=null;for(let t=1;t<=s.patternsPerChannel;t++){let i=!1;for(let n=0;n<s.barCount;n++)if(s.channels[e].bars[n]==t){i=!0;break}if(i)continue;null==o&&(o=t);if(0==s.channels[e].patterns[t-1].notes.length){n=t;break}}if(null!=n)this.wt=n;else if(s.patternsPerChannel<s.barCount)this.bt=s.patternsPerChannel+1,this.wt=s.patternsPerChannel+1;else{if(null==o)throw new Error;this.wt=o,this.dt=s.channels[e].patterns[o-1].notes}this.V(),this.Y()}Y(){const t=this.m.song;for(let e=t.patternsPerChannel;e<this.bt;e++)for(let i=0;i<t.getChannelCount();i++)t.channels[i].patterns[e]=new K;t.patternsPerChannel=this.bt;t.channels[this.gt].patterns[this.wt-1].notes=[],t.channels[this.gt].bars[this.yt]=this.wt,this.m.notifier.changed()}Z(){const t=this.m.song,e=t.channels[this.gt].patterns[this.wt-1];null!=this.dt&&(e.notes=this.dt),t.channels[this.gt].bars[this.yt]=0;for(let e=0;e<t.getChannelCount();e++)t.channels[e].patterns.length=this.vt;t.patternsPerChannel=this.vt,this.m.notifier.changed()}}class Qt extends ct{constructor(t,e,i,s){super(t,e),s-=this.it;const n=this.rt[i].time,o=Math.min(n,s),r=Math.max(n,s);let h=!1;for(let t=0;t<this.rt.length;t++){const n=e.pins[t],a=n.time;a<o?this.ht.push(W(n.interval,a,n.volume)):a>r&&(h||(this.ht.push(W(this.rt[i].interval,s,this.rt[i].volume)),h=!0),this.ht.push(W(n.interval,a,n.volume)))}h||this.ht.push(W(this.rt[i].interval,s,this.rt[i].volume)),this.ct()}}class Xt extends ct{constructor(t,e,i,s,n,o){super(t,e),i-=this.it,s-=this.it,n-=e.pitches[o];let r,h,a,l,c=!1,f=!1,u=0,d=3,m=!0;for(s>i?(r=0,h=1,a=e.pins.length,l=t=>{this.ht.push(t)}):(r=e.pins.length-1,h=-1,a=-1,l=t=>{this.ht.unshift(t)});r!=a;r+=h){const t=e.pins[r],o=t.time;for(;;)if(c){if(f){if(o*h==s*h)break;t.interval!=u&&(m=!1),l(W(m?n:t.interval,o,t.volume));break}if(o*h<=s*h&&(u=t.interval,d=t.volume),o*h<s*h)break;l(W(n,s,d)),f=!0}else{if(o*h<=i*h&&(u=t.interval,d=t.volume),o*h<i*h){l(W(t.interval,o,t.volume));break}l(W(u,i,d)),c=!0}}f||l(W(n,s,d)),this.ct()}}class te extends rt{constructor(t,i){super();const s=e.partsPerBeat/e.rhythms[t.song.rhythm].stepsPerBeat,n=function(i){let n=e.rhythms[t.song.rhythm].roundUpThresholds;if(null!=n){const t=Math.floor(i/e.partsPerBeat)*e.partsPerBeat,o=i-t;let r=t;for(const t of n){if(!(o>=t))break;r+=s}return r}return Math.round(i/s)*s};let o=0;for(;o<i.notes.length;){const e=i.notes[o];n(e.start)>=n(e.end)?this.append(new pe(t,i,e,o,!0)):(this.append(new ee(t,e,n)),o++)}}}class ee extends ct{constructor(t,e,i){super(t,e);for(const t of this.rt)this.ht.push(W(t.interval,i(t.time+this.it)-this.it,t.volume));this.ct()}}class ie extends ot{constructor(t,i,s){super();let n=Math.round(i%t.song.beatsPerBar*e.partsPerBeat);if(n<0&&(n+=t.song.beatsPerBar*e.partsPerBeat),0!=n){switch(s){case"wrapAround":{const i=e.partsPerBeat*t.song.beatsPerBar;for(const e of t.song.channels)for(const t of e.patterns){const e=[];for(let s=1;s>=0;s--){const o=s*i;for(const s of t.notes){const t=s.start+n,r=s.end+n,h=Math.max(0,t-o),a=Math.min(i,r-o);h<a&&at(s,t-o-h,h,a,e)}}t.notes=e}}break;case"overflow":{let e=t.song.barCount,s=t.song.loopStart,o=t.song.loopLength;if(this.append(new lt(t,t.song.beatsPerBar,n)),i<0){let i=!0;for(const e of t.song.channels)0!=e.bars[0]&&(i=!1);if(i){for(const e of t.song.channels)e.bars.shift();t.song.barCount--}else e++,s++,t.bar++}for(;t.song.barCount<e;){for(const e of t.song.channels)e.bars.push(0);t.song.barCount++}t.song.loopStart=s,t.song.loopLength=o}break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}t.notifier.changed(),this.V()}}}class se extends ot{constructor(t,i,s){if(super(),t.song.beatsPerBar!=i){switch(s){case"splice":if(t.song.beatsPerBar>i){const s=new rt;for(let n=0;n<t.song.getChannelCount();n++)for(let o=0;o<t.song.channels[n].patterns.length;o++)s.append(new ge(t,t.song.channels[n].patterns[o],i*e.partsPerBeat,t.song.beatsPerBar*e.partsPerBeat))}break;case"stretch":{const e=function(e){return Math.round(e*i/t.song.beatsPerBar)};for(let i=0;i<t.song.getChannelCount();i++)for(let s=0;s<t.song.channels[i].patterns.length;s++){const n=t.song.channels[i].patterns[s];let o=0;for(;o<n.notes.length;){const i=n.notes[o];e(i.start)>=e(i.end)?this.append(new pe(t,n,i,o,!0)):(this.append(new ee(t,i,e)),o++)}}this.append(new de(t,t.song.tempo,t.song.tempo*i/t.song.beatsPerBar))}break;case"overflow":this.append(new lt(t,i,0)),t.song.loopStart=0,t.song.loopLength=t.song.barCount;break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}t.song.beatsPerBar=i,t.notifier.changed(),this.V()}}}class ne extends ot{constructor(t,e){super(),t.song.scale!=e&&(t.song.scale=e,t.notifier.changed(),this.V())}}class oe extends ot{constructor(t){super();const i=t.song,s=e.keys[i.key].basePitch,n=[0,0,0,0,0,0,0,0,0,0,0,0];for(let t=0;t<i.pitchChannelCount;t++)for(let o=0;o<i.barCount;o++){const r=i.getPattern(t,o);if(null!=r)for(const t of r.notes){const i=t.pins[0];for(let o=1;o<t.pins.length;o++){const r=t.pins[o];if(i.interval==r.interval){let o=r.time-i.time;o+=Math.max(0,Math.min(e.partsPerBeat,r.time+t.start)-(i.time+t.start)),o*=r.volume+i.volume;for(const e of t.pitches){n[(s+i.interval+e)%12]+=o}}}}}let o=0,r=0;for(let t=0;t<12;t++){const e=n[t]*(3*n[(t+7)%12]+n[(t+4)%12]+n[(t+3)%12]);r<e&&(r=e,o=t)}if(o!=i.key){const e=i.key-o,s=Math.abs(e);for(let n=0;n<i.pitchChannelCount;n++)for(const o of i.channels[n].patterns)for(let i=0;i<s;i++)this.append(new we(t,n,o,e>0,!0));i.key=o,t.notifier.changed(),this.V()}}}function re(t){const e=[];for(let i=0;i<l.presetCategories.length;i++){const s=l.presetCategories[i];if("Novelty Presets"!=s.name)for(let n=0;n<s.presets.length;n++){const o=s.presets[n];null!=o.settings&&1==o.isNoise==t&&e.push((i<<6)+n)}}return e[Math.random()*e.length|0]}function he(t){for(let e=0;e<t.channels.length;e++)for(const i of t.channels[e].instruments){const s=t.getChannelIsNoise(e),n=e==t.pitchChannelCount?l.nameToPresetValue(Math.random()>.5?"chip noise":"standard drumset"):re(s),o=l.valueToPreset(n);i.fromJsonObject(o.settings,s),i.preset=n,i.volume=1}}class ae extends ot{constructor(t,e){super(),t.song.fromBase64String(e),""==e?(this.append(new Me(t,0,0)),t.selection.resetBoxSelection(),he(t.song)):this.append(new le(t)),t.notifier.changed(),this.V()}}class le extends st{constructor(t){super();const e=Math.min(t.channel,t.song.getChannelCount()-1),i=Math.max(0,Math.min(t.song.barCount-1,t.bar)),s=Math.min(t.bar,Math.max(t.bar-(t.trackVisibleBars-1),Math.max(0,Math.min(t.song.barCount-t.trackVisibleBars,t.barScrollPos))));t.channel==e&&t.bar==i&&t.barScrollPos==s||(t.channel=e,t.bar=i,t.barScrollPos=s,t.notifier.changed(),this.V())}}class ce extends ot{constructor(t,i,s){super();const n=t.song;function o(t,e){for(;t.length>e;){let e=t.length-1,i=0;for(let s=0;s<t.length-1;s++){let n=0;for(const e of t[s].bars)0==e&&n++;n>=i&&(e=s,i=n)}t.splice(e,1)}}for(o(i,e.pitchChannelCountMax),o(s,e.noiseChannelCountMax);i.length<e.pitchChannelCountMin;)i.push(new X);for(;s.length<e.noiseChannelCountMin;)s.push(new X);n.barCount=1,n.instrumentsPerChannel=1,n.patternsPerChannel=8;const r=i.concat(s);for(let t=0;t<r.length;t++){const e=r[t];n.barCount=Math.max(n.barCount,e.bars.length),n.patternsPerChannel=Math.max(n.patternsPerChannel,e.patterns.length),n.instrumentsPerChannel=Math.max(n.instrumentsPerChannel,e.instruments.length),n.channels[t]=e}n.channels.length=r.length,n.pitchChannelCount=i.length,n.noiseChannelCount=s.length,n.barCount=Math.min(e.barCountMax,n.barCount),n.patternsPerChannel=Math.min(e.barCountMax,n.patternsPerChannel),n.instrumentsPerChannel=Math.min(e.instrumentsPerChannelMax,n.instrumentsPerChannel);for(let e=0;e<n.channels.length;e++){const i=n.channels[e];for(let t=0;t<i.bars.length;t++)(i.bars[t]>n.patternsPerChannel||i.bars[t]<0)&&(i.bars[t]=0);for(const t of i.patterns)(t.instrument>=n.instrumentsPerChannel||t.instrument<0)&&(t.instrument=0);for(;i.bars.length<n.barCount;)i.bars.push(0);for(;i.patterns.length<n.patternsPerChannel;)i.patterns.push(new K);for(;i.instruments.length<n.instrumentsPerChannel;){const s=new Q(t.song.getChannelIsNoise(e));n.getChannelIsNoise(e)?s.setTypeAndReset(2,!0):s.setTypeAndReset(0,!1),i.instruments.push(s)}i.bars.length=n.barCount,i.patterns.length=n.patternsPerChannel,i.instruments.length=n.instrumentsPerChannel}n.loopStart=Math.max(0,Math.min(n.barCount-1,n.loopStart)),n.loopLength=Math.min(n.barCount-n.loopStart,n.loopLength),this.append(new le(t)),t.notifier.changed(),this.V()}}function fe(t,e){if(t.length!=e.length)return!1;for(let i=0;i<t.length;i++){const s=t[i],n=e[i];if(n.start!=s.start||n.end!=s.end||n.pitches.length!=s.pitches.length||n.pins.length!=s.pins.length)return!1;for(let t=0;t<s.pitches.length;t++)if(n.pitches[t]!=s.pitches[t])return!1;for(let t=0;t<s.pins.length;t++)if(n.pins[t].interval!=s.pins[t].interval||n.pins[t].time!=s.pins[t].time||n.pins[t].volume!=s.pins[t].volume)return!1}return!0}function ue(t){for(const e of t){const t=[];for(let i=0;i<e.bars.length;i++){if(0==e.bars[i])continue;const s=e.patterns[e.bars[i]-1];let n=!1;for(let o=0;o<t.length;o++){const r=t[o];if(r.instrument==s.instrument&&r.notes.length==s.notes.length&&fe(s.notes,r.notes)){n=!0,e.bars[i]=o+1;break}}n||(t.push(s),e.bars[i]=t.length)}for(let i=0;i<t.length;i++)e.patterns[i]=t[i];e.patterns.length=t.length}}class de extends st{constructor(t,i,s){super(),t.song.tempo=Math.max(e.tempoMin,Math.min(e.tempoMax,Math.round(s))),t.notifier.changed(),i!=s&&this.V()}}class me extends st{constructor(t,e,i){super(),t.song.reverb=i,t.notifier.changed(),e!=i&&this.V()}}class pe extends nt{constructor(t,e,i,s,n=!1){super(n),this.m=t,this.kt=e,this.et=i,this.H=s,this.V(),this.redo()}Y(){this.kt.notes.splice(this.H,0,this.et),this.m.notifier.changed()}Z(){this.kt.notes.splice(this.H,1),this.m.notifier.changed()}}class ye extends ct{constructor(t,e,i,s){super(t,e),i-=this.it,s-=this.it;let n,o=!1,r=this.rt[0].volume,h=this.rt[0].interval,a=!0;for(n=0;n<this.rt.length;n++){const t=this.rt[n];if(t.time<i)r=t.volume,h=t.interval;else{if(!(t.time<=s))break;if(t.time>i&&!o&&this.ht.push(W(h,i,r)),this.ht.push(W(t.interval,t.time,t.volume)),o=!0,t.time==s){a=!1;break}}}a&&this.ht.push(W(this.rt[n].interval,s,this.rt[n].volume)),this.ct()}}class ge extends rt{constructor(t,e,i,s,n){super();let o=0;for(;o<e.notes.length;){const r=e.notes[o];if(r==n&&null!=n)o++;else if(r.end<=i)o++;else{if(r.start>=s)break;if(r.start<i&&r.end>s){const n=r.clone();this.append(new ye(t,r,r.start,i)),o++,this.append(new pe(t,e,n,o,!1)),this.append(new ye(t,n,s,n.end)),o++}else r.start<i?(this.append(new ye(t,r,r.start,i)),o++):r.end>s?(this.append(new ye(t,r,s,r.end)),o++):this.append(new pe(t,e,r,o,!0))}}}}class ve extends rt{constructor(t,e){super();let i=0;for(;i<e.notes.length;){const s=e.notes[i];if(s.start<t.selection.patternSelectionStart&&t.selection.patternSelectionStart<s.end){const n=s.clone();this.append(new ye(t,s,s.start,t.selection.patternSelectionStart)),i++,this.append(new pe(t,e,n,i,!1)),this.append(new ye(t,n,t.selection.patternSelectionStart,n.end))}else if(s.start<t.selection.patternSelectionEnd&&t.selection.patternSelectionEnd<s.end){const n=s.clone();this.append(new ye(t,s,s.start,t.selection.patternSelectionEnd)),i++,this.append(new pe(t,e,n,i,!1)),this.append(new ye(t,n,t.selection.patternSelectionEnd,n.end)),i++}else i++}}}class be extends nt{constructor(t,i,s,n,o=!1,r=!1){super(!1),this.m=t,this.et=s,this.rt=s.pins,this.ht=[],this.at=s.pitches,this.lt=[];const h=t.song.getChannelIsNoise(i);if(h!=t.song.getChannelIsNoise(t.channel))return;const a=h?e.drumCount-1:e.maxPitch;for(let i=0;i<this.at.length;i++){let s=this.at[i];if(r&&!h)s=n?Math.min(a,s+12):Math.max(0,s-12);else if(n){for(let i=s+1;i<=a;i++)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}}else for(let i=s-1;i>=0;i--)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}let l=!1;for(let t=0;t<this.lt.length;t++)if(this.lt[t]==s){l=!0;break}l||this.lt.push(s)}let l=0,c=a;for(let t=1;t<this.lt.length;t++){const e=this.lt[0]-this.lt[t];l<e&&(l=e),c>e+a&&(c=e+a)}for(const i of this.rt){let s=i.interval+this.at[0];if(s<l&&(s=l),s>c&&(s=c),r&&!h)s=n?Math.min(c,s+12):Math.max(l,s-12);else if(n){for(let i=s+1;i<=c;i++)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}}else for(let i=s-1;i>=l;i--)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}s-=this.lt[0],this.ht.push(W(s,i.time,i.volume))}if(0!=this.ht[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<this.ht.length-1;)this.ht[t-1].interval==this.ht[t].interval&&this.ht[t].interval==this.ht[t+1].interval&&this.ht[t-1].volume==this.ht[t].volume&&this.ht[t].volume==this.ht[t+1].volume?this.ht.splice(t,1):t++;this.Y(),this.V()}Y(){this.et.pins=this.ht,this.et.pitches=this.lt,this.m.notifier.changed()}Z(){this.et.pins=this.rt,this.et.pitches=this.at,this.m.notifier.changed()}}class we extends rt{constructor(t,e,i,s,n=!1,o=!1){super(),t.selection.patternSelectionActive&&this.append(new ve(t,i));for(const r of i.notes)t.selection.patternSelectionActive&&(r.end<=t.selection.patternSelectionStart||r.start>=t.selection.patternSelectionEnd)||this.append(new be(t,e,r,s,n,o))}}class ke extends st{constructor(t,e,i,s,n){super(),t.selection.boxSelectionX0=e,t.selection.boxSelectionX1=i,t.selection.boxSelectionY0=s,t.selection.boxSelectionY1=n,t.notifier.changed(),this.V()}}class Me extends nt{constructor(t,e,i){super(!1),this.m=t,this.it=t.selection.patternSelectionStart,this.st=t.selection.patternSelectionEnd,this.Mt=t.selection.patternSelectionActive,this.nt=e,this.ot=i,this.xt=e<i,this.Y(),this.V()}Y(){this.m.selection.patternSelectionStart=this.nt,this.m.selection.patternSelectionEnd=this.ot,this.m.selection.patternSelectionActive=this.xt,this.m.notifier.changed()}Z(){this.m.selection.patternSelectionStart=this.it,this.m.selection.patternSelectionEnd=this.st,this.m.selection.patternSelectionActive=this.Mt,this.m.notifier.changed()}}class xe extends rt{constructor(t,i,s,n,o){if(super(),0==n&&0==o)return;t.selection.patternSelectionActive&&this.append(new ve(t,s));const r=t.selection.patternSelectionStart,h=t.selection.patternSelectionEnd,a=Math.max(0,Math.min(t.song.beatsPerBar*e.partsPerBeat,r+n)),l=Math.max(0,Math.min(t.song.beatsPerBar*e.partsPerBeat,h+n));a==l?this.append(new ge(t,s,r,h)):n<0?(this.append(new ge(t,s,a,Math.min(r,l))),r<-n&&this.append(new ge(t,s,r,-n))):(this.append(new ge(t,s,Math.max(h,a),l)),h>t.song.beatsPerBar*e.partsPerBeat-n&&this.append(new ge(t,s,t.song.beatsPerBar*e.partsPerBeat-n,h))),this.append(new Me(t,a,l));const c=[];let f=0,u=0;for(;u<s.notes.length;){const e=s.notes[u];e.end<=r||e.start>=h?(u++,e.end<=a&&(f=u)):(c.push(e.clone()),this.append(new pe(t,s,e,u,!0)))}for(const e of c){e.start+=n,e.end+=n;for(let s=0;s<Math.abs(o);s++)this.append(new be(t,i,e,o>0));this.append(new pe(t,s,e,f++,!1))}}}class Ee extends ot{constructor(t,i,s,n,o){super();for(let r=n;r<n+o;r++){const n={};for(let o=i;o<i+s;o++){const h=t.song.channels[r].bars[o];if(0!=h){if(null==n[String(h)]){let a=!1;for(let e=0;e<t.song.barCount;e++)if((e<i||e>=i+s)&&t.song.channels[r].bars[e]==h){a=!0;break}if(a){const i=t.song.getPattern(r,o);this.append(new yt(t,0,o,r,1,1)),this.append(new Zt(t,r,o));const s=t.song.getPattern(r,o);if(null==s)throw new Error;this.append(new Gt(t,s,i.notes,0,e.partsPerBeat*t.song.beatsPerBar,e.partsPerBeat*t.song.beatsPerBar)),this.append(new Jt(t,i.instrument,s)),n[String(h)]=t.song.channels[r].bars[o]}else n[String(h)]=h}this.append(new yt(t,n[String(h)],o,r,1,1))}}}}}class qe extends st{constructor(t,i,s){super(),t.selection.patternSelectionActive&&new ve(t,i);const n=e.maxPitch;for(const e of i.notes){if(t.selection.patternSelectionActive&&(e.end<=t.selection.patternSelectionStart||e.start>=t.selection.patternSelectionEnd))continue;const i=[],o=[];for(let t=0;t<e.pitches.length;t++){const n=e.pitches[t],o=s[n%12]+(n-n%12);-1==i.indexOf(o)&&i.push(o)}let r=0,h=n;for(let t=1;t<i.length;t++){const e=i[0]-i[t];r<e&&(r=e),h>e+n&&(h=e+n)}for(const t of e.pins){let n=t.interval+e.pitches[0];n<r&&(n=r),n>h&&(n=h);const a=s[n%12]+(n-n%12);o.push(W(a-i[0],t.time,t.volume))}if(0!=o[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<o.length-1;)o[t-1].interval==o[t].interval&&o[t].interval==o[t+1].interval&&o[t-1].volume==o[t].volume&&o[t].volume==o[t+1].volume?o.splice(t,1):t++;e.pitches=i,e.pins=o}this.V(),t.notifier.changed()}}class Ce extends st{constructor(t,e,i){super(),t.song.channels[t.channel].instruments[t.getCurrentInstrument()].volume=i,t.notifier.changed(),e!=i&&this.V()}}class Pe extends st{constructor(t,e,i){super(),t.song.channels[t.channel].instruments[t.getCurrentInstrument()].pan=i,t.notifier.changed(),e!=i&&this.V()}}class Se extends nt{constructor(t,e,i,s,n){super(!1),this.m=t,this.et=e,this.rt=e.pins,this.ht=[];let o=!1;for(const t of e.pins)t.time<i?this.ht.push(t):t.time==i?(this.ht.push(W(n,i,s)),o=!0):(o||(this.ht.push(W(n,i,s)),o=!0),this.ht.push(t));for(let t=1;t<this.ht.length-1;)this.ht[t-1].interval==this.ht[t].interval&&this.ht[t].interval==this.ht[t+1].interval&&this.ht[t-1].volume==this.ht[t].volume&&this.ht[t].volume==this.ht[t+1].volume?this.ht.splice(t,1):t++;this.Y(),this.V()}Y(){this.et.pins=this.ht,this.m.notifier.changed()}Z(){this.et.pins=this.rt,this.m.notifier.changed()}}class Te extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chipWave!=e&&(i.chipWave=e,i.preset=i.type,t.notifier.changed(),this.V())}}class Re extends st{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chipNoise!=e&&(i.chipNoise=e,i.preset=i.type,t.notifier.changed(),this.V())}}class ze{constructor(){this.valid=!1,this.prevNote=null,this.curNote=null,this.nextNote=null,this.pitch=0,this.pitchIndex=-1,this.curIndex=0,this.start=0,this.end=0,this.part=0,this.exactPart=0,this.nearPinIndex=0,this.pins=[]}}class Be{constructor(t,i,s){this.m=t,this.Et=i,this.qt=s,this.Ct=k.pattern({id:"patternEditorNoteBackground"+this.qt,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this.Pt=k.pattern({id:"patternEditorDrumBackground"+this.qt,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this.St=k.rect({x:"0",y:"0","pointer-events":"none",fill:"url(#patternEditorNoteBackground"+this.qt+")"}),this.Tt=k.svg(),this.Rt=k.rect({x:"0",y:"0",width:"4",fill:S.playhead,"pointer-events":"none"}),this.zt=k.rect({fill:S.boxSelectionFill,stroke:S.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","pointer-events":"none",visibility:"hidden"}),this.Bt=k.path({fill:"none",stroke:S.hoverPreview,"stroke-width":"2","pointer-events":"none"}),this.Nt=k.svg({style:`background-color: ${S.editorBackground}; touch-action: none; position: absolute;`,width:"100%",height:"100%"},k.defs(this.Ct,this.Pt),this.St,this.zt,this.Tt,this.Bt,this.Rt),this.container=w.div({style:"height: 100%; overflow:hidden; position: relative; flex-grow: 1;"},this.Nt),this.Lt=[],this.Ft=k.rect(),this.At=-1,this.Ht=0,this.It=0,this.Ot=!1,this.Ut=!1,this.$t=!1,this._t=!1,this.Dt=!1,this.Wt=[],this.jt=0,this.Vt=0,this.Gt=!1,this.Kt=0,this.Jt=!1,this.Yt=!1,this.Zt=!1,this.Qt=0,this.Xt=0,this.te=0,this.ee=!1,this.ie=null,this.se=null,this.ne=!1,this.oe=new ze,this.kt=null,this.re=0,this.he=0,this.ae=-1,this.le=-1,this.ce=-1,this.fe=-1,this.ue=!1,this.de=!1,this.me=-1,this.pe=-1,this.ye=-1,this.ge=-1,this.resetCopiedPins=()=>{const t=this.ve();this.Wt.length=this.m.song.getChannelCount();for(let e=0;e<this.m.song.pitchChannelCount;e++)this.Wt[e]=[W(0,0,3),W(0,t,3)];for(let e=this.m.song.pitchChannelCount;e<this.m.song.getChannelCount();e++)this.Wt[e]=[W(0,0,3),W(0,t,0)]},this.be=t=>{this.Dt&&!this.Gt&&!this.$t&&this.Ot&&performance.now()>this.Kt+1e3&&this.oe.valid&&this.m.lastChangeWas(this.ie)&&(this.ie.undo(),this.Gt=!0,this.we(),this.m.notifier.notifyWatchers());const e=Math.floor(this.m.synth.playhead);if(this.m.synth.playing&&(null!=this.kt&&this.m.song.getPattern(this.m.channel,Math.floor(this.m.synth.playhead))==this.kt||Math.floor(this.m.synth.playhead)==this.m.bar+this.qt)){this.Rt.setAttribute("visibility","visible");const t=this.m.synth.playhead-e;Math.abs(t-this.re)>.1?this.re=t:this.re+=.2*(t-this.re),this.Rt.setAttribute("x",""+a(this.re*this.ke-2))}else this.Rt.setAttribute("visibility","hidden");this.m.synth.playing&&this.m.autoFollow&&this.ge!=e&&(new kt(this.m,this.m.channel,e),this.m.notifier.notifyWatchers()),this.ge=e,window.requestAnimationFrame(this.be)},this.Me=t=>{this.Ut||(this.Ut=!0,this.Dt=!1)},this.xe=t=>{this.Ut&&(this.Ut=!1)},this.Ee=t=>{t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Ht=((t.clientX||t.pageX)-e.left)*this.ke/(e.right-e.left),this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Dt=!1,this.Gt=t.shiftKey,this.we()},this.Ce=t=>{t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Ht=(t.touches[0].clientX-e.left)*this.ke/(e.right-e.left),this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Dt=!0,this.Gt=t.shiftKey,this.Kt=performance.now(),this.we()},this.Pe=t=>{const e=this.Nt.getBoundingClientRect();this.Ht=((t.clientX||t.pageX)-e.left)*this.ke/(e.right-e.left),this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Dt=!1,this.Se()},this.Te=t=>{if(!this.Ot)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Ht=(t.touches[0].clientX-e.left)*this.ke/(e.right-e.left),this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Se()},this.Re=t=>{if(!this.oe.valid)return;const i=this.m.lastChangeWas(this.ie);if(this.Ot&&i&&null!=this.ie)if(this.Zt)this.m.record(this.ie),this.ie=null;else if(this.Jt||this.Yt||this.Gt)this.ze(this.ie),this.ie=null;else if(this.$t||null==this.oe.curNote||!this.ie.isNoop()||this.Jt||this.Yt||this.Zt||this.Gt)this.m.record(this.ie),this.ie=null;else{if(null==this.kt)throw new Error;const t=new rt;if(t.append(new Me(this.m,0,0)),-1==this.oe.pitchIndex){if(this.oe.curNote.pitches.length==e.maxChordSize&&t.append(new Wt(this.m,this.oe.curNote,this.oe.curNote.pitches[0],0,!0)),t.append(new Wt(this.m,this.oe.curNote,this.oe.pitch,this.oe.curNote.pitches.length)),this.Be(this.oe.curNote),this.m.enableNotePreview&&!this.m.synth.playing){const t=Math.min(e.partsPerBeat,this.oe.end-this.oe.start);this.m.synth.liveInputDuration=t,this.m.synth.liveInputPitches=this.oe.curNote.pitches.concat(),this.m.synth.liveInputStarted=!0}}else 1==this.oe.curNote.pitches.length?t.append(new pe(this.m,this.kt,this.oe.curNote,this.oe.curIndex,!0)):t.append(new Wt(this.m,this.oe.curNote,this.oe.pitch,this.oe.curNote.pitches.indexOf(this.oe.pitch),!0));this.m.record(t)}this.Ot=!1,this.$t=!1,this.Jt=!1,this.Yt=!1,this.Zt=!1,this.ne=!1,this.Ne(),this.Le()};for(let t=0;t<e.pitchesPerOctave;t++){const e=k.rect();e.setAttribute("x","1"),e.setAttribute("fill",0==t?S.tonic:S.pitchBackground),this.Ct.appendChild(e),this.Lt[t]=e}this.Ft.setAttribute("x","1"),this.Ft.setAttribute("y","1"),this.Ft.setAttribute("fill",S.pitchBackground),this.Pt.appendChild(this.Ft),this.Et?(this.Ne(),this.Le(),window.requestAnimationFrame(this.be),this.Nt.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Re),this.Nt.addEventListener("mouseover",this.Me),this.Nt.addEventListener("mouseout",this.xe),this.Nt.addEventListener("touchstart",this.Ce),this.Nt.addEventListener("touchmove",this.Te),this.Nt.addEventListener("touchend",this.Re),this.Nt.addEventListener("touchcancel",this.Re)):(this.Rt.style.display="none",this.Nt.appendChild(k.rect({x:0,y:0,width:1e4,height:1e4,fill:S.editorBackground,style:"opacity: 0.5;"}))),this.resetCopiedPins()}ve(){const t=e.rhythms[this.m.song.rhythm].stepsPerBeat;return t%4==0?e.partsPerBeat/2:t%3==0?e.partsPerBeat/3:t%2==0?e.partsPerBeat/2:e.partsPerBeat}Fe(){return e.partsPerBeat/e.rhythms[this.m.song.rhythm].stepsPerBeat}Ae(t){const e=this.Fe();return Math.floor(t/e)*e}Ne(){if(this.oe=new ze,this.Ht<0||this.Ht>this.ke||this.It<0||this.It>this.qe||this.At<=0)return;const t=this.Fe();if(this.oe.exactPart=this.Ht/this.He,this.oe.part=Math.floor(Math.max(0,Math.min(this.m.song.beatsPerBar*e.partsPerBeat-t,this.oe.exactPart))/t)*t,null!=this.kt)for(const t of this.kt.notes)if(t.end<=this.oe.exactPart)this.oe.prevNote=t,this.oe.curIndex++;else if(t.start<=this.oe.exactPart&&t.end>this.oe.exactPart)this.oe.curNote=t;else if(t.start>this.oe.exactPart){this.oe.nextNote=t;break}let i=this.Ie(this.It);if(null!=this.oe.curNote){this.oe.start=this.oe.curNote.start,this.oe.end=this.oe.curNote.end,this.oe.pins=this.oe.curNote.pins;let t,s=0,n=0,o=this.oe.curNote.pins[0];for(let e=1;e<this.oe.curNote.pins.length;e++){t=o,o=this.oe.curNote.pins[e];const i=this.He*(this.oe.curNote.start+t.time),r=this.He*(this.oe.curNote.start+o.time);if(this.Ht>r)continue;if(this.Ht<i)throw new Error;const h=(this.Ht-i)/(r-i),a=Math.sqrt(1/Math.sqrt(4)-Math.pow(h-.5,2))-.5,l=Math.abs(o.interval-t.interval);s=t.interval*(1-h)+o.interval*h,n=a*l+.95;break}let r=Number.MAX_VALUE,h=-Number.MAX_VALUE,a=Number.MAX_VALUE;for(const t of this.oe.curNote.pins){r>t.interval&&(r=t.interval),h<t.interval&&(h=t.interval);const e=Math.abs(this.oe.curNote.start+t.time-this.Ht/this.He);a>e&&(a=e,this.oe.nearPinIndex=this.oe.curNote.pins.indexOf(t))}if(i-=s,this.oe.pitch=this.Oe(i,-r,(this.m.song.getChannelIsNoise(this.m.channel)?e.drumCount-1:e.maxPitch)-h),!this.m.song.getChannelIsNoise(this.m.channel)){let t=n;for(let e=0;e<this.oe.curNote.pitches.length;e++){const s=Math.abs(this.oe.curNote.pitches[e]-i+.5);s>t||(t=s,this.oe.pitch=this.oe.curNote.pitches[e])}}for(let t=0;t<this.oe.curNote.pitches.length;t++)if(this.oe.curNote.pitches[t]==this.oe.pitch){this.oe.pitchIndex=t;break}}else{this.oe.pitch=this.Oe(i,0,e.maxPitch);const t=this.Ue[this.Ue.length-1].time,s=Math.floor(this.oe.part/e.partsPerBeat),n=this.ve(),o=this.oe.part%e.partsPerBeat;if(1==t)this.oe.start=this.oe.part;else if(t>e.partsPerBeat)this.oe.start=s*e.partsPerBeat;else if(t==e.partsPerBeat)this.oe.start=s*e.partsPerBeat,n<e.partsPerBeat&&o>n&&(this.oe.start+=Math.floor(o/n)*n);else{this.oe.start=s*e.partsPerBeat;let i=e.partsPerBeat%t==0?t:Math.min(t,n);for(;i<n&&e.partsPerBeat%i!=0;)i++;this.oe.start+=Math.floor(o/i)*i}this.oe.end=this.oe.start+t;let r=0,h=this.m.song.beatsPerBar*e.partsPerBeat;if(null!=this.oe.prevNote&&(r=this.oe.prevNote.end),null!=this.oe.nextNote&&(h=this.oe.nextNote.start),this.oe.start<r?(this.oe.start=r,this.oe.end=this.oe.start+t,this.oe.end>h&&(this.oe.end=h)):this.oe.end>h&&(this.oe.end=h,this.oe.start=this.oe.end-t,this.oe.start<r&&(this.oe.start=r)),this.oe.end-this.oe.start==t)this.oe.pins=this.Ue;else{this.oe.pins=[];for(const t of this.Ue){if(!(t.time<=this.oe.end-this.oe.start)){this.oe.pins.push(W(0,this.oe.end-this.oe.start,t.volume));break}if(this.oe.pins.push(W(0,t.time,t.volume)),t.time==this.oe.end-this.oe.start)break}}}this.oe.valid=!0}$e(){return this.oe.valid&&this.m.selection.patternSelectionActive&&this.m.selection.patternSelectionStart<=this.oe.exactPart&&this.oe.exactPart<=this.m.selection.patternSelectionEnd}_e(){return this.oe.valid&&this.m.selection.patternSelectionActive&&-1==this.oe.pitchIndex&&this.m.selection.patternSelectionStart-3<=this.oe.exactPart&&this.oe.exactPart<=this.m.selection.patternSelectionStart+1.25}De(){return this.oe.valid&&this.m.selection.patternSelectionActive&&-1==this.oe.pitchIndex&&this.m.selection.patternSelectionEnd-1.25<=this.oe.exactPart&&this.oe.exactPart<=this.m.selection.patternSelectionEnd+3}Ie(t){return Math.max(0,Math.min(this.We-1,this.We-t/this.At))+this.he}Oe(t,i,s){t<i&&(t=i),t>s&&(t=s);const n=e.scales[this.m.song.scale].flags;if(n[Math.floor(t)%e.pitchesPerOctave]||this.m.song.getChannelIsNoise(this.m.channel))return Math.floor(t);{let o=Math.floor(t)+1,r=Math.floor(t)-1;for(;!n[o%e.pitchesPerOctave];)o++;for(;!n[r%e.pitchesPerOctave];)r--;if(o>s)return r<i?i:r;if(r<i)return o;let h=o,a=r+1;return o%e.pitchesPerOctave!=0&&o%e.pitchesPerOctave!=7||(h-=.5),r%e.pitchesPerOctave!=0&&r%e.pitchesPerOctave!=7||(a+=.5),t-a>h-t?o:r}}Be(t){this.Ue=[];for(const e of t.pins)this.Ue.push(W(0,e.time,e.volume));for(let t=1;t<this.Ue.length-1;)this.Ue[t-1].volume==this.Ue[t].volume&&this.Ue[t].volume==this.Ue[t+1].volume?this.Ue.splice(t,1):t++;this.Wt[this.m.channel]=this.Ue}we(){this.m.enableNotePreview&&this.m.synth.maintainLiveInput(),this.Ot=!0,this.jt=this.Ht,this.Vt=this.It,this.Ne(),this.Le();const t=new rt;if(this.ie=t,this.ne=this.m.lastChangeWas(this.se),this.m.setProspectiveChange(this.ie),this._e())this.Jt=!0;else if(this.De())this.Yt=!0;else if(this.Gt)if(this.m.selection.patternSelectionActive&&-1==this.oe.pitchIndex||this.$e())t.append(new Me(this.m,0,0));else if(null!=this.oe.curNote)t.append(new Me(this.m,this.oe.curNote.start,this.oe.curNote.end));else{const i=Math.max(0,Math.min((this.m.song.beatsPerBar-1)*e.partsPerBeat,Math.floor(this.oe.exactPart/e.partsPerBeat)*e.partsPerBeat)),s=i+e.partsPerBeat;t.append(new Me(this.m,i,s))}else if(this.$e())this.Zt=!0;else if(this.oe.valid&&null==this.oe.curNote){t.append(new Me(this.m,0,0));const i=new G(this.oe.pitch,this.oe.start,this.oe.end,3,this.m.song.getChannelIsNoise(this.m.channel));i.pins=[];for(const t of this.oe.pins)i.pins.push(W(0,t.time,t.volume));t.append(new Zt(this.m,this.m.channel,this.m.bar));const s=this.m.getCurrentPattern(this.qt);if(null==s)throw new Error;if(t.append(new pe(this.m,s,i,this.oe.curIndex)),this.m.enableNotePreview&&!this.m.synth.playing){const t=Math.min(e.partsPerBeat,this.oe.end-this.oe.start);this.m.synth.liveInputDuration=t,this.m.synth.liveInputPitches=[this.oe.pitch],this.m.synth.liveInputStarted=!0}}this.je()}Se(){this.m.enableNotePreview&&this.Ut&&this.m.synth.maintainLiveInput();const t=this.m.lastChangeWas(this.ie);if(!this.$t&&this.Ot&&this.oe.valid&&t){const t=this.Ht-this.jt,e=this.It-this.Vt;Math.sqrt(t*t+e*e)>5&&(this.$t=!0,this._t=Math.abs(t)>=Math.abs(e))}if(this.$t&&this.Ot&&this.oe.valid&&t){this.ie.undo();const t=new rt;this.ie=t,this.m.setProspectiveChange(this.ie);const i=this.Fe(),s=this.Ae(this.Ht/this.He);if(this.Jt)t.append(new Me(this.m,Math.max(0,Math.min(this.m.song.beatsPerBar*e.partsPerBeat,s)),this.m.selection.patternSelectionEnd)),this.je();else if(this.Yt)t.append(new Me(this.m,this.m.selection.patternSelectionStart,Math.max(0,Math.min(this.m.song.beatsPerBar*e.partsPerBeat,s)))),this.je();else if(this.Zt){const t=this.m.getCurrentPattern(this.qt);if(this.$t&&null!=t){this.ie.undo();const s=new rt;this.ie=s,this.m.setProspectiveChange(this.ie);const n=e.scales[this.m.song.scale].flags.filter((t=>t)).length,o=this.m.song.getChannelIsNoise(this.m.channel)?1:12/n,r=Math.round((this.Ht-this.jt)/(this.He*i))*i,h=Math.round((this.Vt-this.It)/(this.At*o));s.append(new xe(this.m,this.m.channel,t,r,h))}}else if(this.Gt){if(this.$t){let i=Math.max(0,Math.min((this.m.song.beatsPerBar-1)*e.partsPerBeat,Math.floor(this.oe.exactPart/e.partsPerBeat)*e.partsPerBeat)),n=i+e.partsPerBeat;if(null!=this.oe.curNote&&(i=Math.max(i,this.oe.curNote.start),n=Math.min(n,this.oe.curNote.end)),s<i){i=0;const t=this.m.getCurrentPattern(this.qt);if(null!=t)for(let e=0;e<t.notes.length;e++)t.notes[e].start<=s&&(i=t.notes[e].start),t.notes[e].end<=s&&(i=t.notes[e].end);for(let t=0;t<=this.m.song.beatsPerBar;t++){const n=t*e.partsPerBeat;i<=n&&n<=s&&(i=n)}}if(s>n){n=e.partsPerBeat*this.m.song.beatsPerBar;const t=this.m.getCurrentPattern(this.qt);if(null!=t)for(let e=0;e<t.notes.length;e++){if(t.notes[e].start>=s){n=t.notes[e].start;break}if(t.notes[e].end>=s){n=t.notes[e].end;break}}for(let t=0;t<=this.m.song.beatsPerBar;t++){const i=t*e.partsPerBeat;s<i&&i<n&&(n=i)}}t.append(new Me(this.m,i,n)),this.je()}}else if(null==this.oe.curNote){let n,o;t.append(new Me(this.m,0,0)),s<this.oe.start?(n=!0,o=this.oe.start-s):(n=!1,o=s-this.oe.start+i);let r,h,a=i;for(let t=i;t<=this.m.song.beatsPerBar*e.partsPerBeat;t+=i){if(1==i){if(t<5);else if(t<=e.partsPerBeat/2){if(t%3!=0&&t%4!=0)continue}else if(t<=1.5*e.partsPerBeat){if(t%6!=0&&t%8!=0)continue}else if(t%e.partsPerBeat!=0)continue}else if(t>=5*i&&t%e.partsPerBeat!=0&&t!=3*e.partsPerBeat/4&&t!=3*e.partsPerBeat/2&&t!=4*e.partsPerBeat/3)continue;const s=t;if(s==o){a=s;break}if(s<o&&(a=s),s>o){a<o-i&&(a=s);break}}if(n?(h=this.oe.start,r=h-a):(r=this.oe.start,h=r+a),r<0&&(r=0),h>this.m.song.beatsPerBar*e.partsPerBeat&&(h=this.m.song.beatsPerBar*e.partsPerBeat),r<h){t.append(new Zt(this.m,this.m.channel,this.m.bar));const e=this.m.getCurrentPattern(this.qt);if(null==e)throw new Error;let i;for(t.append(new ge(this.m,e,r,h)),i=0;i<e.notes.length&&!(e.notes[i].start>=h);i++);const s=new G(this.oe.pitch,r,h,3,this.m.song.getChannelIsNoise(this.m.channel));t.append(new pe(this.m,e,s,i)),this.Be(s),this.Qt=n?r:h,this.Xt=this.oe.pitch,this.te=s.pins[n?0:1].volume,this.ee=!0}this.kt=this.m.getCurrentPattern(this.qt)}else if(this._t){t.append(new Me(this.m,0,0));const s=(this.Ht-this.jt)/this.He,n=this.oe.curNote.pins[this.oe.nearPinIndex];let o=Math.round((this.oe.curNote.start+n.time+s)/i)*i;if(o<0&&(o=0),o>this.m.song.beatsPerBar*e.partsPerBeat&&(o=this.m.song.beatsPerBar*e.partsPerBeat),null==this.kt)throw new Error;if(o<=this.oe.curNote.start&&this.oe.nearPinIndex==this.oe.curNote.pins.length-1||o>=this.oe.curNote.end&&0==this.oe.nearPinIndex)t.append(new pe(this.m,this.kt,this.oe.curNote,this.oe.curIndex,!0)),this.ee=!1;else{const e=Math.min(this.oe.curNote.start,o),i=Math.max(this.oe.curNote.end,o);this.Qt=o,this.Xt=this.oe.curNote.pitches[-1==this.oe.pitchIndex?0:this.oe.pitchIndex]+this.oe.curNote.pins[this.oe.nearPinIndex].interval,this.te=this.oe.curNote.pins[this.oe.nearPinIndex].volume,this.ee=!0,t.append(new ge(this.m,this.kt,e,i,this.oe.curNote)),t.append(new Qt(this.m,this.oe.curNote,this.oe.nearPinIndex,o)),this.Be(this.oe.curNote)}}else if(-1==this.oe.pitchIndex){t.append(new Me(this.m,0,0));const s=Math.max(this.oe.curNote.start,Math.min(this.oe.curNote.end,Math.round(this.Ht/(this.He*i))*i))-this.oe.curNote.start;let n,o=this.oe.curNote.pins[0],r=0,h=0;for(let t=1;t<this.oe.curNote.pins.length;t++){if(n=o,o=this.oe.curNote.pins[t],s>o.time)continue;if(s<n.time)throw new Error;const i=(s-n.time)/(o.time-n.time);r=Math.round(n.volume*(1-i)+o.volume*i+(this.Vt-this.It)/25),r<0&&(r=0),r>3&&(r=3),h=this.Oe(n.interval*(1-i)+o.interval*i+this.oe.curNote.pitches[0],0,e.maxPitch)-this.oe.curNote.pitches[0];break}this.Qt=this.oe.curNote.start+s,this.Xt=this.oe.curNote.pitches[-1==this.oe.pitchIndex?0:this.oe.pitchIndex]+h,this.te=r,this.ee=!0,t.append(new Se(this.m,this.oe.curNote,s,r,h)),this.Be(this.oe.curNote)}else{if(t.append(new Me(this.m,0,0)),this.te=this.oe.curNote.pins[this.oe.nearPinIndex].volume,null==this.kt)throw new Error;let n,o;this.Ht>=this.jt?(n=Math.max(this.oe.curNote.start,this.oe.part),o=s+i):(n=Math.min(this.oe.curNote.end,this.oe.part+i),o=s),o<0&&(o=0),o>this.m.song.beatsPerBar*e.partsPerBeat&&(o=this.m.song.beatsPerBar*e.partsPerBeat),o>this.oe.curNote.end&&t.append(new ge(this.m,this.kt,this.oe.curNote.start,o,this.oe.curNote)),o<this.oe.curNote.start&&t.append(new ge(this.m,this.kt,o,this.oe.curNote.end,this.oe.curNote));let r=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(const t of this.oe.curNote.pitches)r>t&&(r=t),h<t&&(h=t);r-=this.oe.curNote.pitches[this.oe.pitchIndex],h-=this.oe.curNote.pitches[this.oe.pitchIndex];const a=this.Oe(this.Ie(this.It),-r,(this.m.song.getChannelIsNoise(this.m.channel)?e.drumCount-1:e.maxPitch)-h);t.append(new Xt(this.m,this.oe.curNote,n,o,a,this.oe.pitchIndex)),this.Be(this.oe.curNote),this.Qt=o,this.Xt=a,this.ee=!0}}this.Ot&&this.oe.valid&&t||(this.Ne(),this.Le())}ze(t){this.se=t,this.m.hasRedoHistory()||this.m.record(this.se,this.ne)}Le(){if(this.Dt)if(!this.Ot||!this.oe.valid||!this.$t||!this.ee||this.Gt||this.Jt||this.Yt||this.Zt)this.Bt.setAttribute("visibility","hidden");else{this.Bt.setAttribute("visibility","visible");const t=this.He*this.Qt,e=this.Ve(this.Xt-this.he),i=this.At/2,s=80,n=60;let o="";o+="M "+a(t)+" "+a(e-i*(this.te/3))+" ",o+="L "+a(t)+" "+a(e-i*(this.te/3)-n)+" ",o+="M "+a(t)+" "+a(e+i*(this.te/3))+" ",o+="L "+a(t)+" "+a(e+i*(this.te/3)+n)+" ",o+="M "+a(t)+" "+a(e-i*(this.te/3))+" ",o+="L "+a(t+s)+" "+a(e-i*(this.te/3))+" ",o+="M "+a(t)+" "+a(e+i*(this.te/3))+" ",o+="L "+a(t+s)+" "+a(e+i*(this.te/3))+" ",o+="M "+a(t)+" "+a(e-i*(this.te/3))+" ",o+="L "+a(t-s)+" "+a(e-i*(this.te/3))+" ",o+="M "+a(t)+" "+a(e+i*(this.te/3))+" ",o+="L "+a(t-s)+" "+a(e+i*(this.te/3))+" ",this.Bt.setAttribute("d",o)}else if(this.Ut&&!this.Ot&&this.oe.valid)if(this.Bt.setAttribute("visibility","visible"),this._e()){const t=this.He*this.m.selection.patternSelectionStart,e=a(t-4),i=a(t+4),s=this.Ve(-.5);this.Bt.setAttribute("d","M "+e+" 0 L "+e+" "+s+" L "+i+" "+s+" L "+i+" 0 z")}else if(this.De()){const t=this.He*this.m.selection.patternSelectionEnd,e=a(t-4),i=a(t+4),s=this.Ve(-.5);this.Bt.setAttribute("d","M "+e+" 0 L "+e+" "+s+" L "+i+" "+s+" L "+i+" 0 z")}else if(this.$e()){const t=a(this.He*this.m.selection.patternSelectionStart-2),e=a(this.He*this.m.selection.patternSelectionEnd+2),i=this.Ve(-.5);this.Bt.setAttribute("d","M "+t+" 0 L "+t+" "+i+" L "+e+" "+i+" L "+e+" 0 z")}else this.Ge(this.Bt,this.oe.pitch,this.oe.start,this.oe.pins,this.At/2+1,!0,this.he);else this.Bt.setAttribute("visibility","hidden")}je(){this.m.selection.patternSelectionActive?(this.zt.setAttribute("visibility","visible"),this.zt.setAttribute("x",String(this.He*this.m.selection.patternSelectionStart)),this.zt.setAttribute("width",String(this.He*(this.m.selection.patternSelectionEnd-this.m.selection.patternSelectionStart)))):this.zt.setAttribute("visibility","hidden")}render(){const t=this.m.getCurrentPattern(this.qt);this.kt!=t&&null!=this.kt&&(this.ie=null,this.Re(null)),this.kt=t,this.ke=this.container.clientWidth,this.qe=this.container.clientHeight,this.He=this.ke/(this.m.song.beatsPerBar*e.partsPerBeat),this.We=this.m.song.getChannelIsNoise(this.m.channel)?e.drumCount:e.windowPitchCount,this.At=this.qe/this.We,this.he=this.m.song.channels[this.m.channel].octave*e.pitchesPerOctave,this.me==this.m.song.rhythm&&this.pe==this.m.song.pitchChannelCount&&this.ye==this.m.song.noiseChannelCount||(this.me=this.m.song.rhythm,this.pe=this.m.song.pitchChannelCount,this.ye=this.m.song.noiseChannelCount,this.resetCopiedPins()),this.Ue=this.Wt[this.m.channel],this.ae==this.ke&&this.le==this.qe||(this.ae=this.ke,this.le=this.qe,this.St.setAttribute("width",""+this.ke),this.St.setAttribute("height",""+this.qe),this.Rt.setAttribute("height",""+this.qe),this.zt.setAttribute("y","0"),this.zt.setAttribute("height",""+this.qe));const i=this.ke/this.m.song.beatsPerBar;if(this.ce!=i||this.fe!=this.At){this.ce=i,this.fe=this.At,this.Ct.setAttribute("width",""+i),this.Ct.setAttribute("height",""+this.At*e.pitchesPerOctave),this.Pt.setAttribute("width",""+i),this.Pt.setAttribute("height",""+this.At),this.Ft.setAttribute("width",""+(i-2)),this.Ft.setAttribute("height",""+(this.At-2));for(let t=0;t<e.pitchesPerOctave;t++){const s=this.Lt[t],n=(e.pitchesPerOctave-t)%e.pitchesPerOctave;s.setAttribute("width",""+(i-2)),s.setAttribute("y",""+(n*this.At+1)),s.setAttribute("height",""+(this.At-2))}}this.Tt=function(t){const e=t.cloneNode(!1);return t.parentNode.replaceChild(e,t),e}(this.Tt),this.Et&&(this.Ot||this.Ne(),this.Le(),this.je()),this.ue!=this.m.showFifth&&(this.ue=this.m.showFifth,this.Lt[7].setAttribute("fill",this.m.showFifth?S.fifthNote:S.pitchBackground));for(let t=0;t<e.pitchesPerOctave;t++)this.Lt[t].style.visibility=e.scales[this.m.song.scale].flags[t]?"visible":"hidden";if(this.m.song.getChannelIsNoise(this.m.channel)?this.de||(this.de=!0,this.St.setAttribute("fill","url(#patternEditorDrumBackground"+this.qt+")")):this.de&&(this.de=!1,this.St.setAttribute("fill","url(#patternEditorNoteBackground"+this.qt+")")),this.m.showChannels)for(let t=this.m.song.getChannelCount()-1;t>=0;t--){if(t==this.m.channel)continue;if(this.m.song.getChannelIsNoise(t)!=this.m.song.getChannelIsNoise(this.m.channel))continue;const i=this.m.song.getPattern(t,this.m.bar+this.qt);if(null!=i)for(const s of i.notes)for(const i of s.pitches){const n=k.path();n.setAttribute("fill",S.getChannelColor(this.m.song,t).secondaryNote),n.setAttribute("pointer-events","none"),this.Ge(n,i,s.start,s.pins,.19*this.At,!1,this.m.song.channels[t].octave*e.pitchesPerOctave),this.Tt.appendChild(n)}}if(null!=this.kt)for(const t of this.kt.notes)for(let e=0;e<t.pitches.length;e++){const i=t.pitches[e];let s=k.path();if(s.setAttribute("fill",S.getChannelColor(this.m.song,this.m.channel).secondaryNote),s.setAttribute("pointer-events","none"),this.Ge(s,i,t.start,t.pins,this.At/2+1,!1,this.he),this.Tt.appendChild(s),s=k.path(),s.setAttribute("fill",S.getChannelColor(this.m.song,this.m.channel).primaryNote),s.setAttribute("pointer-events","none"),this.Ge(s,i,t.start,t.pins,this.At/2+1,!0,this.he),this.Tt.appendChild(s),t.pitches.length>1){const s=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()].getChord();if(!s.harmonizes||s.arpeggiates||s.strumParts>0){let s=k.text();s.setAttribute("x",""+a(this.He*t.start+2)),s.setAttribute("y",""+a(this.Ve(i-this.he))),s.setAttribute("width","30"),s.setAttribute("fill",S.invertedText),s.setAttribute("text-anchor","start"),s.setAttribute("dominant-baseline","central"),s.setAttribute("pointer-events","none"),s.textContent=""+(e+1),this.Tt.appendChild(s)}}}}Ge(t,e,i,s,n,o,r){const h=this.He*(s[s.length-1].time+s[0].time),l=.5*Math.min(2,h-1);let c=s[0],f="M "+a(this.He*(i+c.time)+l)+" "+a(this.Ve(e-r)+n*(o?c.volume/3:1))+" ";for(let t=1;t<s.length;t++){let h=c;c=s[t];let u=this.He*(i+h.time)+(1==t?l:0),d=this.He*(i+c.time)-(t==s.length-1?l:0),m=this.Ve(e+h.interval-r),p=this.Ve(e+c.interval-r),y=o?h.volume/3:1,g=o?c.volume/3:1;f+="L "+a(u)+" "+a(m-n*y)+" ",h.interval>c.interval&&(f+="L "+a(u+1)+" "+a(m-n*y)+" "),h.interval<c.interval&&(f+="L "+a(d-1)+" "+a(p-n*g)+" "),f+="L "+a(d)+" "+a(p-n*g)+" "}for(let t=s.length-2;t>=0;t--){let h=c;c=s[t];let u=this.He*(i+h.time)-(t==s.length-2?l:0),d=this.He*(i+c.time)+(0==t?l:0),m=this.Ve(e+h.interval-r),p=this.Ve(e+c.interval-r),y=o?h.volume/3:1,g=o?c.volume/3:1;f+="L "+a(u)+" "+a(m+n*y)+" ",h.interval<c.interval&&(f+="L "+a(u-1)+" "+a(m+n*y)+" "),h.interval>c.interval&&(f+="L "+a(d+1)+" "+a(p+n*g)+" "),f+="L "+a(d)+" "+a(p+n*g)+" "}f+="z",t.setAttribute("d",f)}Ve(t){return this.At*(this.We-t-.5)}}class Ne{constructor(t){this.m=t,this.container=w.div({class:"muteEditor"}),this.Ke=[],this.qe=128,this.Je=0,this.Ye=-1,this.Ze=t=>{const e=this.Ke.indexOf(t.target);-1!=e&&(this.m.song.channels[e].muted=!this.m.song.channels[e].muted,this.m.notifier.changed())},this.container.addEventListener("click",this.Ze)}render(){if(!this.m.enableChannelMuting)return;const t=this.m.getChannelHeight();if(this.Je!=this.m.song.getChannelCount()){for(let e=this.Je;e<this.m.song.getChannelCount();e++){const i=w.button({class:"mute-button",style:`height: ${t-4}px; margin: 2px;`});this.container.appendChild(i),this.Ke[e]=i}for(let t=this.m.song.getChannelCount();t<this.Je;t++)this.container.removeChild(this.Ke[t]);this.Ke.length=this.m.song.getChannelCount()}for(let t=0;t<this.m.song.getChannelCount();t++)this.m.song.channels[t].muted?this.Ke[t].classList.add("muted"):this.Ke[t].classList.remove("muted");if(this.Ye!=t)for(let e=0;e<this.m.song.getChannelCount();e++)this.Ke[e].style.height=t-4+"px";this.Ye==t&&this.Je==this.m.song.getChannelCount()||(this.Ye=t,this.Je=this.m.song.getChannelCount(),this.qe=this.m.song.getChannelCount()*t,this.container.style.height=this.qe+"px")}}class Le{constructor(t,e,i,s){this.Qe=e,this.Xe=i,this.ti=document.createTextNode("1"),this.ei=k.text({"font-family":"sans-serif","font-size":20,"text-anchor":"middle","font-weight":"bold",fill:"red"},this.ti),this.ii=k.rect({x:1,y:1}),this.container=k.svg(this.ii,this.ei),this.si=1,this.ni=!0,this.oi=!1,this.ri="",this.ii.setAttribute("fill",S.uiWidgetBackground),this.ei.setAttribute("fill",s)}setSize(t,e){this.container.setAttribute("x",""+this.Qe*t),this.container.setAttribute("y",""+this.Xe*e),this.ii.setAttribute("width",""+(t-2)),this.ii.setAttribute("height",""+(e-2)),this.ei.setAttribute("x",""+t/2),this.ei.setAttribute("y",""+Math.round(e/2+7))}setIndex(t,e,i,s){this.si!=t&&(this.oi||0==t==(0==this.si)||this.ii.setAttribute("fill",0==t?"none":S.uiWidgetBackground),this.si=t,this.ti.data=""+t),this.ni==e&&this.ri==s||(this.ni=e,i?this.ei.setAttribute("fill",S.invertedText):this.ei.setAttribute("fill",s)),this.oi==i&&this.ri==s||(this.oi=i,i?(this.ii.setAttribute("fill",s),this.ei.setAttribute("fill",S.invertedText)):(this.ii.setAttribute("fill",0==this.si?S.editorBackground:S.uiWidgetBackground),this.ei.setAttribute("fill",s))),this.ri=s}}class Fe{constructor(t){this.m=t,this.hi=k.g(),this.ai=k.rect({fill:S.playhead,x:0,y:0,width:4,height:128}),this.li=k.rect({fill:"none",stroke:S.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:1,width:30,height:30}),this.ci=k.path({fill:S.invertedText,stroke:S.invertedText,"stroke-width":1,"pointer-events":"none"}),this.fi=k.path({fill:S.invertedText,stroke:S.invertedText,"stroke-width":1,"pointer-events":"none"}),this.zt=k.rect({fill:S.boxSelectionFill,stroke:S.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","pointer-events":"none",visibility:"hidden",x:1,y:1,width:62,height:62}),this.Nt=k.svg({style:`background-color: ${S.editorBackground}; position: absolute;`,height:128},this.hi,this.zt,this.li,this.ci,this.fi,this.ai),this.ui=w.select({class:"trackSelectBox",style:"background: none; border: none; appearance: none; border-radius: initial; box-shadow: none; color: transparent; position: absolute; touch-action: none;"}),this.container=w.div({class:"noSelection",style:"height: 128px; position: relative; overflow:hidden;"},this.Nt,this.ui),this.di=[],this.Ht=0,this.It=0,this.mi=0,this.pi=0,this.yi=0,this.gi=0,this.Ut=!1,this.vi=!1,this.$t=!1,this.bi=32,this.wi=32,this.Je=0,this.ki=0,this.Mi=0,this.xi=-1,this.Ei=-1,this.Ye=-1,this.qi=h,this.Ci=()=>{this.m.selection.setPattern(this.ui.selectedIndex)},this.be=t=>{const e=this.bi*this.m.synth.playhead-2;this.xi!=e&&(this.xi=e,this.ai.setAttribute("x",""+e)),window.requestAnimationFrame(this.be)},this.Pi=t=>{this.vi=!0,this.$t=!0,this.Si(t),this.mi=this.yi,this.pi=this.gi},this.Ti=t=>{this.Si(t),this.mi==this.yi&&this.pi==this.gi||t.preventDefault(),this.vi&&this.Ri(),this.Le()},this.zi=t=>{this.vi=!1,this.$t=!1,this.Le()},this.Me=t=>{this.Ut||(this.Ut=!0)},this.xe=t=>{this.Ut&&(this.Ut=!1)},this.Ee=t=>{t.preventDefault(),this.vi=!0,this.Bi(t),this.mi=this.yi,this.pi=this.gi,t.shiftKey?(this.$t=!0,this.m.selection.setTrackSelection(this.m.selection.boxSelectionX0,this.yi,this.m.selection.boxSelectionY0,this.gi),this.m.selection.selectionUpdated()):(this.$t=!1,this.m.channel==this.gi&&this.m.bar==this.yi||(this.m.selection.setChannelBar(this.gi,this.yi),this.$t=!0),this.m.selection.resetBoxSelection())},this.Pe=t=>{this.Bi(t),this.vi&&(this.mi==this.yi&&this.pi==this.gi||(this.$t=!0),this.Ri()),this.Le()},this.Ni=t=>{if(this.vi&&!this.$t&&this.m.channel==this.gi&&this.m.bar==this.yi){const t=this.It%this.wi<this.wi/2,e=this.m.song.patternsPerChannel;this.m.selection.setPattern((this.m.song.channels[this.gi].bars[this.yi]+(t?1:e))%(e+1))}this.vi=!1,this.$t=!1,this.Le()},window.requestAnimationFrame(this.be),this.Nt.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Ni),this.Nt.addEventListener("mouseover",this.Me),this.Nt.addEventListener("mouseout",this.xe),this.ui.addEventListener("change",this.Ci),this.ui.addEventListener("touchstart",this.Pi),this.ui.addEventListener("touchmove",this.Ti),this.ui.addEventListener("touchend",this.zi),this.ui.addEventListener("touchcancel",this.zi);let e=!1;document.addEventListener("mousedown",(()=>{e||(this.qi=!1,this.Le()),e=!0}),!0),document.addEventListener("touchstart",(()=>{e||(this.qi=!0,this.Le()),e=!0}),!0)}Ri(){this.m.selection.setTrackSelection(this.m.selection.boxSelectionX0,this.yi,this.m.selection.boxSelectionY0,this.gi),this.m.selection.selectionUpdated()}Si(t){const e=this.Nt.getBoundingClientRect();this.Ht=t.touches[0].clientX-e.left,this.It=t.touches[0].clientY-e.top,isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.yi=Math.floor(Math.min(this.m.song.barCount-1,Math.max(0,this.Ht/this.bi))),this.gi=Math.floor(Math.min(this.m.song.getChannelCount()-1,Math.max(0,this.It/this.wi)))}Bi(t){const e=this.Nt.getBoundingClientRect();this.Ht=(t.clientX||t.pageX)-e.left,this.It=(t.clientY||t.pageY)-e.top,this.yi=Math.floor(Math.min(this.m.song.barCount-1,Math.max(0,this.Ht/this.bi))),this.gi=Math.floor(Math.min(this.m.song.getChannelCount()-1,Math.max(0,this.It/this.wi)))}Le(){let t=this.gi,e=this.yi;this.qi&&(e=this.m.bar,t=this.m.channel);const i=e==this.m.bar&&t==this.m.channel;if(!this.Ut||this.vi||i?this.li.style.visibility="hidden":(this.li.setAttribute("x",""+(1+this.bi*e)),this.li.setAttribute("y",""+(1+this.wi*t)),this.li.setAttribute("height",""+(this.wi-2)),this.li.setAttribute("width",""+(this.bi-2)),this.li.style.visibility="visible"),(this.Ut||this.qi)&&i){const i=this.It%this.wi<this.wi/2,s=this.bi*(e+.8),n=this.wi*(t+.5),o=.1*this.wi,r=.4*this.wi,h=.175*this.wi;this.ci.setAttribute("fill",i&&!this.qi?S.hoverPreview:S.invertedText),this.fi.setAttribute("fill",i||this.qi?S.invertedText:S.hoverPreview),this.ci.setAttribute("d",`M ${s} ${n-r} L ${s+h} ${n-o} L ${s-h} ${n-o} z`),this.fi.setAttribute("d",`M ${s} ${n+r} L ${s+h} ${n+o} L ${s-h} ${n+o} z`),this.ci.style.visibility="visible",this.fi.style.visibility="visible"}else this.ci.style.visibility="hidden",this.fi.style.visibility="hidden";this.ui.style.left=this.bi*this.m.bar+"px",this.ui.style.width=this.bi+"px",this.ui.style.top=this.wi*this.m.channel+"px",this.ui.style.height=this.wi+"px";const s=this.m.song.patternsPerChannel+1;for(let t=this.Mi;t<s;t++)this.ui.appendChild(w.option({value:t},t));for(let t=s;t<this.Mi;t++)this.ui.removeChild(this.ui.lastChild);this.Mi=s;const n=this.m.song.channels[this.m.channel].bars[this.m.bar];this.ui.selectedIndex!=n&&(this.ui.selectedIndex=n)}render(){if(this.bi=this.m.getBarWidth(),this.wi=this.m.getChannelHeight(),this.Je!=this.m.song.getChannelCount()){for(let t=this.Je;t<this.m.song.getChannelCount();t++){this.di[t]=[];for(let e=0;e<this.ki;e++){const i=new Le(t,e,t,S.getChannelColor(this.m.song,t).secondaryChannel);i.setSize(this.bi,this.wi),this.hi.appendChild(i.container),this.di[t][e]=i}}for(let t=this.m.song.getChannelCount();t<this.Je;t++)for(let e=0;e<this.ki;e++)this.hi.removeChild(this.di[t][e].container);this.di.length=this.m.song.getChannelCount(),this.vi=!1}if(this.ki!=this.m.song.barCount)for(let t=0;t<this.m.song.getChannelCount();t++){for(let e=this.ki;e<this.m.song.barCount;e++){const i=new Le(t,e,t,S.getChannelColor(this.m.song,t).secondaryChannel);i.setSize(this.bi,this.wi),this.hi.appendChild(i.container),this.di[t][e]=i}for(let e=this.m.song.barCount;e<this.ki;e++)this.hi.removeChild(this.di[t][e].container);this.di[t].length=this.m.song.barCount}if(this.ki!=this.m.song.barCount||this.Ei!=this.bi){this.ki=this.m.song.barCount;const t=this.bi*this.m.song.barCount;this.container.style.width=t+"px",this.Nt.setAttribute("width",t+""),this.vi=!1}if(this.Ye!=this.wi||this.Ei!=this.bi){this.Ei=this.bi;for(let t=0;t<this.m.song.getChannelCount();t++)for(let e=0;e<this.ki;e++)this.di[t][e].setSize(this.bi,this.wi);this.vi=!1}if(this.Ye!=this.wi||this.Je!=this.m.song.getChannelCount()){this.Ye=this.wi,this.Je=this.m.song.getChannelCount();const t=this.m.song.getChannelCount()*this.wi;this.Nt.setAttribute("height",""+t),this.ai.setAttribute("height",""+t),this.container.style.height=t+"px"}for(let t=0;t<this.m.song.getChannelCount();t++)for(let e=0;e<this.ki;e++){const i=this.m.song.getPattern(t,e),s=e==this.m.bar&&t==this.m.channel,n=null==i||0==i.notes.length,o=this.di[t][e];if(e<this.m.song.barCount){const i=S.getChannelColor(this.m.song,t);o.setIndex(this.m.song.channels[t].bars[e],n,s,n&&!s?i.secondaryChannel:i.primaryChannel),o.container.style.visibility="visible"}else o.container.style.visibility="hidden"}this.ui.style.display=this.qi?"":"none",this.m.selection.boxSelectionWidth>1||this.m.selection.boxSelectionHeight>1?(this.zt.setAttribute("x",String(this.bi*this.m.selection.boxSelectionBar+1)),this.zt.setAttribute("y",String(this.wi*this.m.selection.boxSelectionChannel+1)),this.zt.setAttribute("width",String(this.bi*this.m.selection.boxSelectionWidth-2)),this.zt.setAttribute("height",String(this.wi*this.m.selection.boxSelectionHeight-2)),this.zt.setAttribute("visibility","visible")):this.zt.setAttribute("visibility","hidden"),this.Le()}}class Ae{constructor(t){this.m=t,this.qe=20,this.Li=0,this.Fi=1,this.Ai=2,this.Hi=k.path({fill:"none",stroke:S.loopAccent,"stroke-width":4}),this.Ii=k.path({fill:S.hoverPreview,"pointer-events":"none"}),this.Nt=k.svg({style:`background-color: ${S.editorBackground}; touch-action: pan-y; position: absolute;`,height:this.qe},this.Hi,this.Ii),this.container=w.div({style:"height: 20px; position: relative; margin: 5px 0;"},this.Nt),this.bi=32,this.Oi=null,this.oe={startBar:-1,mode:-1},this.Ht=0,this.Ui=0,this.$i=0,this._i=!1,this.Di=!1,this.Ot=!1,this.Ut=!1,this.Wi=-1,this.ji=-1,this.ki=0,this.Ei=-1,this.Me=t=>{this.Ut||(this.Ut=!0,this.Le())},this.xe=t=>{this.Ut&&(this.Ut=!1,this.Le())},this.Ee=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=(t.clientX||t.pageX)-e.left,this.Ne(),this.Le(),this.Pe(t)},this.Ce=t=>{this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=t.touches[0].clientX-e.left,this.Ne(),this.Le(),this.Ui=t.touches[0].clientX,this.$i=t.touches[0].clientY,this.Di=!1,this._i=!1},this.Pe=t=>{const e=this.Nt.getBoundingClientRect();this.Ht=(t.clientX||t.pageX)-e.left,this.Se()},this.Te=t=>{if(!this.Ot)return;const e=this.Nt.getBoundingClientRect();this.Ht=t.touches[0].clientX-e.left,this.Di||this._i||(Math.abs(t.touches[0].clientY-this.$i)>10?this._i=!0:Math.abs(t.touches[0].clientX-this.Ui)>10&&(this.Di=!0)),this.Di&&(this.Se(),t.preventDefault())},this.Vi=t=>{t.preventDefault(),this._i||(this.Se(),this.Ut=!1,this.Re(t),this.Le()),this.Ot=!1},this.Re=t=>{null!=this.Oi&&this.m.record(this.Oi),this.Oi=null,this.Ot=!1,this.Ne(),this.Gi()},this.Ki=()=>{this.Gi()},this.Ne(),this.Gi(),this.m.notifier.watch(this.Ki),this.container.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Re),this.container.addEventListener("mouseover",this.Me),this.container.addEventListener("mouseout",this.xe),this.container.addEventListener("touchstart",this.Ce),this.container.addEventListener("touchmove",this.Te),this.container.addEventListener("touchend",this.Vi),this.container.addEventListener("touchcancel",this.Vi)}Ne(){const t=this.Ht/this.bi;this.oe.startBar=t,t>this.m.song.loopStart-.25&&t<this.m.song.loopStart+this.m.song.loopLength+.25?t-this.m.song.loopStart<.5*this.m.song.loopLength?this.oe.mode=this.Li:this.oe.mode=this.Fi:this.oe.mode=this.Ai}Ji(t){let e=Math.round(t-this.m.song.loopLength/2),i=e+this.m.song.loopLength;return e<0&&(i-=e,e=0),i>this.m.song.barCount&&(e-=i-this.m.song.barCount,i=this.m.song.barCount),{start:e,length:i-e}}Se(){if(this.Ot){let t=this.m.song.loopStart,e=this.m.song.loopStart+this.m.song.loopLength;null!=this.Oi&&this.m.lastChangeWas(this.Oi)&&(t=this.Oi.oldStart,e=t+this.Oi.oldLength);const i=this.Ht/this.bi;let s,n,o;if(this.oe.mode==this.Li)s=t+Math.round(i-this.oe.startBar),n=e,s<0&&(s=0),s>=this.m.song.barCount&&(s=this.m.song.barCount),s==n?s=n-1:s>n&&(o=s,s=n,n=o),this.Oi=new Dt(this.m,t,e-t,s,n-s);else if(this.oe.mode==this.Fi)s=t,n=e+Math.round(i-this.oe.startBar),n<0&&(n=0),n>=this.m.song.barCount&&(n=this.m.song.barCount),n==s?n=s+1:n<s&&(o=s,s=n,n=o),this.Oi=new Dt(this.m,t,e-t,s,n-s);else if(this.oe.mode==this.Ai){const s=this.Ji(i);this.Oi=new Dt(this.m,t,e-t,s.start,s.length)}this.m.synth.jumpIntoLoop(),this.m.autoFollow&&new kt(this.m,this.m.channel,Math.floor(this.m.synth.playhead),!0),this.m.setProspectiveChange(this.Oi)}else this.Ne(),this.Le()}Le(){const t=this.Ut&&!this.Ot;if(this.Ii.style.visibility=t?"visible":"hidden",t){const t=this.qe/2;let e=this.m.song.loopStart*this.bi,i=(this.m.song.loopStart+this.m.song.loopLength)*this.bi;if(this.oe.mode==this.Li)i=this.m.song.loopStart*this.bi+2*t;else if(this.oe.mode==this.Fi)e=(this.m.song.loopStart+this.m.song.loopLength)*this.bi-2*t;else{const t=this.Ji(this.oe.startBar);e=t.start*this.bi,i=(t.start+t.length)*this.bi}this.Ii.setAttribute("d",`M ${e+t} 4 L ${i-t} 4 A ${t-4} ${t-4} 0 0 1 ${i-t} ${this.qe-4} L ${e+t} ${this.qe-4} A ${t-4} ${t-4} 0 0 1 ${e+t} 4 z`)}}Gi(){this.bi=this.m.getBarWidth();const t=this.qe/2,e=this.m.song.loopStart*this.bi,i=(this.m.song.loopStart+this.m.song.loopLength)*this.bi;if(this.ki!=this.m.song.barCount||this.Ei!=this.bi){this.ki=this.m.song.barCount,this.Ei=this.bi;const t=this.bi*this.m.song.barCount;this.container.style.width=t+"px",this.Nt.setAttribute("width",t+"")}this.Wi==e&&this.ji==i||(this.Wi=e,this.ji=i,this.Hi.setAttribute("d",`M ${e+t} 2 L ${i-t} 2 A ${t-2} ${t-2} 0 0 1 ${i-t} ${this.qe-2} L ${e+t} ${this.qe-2} A ${t-2} ${t-2} 0 0 1 ${e+t} 2 z`)),this.Le()}}class He{constructor(t,i){this.m=t,this.Yi=i,this.ke=112,this.qe=26,this.Zi=k.path({fill:S.uiWidgetBackground,"pointer-events":"none"}),this.Qi=k.svg({"pointer-events":"none"}),this.Xi=k.svg({"pointer-events":"none"}),this.ts=k.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.es=k.path({fill:"currentColor","pointer-events":"none"}),this.Nt=k.svg({style:`background-color: ${S.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.ke+" "+this.qe,preserveAspectRatio:"none"},this.Zi,this.Qi,this.Xi,this.ts,this.es),this.container=w.div({class:"spectrum",style:"height: 2em;"},this.Nt),this.Ht=0,this.It=0,this.ss=0,this.ns=0,this.Ot=!1,this.Oi=null,this.os="",this.ue=!0,this.Ee=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=((t.clientX||t.pageX)-e.left)*this.ke/(e.right-e.left),this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.ss=this.rs(this.Ht),this.ns=this.hs(this.It),this.Se()},this.Ce=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=(t.touches[0].clientX-e.left)*this.ke/(e.right-e.left),this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.ss=this.rs(this.Ht),this.ns=this.hs(this.It),this.Se()},this.Pe=t=>{if(null==this.container.offsetParent)return;const e=this.Nt.getBoundingClientRect();this.Ht=((t.clientX||t.pageX)-e.left)*this.ke/(e.right-e.left),this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Se()},this.Te=t=>{if(null==this.container.offsetParent)return;if(!this.Ot)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Ht=(t.touches[0].clientX-e.left)*this.ke/(e.right-e.left),this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Se()},this.Re=t=>{this.Ot&&(this.m.record(this.Oi),this.Oi=null),this.Ot=!1};for(let t=0;t<e.spectrumControlPoints;t+=e.spectrumControlPointsPerOctave)this.Qi.appendChild(k.rect({fill:S.tonic,x:(t+1)*this.ke/(e.spectrumControlPoints+2)-1,y:0,width:2,height:this.qe}));for(let t=4;t<=e.spectrumControlPoints;t+=e.spectrumControlPointsPerOctave)this.Xi.appendChild(k.rect({fill:S.fifthNote,x:(t+1)*this.ke/(e.spectrumControlPoints+2)-1,y:0,width:2,height:this.qe}));this.container.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Re),this.container.addEventListener("touchstart",this.Ce),this.container.addEventListener("touchmove",this.Te),this.container.addEventListener("touchend",this.Re),this.container.addEventListener("touchcancel",this.Re)}rs(t){return(e.spectrumControlPoints+2)*t/this.ke-1}hs(t){return e.spectrumMax*(1-(t-1)/(this.qe-2))}Se(){if(this.Ot){const t=this.rs(this.Ht),i=this.hs(this.It),s=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()],n=null==this.Yi?s.spectrumWave:s.drumsetSpectrumWaves[this.Yi];if(t!=this.ss){const s=(i-this.ns)/(t-this.ss),o=this.ns-this.ss*s,r=Math.ceil(Math.min(this.ss,t)),h=Math.floor(Math.max(this.ss,t));for(let t=r;t<=h;t++)t<0||t>=e.spectrumControlPoints||(n.spectrum[t]=Math.max(0,Math.min(e.spectrumMax,Math.round(t*s+o))))}n.spectrum[Math.max(0,Math.min(e.spectrumControlPoints-1,Math.round(t)))]=Math.max(0,Math.min(e.spectrumMax,Math.round(i))),this.ss=t,this.ns=i,this.Oi=new qt(this.m,s,n),this.m.setProspectiveChange(this.Oi)}}render(){const t=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()],i=null==this.Yi?t.spectrumWave:t.drumsetSpectrumWaves[this.Yi],s=t=>(1-t/e.spectrumMax)*(this.qe-1)+1;let n=0,o="M 0 "+a(this.qe)+" ";for(let t=0;t<e.spectrumControlPoints;t++){let r=i.spectrum[t];o+=0!=n||0!=r?"L ":"M ",o+=a((t+1)*this.ke/(e.spectrumControlPoints+2))+" "+a(s(r))+" ",n=r}const r=s(n);n>0&&(o+="L "+(this.ke-1)+" "+a(r)+" "),this.os!=o&&(this.os=o,this.ts.setAttribute("d",o),this.Zi.setAttribute("d",o+"L "+this.ke+" "+a(r)+" L "+this.ke+" "+a(this.qe)+" L 0 "+a(this.qe)+" z "),this.es.setAttribute("d","M "+this.ke+" "+a(r)+" L "+(this.ke-4)+" "+a(r-4)+" L "+(this.ke-4)+" "+a(r+4)+" z"),this.es.style.display=n>0?"":"none"),this.ue!=this.m.showFifth&&(this.ue=this.m.showFifth,this.Xi.style.display=this.m.showFifth?"":"none")}}class Ie{constructor(t){this.m=t,this.ke=112,this.qe=26,this.Qi=k.svg({"pointer-events":"none"}),this.Xi=k.svg({"pointer-events":"none"}),this.ts=k.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.ls=[],this.cs=k.svg({"pointer-events":"none"}),this.Nt=k.svg({style:`background-color: ${S.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.ke+" "+this.qe,preserveAspectRatio:"none"},this.Qi,this.Xi,this.ts,this.cs),this.container=w.div({class:"harmonics",style:"height: 2em;"},this.Nt),this.Ht=0,this.It=0,this.ss=0,this.ns=0,this.Ot=!1,this.Oi=null,this.os="",this.ue=!0,this.Ee=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=((t.clientX||t.pageX)-e.left)*this.ke/(e.right-e.left),this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.ss=this.rs(this.Ht),this.ns=this.hs(this.It),this.Se()},this.Ce=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=(t.touches[0].clientX-e.left)*this.ke/(e.right-e.left),this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.ss=this.rs(this.Ht),this.ns=this.hs(this.It),this.Se()},this.Pe=t=>{if(null==this.container.offsetParent)return;const e=this.Nt.getBoundingClientRect();this.Ht=((t.clientX||t.pageX)-e.left)*this.ke/(e.right-e.left),this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Se()},this.Te=t=>{if(null==this.container.offsetParent)return;if(!this.Ot)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Ht=(t.touches[0].clientX-e.left)*this.ke/(e.right-e.left),this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.Ht)&&(this.Ht=0),isNaN(this.It)&&(this.It=0),this.Se()},this.Re=t=>{this.Ot&&(this.m.record(this.Oi),this.Oi=null),this.Ot=!1};for(let t=1;t<=e.harmonicsControlPoints;t*=2)this.Qi.appendChild(k.rect({fill:S.tonic,x:(t-.5)*(this.ke-8)/(e.harmonicsControlPoints-1)-1,y:0,width:2,height:this.qe}));for(let t=3;t<=e.harmonicsControlPoints;t*=2)this.Xi.appendChild(k.rect({fill:S.fifthNote,x:(t-.5)*(this.ke-8)/(e.harmonicsControlPoints-1)-1,y:0,width:2,height:this.qe}));for(let t=0;t<4;t++){const e=k.rect({fill:"currentColor",x:this.ke-2*t-1,y:0,width:1,height:this.qe});this.ls.push(e),this.cs.appendChild(e)}this.container.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Re),this.container.addEventListener("touchstart",this.Ce),this.container.addEventListener("touchmove",this.Te),this.container.addEventListener("touchend",this.Re),this.container.addEventListener("touchcancel",this.Re)}rs(t){return(e.harmonicsControlPoints-1)*t/(this.ke-8)-.5}hs(t){return e.harmonicsMax*(1-t/this.qe)}Se(){if(this.Ot){const t=this.rs(this.Ht),i=this.hs(this.It),s=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()],n=s.harmonicsWave;if(t!=this.ss){const s=(i-this.ns)/(t-this.ss),o=this.ns-this.ss*s,r=Math.ceil(Math.min(this.ss,t)),h=Math.floor(Math.max(this.ss,t));for(let t=r;t<=h;t++)t<0||t>=e.harmonicsControlPoints||(n.harmonics[t]=Math.max(0,Math.min(e.harmonicsMax,Math.round(t*s+o))))}n.harmonics[Math.max(0,Math.min(e.harmonicsControlPoints-1,Math.round(t)))]=Math.max(0,Math.min(e.harmonicsMax,Math.round(i))),this.ss=t,this.ns=i,this.Oi=new Ct(this.m,s,n),this.m.setProspectiveChange(this.Oi)}}render(){const t=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()].harmonicsWave,i=t=>(1-t/e.harmonicsMax)*this.qe;let s=a(this.qe),n="";for(let o=0;o<e.harmonicsControlPoints-1;o++){if(0==t.harmonics[o])continue;let r=a((o+.5)*(this.ke-8)/(e.harmonicsControlPoints-1));n+="M "+r+" "+s+" ",n+="L "+r+" "+a(i(t.harmonics[o]))+" "}const o=i(t.harmonics[e.harmonicsControlPoints-1]);for(let t=0;t<4;t++){const e=this.ls[t];e.setAttribute("y",a(o)),e.setAttribute("height",a(this.qe-o))}this.os!=n&&(this.os=n,this.ts.setAttribute("d",n)),this.ue!=this.m.showFifth&&(this.ue=this.m.showFifth,this.Xi.style.display=this.m.showFifth?"":"none")}}class Oe{constructor(t,e){this.m=t,this.fs=e,this.ke=512,this.qe=20,this.us=k.svg({"pointer-events":"none"}),this.ds=k.rect({fill:S.uiWidgetBackground,x:0,y:2,width:10,height:this.qe-4}),this.ps=k.rect({fill:"none",stroke:S.hoverPreview,"stroke-width":2,"pointer-events":"none",x:0,y:1,width:10,height:this.qe-2}),this.ys=k.path({fill:S.hoverPreview,"pointer-events":"none"}),this.gs=k.path({fill:S.hoverPreview,"pointer-events":"none"}),this.Nt=k.svg({style:`background-color: ${S.editorBackground}; touch-action: pan-y; position: absolute;`,width:this.ke,height:this.qe},this.us,this.ds,this.ps,this.ys,this.gs),this.container=w.div({class:"barScrollBar",style:"width: 512px; height: 20px; overflow: hidden; position: relative;"},this.Nt),this.Ht=0,this.Ot=!1,this.Ut=!1,this.vs=!1,this.bs=-1,this.ws=-1,this.ks=t=>{this.m.barScrollPos=this.fs.scrollLeft/this.m.getBarWidth()},this.Me=t=>{this.Ut||(this.Ut=!0,this.Le())},this.xe=t=>{this.Ut&&(this.Ut=!1,this.Le())},this.Ee=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=(t.clientX||t.pageX)-e.left,this.Le(),this.Ht>=this.m.barScrollPos*this.Ms&&this.Ht<=(this.m.barScrollPos+this.m.trackVisibleBars)*this.Ms&&(this.vs=!0,this.xs=this.Ht)},this.Ce=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.Ht=t.touches[0].clientX-e.left,this.Le(),this.Ht>=this.m.barScrollPos*this.Ms&&this.Ht<=(this.m.barScrollPos+this.m.trackVisibleBars)*this.Ms&&(this.vs=!0,this.xs=this.Ht)},this.Pe=t=>{const e=this.Nt.getBoundingClientRect();this.Ht=(t.clientX||t.pageX)-e.left,this.Se()},this.Te=t=>{if(!this.Ot)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Ht=t.touches[0].clientX-e.left,this.Se()},this.Re=t=>{!this.vs&&this.Ot&&(this.Ht<(this.m.barScrollPos+8)*this.Ms?(this.m.barScrollPos>0&&this.m.barScrollPos--,this.m.notifier.changed()):(this.m.barScrollPos<this.m.song.barCount-this.m.trackVisibleBars&&this.m.barScrollPos++,this.m.notifier.changed())),this.Ot=!1,this.vs=!1,this.Le()};const i=.5*this.qe;this.ys.setAttribute("d",`M 9 ${i} L 20 ${i+6} L 20 ${i-6} z`),this.gs.setAttribute("d",`M ${this.ke-9} ${i} L ${this.ke-20} ${i+6} L ${this.ke-20} ${i-6} z`),this.container.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Re),this.container.addEventListener("mouseover",this.Me),this.container.addEventListener("mouseout",this.xe),this.container.addEventListener("touchstart",this.Ce),this.container.addEventListener("touchmove",this.Te),this.container.addEventListener("touchend",this.Re),this.container.addEventListener("touchcancel",this.Re),this.fs.addEventListener("scroll",this.ks,{capture:!1,passive:!0})}Se(){if(this.vs){for(;this.Ht-this.xs<.5*-this.Ms&&this.m.barScrollPos>0;)this.m.barScrollPos--,this.xs-=this.Ms,this.m.notifier.changed();for(;this.Ht-this.xs>.5*this.Ms&&this.m.barScrollPos<this.m.song.barCount-this.m.trackVisibleBars;)this.m.barScrollPos++,this.xs+=this.Ms,this.m.notifier.changed()}this.Ut&&this.Le()}Le(){let t=!1,e=!1,i=!1;this.Ut&&!this.Ot&&(this.Ht<this.m.barScrollPos*this.Ms?t=!0:this.Ht>(this.m.barScrollPos+this.m.trackVisibleBars)*this.Ms?e=!0:i=!0),this.ys.style.visibility=t?"visible":"hidden",this.gs.style.visibility=e?"visible":"hidden",this.ps.style.visibility=i?"visible":"hidden"}render(){this.Ms=(this.ke-1)/Math.max(this.m.trackVisibleBars,this.m.song.barCount);const t=this.bs!=this.m.song.barCount;if(t){for(this.bs=this.m.song.barCount;this.us.firstChild;)this.us.removeChild(this.us.firstChild);for(let t=0;t<=this.m.song.barCount;t++){const e=t%16==0?0:t%4==0?this.qe/8:this.qe/3;this.us.appendChild(k.rect({fill:S.uiWidgetBackground,x:t*this.Ms-1,y:e,width:2,height:this.qe-2*e}))}}(t||this.ws!=this.m.barScrollPos)&&(this.ws=this.m.barScrollPos,this.ds.setAttribute("x",""+this.Ms*this.m.barScrollPos),this.ds.setAttribute("width",""+this.Ms*this.m.trackVisibleBars),this.ps.setAttribute("x",""+this.Ms*this.m.barScrollPos),this.ps.setAttribute("width",""+this.Ms*this.m.trackVisibleBars)),this.Le(),this.fs.scrollLeft=this.m.barScrollPos*this.m.getBarWidth()}}class Ue{constructor(t){this.m=t,this.ke=20,this.qe=481,this.Es=4,this.qs=e.pitchOctaves,this.Cs=(this.qe-this.Es)/this.qs,this.Ps=this.Cs*e.windowOctaves+this.Es,this.ds=k.rect({fill:S.uiWidgetBackground,x:2,y:0,width:this.ke-4,height:this.Ps}),this.ps=k.rect({fill:"none",stroke:S.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:0,width:this.ke-2,height:this.Ps}),this.ci=k.path({fill:S.hoverPreview,"pointer-events":"none"}),this.fi=k.path({fill:S.hoverPreview,"pointer-events":"none"}),this.Nt=k.svg({style:`background-color: ${S.editorBackground}; touch-action: pan-x; position: absolute;`,width:this.ke,height:"100%",viewBox:"0 0 20 481",preserveAspectRatio:"none"}),this.container=w.div({id:"octaveScrollBarContainer",style:"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;"},this.Nt),this.It=0,this.Ot=!1,this.Ut=!1,this.vs=!1,this.Ss=-1,this.Oi=null,this.Me=t=>{this.Ut||(this.Ut=!0,this.Le())},this.xe=t=>{this.Ut&&(this.Ut=!1,this.Le())},this.Ee=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.m.song.getChannelIsNoise(this.m.channel)||(this.Le(),this.It>=this.Ts-this.Ps&&this.It<=this.Ts&&(this.vs=!0,this.Oi=null,this.xs=this.It))},this.Ce=t=>{t.preventDefault(),this.Ot=!0;const e=this.Nt.getBoundingClientRect();this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.m.song.getChannelIsNoise(this.m.channel)||(this.Le(),this.It>=this.Ts-this.Ps&&this.It<=this.Ts&&(this.vs=!0,this.Oi=null,this.xs=this.It))},this.Pe=t=>{const e=this.Nt.getBoundingClientRect();this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.Se()},this.Te=t=>{if(!this.Ot)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.Se()},this.Re=t=>{if(!this.m.song.getChannelIsNoise(this.m.channel)&&this.Ot)if(this.vs)null!=this.Oi&&this.m.record(this.Oi);else{const t=this.m.lastChangeWas(this.Oi),i=t?this.Oi.oldValue:this.m.song.channels[this.m.channel].octave,s=this.m.song.channels[this.m.channel].octave;this.It<this.Ts-.5*this.Ps?s<e.scrollableOctaves&&(this.Oi=new jt(this.m,i,s+1),this.m.record(this.Oi,t)):s>0&&(this.Oi=new jt(this.m,i,s-1),this.m.record(this.Oi,t))}this.Ot=!1,this.vs=!1,this.Le()},this.Ki=()=>{this.Ts=this.qe-this.Cs*this.m.song.channels[this.m.channel].octave,this.Gi()},this.m.notifier.watch(this.Ki),this.Ki(),this.Nt.appendChild(this.ds);for(let t=0;t<=this.qs;t++)this.Nt.appendChild(k.rect({fill:S.tonic,x:0,y:t*this.Cs,width:this.ke,height:this.Es}));this.Nt.appendChild(this.ps),this.Nt.appendChild(this.ci),this.Nt.appendChild(this.fi);const i=.5*this.ke;this.ci.setAttribute("d",`M ${i} 9 L ${i+6} 20 L ${i-6} 20 z`),this.fi.setAttribute("d",`M ${i} ${this.qe-9} L ${i+6} ${this.qe-20} L ${i-6} ${this.qe-20} z`),this.container.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Re),this.container.addEventListener("mouseover",this.Me),this.container.addEventListener("mouseout",this.xe),this.container.addEventListener("touchstart",this.Ce),this.container.addEventListener("touchmove",this.Te),this.container.addEventListener("touchend",this.Re),this.container.addEventListener("touchcancel",this.Re)}Se(){if(!this.m.song.getChannelIsNoise(this.m.channel)){if(this.vs){const t=this.m.song.channels[this.m.channel].octave,i=this.m.lastChangeWas(this.Oi)?this.Oi.oldValue:t;let s=t;for(;this.It-this.xs<.5*-this.Cs&&s<e.scrollableOctaves;)s++,this.xs-=this.Cs;for(;this.It-this.xs>.5*this.Cs&&s>0;)s--,this.xs+=this.Cs;this.Oi=new jt(this.m,i,s),this.m.setProspectiveChange(this.Oi)}this.Ut&&this.Le()}}Le(){let t=!1,e=!1,i=!1;this.Ut&&!this.Ot&&(this.It<this.Ts-this.Ps?t=!0:this.It>this.Ts?e=!0:i=!0),this.ci.style.visibility=t?"inherit":"hidden",this.fi.style.visibility=e?"inherit":"hidden",this.ps.style.visibility=i?"inherit":"hidden"}Gi(){this.Nt.style.visibility=this.m.song.getChannelIsNoise(this.m.channel)?"hidden":"visible",this.Ss!=this.Ts&&(this.Ss=this.Ts,this.ds.setAttribute("y",""+(this.Ts-this.Ps)),this.ps.setAttribute("y",""+(this.Ts-this.Ps))),this.Le()}}class $e{constructor(t){this.m=t,this.Rs=w.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}),this.zs=w.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}),this.Bs=w.div({style:`width: 100%; height: 40px; border: 2px solid ${S.primaryText}; position: absolute; box-sizing: border-box; pointer-events: none;`}),this.container=w.div({style:"width: 32px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0; touch-action: none;"},this.Rs,this.zs,this.Bs),this.qe=481,this.Ns=[],this.Ls=[],this.It=0,this.Ot=!1,this.Ut=!1,this.Fs=-1,this.As=-1,this.de=!1,this.Hs=-1,this.Me=t=>{this.Ut||(this.Ut=!0,this.Le())},this.xe=t=>{this.Ut&&(this.Ut=!1,this.Le())},this.Ee=t=>{t.preventDefault(),this.m.synth.maintainLiveInput(),this.Ot=!0;const e=this.container.getBoundingClientRect();this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.Is(),this.Le()},this.Pe=t=>{(this.Ot||this.Ut)&&this.m.synth.maintainLiveInput();const e=this.container.getBoundingClientRect();this.It=((t.clientY||t.pageY)-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.Os(),this.Ot&&this.Is(),this.Le()},this.Ni=t=>{this.Ot&&this.Us(),this.Ot=!1,this.Le()},this.Ce=t=>{t.preventDefault(),this.m.synth.maintainLiveInput(),this.Ot=!0;const e=this.container.getBoundingClientRect();this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.Os(),this.Is()},this.Te=t=>{t.preventDefault(),this.m.synth.maintainLiveInput();const e=this.container.getBoundingClientRect();this.It=(t.touches[0].clientY-e.top)*this.qe/(e.bottom-e.top),isNaN(this.It)&&(this.It=0),this.Os(),this.Ot&&this.Is()},this.Vi=t=>{t.preventDefault(),this.Us()},this.Ki=()=>{const t=this.m.song.getChannelIsNoise(this.m.channel);this.At=t?40:13,this.We=t?e.drumCount:e.windowPitchCount,this.Os(),this.Ot&&this.Is(),this.m.synth.liveInputChannel=this.m.channel,this.Gi()},this.Gi=()=>{if(!this.m.showLetters)return;const t=this.m.song.getChannelIsNoise(this.m.channel);if(this.As!=this.m.song.scale||this.Hs!=this.m.song.key||this.de!=t){if(this.As=this.m.song.scale,this.Hs=this.m.song.key,this.de=t,this.Rs.style.display=t?"none":"flex",this.zs.style.display=t?"flex":"none",!t)for(let t=0;t<this.We;t++){const i=(t+e.keys[this.m.song.key].basePitch)%12,s=e.keys[i].isWhiteKey;if(this.Ns[t].style.background=s?S.whitePianoKey:S.blackPianoKey,e.scales[this.m.song.scale].flags[t%12]){let s;if(this.Ns[t].classList.remove("disabled"),this.Ls[t].style.display="",e.keys[i].isWhiteKey)s=e.keys[i].name;else{const n=e.blackKeyNameParents[t%12];s=e.keys[(i+12+n)%12].name,1==n?s+="♭":-1==n&&(s+="♯")}const n=this.Ls[t];n.style.color=e.keys[i].isWhiteKey?"black":"white",n.textContent=s}else this.Ns[t].classList.add("disabled"),this.Ls[t].style.display="none"}this.Le()}};for(let t=0;t<e.windowPitchCount;t++){const t=w.div({class:"piano-label",style:"font-weight: bold; -webkit-text-stroke-width: 0; font-size: 11px; font-family: sans-serif; position: absolute; padding-left: 15px;"}),e=w.div({class:"piano-button",style:"background: gray;"},t);this.Rs.appendChild(e),this.Ls.push(t),this.Ns.push(e)}for(let t=0;t<e.drumCount;t++){const i=100*(1-t/e.drumCount*.35),s=1+(t-e.drumCount/2)/e.drumCount*.5;this.zs.appendChild(w.div({class:"drum-button",style:`background-size: ${i}% ${i}%; filter: brightness(${s})`}))}this.container.addEventListener("mousedown",this.Ee),document.addEventListener("mousemove",this.Pe),document.addEventListener("mouseup",this.Ni),this.container.addEventListener("mouseover",this.Me),this.container.addEventListener("mouseout",this.xe),this.container.addEventListener("touchstart",this.Ce),this.container.addEventListener("touchmove",this.Te),this.container.addEventListener("touchend",this.Vi),this.container.addEventListener("touchcancel",this.Vi),this.m.notifier.watch(this.Ki),this.Ki()}Os(){const t=e.scales[this.m.song.scale].flags,i=Math.max(0,Math.min(this.We-1,this.We-this.It/this.At));if(t[Math.floor(i)%12]||this.m.song.getChannelIsNoise(this.m.channel))this.$s=Math.floor(i);else{let e=Math.floor(i)+1,s=Math.floor(i)-1;for(;!t[e%12];)e++;for(;!t[s%12];)s--;let n=e,o=s+1;e%12!=0&&e%12!=7||(n-=.5),s%12!=0&&s%12!=7||(o+=.5),this.$s=i-o>n-i?e:s}}Is(){const t=this.$s+12*this.m.song.channels[this.m.channel].octave;this.Fs!=t&&(this.Fs=t,this.m.synth.liveInputDuration=Number.MAX_SAFE_INTEGER,this.m.synth.liveInputPitches=[this.Fs],this.m.synth.liveInputStarted=!0)}Us(){this.Fs=-1,this.m.synth.liveInputDuration=0}Le(){if(this.Bs.style.visibility=!this.Ut||this.Ot?"hidden":"visible",!this.Ut||this.Ot)return;const t=this.container.getBoundingClientRect(),e=this.At/(this.qe/(t.bottom-t.top));this.Bs.style.left="0px",this.Bs.style.top=e*(this.We-this.$s-1)+"px",this.Bs.style.height=e+"px"}}const{button:_e,div:De,span:We,h2:je,input:Ve,br:Ge,select:Ke,option:Je}=w;class Ye{constructor(t){this.m=t,this._s=Ve({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Ds=Ke({style:"width: 100%;"},Je({value:"splice"},"Splice beats at end of bars."),Je({value:"stretch"},"Stretch notes to fit in bars."),Je({value:"overflow"},"Overflow notes across bars.")),this.Ws=_e({class:"cancelButton"}),this.js=_e({class:"okayButton",style:"width:45%;"},"Okay"),this.container=De({class:"prompt noSelection",style:"width: 250px;"},je("Beats Per Bar"),De({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},De({style:"text-align: right;"},"Beats per bar:",Ge(),We({style:`font-size: smaller; color: ${S.secondaryText};`},"(Multiples of 3 or 4 are recommended)")),this._s),De({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},De({class:"selectContainer",style:"width: 100%;"},this.Ds)),De({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.js),this.Ws),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.js.removeEventListener("click",this.Vs),this.Ws.removeEventListener("click",this.k),this._s.removeEventListener("keypress",Ye.Gs),this._s.removeEventListener("blur",Ye.Ks),this.container.removeEventListener("keydown",this.Js)},this.Js=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.Vs()},this.Vs=()=>{window.localStorage.setItem("beatCountStrategy",this.Ds.value),this.m.prompt=null,this.m.record(new se(this.m,Ye.Ys(this._s),this.Ds.value),!0)},this._s.value=this.m.song.beatsPerBar+"",this._s.min=e.beatsPerBarMin+"",this._s.max=e.beatsPerBarMax+"";const i=window.localStorage.getItem("beatCountStrategy");null!=i&&(this.Ds.value=i),this._s.select(),setTimeout((()=>this._s.focus())),this.js.addEventListener("click",this.Vs),this.Ws.addEventListener("click",this.k),this._s.addEventListener("keypress",Ye.Gs),this._s.addEventListener("blur",Ye.Ks),this.container.addEventListener("keydown",this.Js)}static Gs(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static Ks(t){const e=t.target;e.value=String(Ye.Ys(e))}static Ys(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}const{button:Ze,div:Qe,span:Xe,h2:ti,input:ei,br:ii,select:si,option:ni}=w;class oi{constructor(t){this.m=t,this._s=ei({style:"width: 3em; margin-left: 1em;",type:"number",step:"0.01",value:"0"}),this.Ds=si({style:"width: 100%;"},ni({value:"overflow"},"Overflow notes across bars."),ni({value:"wrapAround"},"Wrap notes around within bars.")),this.Ws=Ze({class:"cancelButton"}),this.js=Ze({class:"okayButton",style:"width:45%;"},"Okay"),this.container=Qe({class:"prompt noSelection",style:"width: 250px;"},ti("Move Notes Sideways"),Qe({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Qe({style:"text-align: right;"},"Beats to move:",ii(),Xe({style:`font-size: smaller; color: ${S.secondaryText};`},"(Negative is left, positive is right)")),this._s),Qe({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Qe({class:"selectContainer",style:"width: 100%;"},this.Ds)),Qe({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.js),this.Ws),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.js.removeEventListener("click",this.Vs),this.Ws.removeEventListener("click",this.k),this._s.removeEventListener("blur",oi.Ks),this.container.removeEventListener("keydown",this.Js)},this.Js=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.Vs()},this.Vs=()=>{window.localStorage.setItem("moveNotesSidewaysStrategy",this.Ds.value),this.m.prompt=null,this.m.record(new ie(this.m,+this._s.value,this.Ds.value),!0)},this._s.min=-this.m.song.beatsPerBar+"",this._s.max=this.m.song.beatsPerBar+"";const e=window.localStorage.getItem("moveNotesSidewaysStrategy");null!=e&&(this.Ds.value=e),this._s.select(),setTimeout((()=>this._s.focus())),this.js.addEventListener("click",this.Vs),this.Ws.addEventListener("click",this.k),this._s.addEventListener("blur",oi.Ks),this.container.addEventListener("keydown",this.Js)}static Ks(t){const i=t.target;let s=+i.value;s=Math.round(s*e.partsPerBeat)/e.partsPerBeat,s=Math.round(100*s)/100,i.value=Math.max(+i.min,Math.min(+i.max,s))+""}}const{button:ri,div:hi,span:ai,h2:li,input:ci,br:fi,select:ui,option:di}=w;class mi{constructor(t){this.m=t,this.Zs=ci({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Qs=ui({style:"width: 100%;"},di({value:"end"},"Apply change at end of song."),di({value:"beginning"},"Apply change at beginning of song.")),this.Ws=ri({class:"cancelButton"}),this.js=ri({class:"okayButton",style:"width:45%;"},"Okay"),this.container=hi({class:"prompt noSelection",style:"width: 250px;"},li("Song Length"),hi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},hi({style:"display: inline-block; text-align: right;"},"Bars per song:",fi(),ai({style:`font-size: smaller; color: ${S.secondaryText};`},"(Multiples of 4 are recommended)")),this.Zs),hi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},hi({class:"selectContainer",style:"width: 100%;"},this.Qs)),hi({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.js),this.Ws),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.js.removeEventListener("click",this.Vs),this.Ws.removeEventListener("click",this.k),this.Zs.removeEventListener("keypress",mi.Gs),this.Zs.removeEventListener("blur",mi.Ks),this.container.removeEventListener("keydown",this.Js)},this.Js=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.Vs()},this.Vs=()=>{window.localStorage.setItem("barCountPosition",this.Qs.value);const t=new ot;t.append(new gt(this.m,mi.Ys(this.Zs),"beginning"==this.Qs.value)),this.m.prompt=null,this.m.record(t,!0)},this.Zs.value=this.m.song.barCount+"",this.Zs.min=e.barCountMin+"",this.Zs.max=e.barCountMax+"";const i=window.localStorage.getItem("barCountPosition");null!=i&&(this.Qs.value=i),this.Zs.select(),setTimeout((()=>this.Zs.focus())),this.js.addEventListener("click",this.Vs),this.Ws.addEventListener("click",this.k),this.Zs.addEventListener("keypress",mi.Gs),this.Zs.addEventListener("blur",mi.Ks),this.container.addEventListener("keydown",this.Js)}static Gs(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static Ks(t){const e=t.target;e.value=String(mi.Ys(e))}static Ys(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}const{button:pi,div:yi,h2:gi,input:vi}=w;class bi{constructor(t){this.m=t,this.Xs=vi({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.tn=vi({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.en=vi({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.sn=vi({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Ws=pi({class:"cancelButton"}),this.js=pi({class:"okayButton",style:"width:45%;"},"Okay"),this.container=yi({class:"prompt noSelection",style:"width: 250px;"},gi("Channel Settings"),yi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Pitch channels:",this.en),yi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Drum channels:",this.sn),yi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Patterns per channel:",this.Xs),yi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Instruments per channel:",this.tn),yi({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.js),this.Ws),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.js.removeEventListener("click",this.Vs),this.Ws.removeEventListener("click",this.k),this.Xs.removeEventListener("keypress",bi.Gs),this.tn.removeEventListener("keypress",bi.Gs),this.en.removeEventListener("keypress",bi.Gs),this.sn.removeEventListener("keypress",bi.Gs),this.Xs.removeEventListener("blur",bi.Ks),this.tn.removeEventListener("blur",bi.Ks),this.en.removeEventListener("blur",bi.Ks),this.sn.removeEventListener("blur",bi.Ks),this.container.removeEventListener("keydown",this.Js)},this.Js=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.Vs()},this.Vs=()=>{const t=new ot;t.append(new Yt(this.m,bi.Ys(this.Xs))),t.append(new $t(this.m,bi.Ys(this.tn))),t.append(new wt(this.m,bi.Ys(this.en),bi.Ys(this.sn))),this.m.prompt=null,this.m.record(t,!0)},this.Xs.value=this.m.song.patternsPerChannel+"",this.Xs.min="1",this.Xs.max=e.barCountMax+"",this.tn.value=this.m.song.instrumentsPerChannel+"",this.tn.min=e.instrumentsPerChannelMin+"",this.tn.max=e.instrumentsPerChannelMax+"",this.en.value=this.m.song.pitchChannelCount+"",this.en.min=e.pitchChannelCountMin+"",this.en.max=e.pitchChannelCountMax+"",this.sn.value=this.m.song.noiseChannelCount+"",this.sn.min=e.noiseChannelCountMin+"",this.sn.max=e.noiseChannelCountMax+"",this.en.select(),setTimeout((()=>this.en.focus())),this.js.addEventListener("click",this.Vs),this.Ws.addEventListener("click",this.k),this.Xs.addEventListener("keypress",bi.Gs),this.tn.addEventListener("keypress",bi.Gs),this.en.addEventListener("keypress",bi.Gs),this.sn.addEventListener("keypress",bi.Gs),this.Xs.addEventListener("blur",bi.Ks),this.tn.addEventListener("blur",bi.Ks),this.en.addEventListener("blur",bi.Ks),this.sn.addEventListener("blur",bi.Ks),this.container.addEventListener("keydown",this.Js)}static Gs(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static Ks(t){const e=t.target;e.value=String(bi.Ys(e))}static Ys(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}function wi(t,e){const i=new ArrayBuffer(e);let s=0,n=Math.min(t.byteLength,i.byteLength);const o=[8,4,2,1];for(const e of o)if(n>=e){const o=r(e,t,i,s,n);s=o.nextOffset,n=o.leftBytes}return i;function r(t,e,i,s,n){let o=Uint8Array;switch(t){case 8:o=Float64Array;break;case 4:o=Float32Array;break;case 2:o=Uint16Array;break;case 1:default:o=Uint8Array}const r=new o(e,s,n/t|0),h=new o(i,s,n/t|0);for(let t=0;t<h.length;t++)h[t]=r[t];return{nextOffset:r.byteOffset+r.byteLength,leftBytes:n-h.length*t}}}class ki{constructor(t){this.nn=0,this.rn=0,this.hn=new ArrayBuffer(t),this.an=new DataView(this.hn)}ln(t){this.rn+=t,this.rn>this.hn.byteLength&&(this.hn=wi(this.hn,Math.max(2*this.hn.byteLength,this.rn)),this.an=new DataView(this.hn))}getWriteIndex(){return this.nn}rewriteUint32(t,e){this.an.setUint32(t,e>>>0,!1)}writeUint32(t){t>>>=0,this.ln(4),this.an.setUint32(this.nn,t,!1),this.nn=this.rn}writeUint24(t){t>>>=0,this.ln(3),this.an.setUint8(this.nn,t>>16&255),this.an.setUint8(this.nn+1,t>>8&255),this.an.setUint8(this.nn+2,255&t),this.nn=this.rn}writeUint16(t){t>>>=0,this.ln(2),this.an.setUint16(this.nn,t,!1),this.nn=this.rn}writeUint8(t){t>>>=0,this.ln(1),this.an.setUint8(this.nn,t),this.nn=this.rn}writeInt8(t){t|=0,this.ln(1),this.an.setInt8(this.nn,t),this.nn=this.rn}writeMidi7Bits(t){if((t>>>=0)>=128)throw new Error("7 bit value contained 8th bit!");this.ln(1),this.an.setUint8(this.nn,t),this.nn=this.rn}writeMidiVariableLength(t){if((t>>>=0)>268435455)throw new Error("writeVariableLength value too big.");let e=!1;for(let i=0;i<4;i++){const s=t>>>21-7*i&127;0==s&&3!=i||(e=!0),e&&this.writeUint8((3==i?0:128)|s)}}writeMidiAscii(t){this.writeMidiVariableLength(t.length);for(let e=0;e<t.length;e++){const i=t.charCodeAt(e);if(i>127)throw new Error("Trying to write unicode character as ascii.");this.writeUint8(i)}}toCompactArrayBuffer(){return wi(this.hn,this.rn)}}const Mi=8192,xi={35:{frequency:0,duration:2,volume:3},36:{frequency:0,duration:2,volume:3},37:{frequency:5,duration:1,volume:3},38:{frequency:4,duration:2,volume:3},39:{frequency:5,duration:2,volume:3},40:{frequency:4,duration:2,volume:3},41:{frequency:1,duration:2,volume:3},42:{frequency:8,duration:1,volume:3},43:{frequency:1,duration:2,volume:3},44:{frequency:8,duration:1,volume:2},45:{frequency:2,duration:2,volume:3},46:{frequency:8,duration:4,volume:3},47:{frequency:2,duration:2,volume:3},48:{frequency:3,duration:2,volume:3},49:{frequency:7,duration:4,volume:3},50:{frequency:3,duration:2,volume:3},51:{frequency:6,duration:4,volume:2},52:{frequency:7,duration:4,volume:3},53:{frequency:6,duration:2,volume:3},54:{frequency:11,duration:2,volume:3},55:{frequency:9,duration:4,volume:3},56:{frequency:7,duration:1,volume:2},57:{frequency:7,duration:4,volume:3},58:{frequency:10,duration:2,volume:2},59:{frequency:6,duration:4,volume:3},69:{frequency:10,duration:2,volume:3},70:{frequency:10,duration:2,volume:3},73:{frequency:10,duration:1,volume:2},74:{frequency:10,duration:2,volume:2}};function Ei(t){return Math.pow(t/127,4)/.3844015376046128}const{button:qi,div:Ci,h2:Pi,input:Si,select:Ti,option:Ri}=w;function zi(t,e,i){return t+i*(e-t)}function Bi(t,e){if(navigator.msSaveOrOpenBlob)return void navigator.msSaveOrOpenBlob(t,e);const i=document.createElement("a");if(null!=i.download){const s=URL.createObjectURL(t);setTimeout((function(){URL.revokeObjectURL(s)}),6e4),i.href=s,i.download=e,setTimeout((function(){i.dispatchEvent(new MouseEvent("click"))}),0)}else{const e=URL.createObjectURL(t);setTimeout((function(){URL.revokeObjectURL(e)}),6e4),window.open(e,"_blank")||(window.location.href=e)}}class Ni{constructor(t){this.m=t,this.cn=Si({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250,autofocus:"autofocus"}),this.fn=Si({type:"checkbox"}),this.un=Si({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}),this.dn=Si({type:"checkbox"}),this.mn=Ti({style:"width: 100%;"},Ri({value:"wav"},"Export to .wav file."),Ri({value:"mp3"},"Export to .mp3 file."),Ri({value:"midi"},"Export to .mid file."),Ri({value:"json"},"Export to .json file.")),this.Ws=qi({class:"cancelButton"}),this.pn=qi({class:"exportButton",style:"width:45%;"},"Export"),this.container=Ci({class:"prompt noSelection",style:"width: 200px;"},Pi("Export Options"),Ci({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"File name:",this.cn),Ci({style:"display: table; width: 100%;"},Ci({style:"display: table-row;"},Ci({style:"display: table-cell;"},"Intro:"),Ci({style:"display: table-cell;"},"Loop Count:"),Ci({style:"display: table-cell;"},"Outro:")),Ci({style:"display: table-row;"},Ci({style:"display: table-cell; vertical-align: middle;"},this.fn),Ci({style:"display: table-cell; vertical-align: middle;"},this.un),Ci({style:"display: table-cell; vertical-align: middle;"},this.dn))),Ci({class:"selectContainer",style:"width: 100%;"},this.mn),Ci({style:"text-align: left;"},"(Be patient, exporting may take some time...)"),Ci({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.pn),this.Ws),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.cn.removeEventListener("input",Ni.yn),this.un.removeEventListener("blur",Ni.Ks),this.pn.removeEventListener("click",this.gn),this.Ws.removeEventListener("click",this.k),this.container.removeEventListener("keydown",this.Js)},this.Js=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.gn()},this.gn=()=>{switch(window.localStorage.setItem("exportFormat",this.mn.value),this.mn.value){case"wav":this.vn();break;case"mp3":this.bn();break;case"midi":this.wn();break;case"json":this.kn();break;default:throw new Error("Unhandled file export type.")}},this.un.value="1",0==this.m.song.loopStart?(this.fn.checked=!1,this.fn.disabled=!0):(this.fn.checked=!0,this.fn.disabled=!1),this.m.song.loopStart+this.m.song.loopLength==this.m.song.barCount?(this.dn.checked=!1,this.dn.disabled=!0):(this.dn.checked=!0,this.dn.disabled=!1);const e=window.localStorage.getItem("exportFormat");null!=e&&(this.mn.value=e),this.cn.select(),setTimeout((()=>this.cn.focus())),this.cn.addEventListener("input",Ni.yn),this.un.addEventListener("blur",Ni.Ks),this.pn.addEventListener("click",this.gn),this.Ws.addEventListener("click",this.k),this.container.addEventListener("keydown",this.Js)}static yn(t){const e=t.target,i=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(i.test(e.value)){let t=e.selectionStart;e.value=e.value.replace(i,""),t--,e.setSelectionRange(t,t)}}static Ks(t){const e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""}Mn(t){const e=new it(this.m.song);if(e.samplesPerSecond=t,e.loopRepeatCount=Number(this.un.value)-1,!this.fn.checked)for(let t=0;t<this.m.song.loopStart;t++)e.nextBar();const i=Math.ceil(e.getSamplesPerBar()*e.getTotalBars(this.fn.checked,this.dn.checked)),s=new Float32Array(i),n=new Float32Array(i);return e.synthesize(s,n,i),{recordedSamplesL:s,recordedSamplesR:n}}vn(){const t=48e3,{recordedSamplesL:e,recordedSamplesR:i}=this.Mn(t),s=e.length,n=2*s;let o=0;const r=new ArrayBuffer(44+2*n),h=new DataView(r);h.setUint32(o,1380533830,!1),o+=4,h.setUint32(o,36+2*n,!0),o+=4,h.setUint32(o,1463899717,!1),o+=4,h.setUint32(o,1718449184,!1),o+=4,h.setUint32(o,16,!0),o+=4,h.setUint16(o,1,!0),o+=2,h.setUint16(o,2,!0),o+=2,h.setUint32(o,t,!0),o+=4,h.setUint32(o,192e3,!0),o+=4,h.setUint16(o,4,!0),o+=2,h.setUint16(o,16,!0),o+=2,h.setUint32(o,1684108385,!1),o+=4,h.setUint32(o,2*n,!0),o+=4;{const t=32767;for(let n=0;n<s;n++){let s=Math.floor(Math.max(-1,Math.min(1,e[n]))*t),r=Math.floor(Math.max(-1,Math.min(1,i[n]))*t);h.setInt16(o,s,!0),o+=2,h.setInt16(o,r,!0),o+=2}}Bi(new Blob([r],{type:"audio/wav"}),this.cn.value.trim()+".wav"),this.k()}bn(){const t=()=>{const{recordedSamplesL:t,recordedSamplesR:e}=this.Mn(44100),i=1152,s=new window.lamejs.Mp3Encoder(2,44100,192),n=[],o=new Int16Array(t.length),r=new Int16Array(e.length);for(let i=0;i<t.length;i++)o[i]=Math.floor(32767*Math.max(-1,Math.min(1,t[i]))),r[i]=Math.floor(32767*Math.max(-1,Math.min(1,e[i])));for(let t=0;t<o.length;t+=i){const e=o.subarray(t,t+i),h=r.subarray(t,t+i),a=s.encodeBuffer(e,h);a.length>0&&n.push(a)}const h=s.flush();h.length>0&&n.push(h);Bi(new Blob(n,{type:"audio/mp3"}),this.cn.value.trim()+".mp3"),this.k()};if("lamejs"in window)t();else{var e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js",e.onload=t,document.head.appendChild(e)}}wn(){const t=this.m.song,i=2*e.ticksPerPart*e.partsPerBeat,s=2*e.ticksPerPart,n=t.getBeatsPerMinute(),r=Math.round(6e7/n),h=i*t.beatsPerBar,a=24,c=[];if(this.fn.checked)for(let e=0;e<t.loopStart;e++)c.push(e);for(let e=0;e<Number(this.un.value);e++)for(let e=t.loopStart;e<t.loopStart+t.loopLength;e++)c.push(e);if(this.dn.checked)for(let e=t.loopStart+t.loopLength;e<t.barCount;e++)c.push(e);const f=[{isMeta:!0,channel:-1,midiChannel:-1,isNoise:!1,isDrumset:!1}];let u=0,d=!1;for(let t=0;t<this.m.song.getChannelCount();t++)if(d||4!=this.m.song.channels[t].instruments[0].type){if(u>=16)continue;f.push({isMeta:!1,channel:t,midiChannel:u++,isNoise:this.m.song.getChannelIsNoise(t),isDrumset:!1}),9==u&&u++}else f.push({isMeta:!1,channel:t,midiChannel:9,isNoise:!0,isDrumset:!0}),d=!0;const m=new ki(1024);m.writeUint32(1297377380),m.writeUint32(6),m.writeUint16(1),m.writeUint16(f.length),m.writeUint16(i);for(const n of f){m.writeUint32(1297379947);const{isMeta:f,channel:u,midiChannel:d,isNoise:g,isDrumset:v}=n,b=m.getWriteIndex();m.writeUint32(0);let w=0,k=0;const M=function(t){if(t<w)throw new Error("Midi event time cannot go backwards.");m.writeMidiVariableLength(t-w),w=t},x=function(t,e){if(!(e>=0&&e<=127))throw new Error("Midi control event value out of range: "+e);m.writeUint8(176|d),m.writeMidi7Bits(t),m.writeMidi7Bits(0|e)};if(f){M(0),m.writeUint8(255),m.writeMidi7Bits(1),m.writeMidiAscii("Composed with https://www.beepbox.co"),M(0),m.writeUint8(255),m.writeMidi7Bits(81),m.writeMidiVariableLength(3),m.writeUint24(r),M(0),m.writeUint8(255),m.writeMidi7Bits(88),m.writeMidiVariableLength(4),m.writeUint8(t.beatsPerBar),m.writeUint8(2),m.writeUint8(24),m.writeUint8(8);const i=e.scales[t.scale].flags[3]&&!e.scales[t.scale].flags[4],s=t.key;let n=s;for(1==(1&s)&&(n+=6),i&&(n+=9);n>6;)n-=12;M(0),m.writeUint8(255),m.writeMidi7Bits(89),m.writeMidiVariableLength(2),m.writeInt8(n),m.writeUint8(i?1:0),this.fn.checked&&(k+=h*t.loopStart),M(k),m.writeUint8(255),m.writeMidi7Bits(6),m.writeMidiAscii("Loop Start");for(let e=0;e<parseInt(this.un.value);e++)k+=h*t.loopLength,M(k),m.writeUint8(255),m.writeMidi7Bits(6),m.writeMidiAscii(e<Number(this.un.value)-1?"Loop Repeat":"Loop End");if(this.dn.checked&&(k+=h*(t.barCount-t.loopStart-t.loopLength)),k!=h*c.length)throw new Error("Miscalculated number of bars.")}else{let n=S.getChannelColor(t,u).name+" channel";M(0),m.writeUint8(255),m.writeMidi7Bits(3),m.writeMidiAscii(n),M(0),x(101,0),M(0),x(100,0),M(0),x(6,a),M(0),x(38,0),M(0),x(101,127),M(0),x(100,127);let r=-1;function p(i){const s=t.channels[u].instruments[i],n=l.valueToPreset(s.preset);if(r!=i){if(r=i,M(k),m.writeUint8(255),m.writeMidi7Bits(4),m.writeMidiAscii("Instrument "+(i+1)),!v){let t=81;if(null!=n&&null!=n.midiProgram)t=n.midiProgram;else if(4==s.type)t=116;else{const e=s.getFilterEnvelope().type,i=8==e||4==e;if(2==s.type||3==s.type)t=g?116:i?47:75;else if(0==s.type){const e=i?Ni.midiDecayInstruments:Ni.midiSustainInstruments;e.length>s.chipWave&&(t=e[s.chipWave])}else if(6==s.type)t=i?25:81;else{if(1!=s.type&&5!=s.type)throw new Error("Unrecognized instrument type.");t=i?2:81}}M(k),m.writeUint8(192|d),m.writeMidi7Bits(t)}M(k);let t=(o=it.instrumentVolumeToVolumeMult(s.volume),127*Math.pow(.3844015376046128*o,.25));x(7,Math.min(127,Math.round(t))),M(k);let h=63*(s.pan/e.panCenter-1)+64;x(10,Math.min(127,Math.round(h)))}var o}null==t.getPattern(u,0)&&p(0);let f=Mi,b=127,w=!1;const E=g?e.spectrumBasePitch:e.keys[t.key].basePitch,q=g?e.noiseInterval:1;for(const n of c){const r=t.getPattern(u,n);if(null!=r){const n=r.instrument,h=t.channels[u].instruments[n],c=l.valueToPreset(h.preset);p(n);let C=!1,P=!0,S=1;C=h.getChord().harmonizes,P=h.getChord().arpeggiates,P?C&&(0==h.type?S=2:1==h.type?S=e.operatorCount:console.error("Unrecognized instrument type for harmonizing arpeggio: "+h.type)):S=e.maxChordSize;for(let n=0;n<r.notes.length;n++){const h=r.notes[n],u=k+h.start*s;let p=u,C=h.pins[0].volume,T=h.pins[0].interval;const R=[-1,-1,-1,-1],z=[-1,-1,-1,-1],B=Math.min(S,h.pitches.length),N=v?Math.max(1,Math.round(90*h.pins[0].volume/3)):90;let L=h.pickMainInterval(),F=L*q;if(!v){let t=a,e=-24;for(let i=1;i<h.pins.length;i++){const s=h.pins[i].interval*q;t=Math.min(t,s+a),e=Math.max(e,s-a)}F=Math.min(t,Math.max(e,F))}for(let n=1;n<h.pins.length;n++){const r=u+h.pins[n].time*s,w=h.pins[n].volume,S=h.pins[n].interval,A=r-p;for(let n=0;n<A;n++){const r=p+n,H=zi(C,w,n/A),I=zi(T,S,n/A)*q-F,O=Math.max(0,Math.min(16383,Math.round(8192*(1+I/a)))),U=Math.min(127,Math.round((y=it.expressionToVolumeMult(H),127*Math.pow(y,.25))));O!=f&&(M(r),m.writeUint8(224|d),m.writeMidi7Bits(127&O),m.writeMidi7Bits(O>>7&127),f=O),U==b||v||(M(r),x(11,U),b=U);const $=r==u;for(let n=0;n<B;n++){let a=h.pitches[n];if(v){a+=L;const t=[36,41,45,48,40,39,59,49,46,55,69,54];if(a<0||a>=t.length)throw new Error("Could not find corresponding drumset pitch. "+a);a=t[a]}else{if(P&&h.pitches.length>n+1&&n==B-1){const l=(r-k)%i,c=e.rhythms[t.rhythm].ticksPerArpeggio*s/e.ticksPerPart,f=Math.floor(l/c);a=h.pitches[n+o(h.pitches.length-n,t.rhythm,f)]}a=E+a*q+F,null!=c&&null!=c.midiSubharmonicOctaves?a+=12*c.midiSubharmonicOctaves:g&&(a+=12*+l.presetCategories.dictionary["Drum Presets"].presets.dictionary["taiko drum"].midiSubharmonicOctaves),g&&(a*=2)}a=Math.max(0,Math.min(127,a)),z[n]=a,$||R[n]==z[n]||(M(r),m.writeUint8(128|d),m.writeMidi7Bits(R[n]),m.writeMidi7Bits(N))}for(let t=0;t<B;t++)($||R[t]!=z[t])&&(M(r),m.writeUint8(144|d),m.writeMidi7Bits(z[t]),m.writeMidi7Bits(N),R[t]=z[t])}p=r,C=w,T=S}const A=k+h.end*s;for(let t=0;t<B;t++)M(A),m.writeUint8(128|d),m.writeMidi7Bits(R[t]),m.writeMidi7Bits(N);w=!0}}else w&&(w=!1,127!=b&&(b=127,M(k),x(11,b)),f!=Mi&&(f=Mi,M(k),m.writeUint8(224|d),m.writeMidi7Bits(127&f),m.writeMidi7Bits(f>>7&127)));k+=h}}M(k),m.writeUint8(255),m.writeMidi7Bits(47),m.writeMidiVariableLength(0),m.rewriteUint32(b,m.getWriteIndex()-b-4)}var y;Bi(new Blob([m.toCompactArrayBuffer()],{type:"audio/midi"}),this.cn.value.trim()+".mid"),this.k()}kn(){const t=this.m.song.toJsonObject(this.fn.checked,Number(this.un.value),this.dn.checked),e=JSON.stringify(t,null,"\t");Bi(new Blob([e],{type:"application/json"}),this.cn.value.trim()+".json"),this.k()}}Ni.midiSustainInstruments=[74,71,80,70,70,68,68,81,81,81,81,81,81],Ni.midiDecayInstruments=[33,46,46,6,6,24,24,25,25,25,25,106,106];class Li{constructor(t){this.L=0,this.an=t}getReadIndex(){return this.L}readUint32(){if(this.L+4>this.an.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.an.getUint32(this.L,!1);return this.L+=4,t}readUint24(){return this.readUint8()<<16|this.readUint8()<<8|this.readUint8()}readUint16(){if(this.L+2>this.an.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.an.getUint16(this.L,!1);return this.L+=2,t}readUint8(){if(this.L+1>this.an.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.an.getUint8(this.L);return this.L++,t}readInt8(){if(this.L+1>this.an.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.an.getInt8(this.L);return this.L++,t}peakUint8(){if(this.L+1>this.an.byteLength)throw new Error("Reading past the end of the buffer.");return this.an.getUint8(this.L)}readMidi7Bits(){const t=this.readUint8();return t>=128&&console.log("7 bit value contained 8th bit! value "+t+", index "+this.L),127&t}readMidiVariableLength(){let t=0;for(let e=0;e<4;e++){const e=this.readUint8();if(t+=127&e,!(128&e))break;t<<=7}return t}skipBytes(t){this.L+=t}hasMore(){return this.an.byteLength>this.L}getReaderForNextBytes(t){if(this.L+t>this.an.byteLength)throw new Error("Reading past the end of the buffer.");const e=new Li(new DataView(this.an.buffer,this.an.byteOffset+this.L,t));return this.skipBytes(t),e}}const{button:Fi,p:Ai,div:Hi,h2:Ii,input:Oi}=w;class Ui{constructor(t){this.m=t,this.xn=Oi({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}),this.Ws=Fi({class:"cancelButton"}),this.container=Hi({class:"prompt noSelection",style:"width: 300px;"},Ii("Import"),Ai({style:"text-align: left; margin: 0.5em 0;"},"BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure."),Ai({style:"text-align: left; margin: 0.5em 0;"},"BeepBox can also (crudely) import .mid files. There are many tools available for creating .mid files. Shorter and simpler songs are more likely to work well."),this.xn,this.Ws),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.xn.removeEventListener("change",this.En),this.Ws.removeEventListener("click",this.k)},this.En=()=>{const t=this.xn.files[0];if(!t)return;const e=t.name.slice(2+(t.name.lastIndexOf(".")-1>>>0));if("json"==e){const e=new FileReader;e.addEventListener("load",(t=>{this.m.prompt=null,this.m.goBackToStart(),this.m.record(new ae(this.m,e.result),!0,!0)})),e.readAsText(t)}else if("midi"==e||"mid"==e){const e=new FileReader;e.addEventListener("load",(t=>{this.m.prompt=null,this.m.goBackToStart(),this.qn(e.result)})),e.readAsArrayBuffer(t)}else console.error("Unrecognized file extension."),this.k()},this.xn.select(),setTimeout((()=>this.xn.focus())),this.xn.addEventListener("change",this.En),this.Ws.addEventListener("click",this.k)}qn(t){const i=new Li(new DataView(t));let s=null;const n=[];for(;i.hasMore();){const t=i.readUint32(),e=i.readUint32();if(1297377380==t)null==s?s=i.getReaderForNextBytes(e):console.error("This MIDI file has more than one header chunk.");else if(1297379947==t){const t=i.getReaderForNextBytes(e);t.hasMore()&&n.push({reader:t,nextEventMidiTick:t.readMidiVariableLength(),ended:!1,runningStatus:-1})}else i.skipBytes(e)}if(null==s)return console.error("No header chunk found in this MIDI file."),void this.k();const o=s.readUint16();s.readUint16();const r=s.readUint16();let h=0;const a=[],c=2==o;if(c)a.push(h);else for(let t=0;t<n.length;t++)a.push(t);const f=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],u=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],d=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],y=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],g=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],v=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],b=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],w=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];let k=5e5,M=8,x=0,E=!1,q=0;for(;;){let t=Number.MAX_VALUE,i=!1;for(const s of a){const o=n[s];for(;!o.ended&&o.nextEventMidiTick==q;){const s=128&o.reader.peakUint8()?o.reader.readUint8():o.runningStatus,r=240&s,l=15&s;240!=r&&(o.runningStatus=s);let P=!1;switch(r){case 128:{const t=o.reader.readMidi7Bits();o.reader.readMidi7Bits(),v[l].push({midiTick:q,pitch:t,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1})}break;case 144:{const t=o.reader.readMidi7Bits(),i=o.reader.readMidi7Bits();if(0==i)v[l].push({midiTick:q,pitch:t,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1});else{const s=Math.max(0,Math.min(e.volumeRange-1,Math.round(it.volumeMultToInstrumentVolume(Ei(y[l]))))),n=Math.max(0,Math.min(e.panMax,Math.round(((g[l]-64)/63+1)*e.panCenter)));v[l].push({midiTick:q,pitch:t,velocity:Math.max(0,Math.min(1,(i+14)/90)),program:p[l],instrumentVolume:s,instrumentPan:n,on:!0})}}break;case 160:o.reader.readMidi7Bits(),o.reader.readMidi7Bits();break;case 176:{const t=o.reader.readMidi7Bits(),e=o.reader.readMidi7Bits();switch(t){case 6:0==f[l]&&0==u[l]&&(d[l]=e);break;case 7:y[l]=e;break;case 10:g[l]=e;break;case 11:w[l].push({midiTick:q,volume:it.volumeMultToExpression((C=e,Math.pow(C/127,4)))});break;case 38:0==f[l]&&0==u[l]&&(m[l]=e);break;case 100:u[l]=e;break;case 101:f[l]=e}}break;case 192:{const t=o.reader.readMidi7Bits();p[l]=t}break;case 208:o.reader.readMidi7Bits();break;case 224:{const t=o.reader.readMidi7Bits(),e=((o.reader.readMidi7Bits()<<7|t)/8192-1)*(d[l]+.01*m[l]);b[l].push({midiTick:q,interval:e})}break;case 240:if(255==s){const t=o.reader.readMidi7Bits(),i=o.reader.readMidiVariableLength();if(47==t)P=!0,o.reader.skipBytes(i);else if(81==t)k=o.reader.readUint24(),o.reader.skipBytes(i-3);else if(88==t){const t=o.reader.readUint8();let s=o.reader.readUint8();for(o.reader.readUint8(),o.reader.readUint8(),o.reader.skipBytes(i-4),M=4*t;0==(1&M)&&(s>0||M>e.beatsPerBarMax)&&M>=2*e.beatsPerBarMin;)M>>=1,s-=1;M=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,M))}else 89==t?(x=o.reader.readInt8(),E=1==o.reader.readUint8(),o.reader.skipBytes(i-2)):o.reader.skipBytes(i)}else{if(240!=s&&247!=s)return console.error("Unrecognized event status: "+s),void this.k();{const t=o.reader.readMidiVariableLength();o.reader.skipBytes(t)}}break;default:return console.error("Unrecognized event type: "+r),void this.k()}!P&&o.reader.hasMore()?o.nextEventMidiTick=q+o.reader.readMidiVariableLength():(o.ended=!0,c&&(h++,h<n.length&&(a[0]=h,n[h].nextEventMidiTick+=q,t=Math.min(t,n[h].nextEventMidiTick),i=!0)))}o.ended||(i=!0,t=Math.min(t,o.nextEventMidiTick))}if(!i)break;q=t}var C;const P=Math.max(e.tempoMin,Math.min(e.tempoMax,Math.round(6e7/k))),S=r/e.partsPerBeat,T=e.partsPerBeat*M,R=Math.ceil(q/S/T);function z(t){return Math.round(t/S)}let B=x;for(E&&(B+=3),1==(1&B)&&(B+=6);B<0;)B+=12;B%=12;const N=[],L=[];for(let t=0;t<16;t++){if(0==v[t].length)continue;const i=new X,s=l.midiProgramToPresetValue(v[t][0].program),n=null==s?null:l.valueToPreset(s),o=9==t,h=o||null!=n&&1==n.isNoise,a=h?e.spectrumBasePitch:e.keys[B].basePitch,c=h?e.noiseInterval:1,f=h?.5:1,u=h?e.drumCount-1:e.maxPitch;h?o?L.unshift(i):L.push(i):N.push(i);let d=1,m=0,p=0,y=e.panCenter;if(o){const s=[];let n=-1,o=null,r=0,h=!1;const a=l.nameToPresetValue("standard drumset"),c=l.valueToPreset(a),f=new Q(!1);f.fromJsonObject(c.settings,!1),f.preset=a,i.instruments.push(f);for(let a=0;a<=v[t].length;a++){const l=a==v[t].length?null:v[t][a],c=null==l?Number.MAX_SAFE_INTEGER:z(l.midiTick);if(s.length>0&&c>r&&(null==l||l.on)){const t=Math.floor(r/T),a=t*T;if(n!=t||null==o){for(n++;n<t;)i.bars[n]=0,n++;o=new K,i.patterns.push(o),i.bars[n]=i.patterns.length,o.instrument=0}(!h||f.volume>p)&&(f.volume=p,f.pan=y,h=!0);const l=[];let m=u,g=0,v=1;for(const t of s){const e=xi[t];-1==l.indexOf(e.frequency)&&l.push(e.frequency),v=Math.max(v,Math.round(e.volume*d)),m=Math.min(m,e.duration),g=Math.max(g,e.duration)}const b=Math.min(g,Math.max(m,2)),w=r-a,k=Math.min(T,Math.min(c-a,w+6*b)),M=new G(-1,w,k,v,!0);M.pitches.length=0;for(let t=0;t<Math.min(e.maxChordSize,l.length);t++){const i=l[t+Math.max(0,l.length-e.maxChordSize)];-1==M.pitches.indexOf(i)&&M.pitches.push(i)}o.notes.push(M),s.length=0}null!=l&&l.on&&null!=xi[l.pitch]&&(s.push(l.pitch),r=c,d=l.velocity,p=l.instrumentVolume,y=l.instrumentPan)}}else{let s=0,n=3,o=0,g=0;function F(e){for(;o<b[t].length&&b[t][o].midiTick<=e;)s=b[t][o].interval,o++}function A(e){for(;g<w[t].length&&w[t][g].midiTick<=e;)n=w[t][g].volume,g++}const k=[],x=[];let E=-1,q=null,C=0,P=0,R=0,B=0;for(let o of v[t]){const t=o.midiTick,g=z(t);if(x.length>0&&g>P){const o=Math.floor(P/T),v=Math.ceil(g/T);for(let b=o;b<v;b++){const o=b*T,v=b*M*r,w=(b+1)*M*r,z=Math.max(0,P-o),N=Math.min(T,g-o),L=Math.max(v,C),H=Math.min(w,t);if(z<N){const t=l.midiProgramToPresetValue(m),r=null==t?null:l.valueToPreset(t);if(E!=b||null==q){for(E++;E<b;)i.bars[E]=0,E++;if(q=new K,i.patterns.push(q),i.bars[E]=i.patterns.length,null==k[m]){const e=new Q(h);k[m]=e,null!=t&&null!=r&&1==r.isNoise==h?(e.fromJsonObject(r.settings,h),e.preset=t):(e.setTypeAndReset(h?2:0,h),e.chord=0),e.volume=p,e.pan=y,i.instruments.push(e)}q.instrument=i.instruments.indexOf(k[m])}null!=k[m]&&(k[m].volume=Math.min(k[m].volume,p),k[m].pan=Math.min(k[m].pan,y));const g=new G(-1,z,N,3,!1);g.pins.length=0,F(L),A(L);const v=x[0]*f-a,w=Math.round((v+s)/c),M=Math.round(s-a);let C=W(0,0,Math.round(d*n));g.pins.push(C);const P=[{part:0,pitch:w,volume:C.volume,keyPitch:!1,keyVolume:!1}];let T=0,I=(v+s)/c,O=d*n;for(let t=z+1;t<=N;t++){const e=Math.max(L,Math.min(H-1,Math.round(S*(t+o)))),i=t-z,r=t==N;F(e),A(e);const h=(s+v)/c,a=d*n,l=Math.round(h),f=Math.abs(h-l)<.01,u=Math.abs(I-Math.round(I))<.01?Math.abs(h-I)>=1:Math.floor(h)!=Math.floor(I),m=f||u,p=Math.round(a),y=Math.abs(a-p)<.01,b=Math.abs(O-Math.round(O))?Math.abs(a-O)>=1:Math.floor(a)!=Math.floor(O),k=y||b;if(I=h,O=a,m||k||r){const t={part:i,pitch:l,volume:p,keyPitch:m||r,keyVolume:k||r},e=P[T];let s=!1,n=Number.MAX_VALUE;if(t.keyPitch){const i=(t.pitch-e.pitch)/(t.part-e.part);let o=Math.abs(i),r=!1,h=Number.MAX_VALUE;for(let t=T+1;t<P.length;t++){const s=P[t];if(s.keyPitch){const n=e.pitch+i*(s.part-e.part),a=Math.abs(n-s.pitch);o<a&&(o=a,r=!0,h=t)}}r&&(s=!0,n=Math.min(n,h))}if(t.keyVolume){const i=(t.volume-e.volume)/(t.part-e.part);let o=Math.abs(i),r=!1,h=Number.MAX_VALUE;for(let t=T+1;t<P.length;t++){const s=P[t];if(s.keyVolume){const n=e.volume+i*(s.part-e.part),a=Math.abs(n-s.volume);o<a&&(o=a,r=!0,h=t)}}r&&(s=!0,n=Math.min(n,h))}if(s){const t=P[n];g.pins.push(W(t.pitch-w,t.part,t.volume)),T=n}P.push(t)}}const U=P[P.length-1];g.pins.push(W(U.pitch-w,U.part,U.volume));let $=u,_=0;for(const t of g.pins)$=Math.min($,u-t.interval),_=Math.min(_,-t.interval);g.pitches.length=0;for(let t=0;t<Math.min(e.maxChordSize,x.length);t++){let i=x[t+Math.max(0,x.length-e.maxChordSize)]*f;null!=r&&null!=r.midiSubharmonicOctaves&&(i-=12*r.midiSubharmonicOctaves);const s=Math.max(_,Math.min($,Math.round((i+M)/c)));if(-1==g.pitches.indexOf(s)){g.pitches.push(s);const t=g.end-g.start;R+=s*t,B+=t}}q.notes.push(g)}}}-1!=x.indexOf(o.pitch)&&x.splice(x.indexOf(o.pitch),1),o.on&&(x.push(o.pitch),d=o.velocity,m=o.program,p=o.instrumentVolume,y=o.instrumentPan),C=t,P=g}const N=R/B;i.octave=h?0:Math.max(0,Math.min(e.scrollableOctaves,Math.round(N/12-1.5)))}for(;i.bars.length<R;)i.bars.push(0)}function H(t,e){for(;t.length>e;){let e=t.length-2,i=t.length-1,s=Number.MAX_VALUE,n=Number.MAX_VALUE;for(let o=0;o<t.length-1;o++)for(let r=o+1;r<t.length;r++){const h=t[o],a=t[r];let l=0,c=0;for(let t=0;t<h.bars.length&&t<a.bars.length;t++)0!=h.bars[t]&&0!=a.bars[t]&&l++,0==h.bars[t]&&0==a.bars[t]&&c++;l<=s&&(l<s||c<n)&&(e=o,i=r,s=l,n=c)}const o=t[e],r=t[i],h=o.instruments.length,a=o.patterns.length;for(const t of r.instruments)o.instruments.push(t);for(const t of r.patterns)t.instrument+=h,o.patterns.push(t);for(let t=0;t<o.bars.length&&t<r.bars.length;t++)0==o.bars[t]&&0!=r.bars[t]&&(o.bars[t]=r.bars[t]+a);t.splice(i,1)}}H(N,e.pitchChannelCountMax),H(L,e.noiseChannelCountMax);this.m.goBackToStart();for(const t of this.m.song.channels)t.muted=!1;this.m.prompt=null,this.m.record(new class extends ot{constructor(t){super();const e=t.song;e.tempo=P,e.beatsPerBar=M,e.key=B,e.scale=11,e.reverb=1,e.rhythm=1,ue(N),ue(L),this.append(new ce(t,N,L)),e.loopStart=0,e.loopLength=e.barCount,this.V(),t.notifier.changed()}}(this.m),!0,!0)}}const $i="songVersion: ";function _i(t){return JSON.parse(t.substring($i.length))}function Di(t){return $i+JSON.stringify(t)}function Wi(){return(Math.random()*(-1>>>0)>>>0).toString(32)}function ji(t,e){return e.versions[0].time-t.versions[0].time}function Vi(t,e){return e.time-t.time}class Gi{constructor(){this.Cn=new tt}static getAllRecoveredSongs(){const t=[],e={};for(let i=0;i<localStorage.length;i++){const s=localStorage.key(i);if(0==s.indexOf($i)){const i=_i(s);let n=e[i.uid];null==n&&(n={versions:[]},e[i.uid]=n,t.push(n)),n.versions.push(i)}}for(const e of t)e.versions.sort(Vi);return t.sort(ji),t}saveVersion(t,e){const i=Math.round(Date.now());clearTimeout(this.Pn),this.Pn=setTimeout((()=>{try{this.Cn.fromBase64String(e)}catch(t){return void window.alert('Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the "Recover Recent Song..." option in BeepBox\'s "File" menu.')}const s=Gi.getAllRecoveredSongs();let n=null;for(const e of s)e.versions[0].uid==t&&(n=e);null==n&&(n={versions:[]},s.unshift(n));let o=n.versions,r=1e3;if(o.length>0){const t=o[0].time;r=o[0].work+Math.min(18e4,i-t)}const h={uid:t,time:i,work:r},a=Di(h);o.unshift(h),localStorage.setItem(a,e);let l=6e4;const c=Math.pow(2,.5);for(var f=1;f<o.length;f++){if(o[f].work-(f==o.length-1?0:o[f+1].work)<l){let t=f;if(f<o.length-1){const e=o[f].time,i=o[f-1].time;e-o[f+1].time<.5*(i-e)&&(t=f+1)}localStorage.removeItem(Di(o[t]));break}l*=c}for(;s.length>8;){let t=null,e=Number.POSITIVE_INFINITY;for(let n=Math.round(4);n<s.length;n++){const o=s[n],r=1/((i-o.versions[0].time)/432e5+1),h=(o.versions[0].work+3e5)*r;e>h&&(e=h,t=o)}for(const e of t.versions)localStorage.removeItem(Di(e));s.splice(s.indexOf(t),1)}}),750)}}const{button:Ki,div:Ji,h2:Yi,p:Zi,select:Qi,option:Xi,iframe:ts}=w;class es{constructor(t){this.m=t,this.Sn=Ji(),this.Ws=Ki({class:"cancelButton"}),this.container=Ji({class:"prompt",style:"width: 300px;"},Yi("Song Recovery"),Ji({style:"max-height: 385px; overflow-y: auto;"},Zi("This is a TEMPORARY list of songs you have recently modified. Please keep your own backups of songs you care about!"),this.Sn,Zi('(If "Display Song Data in URL" is enabled in your preferences, then you may also be able to find song versions in your browser history. However, song recovery won\'t work if you were browsing in private/incognito mode.)')),this.Ws),this.k=()=>{this.m.undo()},this.cleanUp=()=>{this.Ws.removeEventListener("click",this.k)},this.Ws.addEventListener("click",this.k);const e=Gi.getAllRecoveredSongs();0==e.length&&this.Sn.appendChild(Zi("There are no recovered songs available yet. Try making a song!"));for(const t of e){const e=Qi({style:"width: 100%;"});for(const i of t.versions)e.appendChild(Xi({value:i.time},new Date(i.time).toLocaleString()));const i=ts({style:"width: 100%; height: 60px; border: none; display: block;"});i.src="player/#song="+window.localStorage.getItem(Di(t.versions[0]));const s=Ji({style:"margin: 4px 0;"},Ji({class:"selectContainer",style:"width: 100%; margin: 2px 0;"},e),i);this.Sn.appendChild(s),e.addEventListener("change",(()=>{const s=t.versions[e.selectedIndex];i.contentWindow.location.replace("player/#song="+window.localStorage.getItem(Di(s))),i.contentWindow.dispatchEvent(new Event("hashchange"))}))}}}const{button:is,div:ss,input:ns,select:os,span:rs,optgroup:hs,option:as}=w;function ls(t,e){for(let i=0;i<e.length;i++)t.appendChild(as({value:i},e[i]));return t}function cs(t){const e=os();e.appendChild(hs({label:"Edit"},as({value:"copyInstrument"},"Copy Instrument"),as({value:"pasteInstrument"},"Paste Instrument"),as({value:"randomPreset"},"Random Preset"),as({value:"randomGenerated"},"Random Generated")));const i=hs({label:l.presetCategories[0].name});t?(i.appendChild(as({value:2},l.valueToPreset(2).name)),i.appendChild(as({value:3},l.valueToPreset(3).name)),i.appendChild(as({value:4},l.valueToPreset(4).name))):(i.appendChild(as({value:0},l.valueToPreset(0).name)),i.appendChild(as({value:6},l.valueToPreset(6).name)),i.appendChild(as({value:5},l.valueToPreset(5).name)),i.appendChild(as({value:3},l.valueToPreset(3).name)),i.appendChild(as({value:1},l.valueToPreset(1).name))),e.appendChild(i);for(let i=1;i<l.presetCategories.length;i++){const s=l.presetCategories[i],n=hs({label:s.name});let o=!1;for(let e=0;e<s.presets.length;e++){const r=s.presets[e];1==r.isNoise==t&&(n.appendChild(as({value:(i<<6)+e},r.name)),o=!0)}o&&e.appendChild(n)}return e}function fs(t,e){const i=e.toString();t.value!=i&&(t.value=i)}class us{constructor(t,e,i){this.input=t,this.m=e,this.Tn=i,this.Oi=null,this.Rn=0,this.zn=0,this.Bn=()=>{this.m.lastChangeWas(this.Oi)||(this.zn=this.Rn),this.Oi=this.Tn(this.zn,parseInt(this.input.value)),this.m.setProspectiveChange(this.Oi)},this.Nn=()=>{this.m.record(this.Oi),this.Oi=null},t.addEventListener("input",this.Bn),t.addEventListener("change",this.Nn)}updateValue(t){this.Rn=t,this.input.value=String(t)}}class ds{constructor(t){this.m=t,this.prompt=null,this.Ln=new Be(this.m,!1,-1),this.Fn=new Be(this.m,!0,0),this.An=new Be(this.m,!1,1),this.Hn=new Ne(this.m),this.In=new Fe(this.m),this.On=new Ae(this.m),this.Un=new Ue(this.m),this.$n=new $e(this.m),this._n=is({style:"width: 80px;",type:"button"}),this.Dn=is({class:"prevBarButton",style:"width: 40px;",type:"button",title:"Previous Bar (left bracket)"}),this.Wn=is({class:"nextBarButton",style:"width: 40px;",type:"button",title:"Next Bar (right bracket)"}),this.jn=ns({title:"main volume",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"75",value:"50",step:"1"}),this.Vn=os({style:"width: 100%;"},as({selected:!0,disabled:!0,hidden:!1},"File"),as({value:"new"},"+ New Blank Song"),as({value:"import"},"↑ Import Song..."),as({value:"export"},"↓ Export Song..."),as({value:"copyUrl"},"⎘ Copy Song URL"),as({value:"shareUrl"},"⤳ Share Song URL"),as({value:"shortenUrl"},"… Shorten Song URL"),as({value:"viewPlayer"},"▶ View in Song Player"),as({value:"copyEmbed"},"⎘ Copy HTML Embed Code"),as({value:"songRecovery"},"⚠ Recover Recent Song...")),this.Gn=os({style:"width: 100%;"},as({selected:!0,disabled:!0,hidden:!1},"Edit"),as({value:"undo"},"Undo (Z)"),as({value:"redo"},"Redo (Y)"),as({value:"copy"},"Copy Pattern (C)"),as({value:"pasteNotes"},"Paste Pattern Notes (V)"),as({value:"pasteNumbers"},"Paste Pattern Numbers (⇧V)"),as({value:"insertBars"},"Insert Bar After Selection (⏎)"),as({value:"deleteBars"},"Delete Selected Bar (⌫)"),as({value:"selectAll"},"Select All (A)"),as({value:"selectChannel"},"Select Channel (⇧A)"),as({value:"duplicatePatterns"},"Duplicate Reused Patterns (D)"),as({value:"transposeUp"},"Move Notes Up (+)"),as({value:"transposeDown"},"Move Notes Down (-)"),as({value:"moveNotesSideways"},"Move All Notes Sideways..."),as({value:"beatsPerBar"},"Change Beats Per Bar..."),as({value:"barCount"},"Change Song Length..."),as({value:"channelSettings"},"Channel Settings...")),this.Kn=os({style:"width: 100%;"},as({selected:!0,disabled:!0,hidden:!1},"Preferences"),as({value:"autoPlay"},"Auto Play On Load"),as({value:"autoFollow"},"Auto Follow Track"),as({value:"enableNotePreview"},"Preview Added Notes"),as({value:"showLetters"},"Show Piano Keys"),as({value:"showFifth"},'Highlight "Fifth" Notes'),as({value:"showChannels"},"Show All Channels"),as({value:"showScrollBar"},"Octave Scroll Bar"),as({value:"alwaysShowSettings"},"Customize All Instruments"),as({value:"enableChannelMuting"},"Enable Channel Muting"),as({value:"displayBrowserUrl"},"Display Song Data in URL"),as({value:"fullScreen"},"Full-Screen Layout"),as({value:"colorTheme"},"Light Theme")),this.Jn=ls(os(),e.scales.map((t=>t.name))),this.Yn=ls(os(),e.keys.map((t=>t.name)).reverse()),this.Zn=new us(ns({style:"margin: 0; width: 4em; flex-grow: 1; vertical-align: middle;",type:"range",min:"0",max:"14",value:"7",step:"1"}),this.m,((t,e)=>new de(this.m,t,Math.round(120*Math.pow(2,(-4+e)/9))))),this.Qn=ns({style:"width: 3em; margin-left: 0.4em; vertical-align: middle;",type:"number",step:"1"}),this.Xn=new us(ns({style:"margin: 0;",type:"range",min:"0",max:e.reverbRange-1,value:"0",step:"1"}),this.m,((t,e)=>new me(this.m,t,e))),this.eo=ls(os(),e.rhythms.map((t=>t.name))),this.io=cs(!1),this.so=cs(!0),this.no=ls(os(),e.algorithms.map((t=>t.name))),this.oo=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("algorithm")},"Algorithm: "),ss({class:"selectContainer"},this.no)),this.ho=os(),this.ao=ss({class:"selectRow",style:"display: none;"},rs({class:"tip",onclick:()=>this.ro("instrumentIndex")},"Instrument: "),ss({class:"selectContainer"},this.ho)),this.lo=new us(ns({style:"margin: 0;",type:"range",min:-(e.volumeRange-1),max:"0",value:"0",step:"1"}),this.m,((t,e)=>new Ce(this.m,t,-e))),this.co=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("instrumentVolume")},"Volume: "),this.lo.input),this.fo=new us(ns({style:"margin: 0;",type:"range",min:"0",max:e.panMax,value:e.panCenter,step:"1"}),this.m,((t,e)=>new Pe(this.m,t,e))),this.uo=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("pan")},"Panning: "),this.fo.input),this.do=ls(os(),e.chipWaves.map((t=>t.name))),this.mo=ls(os(),e.chipNoises.map((t=>t.name))),this.po=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("chipWave")},"Wave: "),ss({class:"selectContainer"},this.do)),this.yo=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("chipNoise")},"Noise: "),ss({class:"selectContainer"},this.mo)),this.vo=ls(os(),e.transitions.map((t=>t.name))),this.bo=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("transition")},"Transition:"),ss({class:"selectContainer"},this.vo)),this.wo=ls(os(),e.effectsNames),this.ko=new us(ns({style:"margin: 0;",type:"range",min:"0",max:e.filterCutoffRange-1,value:"6",step:"1"}),this.m,((t,e)=>new zt(this.m,t,e))),this.Mo=ss({class:"selectRow",title:"Low-pass Filter Cutoff Frequency"},rs({class:"tip",onclick:()=>this.ro("filterCutoff")},"Filter Cut:"),this.ko.input),this.xo=new us(ns({style:"margin: 0;",type:"range",min:"0",max:e.filterResonanceRange-1,value:"6",step:"1"}),this.m,((t,e)=>new Bt(this.m,t,e))),this.Eo=ss({class:"selectRow",title:"Low-pass Filter Peak Resonance"},rs({class:"tip",onclick:()=>this.ro("filterResonance")},"Filter Peak:"),this.xo.input),this.qo=ls(os(),e.envelopes.map((t=>t.name))),this.Co=ss({class:"selectRow",title:"Low-pass Filter Envelope"},rs({class:"tip",onclick:()=>this.ro("filterEnvelope")},"Filter Env:"),ss({class:"selectContainer"},this.qo)),this.Po=ls(os(),e.envelopes.map((t=>t.name))),this.So=ss({class:"selectRow",title:"Pulse Width Modulator Envelope"},rs({class:"tip",onclick:()=>this.ro("pulseEnvelope")},"Pulse Env:"),ss({class:"selectContainer"},this.Po)),this.To=new us(ns({style:"margin: 0;",type:"range",min:"0",max:e.pulseWidthRange-1,value:"0",step:"1"}),this.m,((t,e)=>new Tt(this.m,t,e))),this.Ro=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("pulseWidth")},"Pulse Width:"),this.To.input),this.zo=ls(os(),e.intervals.map((t=>t.name))),this.Bo=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("interval")},"Interval:"),ss({class:"selectContainer"},this.zo)),this.No=ls(os(),e.chords.map((t=>t.name))),this.Lo=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("chords")},"Chords:"),ss({class:"selectContainer"},this.No)),this.Fo=ls(os(),e.vibratos.map((t=>t.name))),this.Ao=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("vibrato")},"Vibrato:"),ss({class:"selectContainer"},this.Fo)),this.Ho=ss({class:"editor-controls"}),this.Io=ls(os(),e.feedbacks.map((t=>t.name))),this.Oo=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("feedbackType")},"Feedback:"),ss({class:"selectContainer"},this.Io)),this.Uo=new He(this.m,null),this.$o=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("spectrum")},"Spectrum:"),this.Uo.container),this._o=new Ie(this.m),this.Do=ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("harmonics")},"Harmonics:"),this._o.container),this.Wo=ss({class:"editor-controls"}),this.jo=new us(ns({style:"margin: 0; width: 4em;",type:"range",min:"0",max:e.operatorAmplitudeMax,value:"0",step:"1",title:"Feedback Amplitude"}),this.m,((t,e)=>new Ut(this.m,t,e))),this.Vo=ls(os({style:"width: 100%;",title:"Feedback Envelope"}),e.envelopes.map((t=>t.name))),this.Go=ss({class:"operatorRow"},ss({style:"margin-right: .1em; visibility: hidden;"},"1."),ss({style:"width: 3em; margin-right: .3em;"}),this.jo.input,ss({class:"selectContainer",style:"width: 5em; margin-left: .3em;"},this.Vo)),this.Ko=is({type:"button",class:"customize-instrument"},"Customize Instrument"),this.Jo=ss({class:"editor-controls"},this.Mo,this.Eo,this.Co,this.bo,ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("effects")},"Effects:"),ss({class:"selectContainer"},this.wo)),this.Lo,this.Ao,this.Bo,this.po,this.yo,this.oo,this.Ho,this.Oo,this.Go,this.$o,this.Do,this.Wo,this.So,this.Ro),this.Yo=ss({class:"editor-controls"},ss({style:`margin: 3px 0; text-align: center; color: ${S.secondaryText};`},"Instrument Settings"),this.ao,this.co,this.uo,ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("instrumentType")},"Type: "),ss({class:"selectContainer"},this.io,this.so)),this.Ko,this.Jo),this.Zo=ss({class:"promptContainer",style:"display: none;"}),this.Qo=ss({style:"flex: 1; height: 100%; display: flex; overflow: hidden; justify-content: center;"},this.Ln.container,this.Fn.container,this.An.container),this.Xo=ss({class:"pattern-area"},this.$n.container,this.Qo,this.Un.container),this.fs=ss({class:"trackContainer"},this.In.container,this.On.container),this.tr=ss({class:"trackAndMuteContainer"},this.Hn.container,this.fs),this.er=new Oe(this.m,this.fs),this.ir=ss({class:"track-area"},this.tr,this.er.container),this.sr=ss({class:"settings-area noSelection"},ss({class:"version-area"},ss({style:`text-align: center; margin: 3px 0; color: ${S.secondaryText};`},l.versionDisplayName)),ss({class:"play-pause-area"},ss({class:"playback-bar-controls"},this._n,this.Dn,this.Wn),ss({class:"playback-volume-controls"},rs({class:"volume-speaker"}),this.jn)),ss({class:"menu-area"},ss({class:"selectContainer menu file"},this.Vn),ss({class:"selectContainer menu edit"},this.Gn),ss({class:"selectContainer menu preferences"},this.Kn)),ss({class:"song-settings-area"},ss({class:"editor-controls"},ss({style:`margin: 3px 0; text-align: center; color: ${S.secondaryText};`},"Song Settings"),ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("scale")},"Scale: "),ss({class:"selectContainer"},this.Jn)),ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("key")},"Key: "),ss({class:"selectContainer"},this.Yn)),ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("tempo")},"Tempo: "),rs({style:"display: flex;"},this.Zn.input,this.Qn)),ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("reverb")},"Reverb: "),this.Xn.input),ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("rhythm")},"Rhythm: "),ss({class:"selectContainer"},this.eo)))),ss({class:"instrument-settings-area"},this.Yo)),this.mainLayer=ss({class:"beepboxEditor",tabIndex:"0"},this.Xo,this.ir,this.sr,this.Zo),this.nr=!1,this.rr=null,this.hr=[],this.ar=[],this.lr=[],this.cr=[],this.ur=[],this.dr=[],this.mr=()=>{this.mainLayer.focus({preventScroll:!0})},this.whenUpdated=()=>{this.Hn.container.style.display=this.m.enableChannelMuting?"":"none";const t=this.fs.getBoundingClientRect();if(this.m.trackVisibleBars=Math.floor((t.right-t.left)/this.m.getBarWidth()),this.er.render(),this.Hn.render(),this.In.render(),this.$n.container.style.display=this.m.showLetters?"":"none",this.Un.container.style.display=this.m.showScrollBar?"":"none",this.er.container.style.display=this.m.song.barCount>this.m.trackVisibleBars?"":"none",this.m.getFullScreen()){const t=5*(this.Qo.clientHeight/e.windowPitchCount),i=this.Qo.clientWidth/(3*this.m.song.beatsPerBar),s=this.Qo.clientWidth/(this.m.song.beatsPerBar+2),n=Math.max(i,Math.min(s,t))*this.m.song.beatsPerBar;this.Ln.container.style.width=n+"px",this.Fn.container.style.width=n+"px",this.An.container.style.width=n+"px",this.Ln.container.style.flexShrink="0",this.Fn.container.style.flexShrink="0",this.An.container.style.flexShrink="0",this.Ln.container.style.display="",this.An.container.style.display="",this.Ln.render(),this.An.render()}else this.Fn.container.style.width="",this.Fn.container.style.flexShrink="",this.Ln.container.style.display="none",this.An.container.style.display="none";this.Fn.render();const i=[(this.m.autoPlay?"✓ ":"")+"Auto Play On Load",(this.m.autoFollow?"✓ ":"")+"Auto Follow Track",(this.m.enableNotePreview?"✓ ":"")+"Preview Added Notes",(this.m.showLetters?"✓ ":"")+"Show Piano Keys",(this.m.showFifth?"✓ ":"")+'Highlight "Fifth" Notes',(this.m.showChannels?"✓ ":"")+"Show All Channels",(this.m.showScrollBar?"✓ ":"")+"Octave Scroll Bar",(this.m.alwaysShowSettings?"✓ ":"")+"Customize All Instruments",(this.m.enableChannelMuting?"✓ ":"")+"Enable Channel Muting",(this.m.displayBrowserUrl?"✓ ":"")+"Display Song Data in URL",(this.m.fullScreen?"✓ ":"")+"Full-Screen Layout",("light classic"==this.m.colorTheme?"✓ ":"")+"Light Theme"];for(let t=0;t<i.length;t++){const e=this.Kn.children[t+1];e.innerText!=i[t]&&(e.innerText=i[t])}const s=this.m.song.channels[this.m.channel],n=this.m.getCurrentPattern(),o=this.m.getCurrentInstrument(),r=s.instruments[o],h=this.mainLayer.contains(document.activeElement),l=document.activeElement;if(fs(this.Jn,this.m.song.scale),this.Jn.title=e.scales[this.m.song.scale].realName,fs(this.Yn,e.keys.length-1-this.m.song.key),this.Zn.updateValue(Math.max(0,Math.min(28,Math.round(4+9*Math.log(this.m.song.tempo/120)/Math.LN2)))),this.Qn.value=this.m.song.tempo.toString(),this.Xn.updateValue(this.m.song.reverb),fs(this.eo,this.m.song.rhythm),this.m.song.getChannelIsNoise(this.m.channel)?(this.io.style.display="none",this.so.style.display="",fs(this.so,r.preset)):(this.io.style.display="",this.so.style.display="none",fs(this.io,r.preset)),this.m.alwaysShowSettings||r.preset==r.type){if(this.Ko.style.display="none",this.Jo.style.display="",2==r.type?(this.yo.style.display="",fs(this.mo,r.chipNoise)):this.yo.style.display="none",3==r.type?(this.$o.style.display="",this.Uo.render()):this.$o.style.display="none",5==r.type?(this.Do.style.display="",this._o.render()):this.Do.style.display="none",4==r.type){this.Wo.style.display="",this.bo.style.display="none",this.Lo.style.display="none",this.Mo.style.display="none",this.Eo.style.display="none",this.Co.style.display="none";for(let t=0;t<e.drumCount;t++)fs(this.dr[t],r.drumsetEnvelopes[t]),this.ur[t].render()}else this.Wo.style.display="none",this.bo.style.display="",this.Lo.style.display="",this.Mo.style.display="",this.Eo.style.display="",this.Co.style.display="";if(0==r.type?(this.po.style.display="",fs(this.do,r.chipWave)):this.po.style.display="none",1==r.type){this.oo.style.display="",this.Ho.style.display="",this.Oo.style.display="",this.Go.style.display="",fs(this.no,r.algorithm),fs(this.Io,r.feedbackType),this.jo.updateValue(r.feedbackAmplitude),fs(this.Vo,r.feedbackEnvelope),this.Vo.parentElement.style.color=r.feedbackAmplitude>0?"":S.secondaryText;for(let t=0;t<e.operatorCount;t++){const i=t<e.algorithms[r.algorithm].carrierCount;this.hr[t].style.color=i?S.primaryText:"",fs(this.cr[t],r.operators[t].frequency),this.ar[t].updateValue(r.operators[t].amplitude),fs(this.lr[t],r.operators[t].envelope);const s=(i?"Voice ":"Modulator ")+(t+1);this.cr[t].title=s+" Frequency",this.ar[t].input.title=s+(i?" Volume":" Amplitude"),this.lr[t].title=s+" Envelope",this.lr[t].parentElement.style.color=r.operators[t].amplitude>0?"":S.secondaryText}}else this.oo.style.display="none",this.Ho.style.display="none",this.Oo.style.display="none",this.Go.style.display="none";if(6==r.type?(this.So.style.display="",this.Ro.style.display="",this.To.input.title=a(50*Math.pow(.5,.5*(e.pulseWidthRange-r.pulseWidth-1)))+"%",fs(this.Po,r.pulseEnvelope),this.To.updateValue(r.pulseWidth)):(this.So.style.display="none",this.Ro.style.display="none"),2==r.type)this.Ao.style.display="none",this.Bo.style.display="none";else if(3==r.type)this.Ao.style.display="none",this.Bo.style.display="none";else if(4==r.type)this.Ao.style.display="none",this.Bo.style.display="none";else if(0==r.type)this.Ao.style.display="",this.Bo.style.display="";else if(1==r.type)this.Ao.style.display="",this.Bo.style.display="none";else if(5==r.type)this.Ao.style.display="",this.Bo.style.display="";else{if(6!=r.type)throw new Error("Unrecognized instrument type: "+r.type);this.Ao.style.display="",this.Bo.style.display="none"}}else this.Ko.style.display="",this.Jo.style.display="none";for(let t=0;t<e.chords.length;t++){const i=!e.instrumentTypeHasSpecialInterval[r.type]&&e.chords[t].isCustomInterval,s=this.No.children[t];i?s.hasAttribute("hidden")||s.setAttribute("hidden",""):s.removeAttribute("hidden")}if(this.ao.style.display=this.m.song.instrumentsPerChannel>1?"":"none",this.ao.style.visibility=null==n?"hidden":"",this.ho.children.length!=this.m.song.instrumentsPerChannel){for(;this.ho.firstChild;)this.ho.removeChild(this.ho.firstChild);const t=[];for(let e=0;e<this.m.song.instrumentsPerChannel;e++)t.push(e+1);ls(this.ho,t)}this.Yo.style.color=S.getChannelColor(this.m.song,this.m.channel).primaryNote,this.ko.updateValue(r.filterCutoff),this.xo.updateValue(r.filterResonance),fs(this.qo,r.filterEnvelope),fs(this.vo,r.transition),fs(this.wo,r.effects),fs(this.Fo,r.vibrato),fs(this.zo,r.interval),fs(this.No,r.chord),this.lo.updateValue(-r.volume),this.fo.updateValue(r.pan),fs(this.ho,o),this.jn.value=String(this.m.volume),h&&null!=l&&0==l.clientWidth&&this.mr(),this.pr(this.m.prompt),this.m.autoFollow&&!this.m.synth.playing&&this.m.synth.goToBar(this.m.bar)},this.yr=t=>{switch(t.keyCode){case 8:case 13:case 38:case 40:case 37:case 39:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:t.stopPropagation()}},this.Js=t=>{if(this.prompt)27==t.keyCode&&this.m.undo();else switch(t.keyCode){case 27:new Me(this.m,0,0),this.m.selection.resetBoxSelection();break;case 32:this.gr(),t.preventDefault();break;case 90:t.shiftKey?this.m.redo():this.m.undo(),t.preventDefault();break;case 89:this.m.redo(),t.preventDefault();break;case 67:this.m.selection.copy(),t.preventDefault();break;case 13:this.m.selection.insertBars(),t.preventDefault();break;case 8:this.m.selection.deleteBars(),t.preventDefault();break;case 65:t.shiftKey?this.m.selection.selectChannel():this.m.selection.selectAll(),t.preventDefault();break;case 68:this.m.selection.duplicatePatterns(),t.preventDefault();break;case 77:this.m.enableChannelMuting&&(this.m.selection.muteChannels(t.shiftKey),t.preventDefault());break;case 83:this.m.enableChannelMuting&&(t.shiftKey?this.m.selection.muteChannels(!1):this.m.selection.soloChannels(),t.preventDefault());break;case 86:t.shiftKey?this.m.selection.pasteNumbers():this.m.selection.pasteNotes(),t.preventDefault();break;case 73:if(t.shiftKey){const t=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()].toJsonObject();delete t.volume,delete t.pan,delete t.preset,this.vr(JSON.stringify(t))}t.preventDefault();break;case 219:this.m.synth.prevBar(),this.m.autoFollow&&new kt(this.m,this.m.channel,Math.floor(this.m.synth.playhead)),t.preventDefault();break;case 221:this.m.synth.nextBar(),this.m.autoFollow&&new kt(this.m,this.m.channel,Math.floor(this.m.synth.playhead)),t.preventDefault();break;case 189:case 173:this.m.selection.transpose(!1,t.shiftKey),t.preventDefault();break;case 187:case 61:this.m.selection.transpose(!0,t.shiftKey),t.preventDefault();break;case 38:t.shiftKey?(this.m.selection.boxSelectionY1=Math.max(0,this.m.selection.boxSelectionY1-1),this.m.selection.selectionUpdated()):(this.m.selection.setChannelBar((this.m.channel-1+this.m.song.getChannelCount())%this.m.song.getChannelCount(),this.m.bar),this.m.selection.resetBoxSelection()),t.preventDefault();break;case 40:t.shiftKey?(this.m.selection.boxSelectionY1=Math.min(this.m.song.getChannelCount()-1,this.m.selection.boxSelectionY1+1),this.m.selection.selectionUpdated()):(this.m.selection.setChannelBar((this.m.channel+1)%this.m.song.getChannelCount(),this.m.bar),this.m.selection.resetBoxSelection()),t.preventDefault();break;case 37:t.shiftKey?(this.m.selection.boxSelectionX1=Math.max(0,this.m.selection.boxSelectionX1-1),this.m.selection.scrollToSelection(),this.m.selection.selectionUpdated()):(this.m.selection.setChannelBar(this.m.channel,(this.m.bar+this.m.song.barCount-1)%this.m.song.barCount),this.m.selection.resetBoxSelection()),t.preventDefault();break;case 39:t.shiftKey?(this.m.selection.boxSelectionX1=Math.min(this.m.song.barCount-1,this.m.selection.boxSelectionX1+1),this.m.selection.scrollToSelection(),this.m.selection.selectionUpdated()):(this.m.selection.setChannelBar(this.m.channel,(this.m.bar+1)%this.m.song.barCount),this.m.selection.resetBoxSelection()),t.preventDefault();break;case 48:this.m.selection.nextDigit("0"),t.preventDefault();break;case 49:this.m.selection.nextDigit("1"),t.preventDefault();break;case 50:this.m.selection.nextDigit("2"),t.preventDefault();break;case 51:this.m.selection.nextDigit("3"),t.preventDefault();break;case 52:this.m.selection.nextDigit("4"),t.preventDefault();break;case 53:this.m.selection.nextDigit("5"),t.preventDefault();break;case 54:this.m.selection.nextDigit("6"),t.preventDefault();break;case 55:this.m.selection.nextDigit("7"),t.preventDefault();break;case 56:this.m.selection.nextDigit("8"),t.preventDefault();break;case 57:this.m.selection.nextDigit("9"),t.preventDefault();break;default:this.m.selection.digits=""}},this.wr=()=>{this.m.synth.prevBar()},this.kr=()=>{this.m.synth.nextBar()},this.gr=()=>{this.m.synth.playing?this.Mr():(this.m.synth.snapToBar(),this.Er())},this.qr=()=>{this.m.setVolume(Number(this.jn.value))},this.Cr=()=>{this.m.record(new de(this.m,-1,0|parseInt(this.Qn.value)))},this.Pr=()=>{if(isNaN(this.Jn.value)){switch(this.Jn.value){case"forceScale":this.m.selection.forceScale()}this.m.notifier.changed()}else this.m.record(new ne(this.m,this.Jn.selectedIndex))},this.Sr=()=>{if(isNaN(this.Yn.value)){switch(this.Yn.value){case"detectKey":this.m.record(new oe(this.m))}this.m.notifier.changed()}else this.m.record(new _t(this.m,e.keys.length-1-this.Yn.selectedIndex))},this.Tr=()=>{if(isNaN(this.eo.value)){switch(this.eo.value){case"forceRhythm":this.m.selection.forceRhythm()}this.m.notifier.changed()}else this.m.record(new Vt(this.m,this.eo.selectedIndex))},this.Rr=()=>{this.zr(this.io.value)},this.Br=()=>{this.zr(this.so.value)},this.Nr=()=>{this.m.record(new Ft(this.m,this.Io.selectedIndex))},this.Lr=()=>{this.m.record(new At(this.m,this.Vo.selectedIndex))},this.Fr=()=>{this.m.record(new Lt(this.m,this.no.selectedIndex))},this.Ar=()=>{this.m.selection.setInstrument(this.ho.selectedIndex)},this.Hr=()=>{this.m.record(new ft(this.m))},this.Ir=()=>{this.m.record(new Te(this.m,this.do.selectedIndex))},this.Or=()=>{this.m.record(new Re(this.m,this.mo.selectedIndex))},this.Ur=()=>{this.m.record(new Nt(this.m,this.qo.selectedIndex))},this.$r=()=>{this.m.record(new Rt(this.m,this.Po.selectedIndex))},this._r=()=>{this.m.record(new mt(this.m,this.vo.selectedIndex))},this.Dr=()=>{this.m.record(new pt(this.m,this.wo.selectedIndex))},this.Wr=()=>{this.m.record(new Et(this.m,this.Fo.selectedIndex))},this.jr=()=>{this.m.record(new Mt(this.m,this.zo.selectedIndex))},this.Vr=()=>{this.m.record(new xt(this.m,this.No.selectedIndex))},this.Gr=t=>{switch(this.Vn.value){case"new":this.m.goBackToStart();for(const t of this.m.song.channels)t.muted=!1;this.m.record(new ae(this.m,""),!1,!0);break;case"export":this.ro("export");break;case"import":this.ro("import");break;case"copyUrl":this.vr(new URL("#"+this.m.song.toBase64String(),location.href).href);break;case"shareUrl":navigator.share({url:new URL("#"+this.m.song.toBase64String(),location.href).href});break;case"shortenUrl":window.open("https://tinyurl.com/api-create.php?url="+encodeURIComponent(new URL("#"+this.m.song.toBase64String(),location.href).href));break;case"viewPlayer":location.href="player/#song="+this.m.song.toBase64String();break;case"copyEmbed":this.vr(`<iframe width="384" height="60" style="border: none;" src="${new URL("player/#song="+this.m.song.toBase64String(),location.href).href}"></iframe>`);break;case"songRecovery":this.ro("songRecovery")}this.Vn.selectedIndex=0},this.Kr=t=>{switch(this.Gn.value){case"undo":this.m.undo();break;case"redo":this.m.redo();break;case"copy":this.m.selection.copy();break;case"insertBars":this.m.selection.insertBars();break;case"deleteBars":this.m.selection.deleteBars();break;case"pasteNotes":this.m.selection.pasteNotes();break;case"pasteNumbers":this.m.selection.pasteNumbers();break;case"transposeUp":this.m.selection.transpose(!0,!1);break;case"transposeDown":this.m.selection.transpose(!1,!1);break;case"selectAll":this.m.selection.selectAll();break;case"selectChannel":this.m.selection.selectChannel();break;case"duplicatePatterns":this.m.selection.duplicatePatterns();break;case"barCount":this.ro("barCount");break;case"beatsPerBar":this.ro("beatsPerBar");break;case"moveNotesSideways":this.ro("moveNotesSideways");break;case"channelSettings":this.ro("channelSettings")}this.Gn.selectedIndex=0},this.Jr=t=>{switch(this.Kn.value){case"autoPlay":this.m.autoPlay=!this.m.autoPlay;break;case"autoFollow":this.m.autoFollow=!this.m.autoFollow;break;case"enableNotePreview":this.m.enableNotePreview=!this.m.enableNotePreview;break;case"showLetters":this.m.showLetters=!this.m.showLetters;break;case"showFifth":this.m.showFifth=!this.m.showFifth;break;case"showChannels":this.m.showChannels=!this.m.showChannels;break;case"showScrollBar":this.m.showScrollBar=!this.m.showScrollBar;break;case"alwaysShowSettings":this.m.alwaysShowSettings=!this.m.alwaysShowSettings;break;case"enableChannelMuting":this.m.enableChannelMuting=!this.m.enableChannelMuting;for(const t of this.m.song.channels)t.muted=!1;break;case"displayBrowserUrl":this.m.toggleDisplayBrowserUrl();break;case"fullScreen":this.m.fullScreen=!this.m.fullScreen,R.setFullScreen(this.m.fullScreen);break;case"colorTheme":this.m.colorTheme="light classic"==this.m.colorTheme?"dark classic":"light classic",S.setTheme(this.m.colorTheme)}this.Kn.selectedIndex=0,this.m.notifier.changed(),this.m.savePreferences()},this.m.notifier.watch(this.whenUpdated),window.addEventListener("resize",this.whenUpdated),"share"in navigator||this.Vn.removeChild(this.Vn.querySelector("[value='shareUrl']")),this.Jn.appendChild(hs({label:"Edit"},as({value:"forceScale"},"Snap Notes To Scale"))),this.Yn.appendChild(hs({label:"Edit"},as({value:"detectKey"},"Detect Key"))),this.eo.appendChild(hs({label:"Edit"},as({value:"forceRhythm"},"Snap Notes To Rhythm"))),this.Ho.appendChild(ss({class:"operatorRow",style:`color: ${S.secondaryText}; height: 1em; margin-top: 0.5em;`},ss({style:"margin-right: .1em; visibility: hidden;"},"1."),ss({style:"width: 3em; margin-right: .3em;",class:"tip",onclick:()=>this.ro("operatorFrequency")},"Freq:"),ss({style:"width: 4em; margin: 0;",class:"tip",onclick:()=>this.ro("operatorVolume")},"Volume:"),ss({style:"width: 5em; margin-left: .3em;",class:"tip",onclick:()=>this.ro("operatorEnvelope")},"Envelope:")));for(let t=0;t<e.operatorCount;t++){const i=t,s=ss({style:`margin-right: .1em; color: ${S.secondaryText};`},t+1+"."),n=ls(os({style:"width: 100%;",title:"Frequency"}),e.operatorFrequencies.map((t=>t.name))),o=new us(ns({style:"margin: 0; width: 4em;",type:"range",min:"0",max:e.operatorAmplitudeMax,value:"0",step:"1",title:"Volume"}),this.m,((t,e)=>new Ot(this.m,i,t,e))),r=ls(os({style:"width: 100%;",title:"Envelope"}),e.envelopes.map((t=>t.name))),h=ss({class:"operatorRow"},s,ss({class:"selectContainer",style:"width: 3em; margin-right: .3em;"},n),o.input,ss({class:"selectContainer",style:"width: 5em; margin-left: .3em;"},r));this.Ho.appendChild(h),this.hr[t]=h,this.ar[t]=o,this.lr[t]=r,this.cr[t]=n,r.addEventListener("change",(()=>{this.m.record(new Ht(this.m,i,r.selectedIndex))})),n.addEventListener("change",(()=>{this.m.record(new It(this.m,i,n.selectedIndex))}))}this.Wo.appendChild(ss({class:"selectRow"},rs({class:"tip",onclick:()=>this.ro("drumsetEnvelope")},"Envelope:"),rs({class:"tip",onclick:()=>this.ro("drumsetSpectrum")},"Spectrum:")));for(let t=e.drumCount-1;t>=0;t--){const i=t,s=new He(this.m,i);s.container.addEventListener("mousedown",this.mr),this.ur[t]=s;const n=ls(os({style:"width: 100%;",title:"Filter Envelope"}),e.envelopes.map((t=>t.name)));this.dr[t]=n,n.addEventListener("change",(()=>{this.m.record(new Pt(this.m,i,n.selectedIndex))}));const o=ss({class:"selectRow"},ss({class:"selectContainer",style:"width: 5em; margin-right: .3em;"},n),this.ur[t].container);this.Wo.appendChild(o)}if(this.Vn.addEventListener("change",this.Gr),this.Gn.addEventListener("change",this.Kr),this.Kn.addEventListener("change",this.Jr),this.Qn.addEventListener("change",this.Cr),this.Jn.addEventListener("change",this.Pr),this.Yn.addEventListener("change",this.Sr),this.eo.addEventListener("change",this.Tr),this.io.addEventListener("change",this.Rr),this.so.addEventListener("change",this.Br),this.no.addEventListener("change",this.Fr),this.ho.addEventListener("change",this.Ar),this.Ko.addEventListener("click",this.Hr),this.Io.addEventListener("change",this.Nr),this.Vo.addEventListener("change",this.Lr),this.do.addEventListener("change",this.Ir),this.mo.addEventListener("change",this.Or),this.vo.addEventListener("change",this._r),this.wo.addEventListener("change",this.Dr),this.qo.addEventListener("change",this.Ur),this.Po.addEventListener("change",this.$r),this.zo.addEventListener("change",this.jr),this.No.addEventListener("change",this.Vr),this.Fo.addEventListener("change",this.Wr),this._n.addEventListener("click",this.gr),this.Dn.addEventListener("click",this.wr),this.Wn.addEventListener("click",this.kr),this.jn.addEventListener("input",this.qr),this.Xo.addEventListener("mousedown",this.mr),this.ir.addEventListener("mousedown",this.mr),this.Uo.container.addEventListener("mousedown",this.mr),this._o.container.addEventListener("mousedown",this.mr),this.Qn.addEventListener("keydown",this.yr,!1),this.mainLayer.addEventListener("keydown",this.Js),this.Zo.addEventListener("click",(t=>{t.target==this.Zo&&this.m.undo()})),h){const t=this.Kn.querySelector("[value=autoPlay]");t.disabled=!0,t.setAttribute("hidden","")}if(window.screen.availWidth<700||window.screen.availHeight<700){const t=this.Kn.querySelector("[value=fullScreen]");t.disabled=!0,t.setAttribute("hidden","")}}ro(t){this.m.openPrompt(t),this.pr(t)}pr(t){if(this.rr!=t&&(this.rr=t,this.prompt&&(!this.nr||this.prompt instanceof F||this.Er(),this.nr=!1,this.Zo.style.display="none",this.Zo.removeChild(this.prompt.container),this.prompt.cleanUp(),this.prompt=null,this.mr()),t)){switch(t){case"export":this.prompt=new Ni(this.m);break;case"import":this.prompt=new Ui(this.m);break;case"songRecovery":this.prompt=new es(this.m);break;case"barCount":this.prompt=new mi(this.m);break;case"beatsPerBar":this.prompt=new Ye(this.m);break;case"moveNotesSideways":this.prompt=new oi(this.m);break;case"channelSettings":this.prompt=new bi(this.m);break;default:this.prompt=new F(this.m,t)}this.prompt&&(this.prompt instanceof F||(this.nr=this.m.synth.playing,this.Mr()),this.Zo.style.display="",this.Zo.appendChild(this.prompt.container))}}updatePlayButton(){this.m.synth.playing?(this._n.classList.remove("playButton"),this._n.classList.add("pauseButton"),this._n.title="Pause (Space)",this._n.innerText="Pause"):(this._n.classList.remove("pauseButton"),this._n.classList.add("playButton"),this._n.title="Play (Space)",this._n.innerText="Play")}vr(t){if(navigator.clipboard&&navigator.clipboard.writeText)return void navigator.clipboard.writeText(t).catch((()=>{window.prompt("Copy to clipboard:",t)}));const e=document.createElement("textarea");e.innerText=t,document.body.appendChild(e),e.select();const i=document.execCommand("copy");e.remove(),this.mr(),i||window.prompt("Copy this:",t)}Er(){this.m.synth.play(),this.updatePlayButton()}Mr(){this.m.synth.pause(),this.m.synth.resetEffects(),this.m.autoFollow&&this.m.synth.goToBar(this.m.bar),this.m.synth.snapToBar(),this.updatePlayButton()}Yr(){const t=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()].toJsonObject();t.isDrum=this.m.song.getChannelIsNoise(this.m.channel),window.localStorage.setItem("instrumentCopy",JSON.stringify(t))}Zr(){const t=this.m.song.channels[this.m.channel].instruments[this.m.getCurrentInstrument()],e=JSON.parse(String(window.localStorage.getItem("instrumentCopy")));null!=e&&e.isDrum==this.m.song.getChannelIsNoise(this.m.channel)&&this.m.record(new Kt(this.m,t,e))}Qr(){const t=this.m.song.getChannelIsNoise(this.m.channel);this.m.record(new ut(this.m,re(t)))}Xr(){this.m.record(new dt(this.m))}zr(t){if(isNaN(t)){switch(t){case"copyInstrument":this.Yr();break;case"pasteInstrument":this.Zr();break;case"randomPreset":this.Qr();break;case"randomGenerated":this.Xr()}this.m.notifier.changed()}else this.m.record(new ut(this.m,parseInt(t)))}}class ms{constructor(t){this.m=t,this.boxSelectionX0=0,this.boxSelectionY0=0,this.boxSelectionX1=0,this.boxSelectionY1=0,this.digits="",this.patternSelectionStart=0,this.patternSelectionEnd=0,this.patternSelectionActive=!1,this.th=null,this.eh=null}toJSON(){return{x0:this.boxSelectionX0,x1:this.boxSelectionX1,y0:this.boxSelectionY0,y1:this.boxSelectionY1,start:this.patternSelectionStart,end:this.patternSelectionEnd}}fromJSON(t){null!=t&&(this.boxSelectionX0=+t.x0,this.boxSelectionX1=+t.x1,this.boxSelectionY0=+t.y0,this.boxSelectionY1=+t.y1,this.patternSelectionStart=+t.start,this.patternSelectionEnd=+t.end,this.digits="",this.patternSelectionActive=this.patternSelectionStart<this.patternSelectionEnd)}selectionUpdated(){this.m.notifier.changed(),this.digits=""}get boxSelectionBar(){return Math.min(this.boxSelectionX0,this.boxSelectionX1)}get boxSelectionChannel(){return Math.min(this.boxSelectionY0,this.boxSelectionY1)}get boxSelectionWidth(){return Math.abs(this.boxSelectionX0-this.boxSelectionX1)+1}get boxSelectionHeight(){return Math.abs(this.boxSelectionY0-this.boxSelectionY1)+1}scrollToSelection(){this.m.barScrollPos=Math.min(this.m.barScrollPos,this.boxSelectionX1),this.m.barScrollPos=Math.max(this.m.barScrollPos,this.boxSelectionX1-(this.m.trackVisibleBars-1))}setChannelBar(t,e){const i=this.m.lastChangeWas(this.eh);this.eh=new ot,this.eh.append(new kt(this.m,t,e)),this.m.hasRedoHistory()||this.m.record(this.eh,i),this.selectionUpdated()}setPattern(t){this.m.record(new yt(this.m,t,this.boxSelectionBar,this.boxSelectionChannel,this.boxSelectionWidth,this.boxSelectionHeight))}nextDigit(t){this.digits.length>0&&this.digits!=String(this.m.song.channels[this.boxSelectionChannel].bars[this.boxSelectionBar])&&(this.digits=""),this.digits+=t;let e=parseInt(this.digits);e<=this.m.song.patternsPerChannel?this.setPattern(e):(this.digits=t,e=parseInt(this.digits),e<=this.m.song.patternsPerChannel?this.setPattern(e):this.digits="")}insertBars(){this.m.record(new vt(this.m,this.boxSelectionBar+this.boxSelectionWidth,this.boxSelectionWidth));const t=this.boxSelectionWidth;this.boxSelectionX0+=t,this.boxSelectionX1+=t}deleteBars(){const t=new ot;if(this.m.selection.patternSelectionActive){(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&t.append(new Ee(this.m,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const e of this.ih())for(const i of this.sh(e))t.append(new ge(this.m,i,this.m.selection.patternSelectionStart,this.m.selection.patternSelectionEnd));t.append(new Me(this.m,0,0))}else{t.append(new bt(this.m,this.boxSelectionBar,this.boxSelectionWidth));const e=this.boxSelectionWidth;this.boxSelectionX0=Math.max(0,this.boxSelectionX0-e),this.boxSelectionX1=Math.max(0,this.boxSelectionX1-e)}this.m.record(t)}*ih(){for(let t=this.boxSelectionChannel;t<this.boxSelectionChannel+this.boxSelectionHeight;t++)yield t}*nh(){for(let t=this.boxSelectionBar;t<this.boxSelectionBar+this.boxSelectionWidth;t++)yield t}*sh(t){const e={};for(const i of this.nh()){const s=this.m.song.channels[t].bars[i];if(0==s)continue;if(e[String(s)])continue;e[String(s)]=!0;const n=this.m.song.getPattern(t,i);if(null==n)throw new Error;yield n}}oh(t,e){for(let i=0;i<this.m.song.barCount;i++)if(this.m.song.channels[t].bars[i]==e)return!1;return!0}copy(){const t=[];for(const e of this.ih()){const i={},s=[];for(const t of this.nh()){const n=this.m.song.channels[e].bars[t];if(s.push(n),null==i[String(n)]){const s=this.m.song.getPattern(e,t);let o=0,r=[];if(null!=s)if(o=s.instrument,this.patternSelectionActive)for(const t of s.cloneNotes())t.end<=this.patternSelectionStart||t.start>=this.patternSelectionEnd||((t.start<this.patternSelectionStart||t.end>this.patternSelectionEnd)&&new ye(null,t,Math.max(t.start,this.patternSelectionStart),Math.min(this.patternSelectionEnd,t.end)),t.start-=this.patternSelectionStart,t.end-=this.patternSelectionStart,r.push(t));else r=s.notes;i[String(n)]={instrument:o,notes:r}}}const n={isNoise:this.m.song.getChannelIsNoise(e),patterns:i,bars:s};t.push(n)}const i={partDuration:this.patternSelectionActive?this.patternSelectionEnd-this.patternSelectionStart:this.m.song.beatsPerBar*e.partsPerBeat,channels:t};window.localStorage.setItem("selectionCopy",JSON.stringify(i))}pasteNotes(){const t=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(null==t)return;const i=t.channels||[],s=t.partDuration>>>0,n=new ot,o=this.boxSelectionWidth>1||this.boxSelectionHeight>1,r=o?this.boxSelectionHeight:Math.min(i.length,this.m.song.getChannelCount()-this.boxSelectionChannel);for(let t=0;t<r;t++){const h=i[t%i.length],a=this.boxSelectionChannel+t,l=!!h.isNoise,c=h.patterns||{},f=h.bars||[];if(0==f.length)continue;if(l!=this.m.song.getChannelIsNoise(a))continue;const u=o?this.boxSelectionWidth:Math.min(f.length,this.m.song.barCount-this.boxSelectionBar);if(o||1!=f.length||1!=i.length)if(this.patternSelectionActive){const t={},e={};n.append(new Ee(this.m,this.boxSelectionBar,u,this.boxSelectionChannel,r));for(let i=0;i<u;i++){const o=this.boxSelectionBar+i,r=f[i%f.length]>>>0,h=this.m.song.channels[a].bars[o],l=[r,h].join(",");if(0==r&&0==h)continue;if(null!=t[l]){n.append(new yt(this.m,t[l],o,a,1,1));continue}if(0==h){n.append(new Zt(this.m,a,o));const t=c[String(r)],e=Math.min(t.instrument>>>0,this.m.song.instrumentsPerChannel-1),i=this.m.song.getPattern(a,o);n.append(new Jt(this.m,e,i))}else{const t=this.m.song.getPattern(a,o);if(null==t)throw new Error;if(e[String(h)]){n.append(new yt(this.m,0,o,a,1,1)),n.append(new Zt(this.m,a,o));const e=this.m.song.getPattern(a,o);if(null==e)throw new Error;n.append(new Jt(this.m,t.instrument,e));for(const i of t.cloneNotes())n.append(new pe(this.m,e,i,e.notes.length,!1))}else e[String(h)]=!0}const u=this.m.song.getPattern(a,o);if(null==u)throw new Error;if(0==r)n.append(new ge(this.m,u,this.patternSelectionStart,this.patternSelectionEnd));else{const t=c[String(r)];n.append(new Gt(this.m,u,t.notes,this.patternSelectionStart,this.patternSelectionEnd,s))}t[l]=this.m.song.channels[a].bars[o]}}else{for(let t=0;t<u;t++){const e=this.boxSelectionBar+t,i=this.m.song.channels[a].bars[e];0!=i&&(n.append(new yt(this.m,0,e,a,1,1)),this.oh(a,i)&&(this.m.song.channels[a].patterns[i-1].notes.length=0))}const t={};for(let i=0;i<u;i++){const o=this.boxSelectionBar+i,r=f[i%f.length]>>>0,h=String(r);if(0==r)continue;if(null!=t[h]){n.append(new yt(this.m,t[h],o,a,1,1));continue}const l=c[String(r)],u=Math.min(l.instrument>>>0,this.m.song.instrumentsPerChannel-1),d=this.m.song.channels[a].patterns[r-1];if(null!=d&&s==e.partsPerBeat*this.m.song.beatsPerBar&&fe(l.notes,d.notes)&&u==d.instrument)n.append(new yt(this.m,r,o,a,1,1));else{null!=d&&this.oh(a,r)?n.append(new yt(this.m,r,o,a,1,1)):n.append(new Zt(this.m,a,o));const t=this.m.song.getPattern(a,o);if(null==t)throw new Error;n.append(new Gt(this.m,t,l.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:e.partsPerBeat*this.m.song.beatsPerBar,s)),n.append(new Jt(this.m,u,t))}t[h]=this.m.song.channels[a].bars[o]}}else{const t=f[0]>>>0,i=this.boxSelectionBar,o=this.m.song.channels[a].bars[i];if(0==t&&0==o)continue;const r=c[String(t)],h=Math.min(r.instrument>>>0,this.m.song.instrumentsPerChannel-1);if(0==o){const e=this.m.song.channels[a].patterns[t-1];null!=e&&!this.patternSelectionActive&&(fe(r.notes,e.notes)&&h==e.instrument||this.oh(a,t))?n.append(new yt(this.m,t,i,a,1,1)):n.append(new Zt(this.m,a,i))}const l=this.m.song.getPattern(a,i);if(null==l)throw new Error;n.append(new Gt(this.m,l,r.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:e.partsPerBeat*this.m.song.beatsPerBar,s)),n.append(new Jt(this.m,h,l))}}this.m.record(n)}pasteNumbers(){const t=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(null==t)return;const e=t.channels||[],i=new ot,s=this.boxSelectionWidth>1||this.boxSelectionHeight>1,n=s?this.boxSelectionHeight:Math.min(e.length,this.m.song.getChannelCount()-this.boxSelectionChannel);for(let t=0;t<n;t++){const n=e[t%e.length],o=this.boxSelectionChannel+t,r=n.bars||[];if(0==r.length)continue;const h=s?this.boxSelectionWidth:Math.min(r.length,this.m.song.barCount-this.boxSelectionBar);for(let t=0;t<h;t++){const e=r[t%r.length]>>>0,s=this.boxSelectionBar+t;e>this.m.song.patternsPerChannel&&i.append(new Yt(this.m,e)),i.append(new yt(this.m,e,s,o,1,1))}}this.m.record(i)}selectAll(){new Me(this.m,0,0),0==this.boxSelectionBar&&0==this.boxSelectionChannel&&this.boxSelectionWidth==this.m.song.barCount&&this.boxSelectionHeight==this.m.song.getChannelCount()?this.setTrackSelection(this.m.bar,this.m.bar,this.m.channel,this.m.channel):this.setTrackSelection(0,this.m.song.barCount-1,0,this.m.song.getChannelCount()-1),this.selectionUpdated()}selectChannel(){new Me(this.m,0,0),0==this.boxSelectionBar&&this.boxSelectionWidth==this.m.song.barCount?this.setTrackSelection(this.m.bar,this.m.bar,this.boxSelectionY0,this.boxSelectionY1):this.setTrackSelection(0,this.m.song.barCount-1,this.boxSelectionY0,this.boxSelectionY1),this.selectionUpdated()}duplicatePatterns(){this.m.record(new Ee(this.m,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight))}muteChannels(t){if(t){let t=!1;for(let e=0;e<this.m.song.channels.length;e++)if(this.m.song.channels[e].muted){t=!0;break}for(let e=0;e<this.m.song.channels.length;e++)this.m.song.channels[e].muted=!t}else{let t=!1;for(const e of this.ih())if(!this.m.song.channels[e].muted){t=!0;break}for(const e of this.ih())this.m.song.channels[e].muted=t}this.m.notifier.changed()}soloChannels(){let t=!0;for(let e=0;e<this.m.song.channels.length;e++){const i=e<this.boxSelectionChannel||e>=this.boxSelectionChannel+this.boxSelectionHeight;if(this.m.song.channels[e].muted!=i){t=!1;break}}if(t)for(let t=0;t<this.m.song.channels.length;t++)this.m.song.channels[t].muted=!1;else for(let t=0;t<this.m.song.channels.length;t++)this.m.song.channels[t].muted=t<this.boxSelectionChannel||t>=this.boxSelectionChannel+this.boxSelectionHeight;this.m.notifier.changed()}forceRhythm(){const t=new ot;(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&t.append(new Ee(this.m,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const e of this.ih())for(const i of this.sh(e))t.append(new te(this.m,i));this.m.record(t)}forceScale(){const t=new ot;(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&t.append(new Ee(this.m,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));const i=[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(const t of this.ih())if(!this.m.song.getChannelIsNoise(t))for(const e of this.sh(t))ht(e,i);const s=function(t,i){const s=e.scales[i].flags,n=[],o=[];for(let e=0;e<12;e++)t[e]&&n.push(e),s[e]&&o.push(e);const r=n.length>o.length,h=r?o:n,a=r?n:o,l=["root","second","second","third","third","fourth","tritone","fifth","sixth","sixth","seventh","seventh","root"];let c=Number.MAX_SAFE_INTEGER,f=[];const u=[[0]];for(;u.length>0;){const t=u.pop();if(t.length==h.length){let e=0;for(let i=0;i<t.length;i++)e+=Math.abs(h[i]-a[t[i]]),l[h[i]]!=l[a[t[i]]]&&(e+=.75);c>e&&(c=e,f=t)}else{const e=t[t.length-1]+1,i=a.length-h.length+t.length;for(let s=e;s<=i;s++)u.push(t.concat(s))}}const d=[];for(let t=0;t<f.length;t++){const e=h[t],i=a[f[t]];d[t]=r?[i,e]:[e,i]}d.push([12,12]),o.push(12);let m=0;const p=[];for(let t=0;t<12;t++){const e=d[m][0],i=d[m][1],s=d[m+1][0],n=d[m+1][1];t==s-1&&m++;const r=(t-e)*(n-i)/(s-e)+i;let h=0,a=Number.MAX_SAFE_INTEGER;for(const e of o){let i=Math.abs(e-r);l[e]!=l[t]&&(i+=.1),a>i&&(a=i,h=e)}p[t]=h}return p}(i,this.m.song.scale);for(const e of this.ih())if(!this.m.song.getChannelIsNoise(e))for(const i of this.sh(e))t.append(new qe(this.m,i,s));this.m.record(t)}setTrackSelection(t,e,i,s){const n=this.m.lastChangeWas(this.eh);this.eh=new ot,this.eh.append(new ke(this.m,t,e,i,s)),this.m.hasRedoHistory()||this.m.record(this.eh,n)}transpose(t,e){const i=this.m.lastChangeWas(this.th);this.th=new ot,(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&this.th.append(new Ee(this.m,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const i of this.ih())for(const s of this.sh(i))this.th.append(new we(this.m,i,s,t,!1,e));this.m.record(this.th,i)}setInstrument(t){const e=new ot;(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&e.append(new Ee(this.m,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const i of this.ih())for(const s of this.sh(i))e.append(new Jt(this.m,t,s));this.m.record(e)}resetBoxSelection(){this.boxSelectionX0=this.boxSelectionX1=this.m.bar,this.boxSelectionY0=this.boxSelectionY1=this.m.channel}}class ps{constructor(){this.rh=[],this.hh=!1}watch(t){-1==this.rh.indexOf(t)&&this.rh.push(t)}unwatch(t){const e=this.rh.indexOf(t);-1!=e&&this.rh.splice(e,1)}changed(){this.hh=!0}notifyWatchers(){if(this.hh){this.hh=!1;for(const t of this.rh.concat())t()}}}class ys{constructor(){this.notifier=new ps,this.selection=new ms(this),this.channel=0,this.bar=0,this.volume=75,this.trackVisibleBars=16,this.barScrollPos=0,this.prompt=null,this.ah=new Gi,this.lh=null,this.fh=0,this.uh=0,this.dh=!1,this.mh=!1,this.ph=!1,this.yh=()=>{if(null==window.history.state&&""!=window.location.hash){this.fh++,this.gh();const t={canUndo:!0,sequenceNumber:this.fh,bar:this.bar,channel:this.channel,recoveryUid:this.bh,prompt:null,selection:this.selection.toJSON()};return new ae(this,window.location.hash),this.prompt=t.prompt,this.displayBrowserUrl?this.wh(t,this.song.toBase64String()):this.kh(t,this.song.toBase64String()),this.forgetLastChange(),void this.notifier.notifyWatchers()}const t=this.Mh();if(null==t)throw new Error("History state is null.");t.sequenceNumber!=this.fh&&(this.bar=t.bar,this.channel=t.channel,this.fh=t.sequenceNumber,this.prompt=t.prompt,new ae(this,this.xh()),this.bh=t.recoveryUid,this.selection.fromJSON(t.selection),this.forgetLastChange(),this.notifier.notifyWatchers())},this.Eh=()=>{this.notifier.notifyWatchers()},this.qh=()=>{(!this.synth.playing&&(this.bar<this.selection.boxSelectionBar||this.selection.boxSelectionBar+this.selection.boxSelectionWidth<=this.bar)||this.channel<this.selection.boxSelectionChannel||this.selection.boxSelectionChannel+this.selection.boxSelectionHeight<=this.channel||this.song.barCount<this.selection.boxSelectionBar+this.selection.boxSelectionWidth||this.song.getChannelCount()<this.selection.boxSelectionChannel+this.selection.boxSelectionHeight||1==this.selection.boxSelectionWidth&&1==this.selection.boxSelectionHeight)&&this.selection.resetBoxSelection()},this.Ch=()=>{this.ph=!1;const t=this.song.toBase64String();this.dh&&this.fh++,this.mh?this.gh():this.ah.saveVersion(this.bh,t);let e={canUndo:!0,sequenceNumber:this.fh,bar:this.bar,channel:this.channel,recoveryUid:this.bh,prompt:this.prompt,selection:this.selection.toJSON()};this.dh?this.kh(e,t):this.wh(e,t),this.dh=!1,this.mh=!1},this.notifier.watch(this.qh),this.autoPlay="true"==window.localStorage.getItem("autoPlay"),this.autoFollow="true"==window.localStorage.getItem("autoFollow"),this.enableNotePreview="false"!=window.localStorage.getItem("enableNotePreview"),this.showFifth="true"==window.localStorage.getItem("showFifth"),this.showLetters="true"==window.localStorage.getItem("showLetters"),this.showChannels="true"==window.localStorage.getItem("showChannels"),this.showScrollBar="true"==window.localStorage.getItem("showScrollBar"),this.alwaysShowSettings="true"==window.localStorage.getItem("alwaysShowSettings"),this.enableChannelMuting="true"==window.localStorage.getItem("enableChannelMuting"),this.displayBrowserUrl="false"!=window.localStorage.getItem("displayBrowserUrl"),this.fullScreen="true"==window.localStorage.getItem("fullScreen"),this.colorTheme=window.localStorage.getItem("colorTheme")||"dark classic",S.setTheme(this.colorTheme),R.setFullScreen(this.fullScreen),null!=window.localStorage.getItem("volume")&&(this.volume=Math.min(window.localStorage.getItem("volume")>>>0,75)),null==window.sessionStorage.getItem("currentUndoIndex")&&(window.sessionStorage.setItem("currentUndoIndex","0"),window.sessionStorage.setItem("oldestUndoIndex","0"),window.sessionStorage.setItem("newestUndoIndex","0"));let t=window.location.hash;""==t&&(t=this.xh()),this.song=new tt(t),""!=t&&null!=t||he(this.song),t=this.song.toBase64String(),this.synth=new it(this.song),this.synth.volume=this.Ph();let e=this.Mh();null==e&&(e={canUndo:!1,sequenceNumber:0,bar:0,channel:0,recoveryUid:Wi(),prompt:null,selection:this.selection.toJSON()}),null==e.recoveryUid&&(e.recoveryUid=Wi()),this.wh(e,t),window.addEventListener("hashchange",this.yh),window.addEventListener("popstate",this.yh),this.bar=e.bar,this.channel=e.channel,this.bh=e.recoveryUid,this.barScrollPos=Math.max(0,this.bar-(this.trackVisibleBars-6)),this.prompt=e.prompt,this.selection.fromJSON(e.selection);for(const t of["input","change","click","keyup","keydown","mousedown","mousemove","mouseup","touchstart","touchmove","touchend","touchcancel"])window.addEventListener(t,this.Eh)}toggleDisplayBrowserUrl(){const t=this.Mh();this.displayBrowserUrl=!this.displayBrowserUrl,this.wh(t,this.song.toBase64String())}Mh(){if(this.displayBrowserUrl)return window.history.state;{const t=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return null==t?null:t.state}}xh(){if(this.displayBrowserUrl)return window.location.hash;{const t=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return null==t?"":t.hash}}wh(t,e){this.displayBrowserUrl?window.history.replaceState(t,"","#"+e):(window.sessionStorage.setItem(window.sessionStorage.getItem("currentUndoIndex")||"0",JSON.stringify({state:t,hash:e})),window.history.replaceState(null,"",location.pathname))}kh(t,e){if(this.displayBrowserUrl)window.history.pushState(t,"","#"+e);else{let i=Number(window.sessionStorage.getItem("currentUndoIndex")),s=Number(window.sessionStorage.getItem("oldestUndoIndex"));i=(i+1)%ys.Sh,window.sessionStorage.setItem("currentUndoIndex",String(i)),window.sessionStorage.setItem("newestUndoIndex",String(i)),i==s&&(s=(s+1)%ys.Sh,window.sessionStorage.setItem("oldestUndoIndex",String(s))),window.sessionStorage.setItem(String(i),JSON.stringify({state:t,hash:e})),window.history.replaceState(null,"",location.pathname)}this.uh=t.sequenceNumber}hasRedoHistory(){return this.uh>this.fh}Th(){if(this.displayBrowserUrl)window.history.forward();else{let t=Number(window.sessionStorage.getItem("currentUndoIndex"));t!=Number(window.sessionStorage.getItem("newestUndoIndex"))&&(t=(t+1)%ys.Sh,window.sessionStorage.setItem("currentUndoIndex",String(t)),setTimeout(this.yh))}}Rh(){if(this.displayBrowserUrl)window.history.back();else{let t=Number(window.sessionStorage.getItem("currentUndoIndex"));t!=Number(window.sessionStorage.getItem("oldestUndoIndex"))&&(t=(t+ys.Sh-1)%ys.Sh,window.sessionStorage.setItem("currentUndoIndex",String(t)),setTimeout(this.yh))}}record(t,e=!1,i=!1){t.isNoop()?(this.lh=null,e&&this.Rh()):(t.commit(),this.lh=t,this.dh=this.dh||!e,this.mh=this.mh||i,this.ph||(window.requestAnimationFrame(this.Ch),this.ph=!0))}gh(){this.bh=Wi()}openPrompt(t){this.prompt=t;const e=this.song.toBase64String();this.fh++;const i={canUndo:!0,sequenceNumber:this.fh,bar:this.bar,channel:this.channel,recoveryUid:this.bh,prompt:this.prompt,selection:this.selection.toJSON()};this.kh(i,e)}undo(){this.Mh().canUndo&&this.Rh()}redo(){this.Th()}setProspectiveChange(t){this.lh=t}forgetLastChange(){this.lh=null}lastChangeWas(t){return null!=t&&t==this.lh}goBackToStart(){this.channel=0,this.bar=0,this.barScrollPos=0,this.notifier.changed(),this.synth.snapToStart(),this.notifier.changed()}savePreferences(){window.localStorage.setItem("autoPlay",this.autoPlay?"true":"false"),window.localStorage.setItem("autoFollow",this.autoFollow?"true":"false"),window.localStorage.setItem("enableNotePreview",this.enableNotePreview?"true":"false"),window.localStorage.setItem("showFifth",this.showFifth?"true":"false"),window.localStorage.setItem("showLetters",this.showLetters?"true":"false"),window.localStorage.setItem("showChannels",this.showChannels?"true":"false"),window.localStorage.setItem("showScrollBar",this.showScrollBar?"true":"false"),window.localStorage.setItem("alwaysShowSettings",this.alwaysShowSettings?"true":"false"),window.localStorage.setItem("enableChannelMuting",this.enableChannelMuting?"true":"false"),window.localStorage.setItem("displayBrowserUrl",this.displayBrowserUrl?"true":"false"),window.localStorage.setItem("fullScreen",this.fullScreen?"true":"false"),window.localStorage.setItem("colorTheme",this.colorTheme),window.localStorage.setItem("volume",String(this.volume))}setVolume(t){this.volume=t,this.savePreferences(),this.synth.volume=this.Ph()}Ph(){return Math.min(1,Math.pow(this.volume/50,.5))*Math.pow(2,(this.volume-75)/25)}getCurrentPattern(t=0){return this.song.getPattern(this.channel,this.bar+t)}getCurrentInstrument(t=0){const e=this.getCurrentPattern(t);return null==e?0:e.instrument}getMobileLayout(){return window.innerWidth<=700}getBarWidth(){return this.getMobileLayout()||!this.enableChannelMuting||this.getFullScreen()?32:30}getChannelHeight(){return this.getMobileLayout()||this.song.getChannelCount()>4||this.song.barCount>this.trackVisibleBars&&this.song.getChannelCount()>3?27:32}getFullScreen(){return!this.getMobileLayout()&&this.fullScreen}}ys.Sh=100;const gs=new ys,vs=new ds(gs);if(document.getElementById("beepboxEditorContainer").appendChild(vs.mainLayer),vs.whenUpdated(),vs.mainLayer.focus(),!h&&gs.autoPlay){function bs(){document.hidden||(gs.synth.play(),vs.updatePlayButton(),window.removeEventListener("visibilitychange",bs))}document.hidden?window.addEventListener("visibilitychange",bs):bs()}return"scrollRestoration"in history&&(history.scrollRestoration="manual"),vs.updatePlayButton(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service_worker.js",{updateViaCache:"all",scope:"/"}).catch((()=>{})),t.ChangePreset=ut,t.Channel=X,t.ColorConfig=S,t.Config=e,t.EditorConfig=l,t.ExportPrompt=Ni,t.Instrument=Q,t.Note=G,t.Pattern=K,t.SongDocument=ys,t.SongEditor=ds,t.Synth=it,Object.defineProperty(t,"zh",{value:!0}),t}({});
//# sourceMappingURL=beepbox_editor.min.js.map
	</script>
</body></html>
